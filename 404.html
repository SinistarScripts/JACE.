<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JACE.</title>

    <link rel="icon" type="image/png" href="Jace_LOGO2.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.sandbox.paypal.com/sdk/js?client-id=AW_n6tSU0nZgnC4v0y_Ua--seUwYuMGAbBRnV6EV3ZhNOaVV6H5P4BoH3Y7m-cuBdVicq_90XELd2IAK&currency=USD&intent=capture" data-sdk-integration-source="button-factory"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            teal: '#0f4c5c',
                            orange: '#ff8c42',
                            orangeDark: '#e57a33',
                        },
                        // Dynamic Semantic Colors using CSS Variables
                        app: {
                            bg: 'var(--app-bg)',
                            sidebar: 'var(--app-sidebar)',
                            text: 'var(--app-text)',
                            textMuted: 'var(--app-text-muted)',
                            border: 'var(--app-border)',
                            card: 'var(--app-card)',
                            input: 'var(--app-input)',
                            hover: 'var(--app-hover)',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'toast-in': 'toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'cart-pulse': 'cartPulse 0.4s ease-in-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        toastIn: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        cartPulse: {
                            '0%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.3)' },
                            '100%': { transform: 'scale(1)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Mode (Default) */
            --app-bg: #ffffff;
            --app-sidebar: #ffffff;
            --app-text: #0f4c5c;
            --app-text-muted: #6b7280;
            --app-border: #e5e7eb;
            --app-card: #f9fafb;
            --app-input: #ffffff;
            --app-hover: #f3f4f6;
        }

        .dark {
            /* Dark Mode */
            --app-bg: #121212; /* Dark Charcoal */
            --app-sidebar: #1a1a1a;
            --app-text: #e0f2f1; /* Soft Teal/White */
            --app-text-muted: #9ca3af;
            --app-border: #2d2d2d;
            --app-card: #1e1e1e;
            --app-input: #2d2d2d;
            --app-hover: #2d2d2d;
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Scroll Snapping */
        .snap-y-mandatory { scroll-snap-type: y mandatory; }
        .snap-start { scroll-snap-align: start; }
        
        /* Smooth scrolling */
        html, body { overscroll-behavior: none; transition: background-color 0.3s ease, color 0.3s ease; }
        
        /* Animation for Like */
        @keyframes pulse-heart {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .animate-like { animation: pulse-heart 0.3s ease-in-out; }
        
        /* Scrolling text animation */
        .scrolling-text-container {
            mask-image: linear-gradient(to right, transparent 0%, black 10%, black 90%, transparent 100%);
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(15, 76, 92, 0.4);
            backdrop-filter: blur(4px);
        }

        /* Tab Active State */
        .tab-active {
            color: var(--app-text); 
            border-bottom: 2px solid #0f4c5c;
        }
        .dark .tab-active {
            border-bottom-color: #ff8c42; /* Orange accent in dark mode */
        }
        
        .tab-inactive {
            color: var(--app-text-muted);
            border-bottom: 2px solid transparent;
        }
        .tab-inactive:hover {
            color: var(--app-text);
        }

        /* Toggle Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #ff8c42;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #ff8c42;
        }
        
        /* Feed Shift Animation */
        .feed-shifted {
            padding-right: 400px; /* Shift view to left by adding padding to right */
        }
        
        /* Chat Bubbles */
        .chat-bubble-sent {
            background-color: #0f4c5c;
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        .chat-bubble-received {
            background-color: var(--app-hover);
            color: var(--app-text);
            border-radius: 18px 18px 18px 4px;
        }
        .inbox-tab-active {
            background-color: var(--app-hover);
            color: var(--app-text);
            border-right: 3px solid #0f4c5c;
        }
        .dark .inbox-tab-active {
            border-right-color: #ff8c42;
        }
        
        /* Video Message Preview in Chat */
        .video-msg-preview {
            width: 200px;
            aspect-ratio: 9/16;
            background-color: black;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Play/Pause Icon Overlay */
        .play-pause-icon {
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
        }

        .heart-liked {
            fill: #ff8c42 !important;
            color: #ff8c42 !important;
            stroke: #ff8c42 !important;
            animation: pulse-heart 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .heart-container-liked {
            border-color: #ff8c42 !important;
            background-color: rgba(255, 140, 66, 0.1) !important;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "path": "https://esm.sh/path@^0.12.7",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "url": "https://esm.sh/url@^0.11.4",
    "firebase/": "https://esm.sh/firebase@^12.8.0/"
  }
}
</script>

   <!-- START EMAILJS SDK -->
   <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
   <script type="text/javascript">
      (function(){
         emailjs.init("4TCB2A7eRe2V4sYz0"); 
      })();
   </script>

<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-app-bg text-app-text overflow-hidden font-sans w-full h-screen flex">

    <!-- TOAST CONTAINER (FIXED BOTTOM) -->
    <div id="toast-container" class="fixed bottom-24 right-6 md:bottom-6 md:left-[284px] md:right-auto z-[90] bg-brand-teal text-white p-6 rounded-full shadow-2xl hover:scale-110 transition-transform group hidden items-center justify-center gap-2 border-2 border-white/20"></div>

    <!-- PERSISTENT CART FAB -->
    <button id="cart-fab" onclick="window.navigateTo('cart')" class="fixed bottom-20 right-4 md:bottom-6 md:left-[284px] md:right-auto z-[90] bg-brand-teal text-white p-4 md:p-6 rounded-full shadow-2xl hover:scale-110 transition-transform group hidden items-center justify-center gap-2 border-2 border-white/20">
        <div class="relative">
            <i data-lucide="shopping-cart" class="w-6 h-6 fill-current"></i>
            <span id="cart-badge" class="absolute -top-3 -right-3 bg-brand-orange text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] text-center hidden border-2 border-app-bg">0</span>
        </div>
        <span class="font-bold hidden group-hover:block whitespace-nowrap overflow-hidden transition-all pr-1">Cart</span>
    </button>

    <!-- HIDDEN FILE INPUT FOR AVATAR UPLOAD -->
    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
    
    <!-- COMMENT OVERLAY (TRANSPARENT BUT CLICKABLE) -->
    <div id="comment-overlay" onclick="window.closeComments()" class="fixed inset-0 z-[60] hidden transition-opacity duration-300"></div>

    <!-- SHARE MODAL -->
    <div id="share-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[80vh]">
            <!-- Header -->
            <div class="p-4 border-b border-app-border flex justify-between items-center bg-app-card">
                <h3 class="font-bold text-lg text-app-text">Share to</h3>
                <button onclick="window.closeShareModal()" class="p-1 hover:bg-app-hover rounded-full text-app-textMuted">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Actions: Repost & Not Interested OR Edit/Delete (Dynamic) -->
            <div id="share-actions-row" class="p-4 border-b border-app-border flex gap-4 bg-app-bg justify-around">
                <!-- Content injected via JS based on ownership -->
            </div>

            <!-- Following List -->
            <div class="flex-1 overflow-y-auto bg-app-bg">
                 <div class="px-4 py-2 text-xs font-bold text-app-textMuted uppercase tracking-wider sticky top-0 bg-app-bg/95 backdrop-blur-sm z-10 border-b border-app-border">Following</div>
                 <div id="share-following-list" class="p-2 space-y-1">
                     <!-- Populated by JS -->
                     <div class="text-center text-sm text-app-textMuted py-8">Loading friends...</div>
                 </div>
            </div>
        </div>
    </div>

    <!-- REPORT MODAL -->
   <div id="report-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center modal-backdrop p-4">
       <div class="bg-app-bg w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up relative">
           <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
               <i data-lucide="x" class="w-6 h-6"></i>
           </button>
           <div class="p-6">
               <div class="flex items-center gap-3 mb-2 text-red-500">
                   <div class="p-2 bg-red-100 rounded-full"><i data-lucide="flag" class="w-5 h-5"></i></div>
                   <h2 class="text-xl font-extrabold text-app-text">Report</h2>
               </div>
               <p class="text-sm text-app-textMuted mb-6">Help us keep the community safe. This report is anonymous.</p>
               
               <form onsubmit="window.handleReportSubmit(event)" class="space-y-4">
                   <input type="hidden" id="report-target-id">
                   <input type="hidden" id="report-target-type">
                   <input type="hidden" id="report-user-id">

                   <div>
                       <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Reason</label>
                       <div class="relative">
                           <select id="report-reason" class="w-full px-4 py-3 rounded-xl border border-app-border bg-app-input text-app-text outline-none focus:border-brand-teal appearance-none font-medium cursor-pointer" required>
                               <option value="" disabled selected>Select a reason</option>
                               <option value="spam">Spam or Misleading</option>
                               <option value="harassment">Harassment or Bullying</option>
                               <option value="inappropriate">Inappropriate Content</option>
                               <option value="scam">Scam or Fraud</option>
                               <option value="intellectual_property">Intellectual Property</option>
                               <option value="other">Other</option>
                           </select>
                           <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-app-textMuted"><i data-lucide="chevron-down" class="w-4 h-4"></i></div>
                       </div>
                   </div>
                   <div>
                       <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Details (Optional)</label>
                       <textarea id="report-details" rows="3" class="w-full px-4 py-3 rounded-xl border border-app-border bg-app-input text-app-text outline-none focus:border-brand-teal resize-none font-medium" placeholder="Provide more context..."></textarea>
                   </div>
                   <button type="submit" class="w-full bg-red-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-500/20 hover:bg-red-600 transition-all flex items-center justify-center gap-2">
                       <span>Submit Report</span>
                   </button>
               </form>
           </div>
       </div>
   </div>
    
    <!-- OFFER MODAL -->
    <div id="offer-modal" class="hidden fixed inset-0 z-[120] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
            <div class="p-4 border-b border-app-border flex justify-between items-center bg-app-card">
                <h3 class="font-bold text-lg text-app-text flex items-center gap-2">
                    <i data-lucide="tag" class="w-5 h-5 text-brand-orange"></i> Make an Offer
                </h3>
                <button onclick="window.closeOfferModal()" class="p-1 hover:bg-app-hover rounded-full text-app-textMuted">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-app-textMuted mb-4">Send a private offer to the seller. If accepted, you can proceed to purchase.</p>
                
                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Preset Discounts</label>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="window.setOfferPreset(0.90)" class="p-2 border border-app-border rounded-lg hover:bg-app-hover text-app-text text-sm font-bold">-10%</button>
                    <button onclick="window.setOfferPreset(0.85)" class="p-2 border border-app-border rounded-lg hover:bg-app-hover text-app-text text-sm font-bold">-15%</button>
                    <button onclick="window.setOfferPreset(0.80)" class="p-2 border border-app-border rounded-lg hover:bg-app-hover text-app-text text-sm font-bold">-20%</button>
                </div>
                
                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Your Offer ($)</label>
                <input type="number" id="offer-input" step="0.01" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text text-lg font-bold focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none mb-4" placeholder="0.00">
                
                <button onclick="window.submitOffer()" class="w-full bg-brand-teal text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all">Send Offer</button>
            </div>
        </div>
    </div>
    
    <!-- CONFIRMATION MODAL -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up p-6 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
            </div>
            <h3 id="confirm-title" class="text-xl font-bold text-app-text mb-2">Are you sure?</h3>
            <p id="confirm-desc" class="text-app-textMuted text-sm mb-6">This action cannot be undone.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="window.closeConfirmModal()" class="px-6 py-2.5 rounded-xl border border-app-border font-bold text-app-text hover:bg-app-hover transition-colors">Cancel</button>
                <button id="confirm-yes-btn" class="px-6 py-2.5 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition-colors shadow-lg shadow-red-500/20">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- CHECKOUT MODAL -->
    <div id="checkout-modal" class="hidden fixed inset-0 z-[160] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-app-border bg-app-card flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-app-text">Secure Checkout</h3>
                <button onclick="window.closeCheckoutModal()" class="text-app-textMuted hover:text-app-text"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto no-scrollbar">
                <!-- Order Summary -->
                <div id="checkout-items-summary" class="space-y-3 mb-6">
                    <!-- Injected via JS -->
                </div>

                <!-- Shipping Info -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-sm font-bold text-app-text uppercase tracking-wider">Shipping Address</h4>
                        <button onclick="window.navigateTo('settings'); window.closeCheckoutModal();" class="text-xs text-brand-teal font-bold hover:underline">Edit</button>
                    </div>
                    <div id="checkout-address-preview" class="p-3 bg-app-card border border-app-border rounded-xl text-sm text-app-textMuted">
                        Loading address...
                    </div>
                </div>

                <!-- Totals -->
                <div class="border-t border-app-border pt-4 space-y-2 text-sm mb-6">
                    <div class="flex justify-between text-app-textMuted"><span>Subtotal</span><span id="checkout-subtotal">$0.00</span></div>
                    <div class="flex justify-between text-app-textMuted"><span>Shipping</span><span id="checkout-shipping">Free</span></div>
                    <div class="flex justify-between text-app-text font-bold text-lg pt-2 border-t border-app-border mt-2"><span>Total</span><span id="checkout-total">$0.00</span></div>
                </div>

                <!-- PayPal Container -->
                <div id="paypal-button-container" class="w-full min-h-[50px]"></div>
                
                <p class="text-[10px] text-center text-app-textMuted mt-4">
                    Payments processed securely by PayPal. "Checkout All" creates separate orders for each seller.
                </p>
            </div>
        </div>
    </div>

    <!-- SHIPPING LABEL MODAL -->
    <div id="shipping-label-modal" class="hidden fixed inset-0 z-[190] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-white w-full max-w-md rounded-lg shadow-2xl overflow-hidden animate-slide-up text-black">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="printer" class="w-5 h-5"></i> Print Label</h3>
                <button onclick="document.getElementById('shipping-label-modal').classList.add('hidden')" class="text-gray-500 hover:text-black"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div id="label-content" class="p-6 bg-white">
                <div class="border-2 border-black p-4 rounded-sm">
                    <!-- Header -->
                    <div class="flex justify-between items-start border-b-2 border-black pb-4 mb-4">
                        <div class="text-3xl font-black tracking-tighter">JACE.</div>
                        <div class="text-right">
                            <div class="w-16 h-16 bg-black text-white font-bold flex items-center justify-center text-xl mb-1">P</div>
                            <span class="text-xs font-bold">PRIORITY MAIL</span>
                        </div>
                    </div>
                    
                    <!-- Addresses -->
                    <div class="space-y-6 mb-6">
                        <div class="text-xs uppercase">
                            <span class="text-[10px] text-gray-500 block mb-0.5">FROM:</span>
                            <p class="font-bold" id="label-seller-name">Seller Name</p>
                            <p id="label-seller-address">123 Seller St, City, ST 12345</p>
                        </div>
                        
                        <div class="text-sm uppercase pl-8">
                            <span class="text-[10px] text-gray-500 block mb-0.5">SHIP TO:</span>
                            <p class="text-lg font-bold" id="label-buyer-name">Buyer Name</p>
                            <p id="label-buyer-address">456 Buyer Ave, City, ST 67890</p>
                            <p id="label-buyer-country" class="font-bold">UNITED STATES</p>
                        </div>
                    </div>
                    
                    <!-- Barcode Simulation -->
                    <div class="border-t-2 border-black pt-4 text-center">
                        <div class="h-12 bg-black w-[80%] mx-auto mb-1"></div>
                        <p class="text-xs font-mono tracking-widest" id="label-tracking">9405 5096 9993 9982 8841 02</p>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3">
                <button onclick="document.getElementById('shipping-label-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-bold text-gray-600 hover:bg-gray-200 rounded-lg">Close</button>
                <button onclick="window.print()" class="px-6 py-2 text-sm font-bold bg-black text-white rounded-lg hover:opacity-80 flex items-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i> Print</button>
            </div>
        </div>
    </div>

    <!-- ORDER DETAILS MODAL -->
    <div id="order-details-modal" class="hidden fixed inset-0 z-[180] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="p-4 border-b border-app-border bg-app-card flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-app-text">Order Details</h3>
                <button onclick="document.getElementById('order-details-modal').classList.add('hidden')" class="p-1 hover:bg-app-hover rounded-full text-app-textMuted transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Content Area (This is what was null) -->
            <div id="order-details-content" class="p-6 overflow-y-auto no-scrollbar bg-app-bg">
                <!-- Content injected via JS -->
            </div>

            <!-- Footer Actions -->
            <div id="order-details-footer" class="p-4 border-t border-app-border bg-app-card flex gap-3 shrink-0">
                <!-- Actions injected via JS -->
            </div>
        </div>
    </div>

        <!-- USER REVIEWS MODAL -->
    <div id="user-reviews-modal" class="hidden fixed inset-0 z-[160] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-app-border bg-app-card flex justify-between items-center shrink-0">
                <h3 class="font-bold text-lg text-app-text">User Reviews</h3>
                <button onclick="document.getElementById('user-reviews-modal').classList.add('hidden')" class="p-1 hover:bg-app-hover rounded-full text-app-textMuted">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="user-reviews-modal-list" class="p-6 overflow-y-auto no-scrollbar bg-app-bg space-y-4">
                <!-- Reviews injected here -->
            </div>
        </div>
    </div>

    <!-- COMMENTS PANEL -->
    <aside id="comments-panel" class="fixed z-[90] bg-white dark:bg-zinc-900 shadow-2xl transition-transform duration-300 flex flex-col border-app-border inset-x-0 bottom-0 h-[60vh] rounded-t-2xl border-t translate-y-full md:inset-y-0 md:right-0 md:left-auto md:bottom-auto md:h-full md:w-[450px] md:rounded-none md:border-l md:border-t-0 md:translate-y-0 md:translate-x-full">
        
        <!-- Mobile Drag Handle -->
        <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-700 rounded-full mx-auto mt-3 mb-1 md:hidden shrink-0"></div>

        <!-- Header -->
        <div class="p-4 border-b border-app-border flex items-center justify-between bg-app-card rounded-t-2xl md:rounded-none">
            <h3 class="font-bold text-lg text-app-text flex items-center gap-2">
                <i data-lucide="message-circle" class="w-5 h-5 text-brand-orange"></i>
                <span id="comment-count-header">Comments</span>
            </h3>
            <button onclick="window.closeComments()" class="p-2 hover:bg-app-hover rounded-full text-app-textMuted transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Comments List -->
        <div id="comments-list" class="flex-1 overflow-y-auto p-5 pb-20 no-scrollbar">
            <!-- Populated via JS -->
            <div class="text-center text-app-textMuted py-10">Loading...</div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-app-border bg-app-card">
            <div id="reply-indicator" class="hidden flex justify-between items-center bg-brand-orange/10 border border-brand-orange/20 rounded-lg p-2 mb-2 animate-fade-in">
                <div class="flex items-center gap-2 text-xs text-brand-orange font-bold">
                    <i data-lucide="corner-down-right" class="w-3 h-3"></i>
                    <span>Replying to <span id="reply-username">@user</span></span>
                </div>
                <button onclick="window.cancelReply()" class="text-brand-orange hover:text-brand-orangeDark">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            </div>
            
            <div id="comment-input-area" class="flex gap-3 items-end relative">
                <div class="flex-1 relative">
                    <!-- Mention Suggestions Popup -->
                    <div id="mention-suggestions" class="hidden absolute bottom-full left-0 w-full mb-2 bg-app-card border border-app-border rounded-xl shadow-xl overflow-hidden max-h-48 overflow-y-auto z-50 animate-fade-in"></div>
                    
                    <!-- Updated Textarea with oninput event -->
                    <textarea id="comment-text" oninput="window.handleCommentInput(this)" rows="1" class="w-full bg-app-input border border-app-border rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-brand-teal/20 focus:border-brand-teal outline-none resize-none no-scrollbar text-app-text" placeholder="Add a comment..."></textarea>
                </div>
                <button onclick="window.handleSendComment()" class="bg-brand-teal text-white p-3 rounded-xl hover:bg-brand-teal/90 transition-all shadow-lg shadow-brand-teal/20">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="comment-auth-message" class="hidden text-center text-sm text-app-textMuted py-2">
                <button onclick="window.toggleAuthModal(true)" class="text-brand-orange font-bold hover:underline">Log in</button> to comment.
            </div>
        </div>
    </aside>

    <!-- LEFT SIDEBAR (Fixed, Desktop Only) -->
    <aside id="app-sidebar" class="fixed inset-y-0 left-0 z-[100] w-[260px] h-full flex-shrink-0 border-r border-app-border bg-app-sidebar flex flex-col p-6 shadow-2xl transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 md:shadow-[4px_0_24px_rgba(0,0,0,0.02)]">

        <!-- Logo -->
        <div class="mb-8 cursor-pointer flex items-center gap-2" onclick="navigateTo('feed')">
            <img src="Jace_LOGO.png" alt="JACE." class="h-16 w-auto object-contain block" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
            <h1 class="text-3xl font-extrabold text-app-text tracking-tight hidden">JACE.<span class="text-brand-orange">.</span></h1>
        </div>

        <!-- User Profile Display (Hidden by default) -->
        <div id="user-display" class="hidden mb-6 animate-fade-in">
            <!-- Populated by JS -->
        </div>

        <!-- Primary CTA: Upload Button (Hidden by default, shown via Auth) -->
        <button id="upload-btn" onclick="navigateTo('upload')" class="hidden w-full bg-brand-orange text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-brand-orange/20 hover:scale-[1.02] hover:bg-brand-orangeDark transition-all duration-200 items-center justify-center gap-2 mb-4 group">
            <i data-lucide="plus-circle" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300"></i>
            <span class="tracking-wide">Create Content</span>
        </button>

        <!-- New CTA: Create Product (Hidden by default, shown via Auth) -->
        <button id="create-product-btn" onclick="navigateTo('create-product')" class="hidden w-full bg-red-500 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-red-500/20 hover:scale-[1.02] hover:bg-red-600 transition-all duration-200 items-center justify-center gap-2 mb-4 group">
            <i data-lucide="shopping-bag" class="w-5 h-5"></i>
            <span class="tracking-wide">Create Product</span>
        </button>

        <!-- Secondary CTA: Login Button -->
        <button id="auth-btn" class="w-full bg-red-500 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-red-500/20 hover:scale-[1.02] hover:bg-red-600 transition-all duration-200 flex items-center justify-center gap-2 mb-8">
            <i data-lucide="log-in" class="w-5 h-5"></i>
            <span class="tracking-wide">Login</span>
        </button>

        <!-- Navigation -->
        <nav class="flex flex-col gap-2">
            <button onclick="navigateTo('feed')" id="nav-feed" class="flex items-center gap-4 text-app-text text-lg font-bold px-4 py-3 rounded-xl bg-app-hover transition-colors border border-app-border/50">
                <i data-lucide="home" class="w-6 h-6"></i>
                For You
            </button>
            <!-- NEW: Store Button -->
            <button onclick="navigateTo('store')" id="nav-store" class="flex items-center gap-4 text-app-textMuted text-lg font-medium px-4 py-3 rounded-xl hover:bg-app-hover hover:text-app-text transition-all">
                <i data-lucide="shopping-basket" class="w-6 h-6"></i>
                Store
            </button>
            <button onclick="navigateTo('explore')" id="nav-explore" class="flex items-center gap-4 text-app-textMuted text-lg font-medium px-4 py-3 rounded-xl hover:bg-app-hover hover:text-app-text transition-all">
                <i data-lucide="compass" class="w-6 h-6"></i>
                Explore
            </button>
            <!-- Profile Button (Hidden by default) -->
            <button onclick="window.viewMyProfile()" id="nav-profile" class="hidden flex items-center gap-4 text-app-textMuted text-lg font-medium px-4 py-3 rounded-xl hover:bg-app-hover hover:text-app-text transition-all">
                <i data-lucide="user" class="w-6 h-6"></i>
                Profile
            </button>
            <!-- Inbox Button (Hidden by default) -->
            <button onclick="navigateTo('inbox')" id="nav-inbox" class="hidden flex items-center gap-4 text-app-textMuted text-lg font-medium px-4 py-3 rounded-xl hover:bg-app-hover hover:text-app-text transition-all justify-between">
                <div class="flex items-center gap-4">
                    <i data-lucide="inbox" class="w-6 h-6"></i>
                    Inbox
                </div>
                <div id="sidebar-unread-count" class="hidden w-2 h-2 rounded-full bg-brand-orange"></div>
            </button>
             <!-- Settings Button (ALWAYS VISIBLE NOW) -->
            <button onclick="navigateTo('settings')" id="nav-settings" class="flex items-center gap-4 text-app-textMuted text-lg font-medium px-4 py-3 rounded-xl hover:bg-app-hover hover:text-app-text transition-all">
                <i data-lucide="settings" class="w-6 h-6"></i>
                Settings
            </button>
            <!-- Admin Button (Hidden by default) -->
            <button onclick="navigateTo('admin')" id="nav-admin" class="hidden flex items-center gap-4 text-red-500 text-lg font-bold px-4 py-3 rounded-xl hover:bg-red-50 transition-all border border-transparent hover:border-red-200">
                <i data-lucide="shield-alert" class="w-6 h-6"></i>
                Admin Panel
            </button>
        </nav>

        <div class="mt-auto border-t border-app-border pt-6">
            <p class="text-xs text-app-textMuted font-medium">Â© 2026 JACE. Inc.</p>
               <div class="flex gap-4 mt-4">
                <a href="#" class="text-xs text-app-textMuted hover:text-brand-orange">Privacy</a>
                <a href="#" class="text-xs text-app-textMuted hover:text-brand-orange">Terms</a>
                <a href="#" onclick="window.navigateTo('support'); return false;" class="text-xs text-app-textMuted hover:text-brand-orange">Support</a>
            </div>
        </div>
    </aside>

   <!-- MOBILE BOTTOM NAVIGATION -->
    <nav id="mobile-bottom-nav"class="md:hidden fixed bottom-0 left-0 w-full bg-app-bg border-t border-app-border z-[80] flex justify-around items-center pb-[env(safe-area-inset-bottom)] pt-2 h-[calc(60px+env(safe-area-inset-bottom))] shadow-[0_-4px_20px_rgba(0,0,0,0.05)] transition-transform duration-300 translate-y-0">

       <!-- Home -->
       <button onclick="window.navigateTo('feed')" id="mobile-nav-feed" class="flex flex-col items-center gap-1 p-2 w-16 text-brand-orange transition-colors">
           <i data-lucide="home" class="w-6 h-6"></i>
           <span class="text-[10px] font-bold">Home</span>
       </button>
       
       <!-- Store -->
       <button onclick="window.navigateTo('store')" id="mobile-nav-store" class="flex flex-col items-center gap-1 p-2 w-16 text-app-textMuted hover:text-app-text transition-colors">
           <i data-lucide="shopping-bag" class="w-6 h-6"></i>
           <span class="text-[10px] font-medium">Store</span>
       </button>
       
       <!-- Upload (Center) -->
       <button onclick="if(window.auth && window.auth.currentUser){document.getElementById('create-options-modal').classList.remove('hidden')}else{window.toggleAuthModal(true)}" id="mobile-nav-upload" class="flex flex-col items-center justify-center -mt-8 relative group">
           <div class="bg-app-text text-app-bg rounded-2xl p-3.5 shadow-xl border-[4px] border-app-bg transform group-active:scale-95 transition-transform">
               <i data-lucide="plus" class="w-7 h-7"></i>
           </div>
       </button>
       
       <!-- Inbox -->
       <button onclick="if(window.auth && window.auth.currentUser){window.navigateTo('inbox')}else{window.toggleAuthModal(true)}" id="mobile-nav-inbox" class="flex flex-col items-center gap-1 p-2 w-16 text-app-textMuted hover:text-app-text transition-colors relative">
           <div class="relative">
               <i data-lucide="message-circle" class="w-6 h-6"></i>
               <span id="mobile-inbox-badge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-brand-orange rounded-full border-2 border-app-bg"></span>
           </div>
           <span class="text-[10px] font-medium">Inbox</span>
       </button>
       
       <!-- Profile -->
       <button onclick="window.viewMyProfile()" id="mobile-nav-profile" class="flex flex-col items-center gap-1 p-2 w-16 text-app-textMuted hover:text-app-text transition-colors">
           <i data-lucide="user" class="w-6 h-6"></i>
           <span class="text-[10px] font-medium">Profile</span>
       </button>
   </nav>

    <!-- CREATE OPTIONS MODAL (Mobile) -->
   <div id="create-options-modal" class="hidden fixed inset-0 z-[150] flex items-end md:items-center justify-center modal-backdrop p-4">
       <div class="bg-app-bg w-full max-w-sm rounded-t-2xl md:rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
           <div class="p-6">
               <div class="flex justify-between items-center mb-6">
                   <h3 class="font-bold text-xl text-app-text">Create</h3>
                   <button onclick="document.getElementById('create-options-modal').classList.add('hidden')" class="p-2 hover:bg-app-hover rounded-full text-app-textMuted">
                       <i data-lucide="x" class="w-6 h-6"></i>
                   </button>
               </div>
               
               <div class="grid grid-cols-2 gap-4">
                   <button onclick="document.getElementById('create-options-modal').classList.add('hidden'); window.navigateTo('upload');" class="flex flex-col items-center gap-3 p-6 bg-app-card border border-app-border rounded-2xl hover:border-brand-teal transition-all group">
                       <div class="w-14 h-14 rounded-full bg-brand-teal/10 text-brand-teal flex items-center justify-center group-hover:bg-brand-teal group-hover:text-white transition-colors">
                           <i data-lucide="video" class="w-7 h-7"></i>
                       </div>
                       <span class="font-bold text-app-text text-sm">Create Content</span>
                   </button>

                   <button onclick="document.getElementById('create-options-modal').classList.add('hidden'); window.navigateTo('create-product');" class="flex flex-col items-center gap-3 p-6 bg-app-card border border-app-border rounded-2xl hover:border-red-500 transition-all group">
                       <div class="w-14 h-14 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition-colors">
                           <i data-lucide="shopping-bag" class="w-7 h-7"></i>
                       </div>
                       <span class="font-bold text-app-text text-sm">List Product</span>
                   </button>
               </div>
           </div>
           <div class="bg-app-card p-4 text-center border-t border-app-border">
               <button onclick="document.getElementById('create-options-modal').classList.add('hidden')" class="text-app-textMuted font-bold text-sm">Cancel</button>
           </div>
       </div>
   </div>

    <!-- MAIN AREA -->
    <main id="main-content" class="flex-1 h-full relative bg-app-bg overflow-hidden transition-all duration-300">
        
        <!-- VIEW 1: FEED (Default) -->
        <div id="feed-container" class="h-full w-full overflow-y-scroll no-scrollbar snap-y-mandatory scroll-smooth">
            <!-- Videos will be injected here by JS -->
        </div>

    <!-- VIEW: ANALYTICS -->
        <div id="analytics-container" class="hidden h-full w-full overflow-y-auto no-scrollbar pt-4 px-4 md:pt-10 md:px-6 pb-20">
            <div class="max-w-5xl mx-auto w-full animate-slide-up">
                <button onclick="window.navigateTo('settings')" class="mb-6 flex items-center gap-2 text-app-textMuted hover:text-app-text font-bold transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to Wallet
                </button>
                
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
                    <div>
                        <h2 class="text-3xl font-extrabold text-app-text mb-1">Creator Analytics</h2>
                        <p class="text-sm text-app-textMuted">Performance overview for the last 30 days.</p>
                    </div>
                    <div class="flex bg-app-card border border-app-border rounded-lg p-1">
                        <button class="px-3 py-1 text-xs font-bold bg-app-text text-app-bg rounded shadow-sm">30 Days</button>
                        <button class="px-3 py-1 text-xs font-bold text-app-textMuted hover:text-app-text transition-colors">90 Days</button>
                        <button class="px-3 py-1 text-xs font-bold text-app-textMuted hover:text-app-text transition-colors">All Time</button>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-app-card border border-app-border rounded-xl p-5 shadow-sm">
                        <p class="text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2 flex items-center gap-2"><i data-lucide="dollar-sign" class="w-3 h-3"></i> Revenue</p>
                        <h3 id="analytics-revenue" class="text-2xl font-black text-app-text">--</h3>
                        <p class="text-[10px] text-green-500 font-bold mt-1">+12% vs last mo</p>
                    </div>
                    <div class="bg-app-card border border-app-border rounded-xl p-5 shadow-sm">
                        <p class="text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2 flex items-center gap-2"><i data-lucide="shopping-bag" class="w-3 h-3"></i> Orders</p>
                        <h3 id="analytics-orders" class="text-2xl font-black text-app-text">--</h3>
                        <p class="text-[10px] text-app-textMuted font-bold mt-1">Total Sales</p>
                    </div>
                    <div class="bg-app-card border border-app-border rounded-xl p-5 shadow-sm">
                        <p class="text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2 flex items-center gap-2"><i data-lucide="eye" class="w-3 h-3"></i> Content Views</p>
                        <h3 id="analytics-views" class="text-2xl font-black text-app-text">--</h3>
                        <p class="text-[10px] text-green-500 font-bold mt-1">Across all content</p>
                    </div>
                    <div class="bg-app-card border border-app-border rounded-xl p-5 shadow-sm">
                        <p class="text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2 flex items-center gap-2"><i data-lucide="users" class="w-3 h-3"></i> Followers</p>
                        <h3 id="analytics-followers" class="text-2xl font-black text-app-text">--</h3>
                        <p class="text-[10px] text-app-textMuted font-bold mt-1">Audience Size</p>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Main Chart -->
                    <div class="lg:col-span-2 bg-app-card border border-app-border rounded-2xl p-6 flex flex-col h-[400px]">
                        <div class="flex justify-between items-center mb-6 shrink-0">
                            <h3 class="font-bold text-app-text">Revenue Trend</h3>
                            <div class="flex bg-app-bg border border-app-border rounded-lg p-0.5">
                                <button onclick="window.switchChartType('bar')" id="chart-btn-bar" class="px-3 py-1 text-xs font-bold bg-app-text text-app-bg rounded shadow-sm transition-all">Bar</button>
                                <button onclick="window.switchChartType('line')" id="chart-btn-line" class="px-3 py-1 text-xs font-bold text-app-textMuted hover:text-app-text transition-all">Line</button>
                            </div>
                        </div>
                        
                        <!-- THIS CONTAINER WAS MISSING -->
                        <div id="analytics-chart-container" class="flex-1 w-full flex items-end justify-between px-2 gap-[1px] min-h-0">
                            <!-- Graph will be injected here by JS -->
                            <div class="w-full h-full flex items-center justify-center text-app-textMuted">
                                <i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i>
                            </div>
                        </div>

                        <div class="flex justify-between text-xs text-app-textMuted mt-4 pt-2 border-t border-app-border/50 font-mono shrink-0">
                            <span>30 Days Ago</span>
                            <span>Today</span>
                        </div>
                    </div>

                    <!-- Top Products -->
                    <div class="bg-app-card border border-app-border rounded-2xl p-6 flex flex-col">
                        <h3 class="font-bold text-app-text mb-4">Top Products</h3>
                        <div id="analytics-top-products" class="flex-1 space-y-4 overflow-y-auto max-h-[300px] no-scrollbar">
                            <!-- Items injected via JS -->
                            <div class="text-center text-xs text-app-textMuted py-10">Loading data...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: SHOPPING CART PAGE -->
        <div id="cart-container" class="hidden h-full w-full overflow-y-auto no-scrollbar pt-10 px-6 pb-20">
            <div class="max-w-4xl mx-auto w-full animate-slide-up">
                <button onclick="window.navigateTo('store')" class="mb-6 flex items-center gap-2 text-app-textMuted hover:text-app-text font-bold transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to Store
                </button>
                
                <h2 class="text-3xl font-extrabold text-app-text mb-8 flex items-center gap-3">
                    <i data-lucide="shopping-cart" class="w-8 h-8 text-brand-orange"></i> Your Cart
                </h2>

                <div id="cart-list" class="space-y-4 mb-8">
                    <!-- Cart items injected here -->
                </div>

                <div id="cart-actions" class="hidden bg-app-card border border-app-border rounded-2xl p-8 shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <span class="text-app-textMuted font-bold uppercase tracking-widest text-xs">Estimated Total</span>
                            <p id="cart-total-display" class="text-4xl font-black text-app-text tracking-tight">$0.00</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-app-textMuted mb-1">Shipping and taxes calculated at checkout</p>
                            <span class="text-xs bg-brand-teal/10 text-brand-teal px-2 py-1 rounded font-bold">Secure Checkout</span>
                        </div>
                    </div>
                    <button onclick="window.initiateCheckoutAll()" class="w-full bg-brand-teal text-white font-bold py-5 rounded-2xl shadow-xl shadow-brand-teal/20 hover:scale-[1.01] hover:bg-brand-teal/90 transition-all flex items-center justify-center gap-3 text-lg">
                        Proceed to Checkout <i data-lucide="arrow-right" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- NEW VIEW: CART -->
        <div id="checkout-container" class="hidden h-full w-full overflow-y-auto no-scrollbar pt-10 px-6 pb-20">
            <div class="max-w-4xl mx-auto w-full animate-slide-up">
                <button onclick="window.navigateTo('cart')" class="mb-6 flex items-center gap-2 text-app-textMuted hover:text-app-text font-bold transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to Cart
                </button>
                
                <h2 class="text-3xl font-extrabold text-app-text mb-8">Checkout</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Details -->
                    <div class="lg:col-span-2 space-y-6">
                        
                        <!-- Shipping Address -->
                        <div class="bg-app-card border border-app-border rounded-2xl p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg text-app-text flex items-center gap-2">
                                    <i data-lucide="map-pin" class="w-5 h-5 text-brand-orange"></i> Shipping Address
                                </h3>
                                <button onclick="window.navigateTo('settings')" class="text-sm text-brand-teal font-bold hover:underline">Edit</button>
                            </div>
                            <div id="checkout-page-address" class="text-app-textMuted text-sm leading-relaxed">
                                Loading address...
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="bg-app-card border border-app-border rounded-2xl p-6">
                            <h3 class="font-bold text-lg text-app-text mb-4 flex items-center gap-2">
                                <i data-lucide="credit-card" class="w-5 h-5 text-brand-orange"></i> Payment Method
                            </h3>
                            
                            <div class="flex gap-4 mb-6">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="payment_method" value="stripe" class="peer sr-only" checked onchange="window.togglePaymentMethod('stripe')">
                                    <div class="h-full p-4 rounded-xl border-2 border-app-border peer-checked:border-[#635bff] peer-checked:bg-[#635bff]/5 hover:bg-app-hover transition-all flex flex-col items-center justify-center gap-2">
                                        <!-- Stripe Logo -->
                                        <svg class="h-6 w-auto" viewBox="0 0 40 17" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M39.06 8.3c-2.3 0-3.9 1.6-3.9 4.2 0 2.6 1.5 4.2 3.9 4.2 2.1 0 3.7-1.2 3.8-3.3h-3.4c-.1.6-.6.9-1.2.9-.6 0-1.1-.3-1.1-1.3h5.8c.1-2.9-1.3-4.7-3.9-4.7zm-1.1 2.3c0-.6.5-1 1.1-1 .6 0 1.1.4 1.1 1h-2.2zM30 8.3c-2.2 0-4 1.5-4 4.2s1.7 4.2 4 4.2c1.3 0 2.3-.4 2.9-1.1v3.2h3.2V8.6h-2.9v1.1c-.6-.8-1.7-1.4-3.2-1.4zm.3 6.1c-1.3 0-2.2-.9-2.2-2s.9-1.9 2.2-1.9 2.2.9 2.2 1.9-.9 2-2.2 2zM21.5 8.6h-3.2v8h3.2v-8zM21.5 4.3h-3.2v2.5h3.2V4.3zM16.5 8.6h-2.9v1c-.5-.8-1.5-1.3-2.8-1.3-2.3 0-4 1.7-4 4.2s1.7 4.2 4 4.2c1.3 0 2.3-.5 2.8-1.3v1.1h2.9v-8zM12.6 14.4c-1.3 0-2.2-.9-2.2-2s.9-1.9 2.2-1.9 2.2.9 2.2 1.9-.8 2-2.2 2zM5.3 12.3c0 1.2-1.2 1.9-2.7 1.9-1.3 0-2.3-.5-2.6-1.3l2.8-.5c.1.2.4.4.8.4.3 0 .6-.2.6-.5 0-.8-3.2-.9-3.2-3.1 0-1.2 1.1-2 2.5-2 1.2 0 2.1.4 2.4 1.1L3.2 8.8c-.1-.1-.3-.3-.7-.3-.3 0-.5.1-.5.4 0 .7 3.2.7 3.2 3.1z" fill="#635bff"/></svg>
                                        <span class="text-sm font-bold text-app-text">Card / Apple Pay</span>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="payment_method" value="paypal" class="peer sr-only" onchange="window.togglePaymentMethod('paypal')">
                                    <div class="h-full p-4 rounded-xl border-2 border-app-border peer-checked:border-[#009cde] peer-checked:bg-[#009cde]/5 hover:bg-app-hover transition-all flex flex-col items-center justify-center gap-2">
                                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.01 4.287-.023.143-.047.288-.077.437-.946 5.438-3.158 7.12-6.525 7.12h-.769c-.306 0-.553.25-.609.558l-.913 6.15c-.03.175-.181.305-.35.305h-.006c-.233 0-.41-.212-.375-.439l.044-.24.775-4.962c.059-.38.375-.664.761-.664h.203c2.493 0 4.14-1.218 4.823-5.267.021-.109.04-.216.057-.323.21-1.35.01-2.22-.695-3.023-.787-.896-2.225-1.28-4.04-1.28H6.666c-.368 0-.683.27-.74.636l-3.21 20.352c-.06.38.232.738.618.738h.001l3.742-.001c.21 0 .37-.197.34-.404l-.341-2.383z" fill="#003087"/><path d="M20.945 6.107c-.012.073-.024.147-.038.222-.21 1.35-.01 2.22-.695 3.023-.787-.896-2.225-1.28-4.04-1.28H6.666c-.368 0-.683.27-.74.636l-.61 3.864h.793c2.493 0 4.14-1.218 4.823-5.267.31-1.87.017-3.136-.995-4.287C9.837 1.81 7.828 1.267 5.258 1.267H4.42c-.41 0-.756.326-.82.733L1.516 14.61a.64.64 0 0 0 .633.74h4.605l.341 2.383c.03.207-.13.404-.34.404l-3.742.001c-.386 0-.678-.358-.618-.738L5.606.901A.64.64 0 0 1 6.24.161h7.46c2.57 0 4.578.543 5.69 1.81 1.012 1.149 1.305 2.419 1.013 4.286l-.458-.15z" fill="#009cde"/></svg>
                                        <span class="text-sm font-bold text-app-text">PayPal</span>
                                    </div>
                                </label>
                            </div>

                            <!-- STRIPE FORM (New) -->
                            <div id="payment-form-stripe" class="space-y-4 animate-fade-in text-center">
                                <div class="bg-app-bg border border-app-border rounded-xl p-4 mb-4">
                                    <p class="text-sm text-app-textMuted mb-2">You will be redirected to Stripe to complete your purchase securely.</p>
                                    <div class="flex items-center justify-center gap-2 opacity-50">
                                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                                        <span class="text-xs font-bold">SSL Encrypted Payment</span>
                                    </div>
                                </div>
                                
                                <button onclick="window.processStripePayment()" id="btn-pay-stripe" class="w-full bg-[#635bff] text-white font-bold py-4 rounded-xl shadow-lg shadow-[#635bff]/20 hover:bg-[#544dff] transition-all flex items-center justify-center gap-2">
                                    <span>Pay with Stripe</span>
                                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                                </button>
                            </div>

                            <!-- PayPal Container -->
                            <div id="payment-form-paypal" class="hidden animate-fade-in">
                                <div id="paypal-page-container" class="w-full min-h-[50px]"></div>
                                <p class="text-[10px] text-center text-app-textMuted mt-4">Secured by PayPal</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Summary -->
                    <div class="space-y-6">
                        <div class="bg-app-card border border-app-border rounded-2xl p-6 sticky top-6">
                            <h3 class="font-bold text-lg text-app-text mb-4">Order Summary</h3>
                            
                            <div id="checkout-page-items" class="space-y-4 mb-6 max-h-[300px] overflow-y-auto no-scrollbar">
                                <!-- Items injected here -->
                            </div>

                            <div class="border-t border-app-border pt-4 space-y-2 text-sm">
                                <div class="flex justify-between text-app-textMuted"><span>Subtotal</span><span id="checkout-page-subtotal">$0.00</span></div>
                                <div class="flex justify-between text-app-textMuted"><span>Shipping</span><span id="checkout-page-shipping">Free</span></div>
                                <div class="flex justify-between text-app-textMuted"><span>Tax (Est.)</span><span>$0.00</span></div>
                                <div class="flex justify-between text-app-text font-bold text-xl pt-4 border-t border-app-border mt-2"><span>Total</span><span id="checkout-page-total">$0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW VIEW: STORE (Grid Feed & Details) -->
        <div id="store-container" class="hidden h-full w-full overflow-y-auto no-scrollbar pt-0 px-6 pb-20">
             <!-- VIEW A: FEED/GRID -->
            <div id="store-feed-view" class="max-w-7xl mx-auto w-full animate-slide-up">
                <div class="sticky top-0 z-30 pt-6 pb-2 bg-app-bg/95 backdrop-blur-sm border-b border-app-border mb-6 -mx-6 px-6 transition-all duration-300">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
                                <div class="flex items-center justify-between w-full md:w-auto">
                                    <div>
                                        <h2 class="text-3xl font-extrabold text-app-text mb-1">Store</h2>
                                        <p class="text-sm text-app-textMuted">Discover products.</p>
                                    </div>
                                    <!-- Mobile Sell Button -->
                                    <button onclick="if(window.auth && window.auth.currentUser){window.navigateTo('create-product')}else{window.toggleAuthModal(true)}" class="md:hidden flex items-center gap-1 bg-red-500 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg shadow-red-500/20">
                                        <i data-lucide="plus" class="w-4 h-4"></i> Sell
                                    </button>
                                </div>
                                <div class="flex gap-2 w-full md:w-auto">
                                    <!-- Search & Filter -->
                                    <div class="relative w-full md:w-80 group">
                                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-app-textMuted group-focus-within:text-brand-teal transition-colors"></i>
                                        <input type="text" id="store-search" oninput="window.runStoreFilters()" placeholder="Search products..." class="w-full pl-10 pr-4 py-2.5 rounded-xl bg-app-card border border-app-border text-app-text focus:ring-2 focus:ring-brand-teal/20 focus:border-brand-teal outline-none transition-all text-sm">
                                    </div>
                                    <button onclick="window.openStoreFilterModal()" class="px-3 py-2.5 rounded-xl border border-app-border bg-app-card hover:bg-app-hover text-app-text transition-colors flex items-center gap-2 shrink-0">
                                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                                    </button>
                                </div>
                        </div>
                        
                        <!-- Category Scroll Row (Mobile Optimized Slidebar) -->
                        <div class="flex items-center gap-3 overflow-x-auto no-scrollbar -mx-6 px-6 md:mx-0 md:px-0 pb-2">
                            <button onclick="window.setStoreCategory('All')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-text text-app-bg shadow-sm" data-cat="All">All</button>
                            <button onclick="window.setStoreCategory('Clothing')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Clothing">Clothing</button>
                            <button onclick="window.setStoreCategory('Shoes')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Shoes">Shoes</button>
                            <button onclick="window.setStoreCategory('Accessories')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Accessories">Accessories</button>
                            <button onclick="window.setStoreCategory('Tech')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Tech">Tech</button>
                            <button onclick="window.setStoreCategory('Home')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Home">Home</button>
                            <button onclick="window.setStoreCategory('Beauty')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Beauty">Beauty</button>
                            <button onclick="window.setStoreCategory('Art & Collectibles')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Art & Collectibles">Art & Collectibles</button>
                            <button onclick="window.setStoreCategory('Books & Media')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Books & Media">Books & Media</button>
                            <button onclick="window.setStoreCategory('Gaming')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Gaming">Gaming</button> 
                            <button onclick="window.setStoreCategory('Sports & Outdoors')" class="store-cat-btn shrink-0 px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors bg-app-card border border-app-border text-app-textMuted hover:text-app-text hover:bg-app-hover" data-cat="Sports & Outdoors">Sports & Outdoors</button>
                        </div>
                </div>
                
                <div id="store-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 pb-10">
                    <!-- Populated by JS -->
                    <div class="col-span-full text-center py-20 text-app-textMuted">
                        <i data-lucide="shopping-basket" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p>Loading products...</p>
                    </div>
                </div>
            </div>

            <!-- VIEW B: DETAIL -->
            <div id="store-detail-view" class="hidden max-w-7xl mx-auto w-full animate-fade-in pt-6 pb-20">
                <button onclick="window.backToStoreFeed()" class="mb-6 flex items-center gap-2 text-app-textMuted hover:text-app-text font-bold transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to Browse
                </button>
                <div id="store-detail-content"></div>
            </div>
        </div>

        <!-- VIEW 2: PROFILE (Hidden by default) -->
        <div id="profile-container" class="hidden h-full w-full overflow-y-auto no-scrollbar pt-4 px-4 pb-20 md:pt-10 md:px-6">

            <!-- Mobile Header: Title & Settings -->
            <div class="max-w-6xl mx-auto w-full mb-4 z-20 relative flex items-center justify-between md:justify-end gap-3">
                    <h2 class="text-xl font-extrabold text-app-text md:hidden">Profile</h2>
                    <div class="flex gap-2 w-full md:w-auto justify-end">
                        <div class="relative w-full max-w-xs group hidden md:block">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-app-textMuted group-focus-within:text-brand-teal transition-colors"></i>
                            <input type="text" id="profile-user-search" oninput="window.handleProfileUserSearch(this.value)" placeholder="Find people..." class="w-full pl-10 pr-4 py-3 rounded-full bg-app-card border border-app-border text-app-text text-sm focus:ring-2 focus:ring-brand-teal/20 focus:border-brand-teal outline-none transition-all shadow-sm">
                            <div id="profile-user-results" class="hidden absolute top-full right-0 left-0 mt-2 bg-app-card border border-app-border rounded-xl shadow-xl overflow-hidden max-h-64 overflow-y-auto z-50"></div>
                        </div>
                        <!-- Mobile Settings Button -->
                        <button onclick="window.navigateTo('settings')" class="md:hidden p-2 rounded-full bg-app-card border border-app-border text-app-text hover:bg-app-hover shadow-sm">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                        </button>
                    </div>
            </div>

            <div class="max-w-6xl mx-auto w-full">

                <!-- Profile Info Section (Compressed for Mobile) -->
                <div class="flex flex-col md:flex-row items-center md:items-start gap-4 md:gap-8 mb-6 md:mb-12 animate-slide-up">

                    <!-- Avatar (Smaller on mobile: w-24 h-24) -->
                    <div class="relative shrink-0 group">
                        <div class="w-24 h-24 md:w-40 md:h-40 rounded-full border-4 border-app-card shadow-xl p-0.5 bg-app-card overflow-hidden">
                            <img id="profile-image" src="https://via.placeholder.com/150" alt="Profile" class="w-full h-full rounded-full object-cover">
                        </div>
                        <div id="profile-camera-btn" onclick="triggerAvatarUpload()" class="absolute bottom-0 right-0 md:bottom-1 md:right-1 bg-brand-orange text-white p-1.5 md:p-2 rounded-full border-4 border-app-bg cursor-pointer shadow-sm hover:scale-110 transition-transform z-10">
                            <i data-lucide="camera" class="w-4 h-4 md:w-5 md:h-5"></i>
                        </div>
                    </div>

                    <!-- Details -->
                    <div class="flex flex-col items-center md:items-start flex-1 pt-0 md:pt-2 w-full">

                        <h1 id="profile-name" class="text-2xl md:text-4xl font-extrabold text-app-text mb-0 md:mb-1">@username</h1>
                       
                        <div id="profile-sales-display" class="hidden mt-1 mb-2 animate-fade-in"></div>

                        <!-- Rating Badge (Mobile Optimized) -->
                        <button id="profile-rating-badge" class="flex items-center gap-1 bg-app-card px-2 py-1 md:px-3 md:py-1.5 rounded-full border border-app-border hover:bg-app-hover transition-colors cursor-pointer group mb-3 md:mb-0 mt-1 md:mt-0">
                            <div class="flex text-brand-orange">
                                <i data-lucide="star" class="w-3 h-3 md:w-4 md:h-4 fill-current"></i>
                                <i data-lucide="star" class="w-3 h-3 md:w-4 md:h-4 fill-current"></i>
                                <i data-lucide="star" class="w-3 h-3 md:w-4 md:h-4 fill-current"></i>
                                <i data-lucide="star" class="w-3 h-3 md:w-4 md:h-4 fill-current"></i>
                                <i data-lucide="star" class="w-3 h-3 md:w-4 md:h-4 fill-current"></i>
                            </div>
                            <span class="text-[10px] md:text-xs font-bold text-app-textMuted ml-1">4.5</span>
                        </button>

                        <p id="profile-bio" class="text-xs md:text-sm text-app-textMuted mb-4 max-w-lg text-center md:text-left leading-relaxed px-4 md:px-0">
                            No bio yet.
                        </p>

                        <!-- Stats Row -->
                        <div class="flex flex-wrap items-center justify-center md:justify-start gap-6 md:gap-6 mb-4 md:mb-6 w-full md:w-auto border-t border-b border-app-border/50 py-3 md:py-0 md:border-0">
                            <div class="text-center md:text-left">
                                <span id="profile-stat-following" class="font-bold text-app-text text-base md:text-lg block md:inline">0</span>
                                <span class="text-[10px] md:text-sm text-app-textMuted uppercase tracking-wider md:normal-case">Following</span>
                            </div>
                            <div class="text-center md:text-left">
                                <span id="profile-stat-followers" class="font-bold text-app-text text-base md:text-lg block md:inline">0</span>
                                <span class="text-[10px] md:text-sm text-app-textMuted uppercase tracking-wider md:normal-case">Followers</span>
                            </div>
                            <div class="text-center md:text-left">
                                <span id="profile-stat-likes" class="font-bold text-app-text text-base md:text-lg block md:inline">0</span>
                                <span class="text-[10px] md:text-sm text-app-textMuted uppercase tracking-wider md:normal-case">Likes</span>
                            </div>
                        </div>

                        <!-- Action Buttons (Filled by JS) -->
                        <div id="profile-actions" class="flex items-center gap-2 md:gap-3 w-full justify-center md:justify-start"></div>
                    </div>
                </div>

                <!-- Profile Tabs (Compressed to fit single line) -->
                <div class="flex w-full border-b border-app-border mb-6 justify-between md:justify-start overflow-x-auto no-scrollbar">
                    <button onclick="switchTab('products')" id="tab-products" class="flex-1 md:flex-none px-2 md:px-8 pb-3 text-xs md:text-base font-bold tab-active flex items-center justify-center gap-1 md:gap-2 hover:bg-app-hover whitespace-nowrap">
                        <i data-lucide="shopping-bag" class="w-3 h-3 md:w-4 md:h-4"></i> Products
                    </button>
                    <button onclick="switchTab('videos')" id="tab-videos" class="flex-1 md:flex-none px-2 md:px-8 pb-3 text-xs md:text-base font-bold tab-inactive flex items-center justify-center gap-1 md:gap-2 hover:bg-app-hover whitespace-nowrap">
                        <i data-lucide="grid-3x3" class="w-3 h-3 md:w-4 md:h-4"></i> Content
                    </button>
                    <button onclick="switchTab('reposts')" id="tab-reposts" class="flex-1 md:flex-none px-2 md:px-8 pb-3 text-xs md:text-base font-bold tab-inactive flex items-center justify-center gap-1 md:gap-2 hover:bg-app-hover whitespace-nowrap">
                        <i data-lucide="repeat" class="w-3 h-3 md:w-4 md:h-4"></i> Reposts
                    </button>
                    <button onclick="switchTab('likes')" id="tab-likes" class="flex-1 md:flex-none px-2 md:px-8 pb-3 text-xs md:text-base font-bold tab-inactive flex items-center justify-center gap-1 md:gap-2 hover:bg-app-hover whitespace-nowrap">
                        <i data-lucide="heart" class="w-3 h-3 md:w-4 md:h-4"></i> Likes
                    </button>
                </div>

                <!-- Profile Content Areas (Unchanged) -->
                <div id="profile-content-products" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 w-full animate-fade-in text-center text-app-textMuted">
                    <div class="col-span-full flex flex-col items-center gap-2 py-20">
                        <div class="w-16 h-16 rounded-full bg-app-card flex items-center justify-center mb-2">
                            <i data-lucide="shopping-bag" class="w-8 h-8 text-app-textMuted/50"></i>
                        </div>
                        <p class="font-bold">No products listed</p>
                        <p class="text-sm">Start selling by creating your first product.</p>
                    </div>
                </div>

                <div id="profile-content-videos" class="hidden grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-4 w-full animate-fade-in"></div>

                <div id="profile-content-reposts" class="hidden grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 md:gap-4 w-full animate-fade-in text-center text-app-textMuted">
                    <div class="col-span-full flex flex-col items-center gap-2 py-20">
                        <div class="w-16 h-16 rounded-full bg-app-card flex items-center justify-center mb-2">
                            <i data-lucide="repeat" class="w-8 h-8 text-app-textMuted/50"></i>
                        </div>
                        <p class="font-bold">No reposts yet</p>
                    </div>
                </div>

                <div id="profile-content-likes" class="hidden text-center text-app-textMuted"></div>

            </div>
        </div>

        <!-- VIEW 6: INBOX -->
        <div id="inbox-container" class="hidden h-full w-full overflow-hidden flex flex-col md:flex-row bg-app-card animate-fade-in">
            
            <!-- MOBILE TOP NAVIGATION BAR -->
            <div class="md:hidden w-full bg-app-card border-b border-app-border shrink-0 z-20">
                <div class="px-4 pt-4 pb-2">
                    <h2 class="text-2xl font-extrabold text-app-text">Inbox</h2>
                </div>
                <!-- Horizontal Scrollable Tabs -->
                <div class="flex overflow-x-auto no-scrollbar px-4 gap-6">
                    <button onclick="switchInboxTab('notifications')" id="mobile-tab-inbox-notifications" class="mobile-inbox-tab pb-3 text-sm font-bold text-app-text border-b-[3px] border-brand-teal whitespace-nowrap transition-all relative shrink-0">
                        Notifications
                        <span id="mobile-badge-notifications" class="hidden absolute top-0 -right-2 w-2 h-2 bg-brand-orange rounded-full ring-2 ring-app-card"></span>
                    </button>
                    <button onclick="switchInboxTab('messages')" id="mobile-tab-inbox-messages" class="mobile-inbox-tab pb-3 text-sm font-medium text-app-textMuted border-b-[3px] border-transparent whitespace-nowrap transition-all relative shrink-0 hover:text-app-text">
                        Messages
                        <span id="mobile-badge-messages" class="hidden absolute top-0 -right-2 w-2 h-2 bg-brand-orange rounded-full ring-2 ring-app-card"></span>
                    </button>
                    <button onclick="switchInboxTab('orders')" id="mobile-tab-inbox-orders" class="mobile-inbox-tab pb-3 text-sm font-medium text-app-textMuted border-b-[3px] border-transparent whitespace-nowrap transition-all shrink-0 hover:text-app-text">
                        Your Orders
                    </button>
                    <button onclick="switchInboxTab('sold')" id="mobile-tab-inbox-sold" class="mobile-inbox-tab pb-3 text-sm font-medium text-app-textMuted border-b-[3px] border-transparent whitespace-nowrap transition-all relative shrink-0 hover:text-app-text">
                        Sold Orders
                        <span id="mobile-badge-sold" class="hidden absolute top-0 -right-2 w-2 h-2 bg-brand-orange rounded-full ring-2 ring-app-card"></span>
                    </button>
                    <button onclick="switchInboxTab('system')" id="mobile-tab-inbox-system" class="mobile-inbox-tab pb-3 text-sm font-medium text-app-textMuted border-b-[3px] border-transparent whitespace-nowrap transition-all relative shrink-0 hover:text-app-text">
                        System
                        <span id="mobile-badge-system" class="hidden absolute top-0 -right-2 w-2 h-2 bg-red-500 rounded-full ring-2 ring-app-card"></span>
                    </button>
                </div>
            </div>

            <!-- DESKTOP SIDEBAR (Hidden on Mobile) -->
            <div class="hidden md:flex w-64 flex-shrink-0 border-r border-app-border flex-col bg-app-sidebar">
                <div class="p-6 border-b border-app-border">
                    <h2 class="text-2xl font-extrabold text-app-text">Inbox</h2>
                </div>
                <div class="flex flex-col p-2 gap-1">
                    <button onclick="switchInboxTab('notifications')" id="tab-inbox-notifications" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-colors inbox-tab-active font-bold">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        Notifications
                        <span id="badge-notifications" class="hidden ml-auto bg-brand-orange text-white text-[10px] px-1.5 py-0.5 rounded-full"></span>
                    </button>
                    <button onclick="switchInboxTab('messages')" id="tab-inbox-messages" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-colors hover:bg-app-hover text-app-textMuted font-medium">
                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                        Messages
                        <span id="badge-messages" class="hidden ml-auto bg-brand-orange text-white text-[10px] px-1.5 py-0.5 rounded-full"></span>
                    </button>
                    <button onclick="window.switchInboxTab('orders')" id="tab-inbox-orders" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-colors hover:bg-app-hover text-app-textMuted font-medium">
                        <i data-lucide="package" class="w-5 h-5"></i>
                        Your Orders
                    </button>
                    <button onclick="window.switchInboxTab('sold')" id="tab-inbox-sold" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-colors hover:bg-app-hover text-app-textMuted font-medium">
                        <i data-lucide="package-check" class="w-5 h-5"></i>
                        Sold Orders
                        <span id="badge-sold" class="hidden ml-auto bg-brand-orange text-white text-[10px] px-1.5 py-0.5 rounded-full"></span>
                    </button>
                    <button onclick="window.switchInboxTab('system')" id="tab-inbox-system" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-colors hover:bg-app-hover text-app-textMuted font-medium">
                        <i data-lucide="siren" class="w-5 h-5"></i>
                        System
                        <span id="badge-system" class="hidden ml-auto bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full"></span>
                    </button>
                </div>
            </div>
            
            <!-- INBOX CONTENT AREA (Adjusted) -->
            <div class="flex-1 relative bg-app-bg overflow-hidden flex flex-col h-full">
                <!-- Notifications View -->
                <div id="inbox-view-notifications" class="h-full overflow-y-auto no-scrollbar p-4 md:p-6 pb-20 md:pb-6">
                    <div id="notifications-list" class="max-w-2xl mx-auto space-y-2">
                        <!-- Populated by JS -->
                        <div class="text-center text-app-textMuted py-20">Loading notifications...</div>
                    </div>
                </div>

                <!-- Orders View -->
                <div id="inbox-view-orders" class="hidden h-full overflow-y-auto no-scrollbar bg-app-bg flex flex-col pb-20 md:pb-0">
                    <div class="p-6 border-b border-app-border bg-app-card shrink-0 hidden md:block">
                        <h2 class="text-2xl font-extrabold text-app-text mb-1">Your Orders</h2>
                        <p class="text-sm text-app-textMuted">Track packages you have purchased.</p>
                    </div>
                    <div id="buyer-orders-list" class="max-w-3xl mx-auto w-full p-4 md:p-6 space-y-4">
                        <!-- Populated by JS -->
                        <div class="text-center text-app-textMuted py-20">Loading your orders...</div>
                    </div>
                </div>

                <!-- Sold Orders View -->
                <div id="inbox-view-sold" class="hidden h-full flex flex-col w-full bg-app-bg pb-20 md:pb-0">
                    <div class="flex items-center gap-6 px-4 md:px-6 py-4 border-b border-app-border bg-app-card shrink-0 overflow-x-auto">
                        <button onclick="window.switchSoldTab('to-ship')" id="sold-tab-to-ship" class="text-sm font-bold text-app-text border-b-2 border-brand-orange pb-1 whitespace-nowrap">To Ship</button>
                        <button onclick="window.switchSoldTab('in-transit')" id="sold-tab-in-transit" class="text-sm font-bold text-app-textMuted border-b-2 border-transparent hover:text-app-text pb-1 transition-all whitespace-nowrap">In Transit</button>
                        <button onclick="window.switchSoldTab('canceled')" id="sold-tab-canceled" class="text-sm font-bold text-app-textMuted border-b-2 border-transparent hover:text-app-text pb-1 transition-all whitespace-nowrap">Canceled</button>
                    </div>
                    <div id="sold-orders-list" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4">
                        <div class="text-center text-app-textMuted py-20">Loading orders...</div>
                    </div>
                </div>

                <!-- System View -->
                <div id="inbox-view-system" class="hidden h-full overflow-y-auto no-scrollbar p-4 md:p-6 pb-20 md:pb-6">
                    <div class="max-w-2xl mx-auto space-y-4" id="system-notifications-list">
                        <div class="text-center text-app-textMuted py-20">Loading updates...</div>
                    </div>
                </div>
                
                <!-- Messages View (Optimized for Mobile) -->
                <div id="inbox-view-messages" class="hidden h-full w-full flex-col md:flex-row relative">
                    
                    <!-- Conversations List (Sidebar) -->
                    <!-- On mobile: w-full, h-full. On desktop: w-80, h-full -->
                    <div id="conversations-sidebar" class="flex flex-col w-full md:w-80 flex-shrink-0 border-r border-app-border bg-app-card h-full z-10">
                        <div class="p-4 border-b border-app-border flex-shrink-0">
                            <input type="text" placeholder="Search messages..." class="w-full bg-app-input border border-app-border rounded-lg px-3 py-2 text-sm text-app-text outline-none focus:border-brand-teal">
                        </div>
                        <div id="conversations-list" class="flex-1 overflow-y-auto no-scrollbar pb-20 md:pb-0">
                            <!-- Populated by JS -->
                            <div class="text-center text-app-textMuted py-10 text-sm">Loading chats...</div>
                        </div>
                    </div>
                    
                    <!-- Active Chat Area -->
                    <!-- On mobile: hidden by default (toggled by JS). On desktop: always flex (forced by CSS above) -->
                    <div id="chat-wrapper" class="hidden md:flex flex-1 flex-col bg-app-bg h-full z-20">
                        
                        <!-- Empty State -->
                        <div id="chat-empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-app-textMuted z-10 bg-app-bg">
                            <div class="w-20 h-20 bg-app-card rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="send" class="w-8 h-8 opacity-50"></i>
                            </div>
                            <h3 class="text-xl font-bold text-app-text mb-2">Your Messages</h3>
                            <p>Select a conversation to start chatting.</p>
                        </div>

                        <!-- Chat Interface -->
                        <div id="chat-interface" class="hidden flex-col h-full z-20 w-full bg-app-bg relative">
                            <!-- Header -->
                            <div class="h-16 border-b border-app-border flex items-center px-4 md:px-6 bg-app-card flex-shrink-0 gap-3 z-30 sticky top-0">
                                <button onclick="document.getElementById('chat-wrapper').classList.add('hidden'); document.getElementById('chat-wrapper').classList.remove('flex'); document.getElementById('conversations-sidebar').classList.remove('hidden');" class="md:hidden p-2 -ml-2 rounded-full hover:bg-app-hover">
                                    <i data-lucide="arrow-left" class="w-5 h-5 text-app-text"></i>
                                </button>
                                <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden shrink-0">
                                    <img id="chat-header-avatar" src="" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <h4 id="chat-header-name" class="font-bold text-app-text text-sm">User</h4>
                                    <span class="text-xs text-green-500 font-bold flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Online</span>
                                </div>
                            </div>
                            
                            <!-- Messages Scroll Area -->
                            <div id="chat-messages-area" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 flex flex-col pb-20 md:pb-6">
                                <!-- Bubbles injected here -->
                            </div>
                            
                            <!-- Input -->
                            <div class="p-3 md:p-4 bg-app-card border-t border-app-border mt-auto pb-24 md:pb-4 z-30 relative shrink-0">
                                <form onsubmit="window.handleSendMessage(event)" class="flex gap-2">
                                    <input type="text" id="chat-input" class="flex-1 bg-app-input border border-app-border rounded-full px-4 py-3 text-sm text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20" placeholder="Type a message..." autocomplete="off">
                                    <button type="submit" class="bg-brand-teal text-white p-3 rounded-full hover:bg-brand-teal/90 transition-colors shadow-lg shadow-brand-teal/20">
                                        <i data-lucide="send-horizontal" class="w-5 h-5"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 5: EXPLORE -->
        <div id="explore-container" class="hidden h-full w-full overflow-y-auto no-scrollbar pt-0 px-6 pb-20">
            <div class="max-w-7xl mx-auto w-full animate-slide-up">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4 sticky top-0 z-30 pt-6 pb-8 bg-gradient-to-b from-app-bg from-60% to-transparent">
                    <div>
                        <h2 class="text-3xl font-extrabold text-app-text mb-1">Explore</h2>
                        <p class="text-sm text-app-textMuted">Discover trending content.</p>
                    </div>
                    <div class="relative w-full md:w-96 group">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-app-textMuted group-focus-within:text-brand-teal transition-colors"></i>
                        <input type="text" id="explore-search" onkeyup="window.handleExploreSearch()" placeholder="Search videos by title or tags..." class="w-full pl-12 pr-4 py-3 rounded-2xl bg-app-card border border-app-border text-app-text focus:ring-2 focus:ring-brand-teal/20 focus:border-brand-teal outline-none transition-all shadow-sm">
                    </div>
                </div>
                
                <div id="explore-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 pb-10">
                    <!-- Populated by JS -->
                    <div class="col-span-full text-center py-20 text-app-textMuted">
                        <i data-lucide="compass" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p>Loading explore feed...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: SETTINGS (Hidden by default) -->
        <div id="settings-container" class="hidden h-full w-full overflow-y-auto no-scrollbar pt-10 px-6 pb-20">
             <div class="max-w-3xl mx-auto w-full animate-slide-up">
                <h2 class="text-3xl font-extrabold text-app-text mb-2">Settings</h2>
                <p class="text-app-textMuted mb-8">Manage your account preferences and app settings.</p>

                <!-- 1. CREATOR WALLET SECTION (UPDATED) -->
                <div id="settings-wallet-section" class="hidden bg-app-card border border-app-border rounded-2xl p-4 md:p-6 mb-4 md:mb-6 animate-slide-up">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-app-text flex items-center gap-2 mb-1">
                                <i data-lucide="wallet" class="w-5 h-5 text-brand-orange"></i> Creator Wallet
                            </h3>
                            <p class="text-xs text-app-textMuted">Manage your earnings and payouts.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.navigateTo('analytics')" class="text-xs font-bold text-app-text border border-app-border px-3 py-1.5 rounded-lg hover:bg-app-hover transition-colors flex items-center gap-1">
                                <i data-lucide="bar-chart-2" class="w-3 h-3"></i> Analytics
                            </button>
                            <button onclick="window.processPendingFunds()" class="text-xs font-bold text-brand-teal hover:underline flex items-center gap-1 px-3 py-1.5">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Balance Card -->
                        <div class="bg-gradient-to-br from-brand-teal to-[#093c4a] rounded-xl p-5 text-white shadow-lg relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <i data-lucide="dollar-sign" class="w-24 h-24"></i>
                            </div>
                            <p class="text-blue-100 text-xs font-bold uppercase tracking-wider mb-1">Available Balance</p>
                            <h4 id="wallet-balance-available" class="text-3xl font-extrabold mb-4 tracking-tight">$0.00</h4>
                            <div class="flex gap-2">
                                <button onclick="window.showToast('Withdrawals coming soon', 'info')" class="bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white text-xs font-bold px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                                    <i data-lucide="arrow-up-right" class="w-3 h-3"></i> Withdraw
                                </button>
                            </div>
                        </div>

                        <!-- Stats/Pending -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-app-bg border border-app-border rounded-xl p-4 flex flex-col justify-center">
                                <p class="text-app-textMuted text-xs font-bold uppercase tracking-wider mb-1">Pending</p>
                                <p id="wallet-balance-pending" class="text-xl font-bold text-app-text">$0.00</p>
                                <p class="text-[10px] text-yellow-600 mt-1 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> Clears in ~1m</p>
                            </div>
                            <div class="bg-app-bg border border-app-border rounded-xl p-4 flex flex-col justify-center">
                                <p class="text-app-textMuted text-xs font-bold uppercase tracking-wider mb-1">Lifetime</p>
                                <p id="wallet-balance-lifetime" class="text-xl font-bold text-app-text">$0.00</p>
                                <p class="text-[10px] text-green-500 mt-1 flex items-center gap-1"><i data-lucide="trending-up" class="w-3 h-3"></i> Earned</p>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity Header -->
                    <h4 class="text-sm font-bold text-app-text mb-3">Recent Activity</h4>
                    <div id="wallet-recent-activity" class="space-y-3">
                        <div class="text-center text-xs text-app-textMuted py-4">No recent activity</div>
                    </div>
                </div>

                <!-- 2. THEMES SECTION (Important) -->
                <div class="bg-app-card border border-app-border rounded-2xl p-4 md:p-6 mb-4 md:mb-6">
                    <h3 class="text-xl font-bold text-app-text mb-4 flex items-center gap-2">
                        <i data-lucide="palette" class="w-5 h-5 text-brand-orange"></i> Appearance
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Light Theme Card -->
                        <div onclick="setTheme('light')" id="theme-card-light" class="border-2 rounded-xl p-4 cursor-pointer transition-all hover:bg-app-hover flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white border border-gray-200 shadow-sm flex items-center justify-center">
                                <i data-lucide="sun" class="w-5 h-5 text-yellow-500"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Light</h4>
                                <p class="text-xs text-gray-500">Default clean look</p>
                            </div>
                            <div class="ml-auto opacity-0 check-icon text-brand-teal">
                                <i data-lucide="check-circle" class="w-6 h-6 fill-current"></i>
                            </div>
                        </div>
                        
                        <!-- Dark Theme Card -->
                        <div onclick="setTheme('dark')" id="theme-card-dark" class="border-2 rounded-xl p-4 cursor-pointer transition-all hover:bg-app-hover flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-900 border border-gray-700 shadow-sm flex items-center justify-center">
                                <i data-lucide="moon" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-app-text">Dark</h4>
                                <p class="text-xs text-app-textMuted">Easy on the eyes</p>
                            </div>
                            <div class="ml-auto opacity-0 check-icon text-brand-orange">
                                <i data-lucide="check-circle" class="w-6 h-6 fill-current"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. PREFERENCES SECTION (New) -->
                <div id="settings-preferences-section" class="hidden bg-app-card border border-app-border rounded-2xl p-4 md:p-6 mb-4 md:mb-6 animate-slide-up">
                    <h3 class="text-xl font-bold text-app-text mb-4 flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-5 h-5 text-brand-orange"></i> Shipping Address
                    </h3>
                    <div>
                        <p class="text-sm text-app-textMuted mb-4">Your full address for shipping. <span class="text-brand-orange font-bold">Only your Country is displayed publicly.</span></p>
                        
                        <form onsubmit="event.preventDefault(); window.saveLocationPreference();" class="space-y-4">
                            <!-- Street Address -->
                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Street Address</label>
                                <input type="text" id="settings-street" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text font-medium focus:border-brand-teal outline-none transition-all" placeholder="123 Main St">
                            </div>

                            <!-- Apt/Suite & Zip -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Apt / Suite (Optional)</label>
                                    <input type="text" id="settings-apt" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text font-medium focus:border-brand-teal outline-none transition-all" placeholder="Apt 4B">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Zip / Postal Code</label>
                                    <input type="text" id="settings-zip" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text font-medium focus:border-brand-teal outline-none transition-all" placeholder="10001">
                                </div>
                            </div>

                            <!-- City & State -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">City</label>
                                    <input type="text" id="settings-city" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text font-medium focus:border-brand-teal outline-none transition-all" placeholder="New York">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">State / Province</label>
                                    <input type="text" id="settings-state" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text font-medium focus:border-brand-teal outline-none transition-all" placeholder="NY">
                                </div>
                            </div>

                            <!-- Country (Public) -->
                            <div class="relative">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Country (Public)</label>
                                <select id="settings-default-location" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text font-medium focus:border-brand-teal outline-none transition-all appearance-none cursor-pointer">
                                    <option value="" disabled selected>Select Country</option>
                                    <option value="Afghanistan">Afghanistan</option>
                                    <option value="Albania">Albania</option>
                                    <option value="Algeria">Algeria</option>
                                    <option value="Argentina">Argentina</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Austria">Austria</option>
                                    <option value="Bangladesh">Bangladesh</option>
                                    <option value="Belgium">Belgium</option>
                                    <option value="Brazil">Brazil</option>
                                    <option value="Canada">Canada</option>
                                    <option value="Chile">Chile</option>
                                    <option value="China">China</option>
                                    <option value="Colombia">Colombia</option>
                                    <option value="Denmark">Denmark</option>
                                    <option value="Egypt">Egypt</option>
                                    <option value="Finland">Finland</option>
                                    <option value="France">France</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Greece">Greece</option>
                                    <option value="India">India</option>
                                    <option value="Indonesia">Indonesia</option>
                                    <option value="Ireland">Ireland</option>
                                    <option value="Italy">Italy</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Malaysia">Malaysia</option>
                                    <option value="Mexico">Mexico</option>
                                    <option value="Netherlands">Netherlands</option>
                                    <option value="New Zealand">New Zealand</option>
                                    <option value="Nigeria">Nigeria</option>
                                    <option value="Norway">Norway</option>
                                    <option value="Pakistan">Pakistan</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="Poland">Poland</option>
                                    <option value="Portugal">Portugal</option>
                                    <option value="Russia">Russia</option>
                                    <option value="Saudi Arabia">Saudi Arabia</option>
                                    <option value="Singapore">Singapore</option>
                                    <option value="South Africa">South Africa</option>
                                    <option value="South Korea">South Korea</option>
                                    <option value="Spain">Spain</option>
                                    <option value="Sweden">Sweden</option>
                                    <option value="Switzerland">Switzerland</option>
                                    <option value="Thailand">Thailand</option>
                                    <option value="Turkey">Turkey</option>
                                    <option value="Ukraine">Ukraine</option>
                                    <option value="United Arab Emirates">United Arab Emirates</option>
                                    <option value="United Kingdom">United Kingdom</option>
                                    <option value="United States">United States</option>
                                    <option value="Vietnam">Vietnam</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="absolute bottom-3 right-0 flex items-center px-3 pointer-events-none text-app-textMuted">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>

                            <button 
                                type="submit"
                                class="mt-4 w-full px-6 py-3 bg-brand-teal text-white font-bold rounded-xl hover:bg-brand-teal/90 transition-all shadow-lg shadow-brand-teal/20 flex items-center justify-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Save Address
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 4. ACCOUNT SECTION -->
                <div id="settings-account-section" class="hidden bg-app-card border border-app-border rounded-2xl p-4 md:p-6 mb-4 md:mb-6">
                    <h3 class="text-xl font-bold text-app-text mb-4 flex items-center gap-2">
                        <i data-lucide="user" class="w-5 h-5 text-brand-orange"></i> Account
                    </h3>
                    <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Username</label>
                                <div class="flex gap-2">
                                    <div id="settings-username" class="flex-1 px-4 py-3 rounded-lg bg-app-input border border-app-border text-app-text font-medium opacity-75">...</div>
                                    <button onclick="document.getElementById('new-username-input').value = ''; document.getElementById('change-username-modal').classList.remove('hidden')" class="px-4 py-2 bg-app-bg border border-app-border rounded-lg font-bold text-app-text hover:bg-app-hover transition-colors text-sm">
                                        Change
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Email</label>
                                <div class="flex gap-2">
                                    <div id="settings-email" class="flex-1 px-4 py-3 rounded-lg bg-app-input border border-app-border text-app-text font-medium opacity-75">...</div>
                                    <button onclick="document.getElementById('new-email-input').value = ''; document.getElementById('change-email-modal').classList.remove('hidden')" class="px-4 py-2 bg-app-bg border border-app-border rounded-lg font-bold text-app-text hover:bg-app-hover transition-colors text-sm">
                                        Change
                                    </button>
                                </div>
                            </div>
                            
                            <div class="pt-2 flex flex-wrap gap-3 border-t border-app-border mt-4">
                                <button onclick="document.getElementById('new-password-input').value=''; document.getElementById('confirm-password-input').value=''; document.getElementById('change-password-modal').classList.remove('hidden')" class="px-4 py-2 text-sm font-bold text-app-text border border-app-border rounded-lg hover:bg-app-hover transition-colors">
                                    Change Password
                                </button>
                                <button onclick="window.handleLogout()" class="px-4 py-2 text-sm font-bold text-red-500 border border-red-200 bg-red-50 rounded-lg hover:bg-red-100 transition-colors ml-auto">
                                    Log Out
                                </button>
                            </div>
                            <div class="mt-6 pt-6 border-t border-app-border">
                                <h4 class="text-xs font-bold text-app-textMuted uppercase tracking-wider mb-3">Help & Support</h4>
                                <button onclick="window.navigateTo('support')" class="w-full flex items-center justify-between p-4 bg-app-bg border border-app-border rounded-xl text-app-text font-bold hover:bg-app-hover transition-colors group">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-brand-teal/10 flex items-center justify-center text-brand-teal group-hover:bg-brand-teal group-hover:text-white transition-colors">
                                            <i data-lucide="life-buoy" class="w-4 h-4"></i>
                                        </div>
                                        <span>Customer Support Center</span>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-app-textMuted group-hover:text-app-text"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <!-- CHANGE USERNAME MODAL -->
        <div id="change-username-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center modal-backdrop p-4">
            <div class="bg-app-bg w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up relative">
                <button onclick="document.getElementById('change-username-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="p-8">
                    <h2 class="text-2xl font-extrabold text-app-text mb-2">Change Username</h2>
                    <p class="text-sm text-app-textMuted mb-6">Choose a unique username.</p>
                    
                    <form onsubmit="window.handleChangeUsernameSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">New Username</label>
                            <input type="text" id="new-username-input" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20 font-medium" placeholder="username" pattern="[a-zA-Z0-9_]{3,20}" title="3-20 chars, letters/numbers/_ only" required>
                            <p id="username-check-msg" class="text-xs mt-2 font-bold hidden"></p>
                        </div>
                        <button type="submit" class="w-full bg-brand-teal text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all">
                            Update Username
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- CHANGE PASSWORD MODAL -->
        <div id="change-password-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center modal-backdrop p-4">
            <div class="bg-app-bg w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up relative">
                <button onclick="document.getElementById('change-password-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="p-8">
                    <h2 class="text-2xl font-extrabold text-app-text mb-2">Change Password</h2>
                    <p class="text-sm text-app-textMuted mb-6">Enter a new secure password.</p>
                    
                    <form onsubmit="window.handleChangePasswordSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">New Password</label>
                            <input type="password" id="new-password-input" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20 font-medium" placeholder="â¢â¢â¢â¢â¢â¢â¢â¢" minlength="6" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Confirm Password</label>
                            <input type="password" id="confirm-password-input" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20 font-medium" placeholder="â¢â¢â¢â¢â¢â¢â¢â¢" minlength="6" required>
                        </div>
                        <button type="submit" class="w-full bg-brand-teal text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all">
                            Update Password
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- CHANGE EMAIL MODAL -->
        <div id="change-email-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center modal-backdrop p-4">
            <div class="bg-app-bg w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up relative">
                <button onclick="document.getElementById('change-email-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div class="p-8">
                    <h2 class="text-2xl font-extrabold text-app-text mb-2">Change Email</h2>
                    <p class="text-sm text-app-textMuted mb-6">Enter your new email address.</p>
                    
                    <form onsubmit="window.handleChangeEmailSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">New Email</label>
                            <input type="email" id="new-email-input" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20 font-medium" placeholder="name@example.com" required>
                        </div>
                        <button type="submit" class="w-full bg-brand-teal text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all">
                            Update Email
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- VIEW: CUSTOMER SUPPORT -->
        <div id="support-container" class="hidden h-full w-full overflow-y-auto no-scrollbar pt-10 px-6 pb-20">
            <div class="max-w-3xl mx-auto w-full animate-slide-up">
                <button onclick="window.navigateTo('settings')" class="mb-6 flex items-center gap-2 text-app-textMuted hover:text-app-text font-bold transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to Settings
                </button>

                <div class="text-center mb-10">
                    <h2 class="text-4xl font-extrabold text-app-text mb-2">How can we help?</h2>
                    <p class="text-app-textMuted">Search for answers or contact our team.</p>
                    
                    <div class="relative max-w-lg mx-auto mt-6">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-app-textMuted"></i>
                        <input type="text" placeholder="Search for help topics..." class="w-full pl-12 pr-4 py-4 rounded-2xl bg-app-card border border-app-border text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20 focus:border-brand-teal transition-all shadow-sm">
                    </div>
                </div>

                <!-- Quick Links Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12">
                    <div class="bg-app-card p-6 rounded-xl border border-app-border text-center hover:border-brand-teal transition-colors cursor-pointer">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="package" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-app-text">Orders & Shipping</h3>
                    </div>
                    <div class="bg-app-card p-6 rounded-xl border border-app-border text-center hover:border-brand-teal transition-colors cursor-pointer">
                        <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-app-text">Returns & Refunds</h3>
                    </div>
                    <div class="bg-app-card p-6 rounded-xl border border-app-border text-center hover:border-brand-teal transition-colors cursor-pointer">
                        <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="user" class="w-6 h-6"></i>
                        </div>
                        <h3 class="font-bold text-app-text">Account & Security</h3>
                    </div>
                </div>

                <!-- FAQ Section -->
                <div class="mb-12">
                    <h3 class="text-xl font-bold text-app-text mb-6">Frequently Asked Questions</h3>
                    <div class="space-y-4">
                        <!-- FAQ Item 1 -->
                        <div class="bg-app-card border border-app-border rounded-xl overflow-hidden">
                            <button onclick="window.toggleFAQ('1')" class="w-full flex items-center justify-between p-5 text-left font-bold text-app-text hover:bg-app-hover transition-colors">
                                <span>How do I track my order?</span>
                                <i id="faq-icon-1" data-lucide="chevron-down" class="w-5 h-5 text-app-textMuted transition-transform duration-300"></i>
                            </button>
                            <div id="faq-ans-1" class="hidden px-5 pb-5 text-sm text-app-textMuted leading-relaxed">
                                Go to your Inbox > Your Orders. Click "Details" on any active order to see the current shipping status and tracking number if available.
                            </div>
                        </div>
                        <!-- FAQ Item 2 -->
                        <div class="bg-app-card border border-app-border rounded-xl overflow-hidden">
                            <button onclick="window.toggleFAQ('2')" class="w-full flex items-center justify-between p-5 text-left font-bold text-app-text hover:bg-app-hover transition-colors">
                                <span>Can I cancel my purchase?</span>
                                <i id="faq-icon-2" data-lucide="chevron-down" class="w-5 h-5 text-app-textMuted transition-transform duration-300"></i>
                            </button>
                            <div id="faq-ans-2" class="hidden px-5 pb-5 text-sm text-app-textMuted leading-relaxed">
                                You can cancel an order as long as the status is "Paid" and has not yet been "Shipped" by the seller. Go to Order Details to find the Cancel button.
                            </div>
                        </div>
                        <!-- FAQ Item 3 -->
                        <div class="bg-app-card border border-app-border rounded-xl overflow-hidden">
                            <button onclick="window.toggleFAQ('3')" class="w-full flex items-center justify-between p-5 text-left font-bold text-app-text hover:bg-app-hover transition-colors">
                                <span>How do I get paid as a seller?</span>
                                <i id="faq-icon-3" data-lucide="chevron-down" class="w-5 h-5 text-app-textMuted transition-transform duration-300"></i>
                            </button>
                            <div id="faq-ans-3" class="hidden px-5 pb-5 text-sm text-app-textMuted leading-relaxed">
                                Funds are held in "Pending" status until you confirm shipment. Once marked shipped, funds move to your wallet and can be withdrawn to your linked bank account or PayPal.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Form -->
                <div class="bg-app-card border border-app-border rounded-2xl p-8 mb-10">
                    <h3 class="text-xl font-bold text-app-text mb-2">Still need help?</h3>
                    <p class="text-sm text-app-textMuted mb-6">Fill out the form below and our support team will get back to you within 24 hours.</p>
                    
                    <form onsubmit="window.handleSupportSubmit(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Name</label>
                                <input type="text" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text focus:border-brand-teal outline-none transition-all" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Email</label>
                                <input type="email" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text focus:border-brand-teal outline-none transition-all" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Topic</label>
                            <select class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text focus:border-brand-teal outline-none transition-all">
                                <option>General Inquiry</option>
                                <option>Order Issue</option>
                                <option>Payment Problem</option>
                                <option>Report a User/Product</option>
                                <option>Technical Bug</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Message</label>
                            <textarea rows="4" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text focus:border-brand-teal outline-none transition-all resize-none" placeholder="Describe your issue..." required></textarea>
                        </div>
                        <button type="submit" class="w-full bg-brand-teal text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="send" class="w-4 h-4"></i> Send Message
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- VIEW 7: CREATE PRODUCT (Hidden by default) -->
        <div id="create-product-container" class="hidden h-full w-full overflow-y-auto no-scrollbar py-10 px-6">
            <div class="max-w-4xl mx-auto w-full animate-slide-up pb-20">
                <div class="flex items-center justify-between mb-8">
                    <div>
                         <h2 class="text-3xl font-extrabold text-app-text mb-2">Create Product</h2>
                         <p class="text-app-textMuted">List an item for sale on JACE. marketplace.</p>
                    </div>
                </div>

                <div class="bg-app-card border border-app-border rounded-2xl overflow-hidden shadow-lg">
                    <form id="create-product-form" onsubmit="window.handleCreateProductSubmit(event)" class="p-8 space-y-8">
                        
                        <!-- 1. Images -->
                        <div class="space-y-4">
                             <h3 class="text-lg font-bold text-app-text border-b border-app-border pb-2">Product Images</h3>
                             <p class="text-xs text-app-textMuted">Upload up to 8 images. First image will be the cover.</p>
                             
                             <div class="grid grid-cols-4 md:grid-cols-8 gap-3" id="product-images-preview">
                                 <!-- Dynamic Previews -->
                             </div>
                             
                             <div onclick="document.getElementById('product-image-input').click()" class="border-2 border-dashed border-app-border rounded-xl p-6 text-center cursor-pointer hover:bg-app-hover transition-colors group">
                                <input type="file" id="product-image-input" class="hidden" accept="image/*" multiple onchange="window.handleProductImageSelect(event)">
                                <i data-lucide="image-plus" class="w-8 h-8 text-brand-teal mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
                                <p class="text-sm font-bold text-app-text">Add Images</p>
                             </div>
                        </div>

                        <!-- 2. Details -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div class="space-y-4 md:col-span-2">
                                 <h3 class="text-lg font-bold text-app-text border-b border-app-border pb-2">Item Details</h3>
                             </div>
                             
                             <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Title <span class="text-red-500">*</span></label>
                                <input type="text" id="prod-title" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none font-medium" placeholder="e.g., Vintage Denim Jacket" required>
                             </div>

                             <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Description</label>
                                <textarea id="prod-desc" rows="4" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none resize-none font-medium" placeholder="Describe the condition, sizing, and features..."></textarea>
                             </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Categories</label>
                                <!-- Chips Container -->
                                <div id="create-category-chips" class="flex flex-wrap gap-2 mb-2 min-h-[2px]"></div>
                                <!-- Adder Dropdown -->
                                <select id="prod-category-select" onchange="window.handleAddCategory('create', this)" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium cursor-pointer">
                                    <option value="" disabled selected>+ Add Category</option>
                                    <option value="Clothing">Clothing</option>
                                    <option value="Shoes">Shoes</option>
                                    <option value="Accessories">Accessories</option>
                                    <option value="Tech">Tech & Electronics</option>
                                    <option value="Home">Home & Living</option>
                                    <option value="Beauty">Beauty</option>
                                    <option value="Art">Art & Collectibles</option>
                                    <option value="Books">Books & Media</option>
                                    <option value="Gaming">Gaming</option>
                                    <option value="Sports">Sports & Outdoors</option>
                                    <option value="Pets">Pet Supplies</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                             <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Brand</label>
                                <input type="text" id="prod-brand" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium" placeholder="e.g., Nike, Zara">
                             </div>
                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Tags</label>
                                <input type="text" id="prod-tags" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium" placeholder="vintage, rare, handmade (comma separated)">
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Condition</label>
                                <select id="prod-condition" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium">
                                    <option value="New">New / With Tags</option>
                                    <option value="Like New">Like New</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                             </div>

                              <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Stock Available</label>
                                <input type="number" id="prod-stock" min="1" value="1" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium">
                             </div>
                        </div>

                        <!-- 3. Shipping & Location -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                             <div class="space-y-4 md:col-span-2">
                                 <h3 class="text-lg font-bold text-app-text border-b border-app-border pb-2">Shipping & Location</h3>
                             </div>

                             <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Shipping Method</label>
                                <select id="prod-shipping" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium">
                                    <option value="Standard">Standard Shipping</option>
                                    <option value="Pickup">Local Pickup Only</option>
                                </select>
                             </div>

                             <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Shipping Cost</label>
                                <div class="flex items-center gap-6 mb-3">
                                    <label class="flex items-center gap-2 cursor-pointer group">
                                        <div class="relative flex items-center">
                                            <input type="radio" name="shipping_cost_type" value="free" checked onchange="window.toggleShippingCostInput()" class="peer sr-only">
                                            <div class="w-5 h-5 border-2 border-app-border rounded-full peer-checked:border-brand-teal peer-checked:bg-brand-teal transition-all"></div>
                                            <div class="absolute w-2.5 h-2.5 bg-white rounded-full left-1.5 top-1.5 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                        </div>
                                        <span class="text-sm font-medium text-app-text group-hover:text-brand-teal transition-colors">Free Shipping</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer group">
                                         <div class="relative flex items-center">
                                            <input type="radio" name="shipping_cost_type" value="paid" onchange="window.toggleShippingCostInput()" class="peer sr-only">
                                            <div class="w-5 h-5 border-2 border-app-border rounded-full peer-checked:border-brand-teal peer-checked:bg-brand-teal transition-all"></div>
                                            <div class="absolute w-2.5 h-2.5 bg-white rounded-full left-1.5 top-1.5 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                        </div>
                                        <span class="text-sm font-medium text-app-text group-hover:text-brand-teal transition-colors">Flat Rate</span>
                                    </label>
                                </div>
                                <div id="shipping-cost-container" class="hidden animate-fade-in">
                                     <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-app-text font-bold">$</span>
                                        <input type="number" id="prod-shipping-cost" oninput="window.updatePayout()" step="0.01" min="0" class="w-full pl-8 pr-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium" placeholder="0.00">
                                    </div>
                                </div>
                             </div>

                             <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Ships From</label>
                                <div class="relative">
                                    <select id="prod-location" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium appearance-none cursor-pointer">
                                        <option value="" disabled selected>Select Country</option>
                                        <option value="Afghanistan">Afghanistan</option>
                                        <option value="Albania">Albania</option>
                                        <option value="Algeria">Algeria</option>
                                        <option value="Argentina">Argentina</option>
                                        <option value="Australia">Australia</option>
                                        <option value="Austria">Austria</option>
                                        <option value="Bangladesh">Bangladesh</option>
                                        <option value="Belgium">Belgium</option>
                                        <option value="Brazil">Brazil</option>
                                        <option value="Canada">Canada</option>
                                        <option value="Chile">Chile</option>
                                        <option value="China">China</option>
                                        <option value="Colombia">Colombia</option>
                                        <option value="Denmark">Denmark</option>
                                        <option value="Egypt">Egypt</option>
                                        <option value="Finland">Finland</option>
                                        <option value="France">France</option>
                                        <option value="Germany">Germany</option>
                                        <option value="Greece">Greece</option>
                                        <option value="India">India</option>
                                        <option value="Indonesia">Indonesia</option>
                                        <option value="Ireland">Ireland</option>
                                        <option value="Italy">Italy</option>
                                        <option value="Japan">Japan</option>
                                        <option value="Malaysia">Malaysia</option>
                                        <option value="Mexico">Mexico</option>
                                        <option value="Netherlands">Netherlands</option>
                                        <option value="New Zealand">New Zealand</option>
                                        <option value="Nigeria">Nigeria</option>
                                        <option value="Norway">Norway</option>
                                        <option value="Pakistan">Pakistan</option>
                                        <option value="Philippines">Philippines</option>
                                        <option value="Poland">Poland</option>
                                        <option value="Portugal">Portugal</option>
                                        <option value="Russia">Russia</option>
                                        <option value="Saudi Arabia">Saudi Arabia</option>
                                        <option value="Singapore">Singapore</option>
                                        <option value="South Africa">South Africa</option>
                                        <option value="South Korea">South Korea</option>
                                        <option value="Spain">Spain</option>
                                        <option value="Sweden">Sweden</option>
                                        <option value="Switzerland">Switzerland</option>
                                        <option value="Thailand">Thailand</option>
                                        <option value="Turkey">Turkey</option>
                                        <option value="Ukraine">Ukraine</option>
                                        <option value="United Arab Emirates">United Arab Emirates</option>
                                        <option value="United Kingdom">United Kingdom</option>
                                        <option value="United States">United States</option>
                                        <option value="Vietnam">Vietnam</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-app-textMuted">
                                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </div>
                                </div>
                             </div>
                        </div>

                        <!-- 4. Pricing -->
                        <div class="pt-2">
                             <h3 class="text-lg font-bold text-app-text border-b border-app-border pb-4 mb-4">Pricing</h3>
                             
                             <div class="bg-app-bg border border-app-border rounded-xl p-6 flex flex-col md:flex-row gap-8 items-center">
                                 <div class="flex-1 w-full">
                                    <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Price ($) <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-app-text font-bold">$</span>
                                        <input type="number" id="prod-price" step="0.01" min="1" oninput="window.updatePayout()" class="w-full pl-8 pr-4 py-4 rounded-xl border border-app-border bg-app-input text-app-text text-xl font-bold focus:border-brand-orange focus:ring-2 focus:ring-brand-orange/20 outline-none" placeholder="0.00" required>
                                    </div>
                                 </div>
                                 
                                 <div class="flex-1 w-full flex flex-col gap-2 border-l border-app-border pl-0 md:pl-8">
                                     <div class="flex justify-between text-sm">
                                         <span class="text-app-textMuted">Price</span>
                                         <span class="font-medium text-app-text" id="calc-price">$0.00</span>
                                     </div>
                                     <div class="flex justify-between text-sm">
                                         <span class="text-app-textMuted">Shipping</span>
                                         <span class="font-medium text-app-text" id="calc-shipping">$0.00</span>
                                     </div>
                                     <div class="flex justify-between text-sm">
                                         <span class="text-app-textMuted">Platform Fee (10%)</span>
                                         <span class="font-medium text-app-text" id="calc-fee">-$0.00</span>
                                     </div>
                                     <div class="flex justify-between text-lg font-bold pt-2 border-t border-app-border">
                                         <span class="text-brand-teal">You Receive</span>
                                         <span class="text-brand-orange" id="calc-payout">$0.00</span>
                                     </div>
                                     <div class="flex justify-between text-sm pt-1 text-app-textMuted">
                                         <span>Buyer Pays</span>
                                         <span class="font-bold" id="calc-total">$0.00</span>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <!-- Submit -->
                        <div class="pt-4 border-t border-app-border flex justify-end gap-4">
                             <button type="button" onclick="navigateTo('feed')" class="px-6 py-3 rounded-xl border border-app-border text-app-text font-bold hover:bg-app-hover transition-colors">Cancel</button>
                             <button type="submit" id="create-product-submit-btn" class="px-8 py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 shadow-lg shadow-red-500/20 transition-all">List Item</button>
                        </div>

                        <div id="create-product-status" class="hidden p-4 rounded-xl text-center text-sm font-medium bg-red-100 text-red-700"></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- VIEW 4: UPLOAD (Hidden by default) -->
        <div id="upload-container" class="hidden h-full w-full overflow-y-auto no-scrollbar py-10 px-6">
            <!-- ... Upload Content ... -->
            <div class="max-w-6xl mx-auto w-full h-full animate-slide-up">
                <div class="flex items-center justify-between mb-8">
                    <div>
                         <h2 class="text-3xl font-extrabold text-app-text mb-2">Create Content</h2>
                         <p class="text-app-textMuted">Share your latest creation with the world.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 h-full pb-20">
                    
                    <!-- LEFT COLUMN: PREVIEW -->
                    <div class="flex flex-col items-center">
                        <div id="upload-preview-container" class="relative w-[320px] aspect-[9/16] bg-black rounded-[2rem] overflow-hidden shadow-2xl border-8 border-gray-800 ring-1 ring-gray-700 flex items-center justify-center transition-all duration-300">
                            <!-- Placeholder Text if no video -->
                            <div id="preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 z-10">
                                <i data-lucide="film" class="w-12 h-12 mb-2 opacity-50"></i>
                                <span class="text-xs font-medium">Preview</span>
                            </div>
                            
                            <!-- Video Element (Contain for Letterboxing) -->
                            <video id="upload-preview" class="w-full h-full object-contain hidden z-20" loop muted playsinline autoplay></video>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: FORM -->
                    <div class="bg-app-card border border-app-border rounded-2xl p-8 h-fit">
                        <form id="upload-form" onsubmit="handleUploadSubmit(event)" class="space-y-6">
                            <div class="mb-6">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Content Type</label>
                                <div class="flex gap-4 p-1 bg-app-bg border border-app-border rounded-xl w-fit">
                                    <label class="flex items-center gap-2 cursor-pointer px-3 py-2 hover:bg-app-hover rounded-lg transition-colors">
                                        <input type="radio" name="content_type" value="video" checked onchange="window.toggleUploadType('video')" class="w-4 h-4 text-brand-teal focus:ring-brand-teal accent-brand-teal">
                                        <span class="text-sm font-bold text-app-text flex items-center gap-1"><i data-lucide="video" class="w-3 h-3"></i> Video</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer px-3 py-2 hover:bg-app-hover rounded-lg transition-colors">
                                        <input type="radio" name="content_type" value="slideshow" onchange="window.toggleUploadType('slideshow')" class="w-4 h-4 text-brand-teal focus:ring-brand-teal accent-brand-teal">
                                        <span class="text-sm font-bold text-app-text flex items-center gap-1"><i data-lucide="images" class="w-3 h-3"></i> Slideshow</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Aspect Ratio</label>
                                <div class="flex gap-4 p-1 bg-app-bg border border-app-border rounded-xl w-fit">
                                    <label class="flex items-center gap-2 cursor-pointer px-3 py-2 hover:bg-app-hover rounded-lg transition-colors">
                                        <input type="radio" name="video_aspect" value="portrait" checked onchange="window.updatePreviewAspect('portrait')" class="w-4 h-4 text-brand-teal focus:ring-brand-teal accent-brand-teal">
                                        <span class="text-sm font-bold text-app-text flex items-center gap-1"><i data-lucide="smartphone" class="w-3 h-3"></i> Portrait (9:16)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer px-3 py-2 hover:bg-app-hover rounded-lg transition-colors">
                                        <input type="radio" name="video_aspect" value="landscape" onchange="window.updatePreviewAspect('landscape')" class="w-4 h-4 text-brand-teal focus:ring-brand-teal accent-brand-teal">
                                        <span class="text-sm font-bold text-app-text flex items-center gap-1"><i data-lucide="monitor" class="w-3 h-3"></i> Landscape (16:9)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 1. Video File Selection -->
                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Video File</label>
                                <div onclick="document.getElementById('video-input').click()" class="border-2 border-dashed border-app-border rounded-xl p-8 text-center cursor-pointer hover:bg-app-hover transition-colors group">
                                    <input type="file" id="video-input" class="hidden" accept="video/*" onchange="handleFileSelect(event)">
                                    <i data-lucide="upload-cloud" class="w-10 h-10 text-brand-orange mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
                                    <p id="file-name-display" class="text-sm font-medium text-app-text">Click to select video</p>
                                    <p class="text-xs text-app-textMuted mt-1">MP4, WebM, QuickTime</p>
                                </div>
                            </div>

                            <!-- 2. Metadata -->
                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Title</label>
                                <input type="text" id="meta-title" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none transition-all font-medium" placeholder="My awesome video" required>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Description</label>
                                <textarea id="meta-desc" rows="3" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none resize-none font-medium" placeholder="Tell your viewers what this is about..."></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Tags</label>
                                <input type="text" id="meta-tags" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none transition-all font-medium" placeholder="#fashion, #tech, #summer">
                            </div>

                            <!-- NEW: VISIBILITY SETTING -->
                            <div class="bg-app-bg border border-app-border rounded-xl p-4 mt-4">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <i data-lucide="eye" class="w-4 h-4"></i> Visibility
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="upload_visibility" value="public" checked class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-brand-teal peer-checked:bg-brand-teal/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="globe" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-brand-teal"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-brand-teal">Everyone</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="upload_visibility" value="followers" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-blue-500 peer-checked:bg-blue-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="users" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-blue-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-blue-500">Followers</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="upload_visibility" value="private" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-gray-500 peer-checked:bg-gray-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="lock" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-gray-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-gray-500">Private</span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- NEW: COMMENT SETTINGS -->
                            <div class="bg-app-bg border border-app-border rounded-xl p-4 mt-4">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <i data-lucide="message-square" class="w-4 h-4"></i> Comments
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="upload_comments" value="allow" checked class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-green-500 peer-checked:bg-green-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="check-circle" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-green-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-green-500">Allow</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="upload_comments" value="restrict" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-orange-500 peer-checked:bg-orange-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="slash" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-orange-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-orange-500">Restrict</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="upload_comments" value="off" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-red-500 peer-checked:bg-red-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="x-circle" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-red-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-red-500">Disable</span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- 3. Featured Product (Updated) -->
                            <div class="border border-app-border rounded-xl p-4 bg-app-bg">
                                <h3 class="text-sm font-bold text-app-text mb-3 flex items-center gap-2">
                                    <i data-lucide="shopping-bag" class="w-4 h-4 text-brand-orange"></i> Featured Product
                                </h3>
                                <div class="relative">
                                    <label class="block text-[10px] font-bold text-app-textMuted uppercase tracking-wider mb-1">Select from your products</label>
                                    <div class="relative">
                                        <select id="upload-product-select" class="w-full px-4 py-3 pr-10 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none appearance-none font-medium cursor-pointer">
                                            <option value="" disabled selected>Select a product (Required)</option>
                                        </select>
                                        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-app-textMuted">
                                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                        </div>
                                    </div>
                                    <div id="upload-product-loading" class="hidden mt-2 text-xs text-brand-teal flex items-center gap-1">
                                        <i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Loading products...
                                    </div>
                                    <p id="no-products-msg" class="hidden text-xs text-app-textMuted mt-2 bg-app-card p-2 rounded border border-app-border">
                                        You haven't created any products yet. <button type="button" onclick="navigateTo('create-product')" class="text-brand-orange font-bold hover:underline">Create one now</button> to feature it in your video.
                                    </p>
                                </div>
                            </div>

                            <!-- 4. Submit -->
                            <button id="upload-submit-btn" type="submit" disabled class="w-full bg-brand-teal disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all duration-200 mt-4 flex items-center justify-center gap-2">
                                <span>Publish Content</span>
                                <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>

                            <div id="upload-status" class="hidden p-4 rounded-xl text-center text-sm font-medium"></div>

                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="edit-video-page-container" class="hidden h-full w-full overflow-y-auto no-scrollbar py-10 px-6">
            <div class="max-w-6xl mx-auto w-full animate-slide-up pb-20">
                <button onclick="window.history.back()" class="mb-6 flex items-center gap-2 text-app-textMuted hover:text-app-text font-bold transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> Back
                </button>

                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-extrabold text-app-text mb-2">Edit Content</h2>
                        <p class="text-app-textMuted">Update details and visibility settings.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <!-- LEFT: PREVIEW -->
                    <div class="flex flex-col items-center">
                        <div id="edit-page-preview-container" class="relative w-[320px] aspect-[9/16] bg-black rounded-[2rem] overflow-hidden shadow-2xl border-8 border-gray-800 ring-1 ring-gray-700 flex items-center justify-center">
                            <video id="edit-page-video-preview" class="w-full h-full object-cover" loop muted playsinline></video>
                        </div>
                    </div>

                    <!-- RIGHT: FORM -->
                    <div class="bg-app-card border border-app-border rounded-2xl p-8 h-fit">
                        <form id="edit-video-page-form" onsubmit="window.handleSaveEditVideo(event)" class="space-y-6">
                            <input type="hidden" id="edit-page-video-id">
                            <input type="hidden" id="edit-page-video-path">
                            <!-- NEW: Hidden input for file path to delete from storage -->
                            <input type="hidden" id="edit-page-storage-path">

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Title</label>
                                <input type="text" id="edit-page-title" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none transition-all font-medium" required>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Description</label>
                                <textarea id="edit-page-desc" rows="4" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none resize-none font-medium"></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Tags (comma separated)</label>
                                <input type="text" id="edit-page-tags" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none transition-all font-medium">
                            </div>

                            <!-- VISIBILITY SETTING -->
                            <div class="bg-app-bg border border-app-border rounded-xl p-4">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <i data-lucide="eye" class="w-4 h-4"></i> Visibility
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="edit_visibility" value="public" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-brand-teal peer-checked:bg-brand-teal/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="globe" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-brand-teal"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-brand-teal">Everyone</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="edit_visibility" value="followers" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-blue-500 peer-checked:bg-blue-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="users" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-blue-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-blue-500">Followers</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="edit_visibility" value="private" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-gray-500 peer-checked:bg-gray-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="lock" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-gray-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-gray-500">Private</span>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- NEW: COMMENT SETTINGS -->
                            <div class="bg-app-bg border border-app-border rounded-xl p-4">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <i data-lucide="message-square" class="w-4 h-4"></i> Comments
                                </label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="edit_comments" value="allow" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-green-500 peer-checked:bg-green-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="check-circle" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-green-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-green-500">Allow</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="edit_comments" value="restrict" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-orange-500 peer-checked:bg-orange-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="slash" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-orange-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-orange-500">Restrict</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer relative">
                                        <input type="radio" name="edit_comments" value="off" class="peer sr-only">
                                        <div class="p-3 rounded-lg border border-app-border bg-app-card peer-checked:border-red-500 peer-checked:bg-red-500/10 hover:bg-app-hover transition-all text-center">
                                            <i data-lucide="x-circle" class="w-5 h-5 mx-auto mb-1 text-app-text peer-checked:text-red-500"></i>
                                            <span class="text-xs font-bold text-app-text peer-checked:text-red-500">Disable</span>
                                        </div>
                                    </label>
                                </div>
                                <p class="text-[10px] text-app-textMuted mt-2 px-1 italic">
                                    <span class="font-bold">Allow:</span> Everyone can comment.<br>
                                    <span class="font-bold">Restrict:</span> View old comments, no new ones.<br>
                                    <span class="font-bold">Disable:</span> Hide all comments.
                                </p>
                            </div>

                            <div class="pt-4 flex flex-col md:flex-row gap-4">
                                <button type="button" onclick="window.history.back()" class="flex-1 py-3 rounded-xl border border-app-border text-app-text font-bold hover:bg-app-hover transition-colors">Cancel</button>
                                <button type="button" onclick="window.handleDeleteVideoFromEditPage()" class="flex-1 py-3 rounded-xl bg-red-50 text-red-500 border border-red-200 font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
                                </button>
                                <button type="submit" id="save-video-btn" class="flex-[2] bg-brand-teal text-white font-bold py-3 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i> Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="edit-product-page-container" class="hidden h-full w-full overflow-y-auto no-scrollbar py-10 px-6">
            <div class="max-w-4xl mx-auto w-full animate-slide-up pb-20">
                <button onclick="window.history.back()" class="mb-6 flex items-center gap-2 text-app-textMuted hover:text-app-text font-bold transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i> Back
                </button>

                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-extrabold text-app-text mb-2">Edit Product</h2>
                        <p class="text-app-textMuted">Update item details and inventory.</p>
                    </div>
                </div>

                <div class="bg-app-card border border-app-border rounded-2xl overflow-hidden shadow-lg p-8">
                    <form id="edit-product-page-form" onsubmit="window.handleSaveEditProductPage(event)" class="space-y-6">
                        <input type="hidden" id="edit-page-prod-id">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Title</label>
                                <input type="text" id="edit-page-prod-title" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none font-medium" required>
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Description</label>
                                <textarea id="edit-page-prod-desc" rows="4" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none resize-none font-medium"></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Tags</label>
                                <input type="text" id="edit-page-prod-tags" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Categories</label>
                                <div id="edit-page-category-chips" class="flex flex-wrap gap-2 mb-2 min-h-[2px]"></div>
                                <select id="edit-page-prod-category-select" onchange="window.handleAddCategory('edit-page', this)" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium cursor-pointer">
                                    <option value="" disabled selected>+ Add Category</option>
                                    <option value="Clothing">Clothing</option>
                                    <option value="Shoes">Shoes</option>
                                    <option value="Accessories">Accessories</option>
                                    <option value="Tech">Tech & Electronics</option>
                                    <option value="Home">Home & Living</option>
                                    <option value="Beauty">Beauty</option>
                                    <option value="Art">Art & Collectibles</option>
                                    <option value="Books">Books & Media</option>
                                    <option value="Gaming">Gaming</option>
                                    <option value="Sports">Sports & Outdoors</option>
                                    <option value="Pets">Pet Supplies</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Brand</label>
                                <input type="text" id="edit-page-prod-brand" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Condition</label>
                                <select id="edit-page-prod-condition" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium">
                                    <option value="New">New / With Tags</option>
                                    <option value="Like New">Like New</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Stock</label>
                                <input type="number" id="edit-page-prod-stock" min="0" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium">
                            </div>
                            
                            <div class="md:col-span-2 pt-4 border-t border-app-border">
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Shipping Method</label>
                                <select id="edit-page-prod-shipping" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium mb-4">
                                    <option value="Standard">Standard Shipping</option>
                                    <option value="Pickup">Local Pickup Only</option>
                                </select>

                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Shipping Cost</label>
                                <div class="flex items-center gap-6 mb-3">
                                    <label class="flex items-center gap-2 cursor-pointer group">
                                        <div class="relative flex items-center">
                                            <input type="radio" name="edit_page_shipping_cost_type" value="free" onchange="window.toggleEditPageShippingInput()" class="peer sr-only">
                                            <div class="w-5 h-5 border-2 border-app-border rounded-full peer-checked:border-brand-teal peer-checked:bg-brand-teal transition-all"></div>
                                            <div class="absolute w-2.5 h-2.5 bg-white rounded-full left-1.5 top-1.5 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                        </div>
                                        <span class="text-sm font-medium text-app-text group-hover:text-brand-teal transition-colors">Free Shipping</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer group">
                                         <div class="relative flex items-center">
                                            <input type="radio" name="edit_page_shipping_cost_type" value="paid" onchange="window.toggleEditPageShippingInput()" class="peer sr-only">
                                            <div class="w-5 h-5 border-2 border-app-border rounded-full peer-checked:border-brand-teal peer-checked:bg-brand-teal transition-all"></div>
                                            <div class="absolute w-2.5 h-2.5 bg-white rounded-full left-1.5 top-1.5 opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                                        </div>
                                        <span class="text-sm font-medium text-app-text group-hover:text-brand-teal transition-colors">Flat Rate</span>
                                    </label>
                                </div>
                                <div id="edit-page-shipping-cost-container" class="hidden animate-fade-in mb-6">
                                     <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-app-text font-bold">$</span>
                                        <input type="number" id="edit-page-prod-shipping-cost" oninput="window.updateEditPagePayout()" step="0.01" min="0" class="w-full pl-8 pr-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium" placeholder="0.00">
                                    </div>
                                </div>
                            </div>

                            <div class="md:col-span-2 pt-2">
                                 <h3 class="text-lg font-bold text-app-text border-b border-app-border pb-4 mb-4">Pricing</h3>
                                 
                                 <div class="bg-app-bg border border-app-border rounded-xl p-6 flex flex-col md:flex-row gap-8 items-center">
                                     <div class="flex-1 w-full">
                                        <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Price ($) <span class="text-red-500">*</span></label>
                                        <div class="relative">
                                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-app-text font-bold">$</span>
                                            <input type="number" id="edit-page-prod-price" step="0.01" min="1" oninput="window.updateEditPagePayout()" class="w-full pl-8 pr-4 py-4 rounded-xl border border-app-border bg-app-input text-app-text text-xl font-bold focus:border-brand-orange focus:ring-2 focus:ring-brand-orange/20 outline-none" placeholder="0.00" required>
                                        </div>
                                     </div>
                                     
                                     <div class="flex-1 w-full flex flex-col gap-2 border-l border-app-border pl-0 md:pl-8">
                                         <div class="flex justify-between text-sm">
                                             <span class="text-app-textMuted">Price</span>
                                             <span class="font-medium text-app-text" id="edit-page-calc-price">$0.00</span>
                                         </div>
                                         <div class="flex justify-between text-sm">
                                             <span class="text-app-textMuted">Shipping</span>
                                             <span class="font-medium text-app-text" id="edit-page-calc-shipping">$0.00</span>
                                         </div>
                                         <div class="flex justify-between text-sm">
                                             <span class="text-app-textMuted">Platform Fee (10%)</span>
                                             <span class="font-medium text-app-text" id="edit-page-calc-fee">-$0.00</span>
                                         </div>
                                         <div class="flex justify-between text-lg font-bold pt-2 border-t border-app-border">
                                             <span class="text-brand-teal">You Receive</span>
                                             <span class="text-brand-orange" id="edit-page-calc-payout">$0.00</span>
                                         </div>
                                         <div class="flex justify-between text-sm pt-1 text-app-textMuted">
                                             <span>Buyer Pays</span>
                                             <span class="font-bold" id="edit-page-calc-total">$0.00</span>
                                         </div>
                                     </div>
                                 </div>
                            </div>
                        </div>

                        <div class="pt-4 flex flex-col md:flex-row gap-4">
                            <button type="button" onclick="window.history.back()" class="flex-1 py-3 rounded-xl border border-app-border text-app-text font-bold hover:bg-app-hover transition-colors">Cancel</button>
                            <button type="button" onclick="window.handleDeleteProductFromEditPage()" class="flex-1 py-3 rounded-xl bg-red-50 text-red-500 border border-red-200 font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> Delete Product
                            </button>
                            <button type="submit" id="save-product-btn" class="flex-[2] bg-brand-teal text-white font-bold py-3 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- VIEW: ADMIN DASHBOARD -->
        <div id="admin-container" class="hidden h-full w-full overflow-y-auto no-scrollbar pt-10 px-6 pb-20 bg-app-bg">
            <div class="max-w-6xl mx-auto w-full animate-slide-up">
        
                <!-- ROW 1: Header & Main Tabs -->
                <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                    <div>
                        <h2 class="text-3xl font-extrabold text-app-text mb-2 flex items-center gap-2">
                            <i data-lucide="shield" class="w-8 h-8 text-brand-orange"></i> Admin Dashboard
                        </h2>
                        <p class="text-app-textMuted">Manage content, users, and support tickets.</p>
                    </div>
                    <!-- Top Tabs (Reports, Support, Roles only) -->
                    <div class="flex bg-app-card border border-app-border rounded-xl p-1 shrink-0 shadow-sm">
                        <button onclick="window.switchAdminTab('reports')" id="admin-tab-reports" class="px-6 py-2 rounded-lg text-sm font-bold bg-app-text text-app-bg shadow-sm transition-all">Reports</button>
                        <button onclick="window.switchAdminTab('support')" id="admin-tab-support" class="px-6 py-2 rounded-lg text-sm font-bold text-app-textMuted hover:text-app-text transition-all">Support</button>
                        <button onclick="window.switchAdminTab('roles')" id="admin-tab-roles" class="px-6 py-2 rounded-lg text-sm font-bold text-app-textMuted hover:text-app-text transition-all">Roles</button>
                    </div>
                </div>

                <!-- ROW 2: Search Bar & User Status Filters -->
                <div class="flex flex-col md:flex-row gap-4 mb-8 items-stretch md:items-center z-20">
                    
                    <!-- Search (Left Aligned) -->
                    <div class="relative flex-1 group">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-app-textMuted group-focus-within:text-brand-orange transition-colors"></i>
                        <input type="text" oninput="window.handleAdminUserSearch(this.value)" placeholder="Search users to moderate (username or email)..." class="w-full pl-12 pr-4 py-3 rounded-2xl bg-app-card border border-app-border text-app-text outline-none focus:ring-2 focus:ring-brand-orange/20 focus:border-brand-orange transition-all shadow-sm h-full">
                        <!-- Search Results Dropdown -->
                        <div id="admin-user-search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-app-card border border-app-border rounded-xl shadow-xl overflow-hidden max-h-64 overflow-y-auto z-50"></div>
                    </div>

                    <!-- User Status Filters (Right Aligned, Same Height) -->
                    <div class="flex bg-app-card border border-app-border rounded-xl p-1 shrink-0 h-[52px] items-center shadow-sm">
                        <button onclick="window.filterPunishedUsers('bans')" id="user-filter-bans" class="h-full px-6 rounded-lg text-sm font-bold text-app-textMuted hover:text-app-text transition-all border border-transparent">Bans</button>
                        <div class="w-px h-6 bg-app-border"></div>
                        <button onclick="window.filterPunishedUsers('strikes')" id="user-filter-strikes" class="h-full px-6 rounded-lg text-sm font-bold text-app-textMuted hover:text-app-text transition-all border border-transparent">Strikes</button>
                        <div class="w-px h-6 bg-app-border"></div>
                        <button onclick="window.filterPunishedUsers('warns')" id="user-filter-warns" class="h-full px-6 rounded-lg text-sm font-bold text-app-textMuted hover:text-app-text transition-all border border-transparent">Warns</button>
                    </div>
                </div>

                <!-- VIEW: USERS LIST (Controlled by Bottom Bar) -->
                <div id="admin-view-users" class="hidden space-y-6">
                    <div id="admin-users-list" class="space-y-4">
                        <div class="text-center py-20 text-app-textMuted">Loading users...</div>
                    </div>
                </div>

                <!-- VIEW: REPORTS -->
                <div id="admin-view-reports" class="space-y-6">
                    <div class="flex flex-wrap items-center gap-3 pb-4 border-b border-app-border">
                        <span class="text-xs font-bold text-app-textMuted uppercase tracking-wider mr-2">Filter By:</span>
                        <button onclick="window.filterReports('all')" class="report-filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-app-text text-app-bg transition-all" data-type="all">All</button>
                        <button onclick="window.filterReports('video')" class="report-filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-app-card border border-app-border text-app-textMuted hover:text-app-text transition-all" data-type="video">Content</button>
                        <button onclick="window.filterReports('product')" class="report-filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-app-card border border-app-border text-app-textMuted hover:text-app-text transition-all" data-type="product">Products</button>
                        <button onclick="window.filterReports('comment')" class="report-filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-app-card border border-app-border text-app-textMuted hover:text-app-text transition-all" data-type="comment">Comments</button>
                        <button onclick="window.filterReports('user')" class="report-filter-btn px-4 py-1.5 rounded-full text-xs font-bold bg-app-card border border-app-border text-app-textMuted hover:text-app-text transition-all" data-type="user">Users</button>
                    </div>
                    <div id="admin-reports-list" class="space-y-4">
                        <div class="text-center py-20 text-app-textMuted">Loading reports...</div>
                    </div>
                </div>

                <!-- VIEW: SUPPORT TICKETS -->
                <div id="admin-view-support" class="hidden space-y-4">
                    <h3 class="text-lg font-bold text-app-text mb-4">Customer Support Inbox</h3>
                    <div id="admin-support-list" class="space-y-4">
                        <div class="text-center py-20 text-app-textMuted">Loading tickets...</div>
                    </div>
                </div>

                <!-- VIEW: ROLES -->
                <div id="admin-view-roles" class="hidden max-w-2xl">
                    <div class="bg-app-card border border-app-border rounded-2xl p-6 mb-6">
                        <h3 class="text-lg font-bold text-app-text mb-4">Manage User Roles</h3>
                        <p class="text-sm text-app-textMuted mb-4">Enter a User ID to assign permissions.</p>
                        <form onsubmit="window.handleRoleUpdate(event)" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">User ID</label>
                                <input type="text" id="admin-role-uid" class="w-full px-4 py-3 rounded-xl bg-app-input border border-app-border text-app-text outline-none focus:border-brand-teal font-mono text-sm" placeholder="e.g. 7d9f8g7d..." required>
                            </div>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="admin-role-is-admin" class="w-5 h-5 text-brand-teal rounded focus:ring-brand-teal">
                                    <span class="font-bold text-app-text">Is Admin?</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="admin-role-is-mod" class="w-5 h-5 text-brand-teal rounded focus:ring-brand-teal">
                                    <span class="font-bold text-app-text">Is Moderator?</span>
                                </label>
                            </div>
                            <button type="submit" class="bg-brand-teal text-white font-bold py-3 px-6 rounded-xl hover:bg-brand-teal/90 transition-all shadow-lg">Update Role</button>
                        </form>
                    </div>
                    <div class="bg-app-card border border-app-border rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-app-text mb-4">Current Staff</h3>
                        <div id="admin-staff-list" class="space-y-2 text-sm text-app-textMuted">Loading staff list...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODERATION PANEL (Slide-in from right) -->
        <aside id="moderation-panel" class="fixed z-[150] bg-app-bg shadow-2xl transition-transform duration-300 flex flex-col border-l border-app-border inset-y-0 right-0 w-full md:w-[480px] translate-x-full">
            
            <!-- Header -->
            <div class="p-4 border-b border-app-border flex items-center justify-between bg-app-card">
                <h3 class="font-bold text-lg text-app-text flex items-center gap-2">
                    <i data-lucide="shield-alert" class="w-5 h-5 text-red-500"></i> Moderation
                </h3>
                <button onclick="window.closeModerationPanel()" class="p-2 hover:bg-app-hover rounded-full text-app-textMuted transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                
                <!-- User Info -->
                <div class="flex items-center gap-4 p-4 bg-app-card rounded-xl border border-app-border">
                    <div class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden shrink-0">
                        <img id="mod-user-avatar" src="" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h4 id="mod-user-name" class="font-bold text-lg text-app-text">@username</h4>
                        <p id="mod-user-id" class="text-xs font-mono text-app-textMuted select-all">UID: ...</p>
                        <div id="mod-user-stats" class="flex gap-3 mt-2 text-xs text-app-textMuted">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Context (Why are we here?) -->
                <div class="bg-app-bg border border-app-border rounded-xl p-4">
                    <p class="text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Report Context</p>
                    <div id="mod-context-display" class="text-sm text-app-text font-medium bg-red-50 dark:bg-red-900/10 p-3 rounded-lg mb-2">
                        Loading context...
                    </div>
                    <p class="text-xs text-app-textMuted">Violation: <span id="mod-violation-reason" class="font-bold text-red-500">...</span></p>
                </div>

                <!-- Action Controls -->
                <div class="bg-app-bg border border-app-border rounded-xl p-4 mb-4">

                    <!-- Action Buttons -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="window.handleModAction('warn')" class="flex flex-col items-center justify-center p-3 bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-600 border border-yellow-500/20 rounded-xl transition-all font-bold text-xs gap-1">
                            <i data-lucide="triangle-alert" class="w-5 h-5"></i> Warn
                        </button>
                        <button onclick="window.handleModAction('strike')" class="flex flex-col items-center justify-center p-3 bg-orange-500/10 hover:bg-orange-500/20 text-orange-600 border border-orange-500/20 rounded-xl transition-all font-bold text-xs gap-1">
                            <i data-lucide="zap" class="w-5 h-5"></i> Strike
                        </button>
                    </div>

                    <div class="bg-app-bg border border-app-border rounded-xl p-4 mb-4">
                        <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Violation Type</label>
                        <select id="mod-violation-type" class="w-full bg-app-card border border-app-border rounded-lg px-3 py-2 text-sm font-bold text-app-text mb-3 outline-none focus:border-brand-teal">
                            <option value="General Violation">General Violation</option>
                            <option value="Spam/Botting">Spam / Botting</option>
                            <option value="Harassment/Bullying">Harassment / Bullying</option>
                            <option value="Hate Speech">Hate Speech</option>
                            <option value="Inappropriate Content">Inappropriate Content</option>
                            <option value="Scam/Fraud">Scam / Fraud</option>
                            <option value="Impersonation">Impersonation</option>
                            <option value="Intellectual Property">Intellectual Property</option>
                        </select>

                        <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Custom Reason (Optional)</label>
                        <textarea id="mod-violation-custom" rows="2" class="w-full bg-app-card border border-app-border rounded-lg px-3 py-2 text-sm text-app-text mb-2 outline-none focus:border-brand-teal resize-none" placeholder="Add specific details..."></textarea>
                    </div>

                    <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">
                        Ban Duration
                    </label>
                    <select id="mod-ban-duration" class="w-full bg-app-card border border-app-border rounded-lg px-3 py-2 text-sm font-bold text-app-text mb-4 outline-none focus:border-brand-teal">
                        <option value="24h">24 Hours</option>
                        <option value="3d">3 Days</option>
                        <option value="7d">7 Days</option>
                        <option value="30d">30 Days</option>
                        <option value="permanent">Permanent</option>
                    </select>

                    <!-- Ban Button -->
                    <button onclick="window.handleModAction('ban')" class="w-full flex items-center justify-center p-3 bg-red-500 text-white hover:bg-red-600 rounded-xl transition-all font-bold text-sm gap-2 shadow-lg shadow-red-500/20">
                        <i data-lucide="ban" class="w-5 h-5"></i> Execute Ban
                    </button>
                </div>

                <!-- History Log -->
                <div>
                    <h4 class="font-bold text-app-text mb-3">Moderation History</h4>
                    <div id="mod-history-log" class="space-y-3">
                        <div class="text-center text-xs text-app-textMuted py-4">Loading history...</div>
                    </div>
                </div>

            </div>
        </aside>
    </main>

    <!-- RESTRICTION NOTICE MODAL -->
    <div id="restriction-modal" class="hidden fixed inset-0 z-[300] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up border-2 border-red-500 relative">
            <div class="p-8 text-center">
                <div class="w-20 h-20 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="zap" class="w-10 h-10 fill-current"></i>
                </div>
                <h2 class="text-3xl font-extrabold text-app-text mb-2">Account Restricted</h2>
                <p class="text-red-500 font-bold mb-6 text-lg">You have received a strike.</p>
                
                <div class="bg-app-card border border-app-border rounded-xl p-6 mb-6 text-left">
                    <p class="text-sm text-app-text font-bold mb-3 flex items-center gap-2">
                        <i data-lucide="lock" class="w-4 h-4"></i> Access Suspended:
                    </p>
                    <ul class="list-disc list-inside text-xs text-app-textMuted mb-4 space-y-1 font-medium">
                        <li>Commenting on content</li>
                        <li>Posting new content</li>
                        <li>Listing products for sale</li>
                    </ul>
                    <div class="border-t border-app-border pt-3">
                        <p class="text-[10px] text-app-textMuted uppercase tracking-wider font-bold mb-1">Restriction lifts on:</p>
                        <p id="restriction-date-display" class="text-lg font-mono font-bold text-app-text">Loading...</p>
                    </div>
                </div>

                <p class="text-xs text-app-textMuted mb-8">
                    Please review our <a href="#" class="text-brand-teal hover:underline font-bold">Terms of Service</a>. Further violations may result in a permanent ban.
                </p>

                <button onclick="document.getElementById('restriction-modal').classList.add('hidden')" class="w-full bg-app-text text-app-bg font-bold py-4 rounded-xl hover:opacity-90 transition-opacity">
                    I Understand
                </button>
            </div>
        </div>
    </div>

    <!-- BAN NOTICE MODAL -->
    <div id="ban-modal" class="hidden fixed inset-0 z-[400] flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="bg-app-bg w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up border-2 border-red-600 relative">
            <div class="p-8 text-center">
                <div class="w-24 h-24 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse">
                    <i data-lucide="ban" class="w-12 h-12 fill-current"></i>
                </div>
                <h2 class="text-3xl font-black text-app-text mb-2 uppercase tracking-tight">Account Suspended</h2>
                <p class="text-red-500 font-bold mb-6 text-lg">Your access has been revoked.</p>
                
                <div class="bg-app-card border border-app-border rounded-xl p-6 mb-6 text-left">
                    <p class="text-sm text-app-textMuted font-medium mb-2">Reason for suspension:</p>
                    <p id="ban-reason-display" class="text-app-text font-bold text-lg mb-4 border-b border-app-border pb-2">Violation of Terms</p>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-app-textMuted uppercase tracking-wider">Lift Date</span>
                        <span id="ban-date-display" class="text-sm font-mono font-bold text-brand-teal">Loading...</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <!-- Primary Action: Log Out -->
                    <button onclick="window.handleLogout()" class="w-full bg-app-text text-app-bg font-bold py-4 rounded-xl hover:opacity-90 transition-opacity shadow-lg">
                        Log Out
                    </button>
                    
                    <!-- Secondary Actions: Terms & Support (Side-by-Side) -->
                    <div class="flex items-center justify-center gap-6 pt-1">
                        <a href="#" class="text-xs font-bold text-app-textMuted hover:text-app-text transition-colors">
                            Terms of Service
                        </a>
                        <span class="text-app-textMuted/30">â¢</span>
                        <button onclick="window.navigateTo('support'); document.getElementById('ban-modal').classList.add('hidden');" class="text-xs font-bold text-app-textMuted hover:text-app-text transition-colors">
                            Contact Support
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL (UNCHANGED) -->
    <div id="auth-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up relative">
            <button id="modal-close" onclick="toggleAuthModal(false)" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="p-8">
                <div class="text-center mb-6">
                    <h2 id="modal-title" class="text-3xl font-extrabold text-app-text mb-2">Welcome Back</h2>
                    <p id="modal-subtitle" class="text-app-textMuted text-sm">Securely access your account</p>
                </div>
                <div id="auth-error" class="hidden mb-4 p-3 bg-red-50 text-red-500 text-sm rounded-lg border border-red-100 text-center font-medium"></div>
                <form id="auth-form" class="space-y-4" onsubmit="return false;">
                    <div id="google-btn-container">
                        <button type="button" onclick="handleGoogleLogin()" class="w-full bg-app-input text-app-text font-bold py-3.5 px-4 rounded-xl border border-app-border shadow-sm hover:bg-app-hover transition-all flex items-center justify-center gap-3 relative group">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            <span>Continue with Google</span>
                        </button>
                        <div class="relative flex py-4 items-center">
                            <div class="flex-grow border-t border-app-border"></div>
                            <span class="flex-shrink-0 mx-4 text-app-textMuted text-xs font-bold uppercase tracking-wider">Or with email</span>
                            <div class="flex-grow border-t border-app-border"></div>
                        </div>
                    </div>
                    <div id="username-container" class="hidden">
                        <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Username</label>
                        <input type="text" id="username" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none transition-all font-medium" placeholder="jace_design" pattern="[a-zA-Z0-9_]{3,20}" title="3-20 characters, letters, numbers, and underscores only.">
                    </div>
                    <div id="email-fields">
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Email Address</label>
                            <input type="email" id="email" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none transition-all font-medium" placeholder="name@example.com">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Password</label>
                            <input type="password" id="password" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal focus:ring-2 focus:ring-brand-teal/20 outline-none transition-all font-medium" placeholder="â¢â¢â¢â¢â¢â¢â¢â¢">
                        </div>
                    </div>
                    <button id="modal-submit" type="submit" class="w-full bg-brand-teal text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all duration-200 mt-2">
                        Login
                    </button>
                </form>
                <div id="toggle-container" class="mt-6 text-center text-sm text-app-textMuted">
                    <span id="modal-toggle-text">New here? <a href="#" onclick="toggleAuthMode('signup')" class="text-brand-orange font-bold hover:underline">Create Account</a></span>
                </div>
            </div>
            <div class="bg-app-card p-4 text-center border-t border-app-border">
                <p class="text-xs text-app-textMuted">Secured by Firebase Auth</p>
            </div>
        </div>
    </div>
    
    <!-- EDIT PROFILE MODAL -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up relative">
            <button onclick="window.closeEditProfileModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="p-8">
                <h2 class="text-2xl font-extrabold text-app-text mb-6">Edit Profile</h2>
                <form onsubmit="window.saveProfileChanges(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Bio</label>
                        <textarea id="edit-bio-input" rows="3" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20 resize-none"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-brand-teal text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all mt-4">
                        Save Changes
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- EDIT VIDEO MODAL -->
    <div id="edit-video-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up relative">
            <button onclick="document.getElementById('edit-video-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="p-8">
                <h2 class="text-2xl font-extrabold text-app-text mb-6">Edit Content</h2>
                <form onsubmit="window.handleEditVideoSubmit(event)" class="space-y-4">
                    <input type="hidden" id="edit-video-path">
                    <div>
                        <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Title</label>
                        <input type="text" id="edit-video-title" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Description</label>
                        <textarea id="edit-video-desc" rows="3" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20 resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Tags (comma separated)</label>
                        <input type="text" id="edit-video-tags" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20">
                    </div>
                    <button type="submit" class="w-full bg-brand-teal text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all mt-4">
                        Save Changes
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- EDIT PRODUCT MODAL -->
    <div id="edit-product-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-slide-up relative flex flex-col max-h-[90vh]">
            <button onclick="document.getElementById('edit-product-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="p-8 overflow-y-auto no-scrollbar">
                <h2 class="text-2xl font-extrabold text-app-text mb-6">Edit Product</h2>
                <form onsubmit="window.handleEditProductSubmit(event)" class="space-y-4">
                    <input type="hidden" id="edit-product-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Title</label>
                            <input type="text" id="edit-prod-title" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Description</label>
                            <textarea id="edit-prod-desc" rows="3" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20 resize-none"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Categories</label>
                            <div id="edit-category-chips" class="flex flex-wrap gap-2 mb-2 min-h-[2px]"></div>
                            <select id="edit-prod-category-select" onchange="window.handleAddCategory('edit', this)" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium cursor-pointer">
                                <option value="" disabled selected>+ Add Category</option>
                                <option value="Clothing">Clothing</option>
                                <option value="Shoes">Shoes</option>
                                <option value="Accessories">Accessories</option>
                                <option value="Tech">Tech & Electronics</option>
                                <option value="Home">Home & Living</option>
                                <option value="Beauty">Beauty</option>
                                <option value="Art">Art & Collectibles</option>
                                <option value="Books">Books & Media</option>
                                <option value="Gaming">Gaming</option>
                                <option value="Sports">Sports & Outdoors</option>
                                <option value="Pets">Pet Supplies</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Brand</label>
                            <input type="text" id="edit-prod-brand" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Tags</label>
                            <input type="text" id="edit-prod-tags" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:border-brand-teal" placeholder="tags...">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Condition</label>
                            <select id="edit-prod-condition" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none">
                                <option value="New">New / With Tags</option>
                                <option value="Like New">Like New</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                                <option value="Poor">Poor</option>
                            </select>
                        </div>

                         <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Stock Available</label>
                            <input type="number" id="edit-prod-stock" min="1" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20" required>
                        </div>
                        
                         <div>
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Price ($)</label>
                            <input type="number" id="edit-prod-price" step="0.01" min="1" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:ring-2 focus:ring-brand-teal/20" required>
                        </div>

                         <div class="md:col-span-2 pt-2 border-t border-app-border">
                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Shipping Method</label>
                            <select id="edit-prod-shipping" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none mb-3">
                                <option value="Standard">Standard Shipping</option>
                                <option value="Pickup">Local Pickup Only</option>
                            </select>
                            
                            <div class="flex items-center gap-6 mb-3">
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="radio" name="edit_shipping_cost_type" value="free" checked onchange="document.getElementById('edit-shipping-cost-container').classList.add('hidden')" class="w-4 h-4 text-brand-teal focus:ring-brand-teal">
                                    <span class="text-sm font-medium text-app-text">Free Shipping</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="radio" name="edit_shipping_cost_type" value="paid" onchange="document.getElementById('edit-shipping-cost-container').classList.remove('hidden')" class="w-4 h-4 text-brand-teal focus:ring-brand-teal">
                                    <span class="text-sm font-medium text-app-text">Flat Rate</span>
                                </label>
                            </div>
                            
                            <div id="edit-shipping-cost-container" class="hidden mb-3">
                                <input type="number" id="edit-prod-shipping-cost" step="0.01" min="0" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none" placeholder="Shipping Cost">
                            </div>

                            <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Location</label>
                            <div class="relative">
                                <select id="edit-prod-location" class="w-full px-4 py-3 rounded-lg border border-app-border bg-app-input text-app-text focus:border-brand-teal outline-none font-medium appearance-none cursor-pointer">
                                    <option value="" disabled selected>Select Country</option>
                                    <option value="Afghanistan">Afghanistan</option>
                                    <option value="Albania">Albania</option>
                                    <option value="Algeria">Algeria</option>
                                    <option value="Argentina">Argentina</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Austria">Austria</option>
                                    <option value="Bangladesh">Bangladesh</option>
                                    <option value="Belgium">Belgium</option>
                                    <option value="Brazil">Brazil</option>
                                    <option value="Canada">Canada</option>
                                    <option value="Chile">Chile</option>
                                    <option value="China">China</option>
                                    <option value="Colombia">Colombia</option>
                                    <option value="Denmark">Denmark</option>
                                    <option value="Egypt">Egypt</option>
                                    <option value="Finland">Finland</option>
                                    <option value="France">France</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Greece">Greece</option>
                                    <option value="India">India</option>
                                    <option value="Indonesia">Indonesia</option>
                                    <option value="Ireland">Ireland</option>
                                    <option value="Italy">Italy</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Malaysia">Malaysia</option>
                                    <option value="Mexico">Mexico</option>
                                    <option value="Netherlands">Netherlands</option>
                                    <option value="New Zealand">New Zealand</option>
                                    <option value="Nigeria">Nigeria</option>
                                    <option value="Norway">Norway</option>
                                    <option value="Pakistan">Pakistan</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="Poland">Poland</option>
                                    <option value="Portugal">Portugal</option>
                                    <option value="Russia">Russia</option>
                                    <option value="Saudi Arabia">Saudi Arabia</option>
                                    <option value="Singapore">Singapore</option>
                                    <option value="South Africa">South Africa</option>
                                    <option value="South Korea">South Korea</option>
                                    <option value="Spain">Spain</option>
                                    <option value="Sweden">Sweden</option>
                                    <option value="Switzerland">Switzerland</option>
                                    <option value="Thailand">Thailand</option>
                                    <option value="Turkey">Turkey</option>
                                    <option value="Ukraine">Ukraine</option>
                                    <option value="United Arab Emirates">United Arab Emirates</option>
                                    <option value="United Kingdom">United Kingdom</option>
                                    <option value="United States">United States</option>
                                    <option value="Vietnam">Vietnam</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-app-textMuted">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>
                         </div>
                    </div>

                    <button type="submit" class="w-full bg-brand-teal text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all mt-4">
                        Save Changes
                    </button>
                </form>
            </div>
        </div>
    </div>

        <!-- STORE FILTER MODAL -->
    <div id="store-filter-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center modal-backdrop p-4">
        <div class="bg-app-bg w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-app-border bg-app-card flex justify-between items-center">
                <h3 class="font-bold text-lg text-app-text">Filters</h3>
                <button onclick="window.closeStoreFilterModal()" class="p-1 hover:bg-app-hover rounded-full text-app-textMuted">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-6">
                <!-- Price Range -->
                <div>
                    <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Price Range ($)</label>
                    <div class="flex items-center gap-3">
                        <input type="number" id="filter-min-price" placeholder="Min" class="w-full px-3 py-2 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:border-brand-teal">
                        <span class="text-app-textMuted">-</span>
                        <input type="number" id="filter-max-price" placeholder="Max" class="w-full px-3 py-2 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:border-brand-teal">
                    </div>
                </div>

                <!-- Brand -->
                <div>
                    <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Brand</label>
                    <input type="text" id="filter-brand" placeholder="e.g. Nike" class="w-full px-3 py-2 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:border-brand-teal">
                </div>

                <!-- Condition -->
                <div>
                    <label class="block text-xs font-bold text-app-textMuted uppercase tracking-wider mb-2">Condition</label>
                    <select id="filter-condition" class="w-full px-3 py-2 rounded-lg border border-app-border bg-app-input text-app-text outline-none focus:border-brand-teal">
                        <option value="">Any Condition</option>
                        <option value="New">New / With Tags</option>
                        <option value="Like New">Like New</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                    </select>
                </div>

                <!-- Toggles -->
                <div class="space-y-3 pt-2">
                    <label class="flex items-center justify-between cursor-pointer group">
                        <span class="text-sm font-bold text-app-text">Free Shipping Only</span>
                        <input type="checkbox" id="filter-shipping" class="w-5 h-5 rounded border-app-border text-brand-teal focus:ring-brand-teal">
                    </label>
                    <label class="flex items-center justify-between cursor-pointer group">
                        <span class="text-sm font-bold text-app-text">In Stock Only</span>
                        <input type="checkbox" id="filter-stock" class="w-5 h-5 rounded border-app-border text-brand-teal focus:ring-brand-teal">
                    </label>
                </div>
            </div>

            <div class="p-4 border-t border-app-border bg-app-card flex gap-3">
                <button onclick="window.clearStoreFilters()" class="flex-1 py-3 rounded-xl border border-app-border font-bold text-app-text hover:bg-app-hover transition-colors">Clear</button>
                <button onclick="window.applyStoreFiltersFromModal()" class="flex-1 py-3 rounded-xl bg-brand-teal text-white font-bold shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all">Apply</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC (CONSOLIDATED) -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut,
            updateProfile,
            updatePassword,
            updateEmail 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
                
                // Import Firebase Storage
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Import Firebase Functions (Correct Source)
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

        // Import Firestore
        import { 
            getFirestore, 
            collection, 
            collectionGroup,
            addDoc, 
            getDocs,
            onSnapshot, 
            query, 
            orderBy, 
            where, 
            doc, 
            setDoc, 
            getDoc, 
            deleteDoc,
            updateDoc,
            serverTimestamp,
            increment,
            arrayUnion,
            arrayRemove,
            writeBatch,
            getAggregateFromServer,
            sum,
            limit,
            count,
            deleteField
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDBybMZAZuiA6YcwOZ5Y9hPK7BzD5O0LQs",
            authDomain: "jace-login-test.firebaseapp.com",
            projectId: "jace-login-test",
            storageBucket: "jace-login-test.firebasestorage.app",
            messagingSenderId: "108661493454",
            appId: "1:108661493454:web:74d680a08b16005dc78a9f",
            measurementId: "G-QQGVKPMLVK"
        };

        const FYP_CONFIG = {
            weights: {
                watchTime: 0.4,
                completion: 0.25,
                like: 0.15,
                comment: 0.1,
                share: 0.1
            },
            decay: {
                freshness: 0.05 // Score reduction per hour
            }
        };

        function formatNumber(num) {
            // Safety check: if num is undefined, null, or Not-a-Number, return '0'
            if (num === undefined || num === null || isNaN(num)) {
                return '0';
            }
            return num >= 1000 ? (num / 1000).toFixed(1) + 'k' : num.toString();
        }

        window.formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount || 0);
        };

        function parseCount(str) {
            if (!str) return 0;
            str = str.toString().toLowerCase().trim();
            if (str.includes('k')) return Math.round(parseFloat(str) * 1000);
            if (str.includes('m')) return Math.round(parseFloat(str) * 1000000);
            return parseInt(str.replace(/,/g, '')) || 0;
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig, "ReviewSystem");
        const auth = getAuth(app);
        const storage = getStorage(app);
        const db = getFirestore(app); 
        const googleProvider = new GoogleAuthProvider();
        const functions = getFunctions(app, "us-central1");
   
        // Initialize Backend Functions
        const getForYouFeedFn = httpsCallable(functions, 'getForYouFeed');
        const logInteractionFn = httpsCallable(functions, 'logInteraction');
        const createVideoFn = httpsCallable(functions, 'createVideo');

        window.auth = auth;

        // --- DATA CONSTANTS (Fallback) ---
        const FEED_DATA = [

            {
                id: '1',
                videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4',
                description: 'The ultimate portable speaker for your summer adventures! ðµâï¸ #SummerVibes #Tech',
                likes: 12400,
                comments: 450,
                shares: 120,
                views: 54000,
                user: { id: 'u1', username: 'tech_guru', avatarUrl: 'https://picsum.photos/100/100?random=1' },
                product: { id: 'p1', title: 'SoundWave Pro Speaker', price: 89.99, currency: '$' }
            },
            {
                id: '2',
                videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                description: 'Check out this amazing 3D printed mechanical setup! ð¤âï¸ #Engineering #3DPrinting',
                likes: 8900,
                comments: 210,
                shares: 85,
                views: 22000,
                user: { id: 'u2', username: 'maker_space', avatarUrl: 'https://picsum.photos/100/100?random=2' },
                product: { id: 'p2', title: 'Creality Ender 3 V2', price: 249.00, currency: '$' }
            },
            {
                id: '3',
                videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4',
                description: 'Morning routines made better with this coffee machine ââ¨ #CoffeeLover #MorningRoutine',
                likes: 45000,
                comments: 1200,
                shares: 3400,
                views: 120000,
                user: { id: 'u3', username: 'lifestyle_daily', avatarUrl: 'https://picsum.photos/100/100?random=3' },
                product: { id: 'p3', title: 'BaristaExpress Machine', price: 599.99, currency: '$' }
            },
            {
                id: '4',
                videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                description: 'Nature is wild! Look at this bunny go ð°ð² #Nature #Wildlife',
                likes: 3200,
                comments: 89,
                shares: 45,
                views: 9500,
                user: { id: 'u4', username: 'nature_focus', avatarUrl: 'https://picsum.photos/100/100?random=4' },
            },
            {
                id: '5',
                videoUrl: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4',
                description: 'Road trip essentials you strictly need! ðð¨ #Travel #RoadTrip',
                likes: 15600,
                comments: 670,
                shares: 890,
                views: 45000,
                user: { id: 'u5', username: 'travel_junkie', avatarUrl: 'https://picsum.photos/100/100?random=5' },
                product: { id: 'p5', title: 'Car Mount & Organizer', price: 24.99, currency: '$' }
            },
        ];

        // Mock comments for preview videos
        const MOCK_COMMENTS = [
            { id: 'm1', userId: 'mock1', username: 'fan_123', text: 'This is awesome! ð¥', avatarUrl: 'https://ui-avatars.com/api/?name=fan_123&background=random', likes: 12, timestamp: new Date() },
            { id: 'm2', userId: 'mock2', username: 'curious_george', text: 'Where can I get this?', avatarUrl: 'https://ui-avatars.com/api/?name=curious_george&background=random', likes: 5, timestamp: new Date(Date.now() - 3600000) },
            { id: 'm3', userId: 'mock3', username: 'tech_lover', text: 'Great review thanks.', avatarUrl: 'https://ui-avatars.com/api/?name=tech_lover&background=random', likes: 2, timestamp: new Date(Date.now() - 7200000) },
            { id: 'm4', userId: 'mock4', username: 'cool_cat', text: 'Needs more cowbell.', avatarUrl: 'https://ui-avatars.com/api/?name=cool_cat&background=random', likes: 0, timestamp: new Date(Date.now() - 10000000) }
        ];

        // UI Elements
        const authBtn = document.getElementById('auth-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const createProductBtn = document.getElementById('create-product-btn');
        const userDisplay = document.getElementById('user-display');
        const authModal = document.getElementById('auth-modal');
        const authError = document.getElementById('auth-error');
        const usernameContainer = document.getElementById('username-container');
        const emailFields = document.getElementById('email-fields');
        const googleBtnContainer = document.getElementById('google-btn-container');
        const toggleContainer = document.getElementById('toggle-container');
        const modalClose = document.getElementById('modal-close');
        const editProfileModal = document.getElementById('edit-profile-modal');

        // Navigation Elements
        const feedContainer = document.getElementById('feed-container');
        const profileContainer = document.getElementById('profile-container');
        const settingsContainer = document.getElementById('settings-container');
        const uploadContainer = document.getElementById('upload-container');
        const createProductContainer = document.getElementById('create-product-container');
        const exploreContainer = document.getElementById('explore-container'); 
        const inboxContainer = document.getElementById('inbox-container');
        const storeContainer = document.getElementById('store-container');
        const cartContainer = document.getElementById('cart-container');
        const checkoutContainer = document.getElementById('checkout-container');
        const cartFab = document.getElementById('cart-fab');

        const navFeed = document.getElementById('nav-feed');
        const navProfile = document.getElementById('nav-profile');
        const navSettings = document.getElementById('nav-settings');
        const navExplore = document.getElementById('nav-explore');
        const navInbox = document.getElementById('nav-inbox');
        const navStore = document.getElementById('nav-store');

        let currentAuthMode = 'login'; 
        let selectedVideoFile = null;
        let selectedSlideFiles = [];
        let currentCommentVideoPath = null;
        let currentCommentVideoId = null;
        let unsubscribeComments = null;
        let replyingTo = null; // State for replies { id: string, username: string }

        let currentViewedProfileId = null;
        let blockedUsers = new Set();
        let allExploreVideos = []; // Store fetched videos for search filtering
        let viewedVideos = new Set(); // Track viewed videos to avoid double counting
        let userSearchTimeout = null;
        let currentReviewRating = 0;
        let presenceInterval = null;
        let profileStatusUnsub = null; // Track profile listener
        let chatStatusUnsub = null;    // Track chat listener

        let currentUserRole = { admin: false, mod: false };
        let unsubscribeReports = null;
        let currentReportFilter = 'all'; 
        let unsubscribeSupportTickets = null;

        // Inbox State
        let currentInboxTab = 'notifications';
        let activeConversationId = null;
        let unsubscribeNotifications = null;
        let unsubscribeConversations = null;
        let unsubscribeMessages = null;

        // Share State
        let currentShareVideo = null; // { id, path, url, authorId }
        let currentShareProfile = null;

        // Store State
        let currentStoreProductId = null;
        let currentStoreSellerId = null;
        let currentProductData = null;
        let allStoreProducts = [];
        let unsubscribeStoreFeed = null;
        let unsubscribeCart = null;
        let currentCheckoutItem = null;

        let storeFilterState = {
            category: 'All',
            minPrice: '',
            maxPrice: '',
            brand: '',
            condition: '',
            freeShipping: false,
            inStock: false
        };

        // --- CHECKOUT & PAYPAL STATE ---
        let checkoutItemsBuffer = []; // Items currently being purchased
        let checkoutTotalAmount = 0;
        let currentSoldFilter = 'to-ship'; // 'to-ship', 'in-transit', 'canceled'
        let unsubscribeSoldOrders = null;
        let unsubscribeBuyerOrders = null;

        // Create Product State
        let productImages = []; // Array of File objects
        let userProducts = []; // New state for fetched products

        // Listener References
        let unsubscribeFeed = null;
        let unsubscribeProfile = null;
        let unsubscribeLikes = null;
        let unsubscribeExplore = null; 
        let unsubscribeReposts = null;
        let unsubscribeProducts = null;

        // Confirmation Modal State
        let confirmCallback = null;

        // Likes Tab State
        let currentLikesFilter = 'videos'; // 'videos' or 'products'

        let currentWatchSession = { videoId: null, startTime: 0, tags: [] };

        window.myFollowing = new Set();
        window.engagementIntervals = {}; 
        window.uploadSlideIndex = 0; 
        window.currentReportFilter = 'all'; 
        window.unsubscribeReports = null;
        window.unsubscribeSupportTickets = null;

        function onVideoStart(videoData) {
            if (!videoData) return;
            currentWatchSession = {
                videoId: videoData.id,
                startTime: Date.now(),
                tags: videoData.tags || []
            };
        }

        function onVideoEnd() {
            if (!currentWatchSession.videoId) return;

            const duration = (Date.now() - currentWatchSession.startTime) / 1000;
            
            // Logic: If watched > 5 seconds, boost the associated tags locally
            if (duration > 5) {
                const interests = JSON.parse(localStorage.getItem('jace_user_interests')) || {};
                
                currentWatchSession.tags.forEach(tag => {
                    // Clean tag
                    const safeTag = tag.trim().toLowerCase();
                    if(safeTag) {
                        interests[safeTag] = (interests[safeTag] || 0) + 1; // +1 point for watching
                    }
                });
                
                localStorage.setItem('jace_user_interests', JSON.stringify(interests));
                console.log(`[FYP] Updated interests for watching ${currentWatchSession.videoId}`, interests);
            }

            // Reset session
            currentWatchSession = { videoId: null, startTime: 0, tags: [] };
        }

        function handleLocalLike(tags = []) {
            const interests = JSON.parse(localStorage.getItem('jace_user_interests')) || {};
            
            tags.forEach(tag => {
                const safeTag = tag.trim().toLowerCase();
                if(safeTag) {
                    interests[safeTag] = (interests[safeTag] || 0) + 5; // +5 points for liking
                }
            });
            
            localStorage.setItem('jace_user_interests', JSON.stringify(interests));
            console.log(`[FYP] Interest boosted for Like`, interests);
        }

        function calculateVideoScore(video, userInterests = {}) {
            const stats = video.stats || { avgWatch: 0, completionRate: 0, likes: 0, views: 1, comments: 0, shares: 0 };
            
            // 1. Calculate Interaction Rates
            const safeViews = stats.views || 1;
            const likeRate = (stats.likes || 0) / safeViews;
            const commentRate = (stats.comments || 0) / safeViews;
            const shareRate = (stats.shares || 0) / safeViews;

            // 2. Base Score (Content Quality)
            const baseScore = 
                ((stats.avgWatch || 0) * FYP_CONFIG.weights.watchTime) +
                ((stats.completionRate || 0) * FYP_CONFIG.weights.completion) +
                (likeRate * FYP_CONFIG.weights.like) +
                (commentRate * FYP_CONFIG.weights.comment) +
                (shareRate * FYP_CONFIG.weights.share);

            // 3. Freshness Boost
            const createdTime = video.createdAt?.toDate ? video.createdAt.toDate().getTime() : Date.now();
            const hoursOld = Math.max(0, (Date.now() - createdTime) / (1000 * 60 * 60));
            const freshnessBoost = Math.max(1, 2.0 - (hoursOld * FYP_CONFIG.decay.freshness));

            // 4. Interest Match Boost
            let interestScore = 0;
            const tags = video.tags || [];
            tags.forEach(tag => {
                if (userInterests[tag]) {
                    interestScore += userInterests[tag];
                }
            });
            const interestBoost = 1 + (Math.log1p(interestScore) * 0.5);

            // 5. ENTROPY (The Fix for "Same Videos")
            // Adds a random factor between 0.0 and 0.3. 
            // This allows videos with similar scores to swap positions on reload.
            const entropy = Math.random() * 0.3;

            return (baseScore * freshnessBoost * interestBoost) + entropy;
        }

        // --- AUTH STATE LISTENER ---
        onAuthStateChanged(auth, async (user) => {
            if (!unsubscribeFeed) {
                window.setupFeedListener();
            }

            // Update comments panel auth state
            const commentInput = document.getElementById('comment-text');
            const commentAuthMsg = document.getElementById('comment-auth-message');
            if (commentInput) {
                if (user) {
                    commentInput.disabled = false;
                    commentInput.placeholder = "Add a comment...";
                    commentAuthMsg.classList.add('hidden');

                    try {
                        const blockedSnap = await getDocs(collection(db, 'users', user.uid, 'blocked'));
                        blockedUsers = new Set(blockedSnap.docs.map(d => d.id));
                        console.log("Blocked users loaded:", blockedUsers.size);
                        
                        window.setupFeedListener();
                        
                    } catch(e) { console.warn("Failed to load blocked users", e); }
                } else {
                    commentInput.disabled = true;
                    commentInput.placeholder = "Log in to comment";
                    commentAuthMsg.classList.remove('hidden');
                    blockedUsers.clear();
                }
            }

            // Update Settings Visibility based on Auth
            const accountSection = document.getElementById('settings-account-section');
            const prefSection = document.getElementById('settings-preferences-section');
            const walletSection = document.getElementById('settings-wallet-section'); // <--- NEW: Select wallet

            if (user) {
                window.setupPresenceSystem();
                window.checkUserRole(user.uid); 
                window.monitorAccountStatus(user);
                accountSection.classList.remove('hidden');
                prefSection.classList.remove('hidden');
                if(walletSection) walletSection.classList.remove('hidden'); // <--- NEW: Show wallet
                
                // Fetch user preferences for settings
                try {
                    const docSnap = await getDoc(doc(db, 'users', user.uid));
                    if(docSnap.exists() && docSnap.data().preferences) {
                        const prefs = docSnap.data().preferences;
                        
                        try {
                            const fSnap = await getDocs(collection(db, 'users', user.uid, 'following'));
                            window.myFollowing = new Set(fSnap.docs.map(d => d.id));
                            console.log("Following list loaded:", window.myFollowing.size);
                        } catch(e) { console.warn("Failed to load following", e); }

                        // Load Public Country
                        if(prefs.defaultLocation) {
                            document.getElementById('settings-default-location').value = prefs.defaultLocation;
                        }

                        // Load Private Address Details
                        if(prefs.address) {
                            if(document.getElementById('settings-street')) document.getElementById('settings-street').value = prefs.address.street || '';
                            if(document.getElementById('settings-apt')) document.getElementById('settings-apt').value = prefs.address.apt || '';
                            if(document.getElementById('settings-city')) document.getElementById('settings-city').value = prefs.address.city || '';
                            if(document.getElementById('settings-state')) document.getElementById('settings-state').value = prefs.address.state || '';
                            if(document.getElementById('settings-zip')) document.getElementById('settings-zip').value = prefs.address.zip || '';
                        }
                    }
                } catch(e) { console.warn("Failed to fetch settings", e); }
            } else {
                window.teardownPresenceSystem();
                window.myFollowing.clear();
                window.resetBanUI();
                accountSection.classList.add('hidden');
                prefSection.classList.add('hidden');
                document.getElementById('nav-admin').classList.add('hidden');
                document.getElementById('nav-admin').classList.remove('flex');
                if(walletSection) walletSection.classList.add('hidden'); // <--- NEW: Hide wallet
            }

            if (user) {
                const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
                const hasValidUsername = user.displayName && usernameRegex.test(user.displayName);

                if (!hasValidUsername) {
                    window.toggleAuthModal(true);
                    window.toggleAuthMode('complete_profile');
                    modalClose.classList.add('hidden');
                    return; 
                }

                modalClose.classList.remove('hidden');
                window.toggleAuthModal(false);

                uploadBtn.classList.remove('hidden');
                uploadBtn.classList.add('flex');
                createProductBtn.classList.remove('hidden');
                createProductBtn.classList.add('flex');
                navProfile.classList.remove('hidden');
                // navSettings is always visible now
                navStore.classList.remove('hidden'); navStore.classList.add('flex');
                navInbox.classList.remove('hidden'); navInbox.classList.add('flex');
                
                // Show Cart Fab
                cartFab.classList.remove('hidden');
                cartFab.classList.add('flex');
                window.setupCartListener();

                // HIDE Login button on sidebar when logged in
                authBtn.classList.add('hidden');

                const displayName = user.displayName;
                let userBio = 'No bio yet.';
                try {
                    // STRUCTURE: users/{userId} (root doc) contains { profile: { username, photoUrl... } }
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        // Check if profile object exists
                        if (userData.profile && userData.profile.bio) userBio = userData.profile.bio;
                    } else {
                        // Create basic user doc if missing
                        await setDoc(userDocRef, {
                            profile: {
                                username: displayName,
                                email: user.email,
                                photoUrl: user.photoURL
                            },
                            stats: { followers: 0, following: 0 },
                            createdAt: serverTimestamp()
                        }, { merge: true });
                    }
                } catch (e) {
                    console.error("Error fetching user profile:", e);
                }

                const finalAvatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${displayName}&background=random`;

                userDisplay.classList.remove('hidden');
                userDisplay.innerHTML = `
                    <div class="flex items-center gap-3 px-4 py-3 bg-app-card rounded-xl border border-app-border">
                        <div class="w-10 h-10 rounded-full bg-brand-teal text-white flex items-center justify-center font-bold text-lg shadow-sm overflow-hidden">
                            <img src="${finalAvatarUrl}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col overflow-hidden">
                            <span class="text-xs text-app-textMuted font-semibold uppercase tracking-wider">Welcome</span>
                            <span class="text-sm font-bold text-app-text truncate w-32" title="${displayName}">${displayName}</span>
                        </div>
                    </div>
                `;

                document.getElementById('settings-username').textContent = displayName;
                document.getElementById('settings-email').textContent = user.email;

            } else {
                if(unsubscribeProfile) {
                    unsubscribeProfile();
                    unsubscribeProfile = null;
                }
                if(unsubscribeConversations) {
                    unsubscribeConversations();
                    unsubscribeConversations = null;
                }
                if(unsubscribeNotifications) {
                    unsubscribeNotifications();
                    unsubscribeNotifications = null;
                }
                if(unsubscribeMessages) {
                    unsubscribeMessages();
                    unsubscribeMessages = null;
                }
                if(unsubscribeCart) {
                    unsubscribeCart();
                    unsubscribeCart = null;
                }
                
                uploadBtn.classList.add('hidden');
                uploadBtn.classList.remove('flex');
                createProductBtn.classList.add('hidden');
                createProductBtn.classList.remove('flex');
                navProfile.classList.add('hidden');
                // navSettings remains visible for theme toggle
                navInbox.classList.add('hidden'); navInbox.classList.remove('flex');
                
                // Hide Cart
                cartFab.classList.add('hidden');
                cartFab.classList.remove('flex');

                // SHOW Login button on sidebar when logged out
                authBtn.classList.remove('hidden');
                authBtn.classList.remove('bg-gray-800', 'hover:bg-gray-900', 'shadow-gray-800/20');
                authBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'shadow-red-500/20');
                authBtn.innerHTML = `<i data-lucide="log-in" class="w-5 h-5"></i><span class="tracking-wide">Login</span>`;
                authBtn.onclick = () => window.toggleAuthModal(true);

                userDisplay.classList.add('hidden');
                userDisplay.innerHTML = '';

                // Redirect only if on a protected route
                if (!profileContainer.classList.contains('hidden') || !uploadContainer.classList.contains('hidden') || !createProductContainer.classList.contains('hidden') || !inboxContainer.classList.contains('hidden') || !cartContainer.classList.contains('hidden')) {
                    window.navigateTo('feed');
                }
            }
            
            if (window.lucide) window.lucide.createIcons();
        });

        const hookFunction = (functionName, preHook, postHook) => {
            const check = () => {
                if (window[functionName]) {
                    const original = window[functionName];
                    window[functionName] = async (...args) => {
                        if (preHook) await preHook(...args);
                        await original(...args);
                        if (postHook) await postHook(...args);
                    };
                    console.log(`[ReviewSystem] Hooked ${functionName}`);
                } else {
                    requestAnimationFrame(check);
                }
            };
            check();
        };

        const renderReviewsSection = async (productId, sellerId) => {
            // Locate the container where reviews should go
            const contentContainer = document.getElementById('store-detail-content');
            if (!contentContainer) return;

            const headers = contentContainer.getElementsByTagName('h3');
            let reviewHeader = null;
            for (let i = 0; i < headers.length; i++) {
                if (headers[i].textContent?.includes('Reviews')) {
                    reviewHeader = headers[i];
                    break;
                }
            }

            if (!reviewHeader || !reviewHeader.parentElement) return;
            
            const reviewSectionContainer = reviewHeader.parentElement;
            
            // Clear existing placeholder
            reviewSectionContainer.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-app-text flex items-center gap-2">
                        Reviews <span id="review-count-badge" class="text-sm bg-app-border px-2 py-0.5 rounded-full text-app-textMuted">0</span>
                    </h3>
                </div>
                <div id="product-review-form-container" class="mb-8 hidden animate-fade-in"></div>
                <div id="product-reviews-list" class="space-y-4">
                    <div class="text-center py-10 text-app-textMuted"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading reviews...</div>
                </div>
            `;

            // 1. Check if user purchased this item to show "Write Review" form
            const user = auth.currentUser;
            if (user && user.uid !== sellerId) {
                try {
                    const ordersQuery = query(
                        collection(db, 'orders'),
                        where('buyerId', '==', user.uid),
                        where('status', 'in', ['paid', 'shipped', 'delivered']) 
                    );
                    const snapshot = await getDocs(ordersQuery);
                    let hasPurchased = false;
                    
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.items && Array.isArray(data.items)) {
                            if (data.items.some((item) => item.id === productId || item.productId === productId)) {
                                hasPurchased = true;
                            }
                        }
                    });

                    if (hasPurchased) {
                        const reviewCheck = await getDocs(query(collection(db, 'users', sellerId, 'products', productId, 'reviews'), where('userId', '==', user.uid)));
                        if (reviewCheck.empty) {
                            renderReviewForm(productId, sellerId);
                        }
                    }
                } catch (e) {
                    console.warn("Failed to check purchase history", e);
                }
            }

            // 2. Listen for Reviews
            const reviewsRef = collection(db, 'users', sellerId, 'products', productId, 'reviews');
            const q = query(reviewsRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('product-reviews-list');
                const badge = document.getElementById('review-count-badge');
                if (!list || !badge) return;

                badge.textContent = snapshot.size.toString();

                if (snapshot.empty) {
                    list.innerHTML = `
                        <div class="bg-app-card rounded-xl p-8 text-center text-app-textMuted border border-app-border">
                            <i data-lucide="message-square-dashed" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                            <p>No reviews yet.</p>
                        </div>
                    `;
                } else {
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const r = doc.data();
                        const isSeller = user && user.uid === sellerId;
                        const isReviewer = user && user.uid === r.userId; // Check if current user wrote this review
                        
                        // Stars HTML
                        let starsHtml = '';
                        for(let i=1; i<=5; i++) {
                            const fill = i <= (r.rating || 0) ? 'fill-brand-orange text-brand-orange' : 'text-gray-300 dark:text-gray-600';
                            starsHtml += `<i data-lucide="star" class="w-3 h-3 ${fill}"></i>`;
                        }

                        const div = document.createElement('div');
                        // Added 'group' and 'relative' for hover delete button positioning
                        div.className = "bg-app-card border border-app-border rounded-xl p-5 animate-fade-in relative group";
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden"><img src="${r.avatarUrl || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover"></div>
                                    <div>
                                        <p class="text-sm font-bold text-app-text">${r.username}</p>
                                        <div class="flex items-center gap-1">${starsHtml}</div>
                                    </div>
                                </div>
                                <span class="text-xs text-app-textMuted">${r.timestamp ? new Date(r.timestamp.toDate()).toLocaleDateString() : 'Just now'}</span>
                            </div>
                            <p class="text-sm text-app-text leading-relaxed mb-4">${r.comment}</p>
                            
                            ${isReviewer ? `
                                <button onclick="window.deleteReview('${productId}', '${sellerId}', '${doc.id}')" class="absolute top-4 right-4 text-xs text-red-500 hover:text-red-700 font-bold opacity-0 group-hover:opacity-100 transition-opacity">
                                    Delete
                                </button>
                            ` : ''}
                            
                            ${r.reply ? `
                                <div class="ml-4 pl-4 border-l-2 border-brand-teal/30 bg-app-bg p-3 rounded-r-lg group/reply relative">
                                    <p class="text-xs font-bold text-brand-teal mb-1">Seller Response</p>
                                    <p class="text-sm text-app-textMuted">${r.reply}</p>
                                    ${isSeller ? `
                                        <button onclick="window.deleteReviewReply('${productId}', '${sellerId}', '${doc.id}')" class="absolute top-2 right-2 text-[10px] text-red-500 opacity-0 group-hover/reply:opacity-100 font-bold hover:underline">Delete</button>
                                    ` : ''}
                                </div>
                            ` : ''}

                            ${isSeller && !r.reply ? `
                                <div class="mt-3 pt-3 border-t border-app-border">
                                    <button onclick="window.toggleReviewReply('${doc.id}')" class="text-xs font-bold text-brand-teal hover:underline flex items-center gap-1">
                                        <i data-lucide="reply" class="w-3 h-3"></i> Reply
                                    </button>
                                    <div id="review-reply-form-${doc.id}" class="hidden mt-3">
                                        <textarea id="reply-input-${doc.id}" class="w-full bg-app-input border border-app-border rounded-lg p-3 text-sm outline-none focus:border-brand-teal mb-2" placeholder="Write a response..."></textarea>
                                        <button onclick="window.submitReviewReply('${doc.id}', '${productId}', '${sellerId}')" class="px-4 py-2 bg-brand-teal text-white text-xs font-bold rounded-lg hover:bg-brand-teal/90">Post Reply</button>
                                    </div>
                                </div>
                            ` : ''}
                        `;
                        list.appendChild(div);
                    });
                }
                if (window.lucide) window.lucide.createIcons();
            });
        };

        const renderReviewForm = (productId, sellerId) => {
            const container = document.getElementById('product-review-form-container');
            if (!container) return;

            currentReviewRating = 5; // Default

            container.innerHTML = `
                <div class="bg-app-bg border border-app-border rounded-xl p-5 mb-6">
                    <h4 class="font-bold text-app-text mb-3">Write a Review</h4>
                    
                    <div class="flex items-center gap-1 mb-4" id="review-star-input">
                        ${[1,2,3,4,5].map(i => `
                            <button onclick="window.setReviewRating(${i})" class="focus:outline-none transition-transform hover:scale-110" data-val="${i}">
                                <i data-lucide="star" class="w-6 h-6 ${i <= 5 ? 'fill-brand-orange text-brand-orange' : 'text-gray-300'}"></i>
                            </button>
                        `).join('')}
                        <span class="ml-2 text-sm font-bold text-app-textMuted" id="rating-label">Excellent</span>
                    </div>

                    <textarea id="review-text" rows="3" class="w-full bg-app-input border border-app-border rounded-xl p-4 text-sm outline-none focus:ring-2 focus:ring-brand-teal/20 mb-3" placeholder="How was the product?"></textarea>
                    
                    <div class="flex justify-end">
                        <button onclick="window.submitProductReview('${productId}', '${sellerId}')" id="btn-submit-review" class="bg-brand-teal text-white font-bold px-6 py-2.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all">Submit Review</button>
                    </div>
                </div>
            `;
            container.classList.remove('hidden');
            if (window.lucide) window.lucide.createIcons();
        };

        // --- 2. PROFILE PAGE REVIEWS TAB ---

        const addReviewsTabToProfile = async (userId) => {
            const profileContainer = document.getElementById('profile-container');
            if (!profileContainer) return;

            const tabContainer = profileContainer.querySelector('.border-b.border-app-border'); // The tab bar
            if (!tabContainer) return;

            // Check if tab already exists to prevent duplicate
            if (document.getElementById('tab-reviews')) return;

            // Create Tab Button
            const btn = document.createElement('button');
            btn.id = 'tab-reviews';
            btn.onclick = () => window.switchTab('reviews');
            btn.className = "px-8 pb-3 text-base font-bold tab-inactive flex items-center gap-2 hover:bg-app-hover transition-colors";
            btn.innerHTML = `<i data-lucide="star" class="w-4 h-4"></i> Reviews`;
            tabContainer.appendChild(btn);

            // Create Content Container
            const contentDiv = document.createElement('div');
            contentDiv.id = 'profile-content-reviews';
            contentDiv.className = "hidden w-full max-w-3xl mx-auto animate-fade-in space-y-4";
            
            // Append content div after the last tab content
            const lastContent = document.getElementById('profile-content-likes');
            if (lastContent && lastContent.parentNode) {
                lastContent.parentNode.insertBefore(contentDiv, lastContent.nextSibling);
            }
            
            if (window.lucide) window.lucide.createIcons();
            
            // Attach listener for this specific user's reviews
            setupProfileReviewsListener(userId, contentDiv);
        };

        const setupProfileReviewsListener = (userId, container) => {
            // We query the 'reviews_received' collection we will create on submission
            const q = query(collection(db, 'users', userId, 'reviews_received'), orderBy('timestamp', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center gap-2 py-20 text-app-textMuted">
                            <div class="w-16 h-16 rounded-full bg-app-card flex items-center justify-center mb-2">
                                <i data-lucide="star-off" class="w-8 h-8 text-app-textMuted/50"></i>
                            </div>
                            <p class="font-bold">No reviews yet</p>
                            <p class="text-sm">Reviews from buyers will appear here.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = '';
                    snapshot.forEach(doc => {
                        const r = doc.data();
                        
                        // Stars
                        let stars = '';
                        for(let i=1; i<=5; i++) stars += `<i data-lucide="star" class="w-3 h-3 ${i <= (r.rating||0) ? 'fill-brand-orange text-brand-orange' : 'text-gray-300 dark:text-gray-600'}"></i>`;

                        const card = document.createElement('div');
                        card.className = "bg-app-card border border-app-border rounded-xl p-5 hover:border-brand-teal/30 transition-colors";
                        card.innerHTML = `
                            <div class="flex gap-4">
                                <div class="w-12 h-12 bg-gray-100 rounded-lg shrink-0 overflow-hidden border border-app-border">
                                    <img src="${r.productImage || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-app-text text-sm truncate">${r.productTitle}</h4>
                                    <div class="flex items-center gap-2 my-1">
                                        <div class="flex">${stars}</div>
                                        <span class="text-xs text-app-textMuted">â¢ ${r.timestamp ? new Date(r.timestamp.toDate()).toLocaleDateString() : 'Just now'}</span>
                                    </div>
                                    <p class="text-sm text-app-text italic">"${r.comment}"</p>
                                    
                                    <div class="flex items-center gap-2 mt-3 pt-3 border-t border-app-border/50">
                                        <div class="w-5 h-5 rounded-full bg-gray-200 overflow-hidden"><img src="${r.reviewerAvatar}" class="w-full h-full object-cover"></div>
                                        <span class="text-xs font-bold text-app-textMuted">${r.reviewerName}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }
                if (window.lucide) window.lucide.createIcons();
            });
        };
        
        const handleStripeReturn = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('payment_status');
            const sessionId = urlParams.get('session_id');

            if (status === 'success') {
                // 1. Retrieve the saved items
                const savedItems = localStorage.getItem('jace_pending_checkout');
                
                if (savedItems) {
                    try {
                        // Restore global buffer
                        checkoutItemsBuffer = JSON.parse(savedItems);
                        
                        window.showToast("Payment verified! Finalizing...", "info");

                        // 2. Wait for Firebase Auth to initialize
                        // (Since page refreshed, auth.currentUser might be null for a split second)
                        const waitForUser = async () => {
                            let attempts = 0;
                            while (!window.auth?.currentUser && attempts < 50) { // Wait up to 5s
                                await new Promise(r => setTimeout(r, 100));
                                attempts++;
                            }
                            return window.auth?.currentUser;
                        };

                        const user = await waitForUser();
                        
                        if (user) {
                            // 3. Trigger existing success logic
                            // We mock the 'details' object that PayPal usually provides
                            await window.handlePaymentSuccess({
                                id: sessionId || 'STRIPE_' + Date.now(),
                                payer: {
                                    name: { given_name: user.displayName || 'Stripe Payer' }
                                }
                            });

                            // 4. Cleanup
                            localStorage.removeItem('jace_pending_checkout');
                            
                            // 5. Remove query params from URL so refresh doesn't re-trigger
                            window.history.replaceState({}, document.title, window.location.pathname);
                            
                        } else {
                            window.showToast("Please log in to see your order.", "error");
                        }

                    } catch (e) {
                        console.error("Error restoring checkout state:", e);
                        window.showToast("Error restoring cart after payment.", "error");
                    }
                }
            } else if (status === 'canceled') {
                window.showToast("Payment canceled.", "info");
                localStorage.removeItem('jace_pending_checkout');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        };

        handleStripeReturn();

        // 1. Helper to extract parameters from URL
        const getParams = (match) => {
            const values = match.result.slice(1);
            const keys = Array.from(match.route.path.matchAll(/:(\w+)/g)).map(result => result[1]);
            return Object.fromEntries(keys.map((key, i) => [key, values[i]]));
        };

        // 2. Route Definitions
        const routerRoutes = [
            { path: "/", view: "feed" },
            { path: "/feed", view: "feed" },
            { path: "/store", view: "store" },
            { path: "/cart", view: "cart" },
            { path: "/checkout", view: "checkout" },
            { path: "/inbox", view: "inbox" },
            { path: "/settings", view: "settings" },
            { path: "/explore", view: "explore" },
            { path: "/upload", view: "upload" },
            { path: "/create-product", view: "create-product" },
            { path: "/analytics", view: "analytics" },
            { path: "/support", view: "support" },

            {
                path: "/video/:videoId/edit",
                view: "edit-video-page",
                load: async (params) => {
                    window.loadEditVideoPage(params.videoId);
                }
            },

            {
                path: "/product/:productId/edit",
                view: "edit-product-page",
                load: async (params) => {
                    window.loadEditProductPage(params.productId);
                }
            },
            
            // --- ADMIN ROUTE ---
            { path: "/admin", view: "admin", load: () => { if(window.switchAdminTab) window.switchAdminTab('reports'); } },

            // Dynamic Route: User Profile (/user/username)
            { 
                path: "/user/:username", 
                view: "profile",
                load: async (params) => {
                    const username = params.username;
                    try {
                        const q = query(collection(db, 'users'), where('profile.username', '==', username), limit(1));
                        const snapshot = await getDocs(q);
                        if (!snapshot.empty) {
                            const doc = snapshot.docs[0];
                            const data = doc.data();
                            window.viewUserProfile(doc.id, data.profile.username, data.profile.photoUrl, true);
                        } else {
                            window.showToast("User not found", "error");
                            window.renderInternalView('feed');
                        }
                    } catch (e) {
                        console.error("Router Profile Lookup Error", e);
                        window.renderInternalView('feed');
                    }
                }
            },

            // Dynamic Route: Product Detail (/product/productId)
            {
                path: "/product/:productId",
                view: "store",
                load: async (params) => {
                    const pid = params.productId;
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        const sellerId = urlParams.get('seller');

                        if (sellerId) {
                            window.viewProduct(pid, sellerId, true);
                        } else {
                            const qGlobal = query(collectionGroup(db, 'products')); 
                            const snap = await getDocs(qGlobal);
                            const found = snap.docs.find(d => d.id === pid);
                            
                            if (found) {
                                const sId = found.ref.parent.parent.id;
                                window.viewProduct(pid, sId, true);
                            } else {
                                window.showToast("Product not found", "error");
                                window.renderInternalView('store');
                            }
                        }
                    } catch (e) {
                        console.error("Router Product Lookup Error", e);
                        window.renderInternalView('store');
                    }
                }
            },

            // Video Deep Link: /:username/video/:videoId
            {
                path: "/:username/video/:videoId",
                view: "feed",
                load: async (params) => {
                    const { username, videoId } = params;
                    const container = document.getElementById('feed-container');
                    container.innerHTML = '<div class="flex h-full items-center justify-center text-app-textMuted"><i data-lucide="loader-2" class="animate-spin w-8 h-8"></i></div>';
                    if(window.lucide) window.lucide.createIcons();

                    try {
                        const cleanUsername = username.replace('@', '');
                        const usersQ = query(collection(db, 'users'), where('profile.username', '==', cleanUsername), limit(1));
                        const userSnap = await getDocs(usersQ);
                        
                        if (userSnap.empty) { throw new Error("User not found"); }
                        const userId = userSnap.docs[0].id;

                        const vidRef = doc(db, 'users', userId, 'videos', videoId);
                        const vidSnap = await getDoc(vidRef);

                        if (vidSnap.exists()) {
                            const post = { id: vidSnap.id, ...vidSnap.data(), path: vidRef.path };
                            container.innerHTML = '';
                            const videoEl = window.createVideoPost(post);
                            container.appendChild(videoEl);
                            if (window.observer) window.observer.observe(videoEl);
                        } else {
                            throw new Error("Video not found");
                        }
                    } catch (e) {
                        container.innerHTML = `<div class="flex flex-col h-full items-center justify-center text-app-textMuted gap-4"><i data-lucide="video-off" class="w-12 h-12 opacity-50"></i><p>${e.message || "Video unavailable"}</p><button onclick="window.navigateTo('feed')" class="px-4 py-2 bg-brand-teal text-white rounded-lg font-bold">Go Home</button></div>`;
                        if(window.lucide) window.lucide.createIcons();
                    }
                }
            },
        ];

        // 3. The Main Router Function
        const router = async () => {
            // Test each route for match
            const potentialMatches = routerRoutes.map(route => {
                // Regex for path matching
                const regexPath = route.path.replace(/\//g, "\\/").replace(/:(\w+)/g, "([^\\/]+)");
                const regex = new RegExp(`^${regexPath}$`);
                const result = location.pathname.match(regex);
                return { route, result };
            });

            let match = potentialMatches.find(potentialMatch => potentialMatch.result !== null);

            // Fallback to home
            if (!match) {
                match = { route: routerRoutes[0], result: [location.pathname] };
            }

            // 1. Render the container
            window.renderInternalView(match.route.view);

            // 2. Run Data Loader if dynamic
            if (match.route.load) {
                const params = getParams(match);
                await match.route.load(params);
            }
        };

        window.resetBanUI = () => {
            // 1. Restore Sidebar Nav
            const sidebarNav = document.querySelector('#app-sidebar nav');
            if (sidebarNav) sidebarNav.classList.remove('hidden');

            // 2. Restore Mobile Nav
            const mobNav = document.getElementById('mobile-bottom-nav');
            if (mobNav) mobNav.classList.remove('hidden');

            // 3. Hide Ban Modal
            document.getElementById('ban-modal').classList.add('hidden');

            // 4. Restore Feed if it was blocked
            const feed = document.getElementById('feed-container');
            if (feed && feed.innerText === 'ACCESS DENIED') {
                feed.innerHTML = ''; // Clear the denied message so the feed listener can repopulate
                if(window.setupFeedListener) window.setupFeedListener();
            }
        };

        // --- VIEW COUNTING LOGIC ---
        window.incrementViewCount = async (videoId, videoPath) => {
             if (!videoPath || videoPath === 'null') return;
             try {
                const ref = doc(db, videoPath);
                await updateDoc(ref, { views: increment(1) });
             } catch(e) { /* silent fail for views */ }
        };

        // --- SHARE COUNTING LOGIC ---
        window.incrementShareCount = async (videoId, videoPath) => {
            const el = document.querySelector(`.share-count-${videoId}`);
            if(el) {
               let val = parseInt(el.innerText.replace('k','000'));
               el.innerText = formatNumber(val + 1);
            }
            if(videoPath && videoPath !== 'null') {
                try {
                    const ref = doc(db, videoPath);
                    await updateDoc(ref, { shares: increment(1) });
                } catch(e) { console.warn('Share update failed', e); }
            }
        };

        // --- CONFIRMATION MODAL ---
        window.openConfirmModal = (title, desc, onYes, btnText = "Delete") => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-desc').textContent = desc;
            
            // Update button text dynamically
            const btn = document.getElementById('confirm-yes-btn');
            if(btn) btn.textContent = btnText;
            
            document.getElementById('confirmation-modal').classList.remove('hidden');
            confirmCallback = onYes;
        };
        
        window.closeConfirmModal = () => {
             document.getElementById('confirmation-modal').classList.add('hidden');
             confirmCallback = null;
        };
        
        document.getElementById('confirm-yes-btn').onclick = () => {
            if(confirmCallback) confirmCallback();
            window.closeConfirmModal();
        };

        // --- NAVIGATION LOGIC ---
        window.renderInternalView = (view) => {
            // 1. Safety cleanup
            if (window.closeComments) window.closeComments();
            if (window.closeShareModal) window.closeShareModal();

            // 2. Map of all views
            const views = {
                'feed': document.getElementById('feed-container'),
                'profile': document.getElementById('profile-container'),
                'settings': document.getElementById('settings-container'),
                'upload': document.getElementById('upload-container'),
                'create-product': document.getElementById('create-product-container'),
                'explore': document.getElementById('explore-container'),
                'inbox': document.getElementById('inbox-container'),
                'store': document.getElementById('store-container'),
                'cart': document.getElementById('cart-container'),
                'checkout': document.getElementById('checkout-container'),
                'analytics': document.getElementById('analytics-container'),
                'support': document.getElementById('support-container'),
                'edit-video-page': document.getElementById('edit-video-page-container'),
                'edit-product-page': document.getElementById('edit-product-page-container'),
                
                // --- THIS MUST BE HERE AND MATCH THE HTML ID ---
                'admin': document.getElementById('admin-container') 
            };

            // 3. Hide all containers
            Object.values(views).forEach(container => {
                if (container) container.classList.add('hidden');
            });
            
            // 4. Reset Desktop Sidebar Buttons
            const navButtons = ['nav-feed', 'nav-profile', 'nav-settings', 'nav-explore', 'nav-inbox', 'nav-store', 'nav-admin'];
            
            navButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.classList.remove('bg-app-hover', 'text-app-text', 'border-app-border/50', 'border');
                    btn.classList.add('text-app-textMuted', 'hover:bg-app-hover', 'hover:text-app-text');
                }
            });

            // 5. Reset Mobile Bottom Nav Buttons
            const mobileNavIds = ['mobile-nav-feed', 'mobile-nav-store', 'mobile-nav-upload', 'mobile-nav-inbox', 'mobile-nav-profile'];
            mobileNavIds.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.classList.remove('text-brand-orange', 'text-app-text');
                    btn.classList.add('text-app-textMuted');
                }
            });

            // 6. Show Active View
            const activeContainer = views[view];
            if (!activeContainer) {
                console.error(`View "${view}" not found. Falling back to feed.`);
                if (views['feed']) views['feed'].classList.remove('hidden');
                return;
            }
            activeContainer.classList.remove('hidden');

            // 7. Highlight Active Buttons
            const highlightDesktop = (id) => {
                const btn = document.getElementById(id);
                if(btn) btn.classList.add('bg-app-hover', 'text-app-text', 'border', 'border-app-border/50');
            };
            const highlightMobile = (id) => {
                const btn = document.getElementById(id);
                if(btn) {
                    btn.classList.remove('text-app-textMuted');
                    btn.classList.add('text-brand-orange');
                }
            };

            if (view === 'feed') {
                highlightDesktop('nav-feed');
                highlightMobile('mobile-nav-feed');
            } else if (view === 'profile') {
                highlightDesktop('nav-profile');
                highlightMobile('mobile-nav-profile');
            } else if (view === 'store') {
                highlightDesktop('nav-store');
                highlightMobile('mobile-nav-store');
                if (window.backToStoreFeed) window.backToStoreFeed();
                if (window.setupStoreListener) window.setupStoreListener();
            } else if (view === 'inbox') {
                highlightDesktop('nav-inbox');
                highlightMobile('mobile-nav-inbox');
                if (!currentInboxTab) window.switchInboxTab('notifications');
                else window.switchInboxTab(currentInboxTab);
                if (auth.currentUser) { 
                    if (window.setupNotificationsListener) window.setupNotificationsListener(); 
                    if (window.setupConversationsListener) window.setupConversationsListener();
                }
            } else if (view === 'upload') {
                highlightMobile('mobile-nav-upload');
                if (auth.currentUser && window.fetchUserProducts) window.fetchUserProducts();
            } else if (view === 'explore') {
                highlightDesktop('nav-explore');
                if (window.setupExploreListener) window.setupExploreListener();
            } else if (view === 'settings') {
                highlightDesktop('nav-settings');
                if (window.loadWalletData) window.loadWalletData();
            } else if (view === 'cart') {
                if (window.renderCartList) window.renderCartList();
            } else if (view === 'checkout') {
                if (window.renderCheckoutPage) window.renderCheckoutPage();
            } else if (view === 'create-product') {
                if (window.initCreateProduct) window.initCreateProduct();
            } else if (view === 'analytics') {
                window.loadAnalyticsData();
            } 
            // --- ADMIN CASE ---
            else if (view === 'admin') {
                highlightDesktop('nav-admin');
            }

            // 8. Mobile Cart Fab Visibility
            const cartFab = document.getElementById('cart-fab');
            if (cartFab && window.auth && window.auth.currentUser) {
                if (window.innerWidth < 768) {
                    if (view === 'store') {
                        cartFab.classList.remove('hidden');
                        cartFab.classList.add('flex');
                    } else {
                        cartFab.classList.add('hidden');
                        cartFab.classList.remove('flex');
                    }
                } else {
                    cartFab.classList.remove('hidden');
                    cartFab.classList.add('flex');
                }
            }

            if (window.lucide) window.lucide.createIcons();
        };

        window.checkAccountRestriction = async () => {
            const user = auth.currentUser;
            if (!user) return false;
            
            try {
                // Force fetch latest user data to ensure we see the strike
                const snap = await getDoc(doc(db, 'users', user.uid));
                
                if (snap.exists()) {
                    const data = snap.data();
                    const restrictedUntil = data.moderation?.restrictedUntil;
                    
                    if (restrictedUntil) {
                        // Handle Firestore Timestamp OR standard Date string/obj
                        const endDate = restrictedUntil.toDate ? restrictedUntil.toDate() : new Date(restrictedUntil);
                        const now = new Date();
                        
                        if (endDate > now) {
                            const dateStr = endDate.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
                            window.showToast(`Account restricted until ${dateStr}`, 'error');
                            return true; // BLOCKED
                        }
                    }
                }
            } catch (e) {
                console.error("Restriction check failed", e);
            }
            return false; // ALLOWED
        };

        window.navigateTo = (input) => {
            const map = {
                'feed': '/for-you',
                'store': '/store',
                'cart': '/cart',
                'checkout': '/checkout',
                'settings': '/settings',
                'inbox': '/inbox',
                'explore': '/explore',
                'upload': '/upload',
                'create-product': '/create-product',
                'analytics': '/analytics',
                'support': '/support',
                'profile': '/user/' + (auth.currentUser ? auth.currentUser.displayName : 'me'),
                'admin': '/admin'
            };

            // Fix: Use input as URL if not found in map (e.g. "video/123/edit")
            let url = map[input] || input;

            // Ensure leading slash
            if (!url.startsWith('/')) {
                url = '/' + url;
            }

            history.pushState(null, null, url);
            
            if(input === 'admin' && auth.currentUser) {
                window.checkUserRole(auth.currentUser.uid);
            }

            router();
        };

        window.addEventListener("popstate", router);
        document.addEventListener("DOMContentLoaded", () => {
            document.body.addEventListener("click", e => {
                // Optional: Intercept all <a> tags for SPA navigation
                if (e.target.matches("[data-link]")) {
                    e.preventDefault();
                    history.pushState(null, null, e.target.href);
                    router();
                }
            });
            router();
        });

        window.addEngagementStyles = () => {
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes floatUpFade {
                    /* 
                    We include translateX(-50%) in EVERY keyframe. 
                    This ensures the bubble stays perfectly centered on its random 'left' position
                    while moving up, preventing any side-to-side wobble.
                    */
                    0% { transform: translateX(-50%) translateY(0) scale(0.8); opacity: 0; }
                    10% { opacity: 1; transform: translateX(-50%) translateY(-20px) scale(1); }
                    100% { transform: translateX(-50%) translateY(-150px) scale(0.9); opacity: 0; }
                }
                .engagement-bubble {
                    position: absolute;
                    bottom: 0;
                    /* Removed 'right: 0' and 'margin: auto' to prevent horizontal fighting */
                    animation: floatUpFade 4s ease-in-out forwards;
                    pointer-events: none;
                    /* Ensure hardware acceleration for smoother path */
                    will-change: transform; 
                }
            `;
            document.head.appendChild(style);
        };
        // Call this immediately
        window.addEngagementStyles();

        window.fetchFriendEngagement = async (videoPath) => {
            if (!videoPath || videoPath === 'null') return [];
            
            try {
                const engagementTypes = [
                    { name: 'likes', type: 'like' },
                    { name: 'reposts', type: 'repost' },
                    { name: 'shares', type: 'share' }
                ];

                // Fetch mostly recent events
                const queries = engagementTypes.map(async (et) => {
                    try {
                        // Limit 5 per type to keep it snappy
                        const q = query(collection(db, videoPath, et.name), limit(5)); 
                        const snap = await getDocs(q);
                        return snap.docs.map(d => ({
                            userId: d.id,
                            type: et.type,
                            // Fallback timestamp if missing
                            timestamp: d.data().timestamp || { toDate: () => new Date() } 
                        }));
                    } catch (err) {
                        return []; // Ignore specific collection errors
                    }
                });

                const results = await Promise.all(queries);
                const allEvents = results.flat();

                if (allEvents.length === 0) return [];

                // Fetch User Profiles (Once per unique user)
                const uniqueUserIds = [...new Set(allEvents.map(e => e.userId))];
                const userMap = {};

                await Promise.all(uniqueUserIds.map(async (uid) => {
                    try {
                        // Simple cache check could go here
                        const docSnap = await getDoc(doc(db, 'users', uid));
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            userMap[uid] = {
                                username: data.profile?.username || 'User',
                                avatar: data.profile?.photoUrl || 'https://via.placeholder.com/150'
                            };
                        } else {
                            userMap[uid] = { username: 'User', avatar: 'https://via.placeholder.com/150' };
                        }
                    } catch (err) {
                        userMap[uid] = { username: 'User', avatar: 'https://via.placeholder.com/150' };
                    }
                }));

                // Flatten back into bubbles array
                const finalBubbles = [];
                allEvents.forEach(event => {
                    const profile = userMap[event.userId];
                    if (profile) {
                        finalBubbles.push({
                            id: event.userId + '_' + event.type, 
                            username: profile.username,
                            avatar: profile.avatar,
                            type: event.type
                        });
                    }
                });

                // Shuffle
                finalBubbles.sort(() => Math.random() - 0.5);
                return finalBubbles;

            } catch (e) {
                console.error("Bubble fetch error:", e);
                return [];
            }
        };

        window.startEngagementBubbles = async (containerId, videoPath) => {
            // 1. CLEAR
            window.stopEngagementBubbles(containerId);

            const container = document.getElementById(containerId);
            if (!container) return;

            // 2. MARK LOADING
            const runTimestamp = Date.now();
            window.engagementIntervals[containerId] = { status: 'loading', runId: runTimestamp };

            // 3. FETCH DATA
            const friends = await window.fetchFriendEngagement(videoPath);
            
            // 4. VALIDATE
            const currentEntry = window.engagementIntervals[containerId];
            if (!document.getElementById(containerId) || !currentEntry || currentEntry.runId !== runTimestamp) {
                return; 
            }

            if (friends.length === 0) {
                delete window.engagementIntervals[containerId];
                return;
            }

            let idx = 0;
            
            // 5. LOOP
            const spawnBubbleLoop = () => {
                const elCheck = document.getElementById(containerId);
                const activeEntry = window.engagementIntervals[containerId];
                
                if (!elCheck || !activeEntry || activeEntry.runId !== runTimestamp) {
                    return;
                }

                if (document.hidden) {
                    const timerId = setTimeout(spawnBubbleLoop, 2000);
                    window.engagementIntervals[containerId] = { status: 'running', id: timerId, runId: runTimestamp };
                    return;
                }
                
                const friend = friends[idx % friends.length];
                idx++;

                let iconSvg = '';
                let bgClass = '';
                
                if (friend.type === 'like') {
                    bgClass = 'bg-red-500';
                    iconSvg = `<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>`;
                } else if (friend.type === 'repost') {
                    bgClass = 'bg-green-500';
                    iconSvg = `<path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/>`;
                } else if (friend.type === 'share') {
                    bgClass = 'bg-blue-500'; 
                    iconSvg = `<path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>`;
                }

                const bubble = document.createElement('div');
                bubble.className = "engagement-bubble absolute bottom-0 w-12 h-12 md:w-14 md:h-14 rounded-full border-2 border-white dark:border-zinc-800 shadow-xl flex items-center justify-center pointer-events-none";
                
                // Random Horizontal: 20% to 80%
                const randomLeft = 20 + Math.random() * 60; 
                const randomZ = 20 + Math.floor(Math.random() * 10);

                bubble.style.left = `${randomLeft}%`;
                // NOTE: We REMOVED inline `transform` here. 
                // It is now handled strictly in the CSS @keyframes `floatUpFade` to prevent conflict and jumps.
                bubble.style.zIndex = randomZ;
                
                bubble.innerHTML = `
                    <img src="${friend.avatar}" class="w-full h-full rounded-full object-cover">
                    <div class="absolute -bottom-1 -right-1 bg-white dark:bg-zinc-800 rounded-full p-1 shadow-sm">
                        <div class="${bgClass} rounded-full p-[3px] text-white flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                ${iconSvg}
                            </svg>
                        </div>
                    </div>
                `;
                
                elCheck.appendChild(bubble);

                setTimeout(() => { bubble.remove(); }, 4000);

                // Schedule next (2s interval for halfway overlap)
                const timerId = setTimeout(spawnBubbleLoop, 2000);
                window.engagementIntervals[containerId] = { status: 'running', id: timerId, runId: runTimestamp };
            };

            spawnBubbleLoop();
        };

        window.stopEngagementBubbles = (containerId) => {
            const entry = window.engagementIntervals[containerId];
            if (entry) {
                if (entry.id) { clearTimeout(entry.id); }
                delete window.engagementIntervals[containerId];
            }
        };
        
        // --- CART LOGIC ---
        window.setupCartListener = () => {
             const user = auth.currentUser;
             if (!user) return;
             if (unsubscribeCart) unsubscribeCart();
             
             const cartRef = collection(db, 'users', user.uid, 'cart');
             const badge = document.getElementById('cart-badge');
             const fab = document.getElementById('cart-fab');
             
             unsubscribeCart = onSnapshot(cartRef, (snapshot) => {
                 const count = snapshot.size;
                 badge.innerText = count > 9 ? '9+' : count;
                 if (count > 0) {
                     badge.classList.remove('hidden');
                     fab.classList.add('border-brand-orange');
                     fab.classList.remove('border-white/20');
                 } else {
                     badge.classList.add('hidden');
                     fab.classList.remove('border-brand-orange');
                     fab.classList.add('border-white/20');
                 }
                 // If viewing cart, re-render
                 if (!cartContainer.classList.contains('hidden')) {
                     window.renderCartList();
                 }
             });
        };

        window.renderCartList = async () => {
            const user = auth.currentUser;
            if(!user) return;
            const list = document.getElementById('cart-list');
            const actionsDiv = document.getElementById('cart-actions');
            const totalDisplay = document.getElementById('cart-total-display');

            list.innerHTML = '<div class="text-center py-20 text-app-textMuted"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i>Loading cart...</div>';
            if(window.lucide) window.lucide.createIcons();
            
            try {
                const snapshot = await getDocs(collection(db, 'users', user.uid, 'cart'));
                
                if (snapshot.empty) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center py-20 text-app-textMuted opacity-60"><i data-lucide="shopping-cart" class="w-16 h-16 mb-4"></i><p class="text-lg font-bold">Your cart is empty</p><p class="text-sm">Start shopping in the Store!</p></div>`;
                    if(actionsDiv) actionsDiv.classList.add('hidden');
                } else {
                    list.innerHTML = '';
                    let grandTotal = 0;
                    
                    snapshot.forEach(doc => {
                        const item = { id: doc.id, ...doc.data() };
                        const qty = item.quantity || 1;
                        const price = item.price || 0;
                        grandTotal += (price * qty);

                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-4 p-4 bg-app-card rounded-xl border border-app-border';
                        div.innerHTML = `
                            <div class="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden shrink-0">
                                <img src="${item.image || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-app-text text-lg truncate">${item.title}</h3>
                                <p class="text-sm text-app-textMuted truncate">Seller: ${(item.sellerId || '').substring(0,8)}...</p>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="font-bold text-brand-teal">$${price.toFixed(2)}</span>
                                    <div class="flex items-center gap-2 bg-app-bg border border-app-border rounded-lg px-2 py-1">
                                        <span class="text-[10px] font-bold text-app-textMuted uppercase">Qty</span>
                                        <input type="number" min="1" max="${item.stock || 1}" value="${qty}" data-cart-id="${item.id}" onchange="window.updateCartQuantity('${item.id}', this.value, ${item.stock || 1})" class="w-12 bg-transparent text-sm font-bold text-app-text outline-none text-center">
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 shrink-0 ml-2">
                                <button onclick="window.removeFromCart('${item.id}')" class="text-xs text-red-500 hover:text-red-600 font-bold py-1">Remove</button>
                            </div>
                        `;
                        list.appendChild(div);
                    });

                    // Update Total and Show Checkout Button
                    if(totalDisplay) totalDisplay.innerText = `$${grandTotal.toFixed(2)}`;
                    if(actionsDiv) actionsDiv.classList.remove('hidden');
                }
                if(window.lucide) window.lucide.createIcons();
            } catch(e) {
                console.error("Cart render failed", e);
                list.innerHTML = '<div class="text-center py-20 text-red-500">Failed to load cart.</div>';
            }
        };

        window.addToCart = async (event) => {
            if(!auth.currentUser) { window.toggleAuthModal(true); return; }
            if(!currentProductData) return;
            
            // Animation Logic
            const fab = document.getElementById('cart-fab');
            let imgSource = document.getElementById('store-main-image');
            
            // If triggered from feed, try to find image in event context if possible, otherwise skip fly animation
            if (!imgSource && event && event.target) {
                 // Try to find image in parent card if triggered from feed product card
                 const card = event.target.closest('.video-item-wrapper');
                 if(card) {
                     // Can't easily grab product image from video feed layout without more DOM querying, 
                     // but store view has #store-main-image.
                 }
            }

            if (imgSource && fab && !fab.classList.contains('hidden')) {
                const startRect = imgSource.getBoundingClientRect();
                const endRect = fab.getBoundingClientRect();
                
                const flyer = imgSource.cloneNode();
                flyer.style.position = 'fixed';
                flyer.style.left = startRect.left + 'px';
                flyer.style.top = startRect.top + 'px';
                flyer.style.width = startRect.width + 'px';
                flyer.style.height = startRect.height + 'px';
                flyer.style.zIndex = '100';
                flyer.style.borderRadius = '1rem';
                flyer.style.transition = 'all 0.8s cubic-bezier(0.2, 1, 0.3, 1)';
                flyer.style.pointerEvents = 'none';
                document.body.appendChild(flyer);
                
                // Force reflow
                void flyer.offsetWidth;
                
                flyer.style.left = (endRect.left + 10) + 'px';
                flyer.style.top = (endRect.top + 10) + 'px';
                flyer.style.width = '20px';
                flyer.style.height = '20px';
                flyer.style.opacity = '0';
                
                setTimeout(() => {
                    flyer.remove();
                    fab.classList.add('animate-cart-pulse');
                    setTimeout(() => fab.classList.remove('animate-cart-pulse'), 400);
                }, 800);
            }
            
            try {
                const user = auth.currentUser;
                const cartRef = doc(db, 'users', user.uid, 'cart', currentProductData.id);
                await setDoc(cartRef, {
                    productId: currentProductData.id,
                    sellerId: currentStoreSellerId,
                    title: currentProductData.title,
                    price: currentProductData.price,
                    image: (currentProductData.images && currentProductData.images[0]) || '',
                    quantity: 1, // Default to 1
                    stock: currentProductData.stock || 1, // Store max available
                    addedAt: serverTimestamp()
                });
                window.showToast("Added to cart", "success");
            } catch(e) {
                console.error("Cart error", e);
                window.showToast("Failed to add to cart", "error");
            }
        };

        window.removeFromCart = async (itemId) => {
            const user = auth.currentUser;
            if(!user) return;
            try {
                await deleteDoc(doc(db, 'users', user.uid, 'cart', itemId));
                window.showToast("Item removed", "success");
                // Listener updates UI
            } catch(e) { console.error(e); }
        };

         window.updateCartQuantity = async (itemId, qty, maxStock) => {
            let val = parseInt(qty);
            if (isNaN(val) || val < 1) val = 1;
            
            // Cap at stock
            if (val > maxStock) {
                val = maxStock;
                window.showToast(`Only ${maxStock} items available`, 'error');
                const input = document.querySelector(`input[data-cart-id="${itemId}"]`);
                if(input) input.value = val;
            }

            const user = auth.currentUser;
            if(!user) return;

            try {
                await updateDoc(doc(db, 'users', user.uid, 'cart', itemId), { quantity: val });
            } catch(e) { console.error("Update quantity failed", e); }
        };

        window.initiateCheckout = async (itemId) => {
            const user = auth.currentUser;
            if(!user) return;
            try {
                const docSnap = await getDoc(doc(db, 'users', user.uid, 'cart', itemId));
                if(!docSnap.exists()) return;
                currentCheckoutItem = { id: docSnap.id, ...docSnap.data() };
                
                document.getElementById('checkout-img').src = currentCheckoutItem.image || 'https://via.placeholder.com/150';
                document.getElementById('checkout-title').innerText = currentCheckoutItem.title;
                document.getElementById('checkout-seller').innerText = 'Seller ID: ' + currentCheckoutItem.sellerId.substring(0,6); // ideally fetch username
                
                const qty = currentCheckoutItem.quantity || 1;
                const price = currentCheckoutItem.price;
                const sub = price * qty;
                const ship = 0; // Simplified
                const total = sub + ship;
                
                document.getElementById('checkout-title').innerText = `${currentCheckoutItem.title} (x${qty})`;
                document.getElementById('checkout-subtotal').innerText = `$${sub.toFixed(2)}`;
                document.getElementById('checkout-total').innerText = `$${total.toFixed(2)}`;
                
                document.getElementById('checkout-modal').classList.remove('hidden');
            } catch(e) { console.error(e); }
        };

        window.confirmCheckout = async () => {
            if(!currentCheckoutItem || !auth.currentUser) return;
            const btn = document.querySelector('#checkout-modal button[onclick="window.confirmCheckout()"]');
            const originalText = btn.innerText;
            btn.innerText = "Processing..."; btn.disabled = true;
            
            const user = auth.currentUser;
            try {
                const batch = writeBatch(db);
                
                // 1. Remove from Cart
                const cartRef = doc(db, 'users', user.uid, 'cart', currentCheckoutItem.id);
                batch.delete(cartRef);
                
                // 2. Notify Seller
                const notifRef = doc(collection(db, 'users', currentCheckoutItem.sellerId, 'notifications'));
                batch.set(notifRef, {
                    type: 'purchase',
                    fromUserId: user.uid,
                    fromUsername: user.displayName,
                    fromUserAvatar: user.photoURL,
                    previewText: `Purchased your item: ${currentCheckoutItem.title}`,
                    productId: currentCheckoutItem.productId, // Actual product ID reference
                    postThumbnail: currentCheckoutItem.image,
                    read: false,
                    timestamp: serverTimestamp()
                });

                // 3. (Optional) Record Transaction
                // Not implementing full ledger for MVP

                await batch.commit();
                
                window.showToast("Purchase successful!", "success");
                document.getElementById('checkout-modal').classList.add('hidden');
                
            } catch(e) {
                console.error("Checkout failed", e);
                window.showToast("Checkout failed. Try again.", "error");
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        };

        // --- NEW PREFERENCE LOGIC ---
       window.saveLocationPreference = async () => {
            const user = auth.currentUser;
            if(!user) return;

            // Get values
            const country = document.getElementById('settings-default-location').value.trim();
            const street = document.getElementById('settings-street').value.trim();
            const apt = document.getElementById('settings-apt').value.trim();
            const city = document.getElementById('settings-city').value.trim();
            const state = document.getElementById('settings-state').value.trim();
            const zip = document.getElementById('settings-zip').value.trim();

            const btn = document.querySelector('#settings-preferences-section button[type="submit"]');
            const oldText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Saving...`; 
            btn.disabled = true;
            
            try {
                const preferencesData = {
                    defaultLocation: country, // Public
                    address: {
                        street: street,
                        apt: apt,
                        city: city,
                        state: state,
                        zip: zip
                    }
                };

                await setDoc(doc(db, 'users', user.uid), { preferences: preferencesData }, { merge: true });
                window.showToast("Address saved successfully", "success");
            } catch(e) {
                console.error(e);
                window.showToast("Failed to save address", "error");
            } finally {
                btn.innerHTML = oldText; 
                btn.disabled = false;
                if(window.lucide) window.lucide.createIcons();
            }
        };

        window.initCreateProduct = async () => {
            const user = auth.currentUser;
            if(!user) return;
            const locInput = document.getElementById('prod-location');
            
            // Reset state first
            locInput.disabled = false;
            locInput.value = '';
            locInput.classList.remove('bg-gray-100', 'cursor-not-allowed', 'opacity-70', 'dark:bg-zinc-800');
            
            try {
                const docSnap = await getDoc(doc(db, 'users', user.uid));
                if(docSnap.exists()) {
                     const prefs = docSnap.data().preferences;
                     if(prefs && prefs.defaultLocation) {
                         locInput.value = prefs.defaultLocation;
                         locInput.disabled = true;
                         locInput.classList.add('bg-gray-100', 'cursor-not-allowed', 'opacity-70', 'dark:bg-zinc-800');
                     }
                }
            } catch(e) { console.warn("Pref fetch failed", e); }
        };

        // --- STORE LOGIC ---
        window.setupStoreListener = () => {
            if (unsubscribeStoreFeed) return;
            // Removed orderBy to avoid composite index requirement errors for collectionGroup queries
            const q = query(collectionGroup(db, 'products'));
            const grid = document.getElementById('store-grid');
            
            unsubscribeStoreFeed = onSnapshot(q, (snapshot) => {
                const products = [];
                snapshot.forEach(doc => {
                    // Try to get seller ID from path: users/{uid}/products/{pid}
                    // doc.ref.parent.parent.id should be the UID
                    const sellerId = doc.ref.parent.parent ? doc.ref.parent.parent.id : null;
                   if(sellerId && !blockedUsers.has(sellerId)) {
                        products.push({ id: doc.id, sellerId: sellerId, ...doc.data() });
                    }
                });
                
                // Client-side sorting by createdAt desc
                products.sort((a, b) => {
                     const tA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                     const tB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                     return tB - tA;
                });
                
                allStoreProducts = products;
                window.runStoreFilters();
            }, (error) => {
                console.error("Store Feed Error:", error);
                grid.innerHTML = `<div class="col-span-full text-center text-red-500 py-20">Error loading store items. (${error.message})</div>`;
            });
        };

        window.renderStoreGrid = (products) => {
            const grid = document.getElementById('store-grid');
            grid.innerHTML = '';
            
            if (products.length === 0) {
                 grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-app-textMuted opacity-60"><i data-lucide="shopping-bag" class="w-16 h-16 mb-4"></i><p class="text-lg font-bold">No products found</p><p class="text-sm">Be the first to list something!</p></div>`;
                 return;
            }

            products.forEach(p => {
                const div = document.createElement('div');
                div.className = 'flex flex-col bg-app-card border border-app-border rounded-xl overflow-hidden cursor-pointer hover:shadow-lg transition-all group relative';
                div.onclick = () => window.viewProduct(p.id, p.sellerId);
                
                const imageUrl = (p.images && p.images.length > 0) ? p.images[0] : 'https://via.placeholder.com/300';
                const isNew = p.condition === 'New';
                const isSoldOut = (p.stock || 0) <= 0;
                
                div.innerHTML = `
                    <div class="aspect-square relative bg-gray-100 overflow-hidden">
                        <img src="${imageUrl}" class="w-full h-full object-cover ${isSoldOut ? 'grayscale opacity-60' : 'group-hover:scale-105'} transition-transform duration-500">
                        ${isNew && !isSoldOut ? '<span class="absolute top-2 left-2 bg-brand-teal text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">NEW</span>' : ''}
                        ${isSoldOut ? '<div class="absolute inset-0 flex items-center justify-center bg-black/40"><span class="bg-black/80 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider border border-white/20 backdrop-blur-sm">Sold Out</span></div>' : ''}
                    </div>
                    <div class="p-3 flex flex-col gap-1">
                        <h4 class="font-bold text-app-text truncate text-sm ${isSoldOut ? 'text-app-textMuted line-through' : ''}">${p.title}</h4>
                        <p class="text-xs text-app-textMuted truncate">${p.brand || 'No brand'}</p>
                        <div class="mt-2 flex items-center justify-between">
                            <span class="font-bold text-app-text">${formatCurrency(p.price)}</span>
                            ${!isSoldOut ? '<div class="bg-app-hover p-1 rounded-full"><i data-lucide="arrow-right" class="w-4 h-4 text-app-text"></i></div>' : ''}
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });
            if(window.lucide) window.lucide.createIcons();
        };

        window.setStoreCategory = (cat) => {
            storeFilterState.category = cat;
            
            // Visual Update
            document.querySelectorAll('.store-cat-btn').forEach(btn => {
                if(btn.dataset.cat === cat) {
                    btn.classList.add('bg-app-text', 'text-app-bg');
                    btn.classList.remove('bg-app-card', 'border', 'text-app-textMuted', 'hover:text-app-text');
                } else {
                    btn.classList.remove('bg-app-text', 'text-app-bg');
                    btn.classList.add('bg-app-card', 'border', 'text-app-textMuted', 'hover:text-app-text');
                }
            });

            window.runStoreFilters();
        };

        window.openStoreFilterModal = () => {
            // Sync UI with State
            document.getElementById('filter-min-price').value = storeFilterState.minPrice;
            document.getElementById('filter-max-price').value = storeFilterState.maxPrice;
            document.getElementById('filter-brand').value = storeFilterState.brand;
            document.getElementById('filter-condition').value = storeFilterState.condition;
            document.getElementById('filter-shipping').checked = storeFilterState.freeShipping;
            document.getElementById('filter-stock').checked = storeFilterState.inStock;
            
            document.getElementById('store-filter-modal').classList.remove('hidden');
        };

        window.closeStoreFilterModal = () => {
            document.getElementById('store-filter-modal').classList.add('hidden');
        };

        window.clearStoreFilters = () => {
            storeFilterState = { ...storeFilterState, minPrice: '', maxPrice: '', brand: '', condition: '', freeShipping: false, inStock: false };
            window.closeStoreFilterModal();
            window.runStoreFilters();
        };

        window.applyStoreFiltersFromModal = () => {
            storeFilterState.minPrice = document.getElementById('filter-min-price').value;
            storeFilterState.maxPrice = document.getElementById('filter-max-price').value;
            storeFilterState.brand = document.getElementById('filter-brand').value.trim();
            storeFilterState.condition = document.getElementById('filter-condition').value;
            storeFilterState.freeShipping = document.getElementById('filter-shipping').checked;
            storeFilterState.inStock = document.getElementById('filter-stock').checked;
            
            window.closeStoreFilterModal();
            window.runStoreFilters();
        };

        // Replaces handleStoreSearch
        window.runStoreFilters = () => {
            // Start with all loaded products
            let results = allStoreProducts;
            
            // 1. Text Search
            const searchInput = document.getElementById('store-search');
            const searchQ = searchInput ? searchInput.value.toLowerCase().trim() : '';
            
            if(searchQ) {
                results = results.filter(p => 
                    (p.title && p.title.toLowerCase().includes(searchQ)) ||
                    (p.description && p.description.toLowerCase().includes(searchQ)) ||
                    (p.brand && p.brand.toLowerCase().includes(searchQ)) ||
                    (p.tags && p.tags.some(t => t.toLowerCase().includes(searchQ))) // Check tags
                );
            }

            // 2. Category
            if(storeFilterState.category !== 'All') {
                results = results.filter(p => {
                    const cats = p.categories || [p.category];
                    return cats.includes(storeFilterState.category);
                });
            }

            // 3. Price
            if(storeFilterState.minPrice) results = results.filter(p => p.price >= parseFloat(storeFilterState.minPrice));
            if(storeFilterState.maxPrice) results = results.filter(p => p.price <= parseFloat(storeFilterState.maxPrice));

            // 4. Brand
            if(storeFilterState.brand) {
                const b = storeFilterState.brand.toLowerCase();
                results = results.filter(p => p.brand && p.brand.toLowerCase().includes(b));
            }

            // 5. Condition
            if(storeFilterState.condition) {
                results = results.filter(p => p.condition === storeFilterState.condition);
            }

            // 6. Free Shipping
            if(storeFilterState.freeShipping) {
                results = results.filter(p => (!p.shippingCost || p.shippingCost === 0));
            }

            // 7. Stock
            if(storeFilterState.inStock) {
                results = results.filter(p => p.stock > 0);
            }

            window.renderStoreGrid(results);
        };
        
        window.backToStoreFeed = () => {
            document.getElementById('store-feed-view').classList.remove('hidden');
            document.getElementById('store-detail-view').classList.add('hidden');
            currentStoreProductId = null;
        };

        window.viewProduct = async (productId, sellerId, skipNav = false) => {
            if (!sellerId) {
                alert(`Demo Product: ${productId}\n\nLogin and create real products to see the full store view.`);
                return;
            }

            if (!skipNav) {
                history.pushState(null, null, `/product/${productId}?seller=${sellerId}`);
            }

            window.renderInternalView('store');
            document.getElementById('store-feed-view').classList.add('hidden');
            document.getElementById('store-detail-view').classList.remove('hidden');

            currentStoreProductId = productId;
            currentStoreSellerId = sellerId;
            
            const container = document.getElementById('store-detail-content');
            container.innerHTML = `<div class="flex flex-col items-center justify-center min-h-[60vh] text-app-textMuted"><i data-lucide="loader-2" class="w-10 h-10 animate-spin mb-4"></i><p>Loading product details...</p></div>`;
            if(window.lucide) window.lucide.createIcons();

            try {
                // 1. Fetch Seller Data FIRST to check Ban Status
                const sellerDoc = await getDoc(doc(db, 'users', sellerId));
                let sellerName = 'User';
                let sellerAvatar = 'https://via.placeholder.com/100';
                
                if(sellerDoc.exists()) {
                    const sData = sellerDoc.data();
                    sellerName = sData.profile?.username || 'User';
                    sellerAvatar = sData.profile?.photoUrl || sellerAvatar;

                    // --- BAN CHECK ---
                    const sBannedUntil = sData.bannedUntil ? (sData.bannedUntil.toDate ? sData.bannedUntil.toDate() : new Date(sData.bannedUntil)) : null;
                    const isSellerBanned = (sData.isBanned === true && !sBannedUntil) || (sBannedUntil && sBannedUntil > new Date());

                    if (isSellerBanned) {
                        container.innerHTML = `
                            <div class="flex flex-col items-center justify-center min-h-[50vh] text-center p-6 animate-fade-in">
                                <div class="w-24 h-24 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-6 border border-red-100">
                                    <i data-lucide="ban" class="w-12 h-12"></i>
                                </div>
                                <h2 class="text-2xl font-black text-app-text mb-2">Product Unavailable</h2>
                                <p class="text-app-textMuted max-w-sm mb-8">This product is no longer available because the seller's account has been suspended.</p>
                                <button onclick="window.backToStoreFeed()" class="px-8 py-3 bg-app-card border border-app-border rounded-xl font-bold text-app-text hover:bg-app-hover transition-colors shadow-sm">
                                    Back to Store
                                </button>
                            </div>
                        `;
                        if(window.lucide) window.lucide.createIcons();
                        return; // STOP RENDERING
                    }
                }

                // 2. Fetch Product Data
                const docRef = doc(db, 'users', sellerId, 'products', productId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    container.innerHTML = `<div class="text-center py-20 text-red-500">Product not found.</div>`;
                    return;
                }

                const p = docSnap.data();
                currentProductData = { id: docSnap.id, ...p };
                
                const mainImage = (p.images && p.images.length > 0) ? p.images[0] : 'https://via.placeholder.com/600x600';
                const thumbnails = p.images || [];
                
                const isMyProduct = auth.currentUser && auth.currentUser.uid === sellerId;
                const isSoldOut = (p.stock || 0) <= 0;

                let actionButtons = '';
                
                if (isMyProduct) {
                    actionButtons = `
                        <div class="flex gap-3">
                            <div class="flex-1 bg-gray-100 dark:bg-zinc-800 text-gray-500 dark:text-gray-400 font-bold py-4 rounded-xl text-center border border-app-border cursor-not-allowed flex items-center justify-center gap-2">
                                <i data-lucide="user-check" class="w-5 h-5"></i>
                                <span>Your listing</span>
                            </div>
                            <button onclick="window.navigateTo('product/${productId}/edit')" class="px-6 bg-brand-teal text-white font-bold rounded-xl hover:bg-brand-teal/90 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="edit-2" class="w-4 h-4"></i> Edit
                            </button>
                        </div>
                    `;
                } else if (isSoldOut) {
                    actionButtons = `
                        <button disabled class="w-full bg-gray-200 dark:bg-zinc-800 text-gray-500 dark:text-gray-400 font-bold py-4 rounded-xl cursor-not-allowed flex items-center justify-center gap-2 border border-gray-300 dark:border-zinc-700">
                            <i data-lucide="slash" class="w-5 h-5"></i> Sold Out
                        </button>
                    `;
                } else {
                    actionButtons = `
                        <button onclick="window.handleBuyNow()" class="w-full bg-brand-orange text-white font-bold py-4 rounded-xl shadow-lg shadow-brand-orange/20 hover:scale-[1.02] hover:bg-brand-orangeDark transition-all">Buy Now</button>
                        <div class="flex gap-3">
                            <button onclick="window.addToCart(event)" class="flex-1 bg-brand-teal text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90 transition-all">Add to Cart</button>
                            <button onclick="window.openOfferModal()" class="flex-1 bg-app-bg text-app-text border-2 border-app-border font-bold py-3.5 rounded-xl hover:bg-app-hover transition-all">Make Offer</button>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <div class="space-y-4">
                            <div class="aspect-square bg-app-card rounded-2xl overflow-hidden border border-app-border relative shadow-lg">
                                <img id="store-main-image" src="${mainImage}" class="w-full h-full object-cover ${isSoldOut ? 'grayscale opacity-80' : ''}">
                                ${isSoldOut ? '<div class="absolute inset-0 flex items-center justify-center bg-black/10"><span class="bg-black/80 text-white text-xl font-black px-6 py-2 rounded-full uppercase tracking-widest border-2 border-white/20 -rotate-12 backdrop-blur-md shadow-2xl">Sold Out</span></div>' : ''}
                                <button onclick="window.toggleProductLike('${docSnap.id}', '${sellerId}')" class="absolute top-4 right-4 bg-white/90 px-3 py-2 rounded-full shadow-md hover:scale-105 transition-transform group z-10 flex items-center gap-2">
                                    <i data-lucide="heart" class="w-5 h-5 text-gray-400 group-hover:text-red-500 transition-colors" id="store-like-icon"></i>
                                    <span id="store-like-count" class="font-bold text-sm text-gray-600">${formatNumber(p.likes || 0)}</span>
                                </button>
                            </div>
                            <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                                ${thumbnails.map((img, idx) => `
                                    <div onclick="document.getElementById('store-main-image').src='${img}'" class="w-20 h-20 rounded-lg overflow-hidden border border-app-border cursor-pointer hover:ring-2 hover:ring-brand-teal transition-all shrink-0">
                                        <img src="${img}" class="w-full h-full object-cover">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <div class="flex justify-between items-start gap-4 mb-2">
                                    <h1 class="text-3xl font-extrabold text-app-text leading-tight">${p.title}</h1>
                                    <button onclick="window.openReportModal('product', '${docSnap.id}', '${sellerId}')" class="p-2 text-app-textMuted hover:text-red-500 hover:bg-red-50 rounded-full transition-colors shrink-0" title="Report Product">
                                        <i data-lucide="flag" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-4 text-sm text-app-textMuted mb-4">
                                    ${(p.categories && p.categories.length > 0) 
                                        ? p.categories.map(c => `<span class="bg-brand-teal/10 text-brand-teal px-3 py-1 rounded-full font-bold">${c}</span>`).join('') 
                                        : `<span class="bg-brand-teal/10 text-brand-teal px-3 py-1 rounded-full font-bold">${p.category || 'Item'}</span>`
                                    }
                                    <span>${p.condition || 'Pre-owned'}</span>
                                    <span>${p.brand || 'No Brand'}</span>
                                </div>
                                <div class="flex items-center gap-3 p-3 bg-app-card rounded-xl border border-app-border cursor-pointer hover:bg-app-hover transition-colors w-fit" onclick="window.viewUserProfile('${sellerId}', '${sellerName}', '${sellerAvatar}')">
                                    <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden"><img src="${sellerAvatar}" class="w-full h-full object-cover"></div>
                                    <div class="text-sm">
                                        <p class="font-bold text-app-text">@${sellerName}</p>
                                        <p class="text-xs text-app-textMuted">${p.location || 'Unknown Location'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="p-6 bg-app-card rounded-2xl border border-app-border space-y-4">
                                <div class="flex items-end justify-between border-b border-app-border pb-4">
                                    <div>
                                        <p class="text-sm text-app-textMuted font-bold uppercase tracking-wider">Price</p>
                                        <p class="text-4xl font-extrabold text-app-text">${window.formatCurrency(p.price)}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-app-textMuted">+ Shipping</p>
                                        <p class="font-bold text-app-text">${p.shippingCost ? window.formatCurrency(p.shippingCost) : 'Free'}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-3">
                                    ${actionButtons}
                                </div>
                                <p class="text-xs text-center text-app-textMuted flex items-center justify-center gap-1"><i data-lucide="shield-check" class="w-4 h-4 text-green-500"></i> Covered by JACE. Buyer Protection</p>
                            </div>

                            <div class="mt-4 mb-2 flex items-center gap-2">
                                <div class="bg-app-bg border border-app-border px-3 py-1.5 rounded-lg flex items-center gap-2">
                                    <i data-lucide="package" class="w-4 h-4 text-app-textMuted"></i>
                                    <span class="text-xs text-app-textMuted font-bold uppercase tracking-wider">Stock:</span>
                                    <span class="font-bold text-app-text">${p.stock || 0} available</span>
                                </div>
                                ${(p.stock && p.stock < 5 && p.stock > 0) ? '<span class="text-xs text-red-500 font-bold animate-pulse flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Low Stock!</span>' : ''}
                            </div>

                            <div>
                                <h3 class="font-bold text-lg text-app-text mb-2">Description</h3>
                                <p class="text-app-textMuted leading-relaxed whitespace-pre-line">${p.description || 'No description provided.'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-16 border-t border-app-border pt-8">
                        <h3 class="text-xl font-bold text-app-text mb-6">Reviews (0)</h3>
                        <div class="bg-app-card rounded-xl p-8 text-center text-app-textMuted border border-app-border">
                            <i data-lucide="message-square-dashed" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                            <p>No reviews yet for this item.</p>
                        </div>
                    </div>
                `;
                if(window.lucide) window.lucide.createIcons();
                
                const user = auth.currentUser;
                if (user) {
                    try {
                        const likeSnap = await getDoc(doc(db, 'users', sellerId, 'products', productId, 'likes', user.uid));
                        if(likeSnap.exists()) {
                            const icon = document.getElementById('store-like-icon');
                            if(icon) {
                                icon.classList.add('text-red-500', 'fill-red-500');
                                icon.classList.remove('text-gray-400');
                            }
                        }
                    } catch(e) {}
                }

            } catch (e) {
                console.error("Store view error:", e);
                container.innerHTML = `<div class="text-center py-20 text-red-500">Error loading product.</div>`;
            }
        };

        window.selectedCategories = { create: new Set(), edit: new Set(), 'edit-page': new Set() };

        window.handleAddCategory = (mode, select) => {
            const val = select.value;
            if (!val) return;
            window.selectedCategories[mode].add(val);
            window.renderCategoryChips(mode);
            select.value = ""; // Reset dropdown to allow adding another
        };

        window.handleRemoveCategory = (mode, cat) => {
            window.selectedCategories[mode].delete(cat);
            window.renderCategoryChips(mode);
        };

        window.renderCategoryChips = (mode) => {
            const container = document.getElementById(mode === 'create' ? 'create-category-chips' : 'edit-category-chips');
            if (!container) return;
            container.innerHTML = '';
            window.selectedCategories[mode].forEach(cat => {
                const chip = document.createElement('span');
                chip.className = "bg-brand-teal text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2 animate-fade-in";
                chip.innerHTML = `${cat} <button type="button" onclick="window.handleRemoveCategory('${mode}', '${cat}')" class="hover:text-red-200"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                container.appendChild(chip);
            });
            if(window.lucide) window.lucide.createIcons();
        };

        window.openOfferModal = () => {
            if(!auth.currentUser) { window.toggleAuthModal(true); return; }
            document.getElementById('offer-modal').classList.remove('hidden');
            document.getElementById('offer-input').value = '';
        };

        window.closeOfferModal = () => { document.getElementById('offer-modal').classList.add('hidden'); };

        window.setOfferPreset = (multiplier) => {
            if(!currentProductData) return;
            const price = currentProductData.price;
            const offer = (price * multiplier).toFixed(2);
            document.getElementById('offer-input').value = offer;
        };

        window.submitOffer = async () => {
            const amount = parseFloat(document.getElementById('offer-input').value);
            if(isNaN(amount) || amount <= 0) return;
            if(!currentProductData || !currentStoreSellerId) return;
            
            const btn = document.querySelector('#offer-modal button[onclick="window.submitOffer()"]');
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerText = "Sending...";

            try {
                const user = auth.currentUser;
                const targetId = currentStoreSellerId;
                
                // 1. Create/Get Conversation
                const convoId = [user.uid, targetId].sort().join('_');
                const convoRef = doc(db, 'conversations', convoId);
                const convoSnap = await getDoc(convoRef);
                
                if(!convoSnap.exists()) {
                    // Need seller details
                    let sellerName = 'User'; let sellerAvatar = '';
                    const sDoc = await getDoc(doc(db, 'users', targetId));
                    if(sDoc.exists()) sellerName = sDoc.data().profile?.username;
                    if(sDoc.exists()) sellerAvatar = sDoc.data().profile?.photoUrl;

                    await setDoc(convoRef, {
                        participants: [user.uid, targetId],
                        lastMessage: `Offer: $${amount}`,
                        lastUpdated: serverTimestamp(),
                        userData: {
                            [user.uid]: { username: user.displayName, avatarUrl: user.photoURL },
                            [targetId]: { username: sellerName || 'User', avatarUrl: sellerAvatar || '' }
                        }
                    });
                } else {
                    await updateDoc(convoRef, { lastMessage: `Offer: $${amount}`, lastUpdated: serverTimestamp() });
                }

                // 2. Send Offer Message
                await addDoc(collection(db, 'conversations', convoId, 'messages'), {
                    type: 'offer',
                    senderId: user.uid,
                    text: `Made an offer of $${amount} for ${currentProductData.title}`,
                    offerAmount: amount,
                    productId: currentProductData.id,
                    productTitle: currentProductData.title,
                    productImage: (currentProductData.images && currentProductData.images[0]) || '',
                    sellerId: targetId, // Added sellerId for easier retrieval later
                    timestamp: serverTimestamp()
                });

                // 3. Notify Seller
                await addDoc(collection(db, 'users', targetId, 'notifications'), {
                    type: 'offer',
                    fromUserId: user.uid,
                    fromUsername: user.displayName,
                    fromUserAvatar: user.photoURL,
                    previewText: `Offered $${amount} for ${currentProductData.title}`,
                    postId: currentProductData.id,
                    postThumbnail: (currentProductData.images && currentProductData.images[0]) || '',
                    read: false,
                    timestamp: serverTimestamp()
                });

                window.closeOfferModal();
                window.showToast("Offer sent successfully!", "success");

            } catch(e) {
                console.error("Offer failed:", e);
                window.showToast("Failed to send offer", "error");
            } finally {
                btn.disabled = false; btn.innerText = originalText;
            }
        };

        window.toggleProductLike = async (productId, sellerId) => {
            if(!auth.currentUser) { window.toggleAuthModal(true); return; }
            const icon = document.getElementById('store-like-icon');
            const isLiked = icon.classList.contains('text-red-500');
            const user = auth.currentUser;
            
            // Visual Toggle
            if(isLiked) {
                icon.classList.remove('text-red-500', 'fill-red-500');
                icon.classList.add('text-gray-400');
            } else {
                icon.classList.add('text-red-500', 'fill-red-500', 'animate-like');
                icon.classList.remove('text-gray-400');
            }

            try {
                const productRef = doc(db, 'users', sellerId, 'products', productId);
                const likeRef = doc(db, 'users', sellerId, 'products', productId, 'likes', user.uid);
                const userLikedProductRef = doc(db, 'users', user.uid, 'likedProducts', productId);
                
                const batch = writeBatch(db);

                if (isLiked) {
                    batch.delete(likeRef);
                    batch.update(productRef, { likes: increment(-1) });
                    batch.delete(userLikedProductRef);
                } else {
                    batch.set(likeRef, { timestamp: serverTimestamp() });
                    batch.update(productRef, { likes: increment(1) });
                    // Store snapshot info for profile view
                    batch.set(userLikedProductRef, {
                         productId: productId,
                         sellerId: sellerId,
                         title: currentProductData.title,
                         price: currentProductData.price,
                         image: (currentProductData.images && currentProductData.images.length > 0) ? currentProductData.images[0] : null,
                         timestamp: serverTimestamp()
                    });
                }
                await batch.commit();
            } catch (e) {
                console.error("Like toggle failed", e);

                const countSpan = document.getElementById('store-like-count');
                let currentCount = parseInt(countSpan.innerText.replace('k', '000')) || 0; // Simple parse

                if(isLiked) {
                    icon.classList.remove('text-red-500', 'fill-red-500');
                    icon.classList.add('text-gray-400');
                    if(currentCount > 0) countSpan.innerText = formatNumber(currentCount - 1);
                } else {
                    icon.classList.add('text-red-500', 'fill-red-500', 'animate-like');
                    icon.classList.remove('text-gray-400');
                    countSpan.innerText = formatNumber(currentCount + 1);
                }
            }
        };

        window.handleBuyNow = () => {
             const user = auth.currentUser;
             if(!user) { window.toggleAuthModal(true); return; }
             
             // Ensure we have product details from the view
             if(!currentProductData || !currentStoreSellerId) {
                 window.showToast("Product details missing", "error");
                 return;
             }

             // Construct a temporary item object for checkout
             const item = {
                 id: 'direct_buy_' + currentProductData.id, // Temporary ID for checkout list
                 productId: currentProductData.id,
                 sellerId: currentStoreSellerId,
                 title: currentProductData.title,
                 price: currentProductData.price,
                 image: (currentProductData.images && currentProductData.images.length > 0) ? currentProductData.images[0] : '',
                 quantity: 1,
                 stock: currentProductData.stock || 1
             };

             // Load into buffer and navigate
             checkoutItemsBuffer = [item];
             window.navigateTo('checkout');
        };
        
        // --- EDIT FUNCTIONALITY ---
        window.openEditProduct = (productId) => {
             if (!currentProductData) return;
             document.getElementById('edit-product-id').value = productId;
             document.getElementById('edit-prod-title').value = currentProductData.title;
             document.getElementById('edit-prod-desc').value = currentProductData.description || '';
             document.getElementById('edit-prod-price').value = currentProductData.price;
             document.getElementById('edit-prod-tags').value = (currentProductData.tags || []).join(', ');
             
             // Populate new fields
            window.selectedCategories.edit = new Set(currentProductData.categories || [currentProductData.category || 'Clothing']);
            window.renderCategoryChips('edit');
            document.getElementById('edit-prod-category-select').value = ""; // Reset dropdown

             document.getElementById('edit-prod-brand').value = currentProductData.brand || '';
             document.getElementById('edit-prod-condition').value = currentProductData.condition || 'New';
             document.getElementById('edit-prod-stock').value = currentProductData.stock || 1;
             document.getElementById('edit-prod-location').value = currentProductData.location || '';
             document.getElementById('edit-prod-shipping').value = currentProductData.shippingMethod || 'Standard';
             
             // Shipping Cost Logic
             const shippingCost = currentProductData.shippingCost || 0;
             const costContainer = document.getElementById('edit-shipping-cost-container');
             const radios = document.getElementsByName('edit_shipping_cost_type');
             
             if (shippingCost > 0) {
                 radios.forEach(r => { if(r.value === 'paid') r.checked = true; });
                 costContainer.classList.remove('hidden');
                 document.getElementById('edit-prod-shipping-cost').value = shippingCost;
             } else {
                 radios.forEach(r => { if(r.value === 'free') r.checked = true; });
                 costContainer.classList.add('hidden');
                 document.getElementById('edit-prod-shipping-cost').value = '';
             }

             document.getElementById('edit-product-modal').classList.remove('hidden');
        };

        window.handleEditProductSubmit = async (e) => {
            e.preventDefault();
            const pid = document.getElementById('edit-product-id').value;
            const title = document.getElementById('edit-prod-title').value.trim();
            const desc = document.getElementById('edit-prod-desc').value.trim();
            const price = parseFloat(document.getElementById('edit-prod-price').value);
            
            // New Fields
            const categories = Array.from(window.selectedCategories.edit);
            if (categories.length === 0) { alert("Please add at least one category."); return; }
            const category = categories[0];

            const brand = document.getElementById('edit-prod-brand').value.trim();
            const condition = document.getElementById('edit-prod-condition').value;
            const location = document.getElementById('edit-prod-location').value.trim();
            const tagsInput = document.getElementById('edit-prod-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
            const stock = parseInt(document.getElementById('edit-prod-stock').value) || 1;
            const shippingMethod = document.getElementById('edit-prod-shipping').value;
            
            let shippingCost = 0;
            const shippingTypeRadios = document.getElementsByName('edit_shipping_cost_type');
            let shippingType = 'free';
            for(let r of shippingTypeRadios) { if(r.checked) shippingType = r.value; }
            if (shippingType === 'paid') {
                 shippingCost = parseFloat(document.getElementById('edit-prod-shipping-cost').value) || 0;
            }
            
            if(!title || !price) { alert("Title and Price are required."); return; }
            
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerText = "Saving...";
            
            try {
                const user = auth.currentUser;
                await updateDoc(doc(db, 'users', user.uid, 'products', pid), {
                    title: title,
                    description: desc,
                    price: price,
                    category: category,
                    brand: brand,
                    condition: condition,
                    stock: stock,
                    tags: tags,
                    categories: categories,
                    location: location,
                    shippingMethod: shippingMethod,
                    shippingCost: shippingCost,
                    updatedAt: serverTimestamp()
                });
                
                window.showToast("Product updated!", "success");
                document.getElementById('edit-product-modal').classList.add('hidden');
                // Refresh view if active
                if(currentStoreProductId === pid) {
                     window.viewProduct(pid, user.uid);
                }
            } catch(err) {
                console.error("Edit Product Failed", err);
                window.showToast("Update failed", "error");
            } finally {
                btn.disabled = false; btn.innerText = originalText;
            }
        };
        
        window.openEditVideo = (videoId, videoPath, currentTitle, currentDesc, currentTags) => {
            document.getElementById('edit-video-path').value = videoPath;
            document.getElementById('edit-video-title').value = currentTitle;
            document.getElementById('edit-video-desc').value = currentDesc;
            document.getElementById('edit-video-tags').value = currentTags;
            document.getElementById('edit-video-modal').classList.remove('hidden');
        };
        
        window.handleEditVideoSubmit = async (e) => {
            e.preventDefault();
            const path = document.getElementById('edit-video-path').value;
            const title = document.getElementById('edit-video-title').value.trim();
            const desc = document.getElementById('edit-video-desc').value.trim();
            const tags = document.getElementById('edit-video-tags').value;
            
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerText = "Saving...";
            
            try {
                const tagsArray = tags.split(',').map(t => t.trim()).filter(t => t.length > 0);
                await updateDoc(doc(db, path), {
                    title: title,
                    description: desc,
                    tags: tagsArray
                });
                window.showToast("Video updated!", "success");
                document.getElementById('edit-video-modal').classList.add('hidden');
            } catch(err) {
                console.error(err);
                window.showToast("Update failed", "error");
            } finally {
                btn.disabled = false; btn.innerText = originalText;
            }
        };

        window.fetchUserProducts = async () => {
            const user = auth.currentUser;
            if (!user) return;
            
            const select = document.getElementById('upload-product-select');
            const loading = document.getElementById('upload-product-loading');
            const noProdMsg = document.getElementById('no-products-msg');
            
            if (!select) return; // Safety check

            loading.classList.remove('hidden');
            select.disabled = true;
            
            try {
                // Determine collection path: users/{uid}/products
                const q = query(collection(db, 'users', user.uid, 'products'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                userProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Clear existing options
                select.innerHTML = '<option value="" disabled selected>Select a product (Required)</option>';
                
                if (userProducts.length === 0) {
                    noProdMsg.classList.remove('hidden');
                } else {
                    noProdMsg.classList.add('hidden');
                    userProducts.forEach(prod => {
                        const opt = document.createElement('option');
                        opt.value = prod.id;
                        opt.textContent = `${prod.title} - $${prod.price.toFixed(2)}`;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error("Error fetching products for upload:", e);
                window.showToast("Failed to load your products", "error");
            } finally {
                loading.classList.add('hidden');
                select.disabled = false;
            }
        };

        window.setupNotificationsListener = () => {
             const user = auth.currentUser;
             if(!user || unsubscribeNotifications) return;
             const q = query(collection(db, 'users', user.uid, 'notifications'), orderBy('timestamp', 'desc'));
             const listEl = document.getElementById('notifications-list');
             unsubscribeNotifications = onSnapshot(q, (snapshot) => {
                listEl.innerHTML = '';
                if(snapshot.empty) {
                    listEl.innerHTML = `<div class="text-center text-app-textMuted py-20 flex flex-col items-center"><i data-lucide="bell-off" class="w-10 h-10 mb-2 opacity-50"></i><p>No notifications yet</p></div>`;
                } else {
                    let unreadCount = 0;
                    snapshot.forEach(doc => {
                        const n = doc.data();
                        if(!n.read) unreadCount++;
                        const div = document.createElement('div');
                        div.className = `flex items-center gap-4 p-4 rounded-xl border border-app-border transition-colors ${n.read ? 'bg-app-card opacity-70' : 'bg-app-bg shadow-sm border-brand-teal/30'}`;
                        div.onclick = async () => {
                             if(!n.read) await updateDoc(doc.ref, { read: true });
                             if(n.postId) window.goToFeedVideo(n.postId);
                             else if(n.fromUserId) window.viewUserProfile(n.fromUserId, n.fromUsername, n.fromUserAvatar);
                        };
                        let icon = 'bell'; let color = 'text-gray-500'; let actionText = 'started following you.';
                        if(n.type === 'like') { icon = 'heart'; color = 'text-red-500'; actionText = 'liked your video.'; }
                        else if(n.type === 'comment') { icon = 'message-circle'; color = 'text-blue-500'; actionText = 'commented: ' + (n.previewText || '...'); }
                        else if(n.type === 'follow') { icon = 'user-plus'; color = 'text-brand-orange'; actionText = 'started following you.'; }
                        else if(n.type === 'repost') { icon = 'repeat'; color = 'text-green-500'; actionText = 'reposted your video.'; }
                        else if(n.type === 'offer') { icon = 'tag'; color = 'text-green-600'; actionText = n.previewText || 'made an offer.'; }
                        else if(n.type === 'purchase') { icon = 'shopping-bag'; color = 'text-brand-teal'; actionText = n.previewText || 'purchased an item.'; }

                        let timeAgo = "Just now";
                        if (n.timestamp) {
                            const diff = (new Date() - n.timestamp.toDate()) / 1000;
                            if(diff < 60) timeAgo = 'Just now';
                            else if(diff < 3600) timeAgo = Math.floor(diff/60) + 'm ago';
                            else if(diff < 86400) timeAgo = Math.floor(diff/3600) + 'h ago';
                            else timeAgo = Math.floor(diff/86400) + 'd ago';
                        }
                        div.innerHTML = `
                            <div class="w-10 h-10 rounded-full bg-app-hover flex items-center justify-center shrink-0">
                                <i data-lucide="${icon}" class="w-5 h-5 ${color} fill-current"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-app-text leading-tight">
                                    <span class="font-bold hover:underline cursor-pointer" onclick="event.stopPropagation(); window.viewUserProfile('${n.fromUserId}', '${n.fromUsername}', '${n.fromUserAvatar}')">${n.fromUsername}</span>
                                    ${actionText}
                                </p>
                                <span class="text-xs text-app-textMuted">${timeAgo}</span>
                            </div>
                            ${n.postThumbnail ? `<div class="w-10 h-12 bg-black rounded overflow-hidden"><img src="${n.postThumbnail}" class="w-full h-full object-cover"></div>` : ''}
                        `;
                        listEl.appendChild(div);
                    });
                    const badge = document.getElementById('badge-notifications');
                    const sidebarBadge = document.getElementById('sidebar-unread-count');
                    if(unreadCount > 0) {
                        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                        badge.classList.remove('hidden');
                        sidebarBadge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                        sidebarBadge.classList.add('hidden');
                    }
                }
                if(window.lucide) window.lucide.createIcons();
             });
        };

        window.setupSystemNotificationsListener = () => {
            const user = auth.currentUser;
            if(!user) return;
            
            if(window.unsubscribeSystemNotifs) window.unsubscribeSystemNotifs();

            const listEl = document.getElementById('system-notifications-list');
            listEl.innerHTML = '<div class="text-center text-app-textMuted py-20"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading system updates...</div>';
            if(window.lucide) window.lucide.createIcons();

            const q = query(collection(db, 'users', user.uid, 'system_notifications'), orderBy('timestamp', 'desc'));

            window.unsubscribeSystemNotifs = onSnapshot(q, (snapshot) => {
                listEl.innerHTML = '';
                
                // FILTER: Only show unread notifications in the UI
                const visibleNotifications = snapshot.docs.filter(doc => !doc.data().read);

                if(visibleNotifications.length === 0) {
                    listEl.innerHTML = `<div class="text-center text-app-textMuted py-20 flex flex-col items-center"><i data-lucide="check-circle" class="w-12 h-12 mb-4 text-green-500/20"></i><p>Your account is in good standing.</p><p class="text-xs opacity-60">No active system notices.</p></div>`;
                    
                    // Hide badge
                    const badges = [document.getElementById('badge-system'), document.getElementById('mobile-badge-system')];
                    badges.forEach(b => { if(b) b.classList.add('hidden'); });
                    
                } else {
                    let unreadCount = visibleNotifications.length;

                    visibleNotifications.forEach(docSnap => {
                        const n = docSnap.data();
                        
                        // Color coding based on type
                        let borderClass = 'border-l-4 border-l-blue-500';
                        let icon = 'info';
                        let iconColor = 'text-blue-500';
                        let bgClass = 'bg-app-card';

                        if(n.type === 'warn' || n.type === 'warning') { borderClass = 'border-l-4 border-l-yellow-500'; icon = 'triangle-alert'; iconColor = 'text-yellow-500'; bgClass = 'bg-yellow-50 dark:bg-yellow-900/10'; }
                        if(n.type === 'strike') { borderClass = 'border-l-4 border-l-orange-500'; icon = 'zap'; iconColor = 'text-orange-500'; bgClass = 'bg-orange-50 dark:bg-orange-900/10'; }
                        if(n.type === 'ban') { borderClass = 'border-l-4 border-l-red-500'; icon = 'ban'; iconColor = 'text-red-500'; bgClass = 'bg-red-50 dark:bg-red-900/10'; }

                        const div = document.createElement('details');
                        div.className = `group bg-app-card border border-app-border rounded-r-xl rounded-l-none ${borderClass} shadow-sm animate-fade-in overflow-hidden`;
                        
                        div.innerHTML = `
                            <summary class="flex items-center gap-4 p-4 cursor-pointer hover:bg-app-hover transition-colors list-none">
                                <div class="w-10 h-10 rounded-full ${bgClass} flex items-center justify-center shrink-0">
                                    <i data-lucide="${icon}" class="w-5 h-5 ${iconColor}"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-center mb-1">
                                        <h4 class="font-bold text-app-text text-sm">${n.title || 'System Notification'}</h4>
                                        <span class="text-[10px] text-app-textMuted">${n.timestamp ? new Date(n.timestamp.toDate()).toLocaleDateString() : 'Just now'}</span>
                                    </div>
                                    <p class="text-xs text-app-textMuted truncate">${n.violation || 'Important account update'}</p>
                                </div>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-app-textMuted group-open:rotate-180 transition-transform"></i>
                            </summary>
                            <div class="p-4 pt-0 text-sm text-app-text border-t border-app-border/50 bg-app-bg">
                                <div class="mt-4 space-y-3">
                                    <div>
                                        <p class="text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Violation</p>
                                        <p class="font-medium text-red-500">${n.violation || 'Unspecified'}</p>
                                    </div>
                                    ${n.contentSnapshot ? `
                                    <div class="bg-app-card p-3 rounded border border-app-border">
                                        <p class="text-xs font-bold text-app-textMuted uppercase tracking-wider mb-1">Removed Content Context</p>
                                        <p class="font-mono text-xs text-app-textMuted whitespace-pre-wrap">${n.contentSnapshot}</p>
                                    </div>` : ''}
                                    <div class="flex gap-3 pt-2">
                                        <button class="text-xs font-bold text-brand-teal hover:underline flex items-center gap-1">
                                            <i data-lucide="book-open" class="w-3 h-3"></i> Read Terms of Service
                                        </button>
                                        <button onclick="window.handleDismissSystemNotification('${docSnap.id}')" class="text-xs font-bold text-app-textMuted hover:text-red-500 ml-auto border border-app-border px-3 py-1 rounded hover:bg-app-hover transition-colors">
                                            Dismiss
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        listEl.appendChild(div);
                    });

                    // Update Badges
                    const badges = [document.getElementById('badge-system'), document.getElementById('mobile-badge-system')];
                    badges.forEach(b => {
                        if(b) {
                            if(unreadCount > 0) {
                                b.textContent = unreadCount > 9 ? '9+' : unreadCount;
                                b.classList.remove('hidden');
                            } else {
                                b.classList.add('hidden');
                            }
                        }
                    });
                }
                if(window.lucide) window.lucide.createIcons();
            });
        };

        window.handleDismissSystemNotification = async (notifId) => {
            const user = auth.currentUser;
            if(!user) return;
            try {
                // CHANGED: Use updateDoc to mark as read (hide) instead of deleteDoc
                await updateDoc(doc(db, 'users', user.uid, 'system_notifications', notifId), { read: true });
                window.showToast("Notification dismissed", "success");
            } catch(e) {
                console.error("Dismiss failed", e);
                window.showToast("Error dismissing notification", "error");
            }
        };

        window.handleDismissProfileWarning = (notifId) => {
            // 1. Immediate UI Removal from Profile
            const el = document.getElementById('profile-active-warning');
            if(el) el.remove();

            // 2. Save to LocalStorage
            // This ensures it stays hidden on refresh, but doesn't change the DB 'read' status.
            // This keeps it visible in the Inbox until dismissed there.
            const dismissed = JSON.parse(localStorage.getItem('jace_dismissed_profile_warnings') || '[]');
            if(!dismissed.includes(notifId)) {
                dismissed.push(notifId);
                localStorage.setItem('jace_dismissed_profile_warnings', JSON.stringify(dismissed));
            }
        };
        
        window.setupConversationsListener = () => {
             const user = auth.currentUser;
             if(!user || unsubscribeConversations) return;
             const q = query(collection(db, 'conversations'), where('participants', 'array-contains', user.uid));
             const listEl = document.getElementById('conversations-list');
             unsubscribeConversations = onSnapshot(q, (snapshot) => {
                listEl.innerHTML = '';
                if(snapshot.empty) {
                    listEl.innerHTML = `<div class="text-center text-app-textMuted py-10 px-4 text-xs">No conversations yet.<br>Visit a profile to message someone.</div>`;
                } else {
                    const chats = [];
                    snapshot.forEach(doc => { chats.push({ id: doc.id, ...doc.data() }); });
                    chats.sort((a, b) => {
                        const tA = a.lastUpdated && a.lastUpdated.toDate ? a.lastUpdated.toDate().getTime() : (a.lastUpdated || 0);
                        const tB = b.lastUpdated && b.lastUpdated.toDate ? b.lastUpdated.toDate().getTime() : (b.lastUpdated || 0);
                        return tB - tA;
                    });
                    chats.forEach(data => {
                        const otherUserId = data.participants.find(id => id !== user.uid);
                        const otherUserData = data.userData ? data.userData[otherUserId] : { username: 'User', avatarUrl: '' };
                        const name = otherUserData.username || 'User';
                        const avatar = otherUserData.avatarUrl || 'https://via.placeholder.com/100';
                        const isActive = activeConversationId === data.id;
                        const div = document.createElement('div');
                        div.className = `flex items-center gap-3 p-3 cursor-pointer hover:bg-app-hover border-b border-app-border transition-colors ${isActive ? 'bg-app-hover' : ''}`;
                        div.onclick = () => window.loadConversation(data.id, otherUserId, name, avatar);
                        let timeStr = '';
                        if(data.lastUpdated && data.lastUpdated.toDate) {
                            const d = data.lastUpdated.toDate();
                            timeStr = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        }
                        let previewMsg = data.lastMessage || 'Started a conversation';
                        if(previewMsg.includes('type:video')) previewMsg = 'Shared a video ð¹';
                        div.innerHTML = `
                            <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden shrink-0">
                                <img src="${avatar}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-baseline">
                                    <h4 class="font-bold text-sm text-app-text truncate">${name}</h4>
                                    <span class="text-[10px] text-app-textMuted flex-shrink-0">${timeStr}</span>
                                </div>
                                <p class="text-xs text-app-textMuted truncate opacity-80">${previewMsg}</p>
                            </div>
                        `;
                        listEl.appendChild(div);
                    });
                }
             }, (error) => { console.error("Conversations Error:", error); });
        };
        
        window.loadConversation = async (convoId, otherUserId, name, avatar) => {
            activeConversationId = convoId;
            const user = auth.currentUser;

            // --- FIX: Responsive Sidebar Logic ---
            // Only hide the sidebar on mobile devices (width < 768px).
            // On Desktop, both sidebar and chat wrapper should be visible side-by-side.
            
            const sidebar = document.getElementById('conversations-sidebar');
            const chatWrapper = document.getElementById('chat-wrapper');
            
            if (window.innerWidth < 768) {
                // Mobile: Hide list, Show chat
                if(sidebar) {
                    sidebar.classList.add('hidden');
                    sidebar.style.display = 'none'; // Force hide list
                }
                if(chatWrapper) {
                    chatWrapper.classList.remove('hidden');
                    chatWrapper.classList.add('flex');
                    chatWrapper.style.display = 'flex'; // Force show chat
                }
            } else {
                // Desktop: Show both side-by-side
                if(sidebar) {
                    sidebar.classList.remove('hidden');
                    sidebar.style.display = 'flex';
                }
                if(chatWrapper) {
                    chatWrapper.classList.remove('hidden');
                    chatWrapper.classList.add('flex');
                    chatWrapper.style.display = 'flex';
                }
            }

            // Reset Chat UI
            document.getElementById('chat-empty-state').classList.add('hidden');
            const chatInterface = document.getElementById('chat-interface');
            chatInterface.classList.remove('hidden');
            chatInterface.classList.add('flex');
            
            document.getElementById('chat-header-name').textContent = name;
            document.getElementById('chat-header-avatar').src = avatar;
            
            const backBtn = chatInterface.querySelector('.sticky button');
            if(backBtn) {
                backBtn.onclick = window.handleMobileChatBack;
            }

            // Ensure the conversation list listener is active (in case of direct link navigation)
            if (!window.unsubscribeConversations && window.setupConversationsListener) {
                window.setupConversationsListener(); 
            }

            if(unsubscribeMessages) unsubscribeMessages();
            
            const msgsDiv = document.getElementById('chat-messages-area');
            msgsDiv.innerHTML = '<div class="text-center text-xs text-app-textMuted py-4"><i data-lucide="loader-2" class="w-4 h-4 animate-spin mx-auto mb-2"></i>Loading history...</div>';
            if(window.lucide) window.lucide.createIcons();
            
            const q = query(collection(db, 'conversations', convoId, 'messages'), orderBy('timestamp', 'asc'));

            // 1. Cleanup Old Listener
            if (chatStatusUnsub) {
                chatStatusUnsub();
                chatStatusUnsub = null;
            }

            // 2. Setup Header UI
            const headerNameDiv = document.getElementById('chat-header-name').parentNode;
            
            // Remove old status element if exists to prevent duplicates
            const oldStatus = document.getElementById('chat-active-status');
            if(oldStatus) oldStatus.remove();

            // Create new status element
            const statusDisplay = document.createElement('span');
            statusDisplay.id = 'chat-active-status';
            statusDisplay.className = "text-xs font-bold flex items-center gap-1 mt-0.5";
            headerNameDiv.appendChild(statusDisplay);

            // 3. Start New Listener
            chatStatusUnsub = onSnapshot(doc(db, 'users', otherUserId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const status = data.status || {};
                    const lastSeenText = window.formatLastSeen(status.last_changed);
                    const isOnline = lastSeenText === 'Online';
                    
                    statusDisplay.innerHTML = `
                        <span class="w-1.5 h-1.5 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></span>
                        <span class="${isOnline ? 'text-green-500' : 'text-app-textMuted'}">${lastSeenText}</span>
                    `;
                    
                    // Hide hardcoded mock status
                    const hardcoded = headerNameDiv.querySelector('.text-green-500');
                    if(hardcoded && hardcoded.id !== 'chat-active-status') hardcoded.style.display = 'none';
                }
            });

            // --- FIX: Added Error Callback to onSnapshot ---
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                msgsDiv.innerHTML = '';
                
                if(snapshot.empty) msgsDiv.innerHTML = '<div class="text-center text-xs text-app-textMuted py-10">Say hello! ð</div>';
                
                snapshot.forEach(doc => {
                    const m = doc.data();
                    const me = m.senderId === user.uid;
                    const bubble = document.createElement('div');
                    
                    // Base Class
                    bubble.className = `max-w-[85%] md:max-w-[70%] p-3 text-sm animate-fade-in ${me ? 'chat-bubble-sent self-end' : 'chat-bubble-received self-start'}`;
                    
                    if (m.type === 'video') {
                        bubble.innerHTML = `
                            <div class="video-msg-preview group" onclick="window.goToFeedVideo('${m.videoId}')">
                                <video src="${m.videoUrl}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" muted loop onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>
                                <div class="absolute inset-0 flex items-center justify-center bg-black/30 group-hover:bg-transparent transition-all pointer-events-none">
                                    <div class="w-8 h-8 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center">
                                        <i data-lucide="play" class="w-4 h-4 fill-white text-white"></i>
                                    </div>
                                </div>
                            </div>
                        `;
                        bubble.className = `max-w-[85%] md:max-w-[70%] p-1 animate-fade-in ${me ? 'self-end' : 'self-start'}`; 
                    
                    } else if (m.type === 'profile') {
                        bubble.innerHTML = `
                            <div class="flex items-center gap-3 min-w-[200px] cursor-pointer" onclick="window.viewUserProfile('${m.profileId}', '${m.profileUsername}', '${m.profileAvatar}')">
                                <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden shrink-0 border border-white/20">
                                    <img src="${m.profileAvatar || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-bold text-sm truncate">@${m.profileUsername}</p>
                                    <div class="flex items-center gap-1 text-[10px] opacity-80 font-bold uppercase tracking-wider">
                                        View Profile <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                    </div>
                                </div>
                            </div>
                        `;
                    
                    } else if (m.type === 'offer') {
                        const productOwnerId = m.sellerId || (me ? otherUserId : user.uid);
                        const status = m.status || 'pending';
                        const isMyOffer = m.senderId === user.uid;
                        let statusHtml = '';
                        
                        if (isMyOffer) {
                            if (status === 'pending') statusHtml = `<div class="mt-2 text-xs font-bold text-app-textMuted bg-black/20 p-2 rounded text-center">Waiting for seller response...</div>`;
                            else if (status === 'accepted') statusHtml = `<div class="mt-2 bg-green-500/20 border border-green-500/30 p-3 rounded-lg text-center"><p class="text-xs font-bold text-green-100 mb-2">Offer Accepted!</p><button onclick="window.addOfferToCart('${m.productId}', '${productOwnerId}', '${(m.productTitle || 'Product').replace(/'/g, "\\'")}', ${m.offerAmount}, '${(m.productImage || '').replace(/'/g, "\\'")}')" class="w-full bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-2 rounded shadow-sm transition-colors">Add to Cart ($${m.offerAmount})</button></div>`;
                            else if (status === 'declined') statusHtml = `<div class="mt-2 text-xs font-bold text-red-300 bg-red-500/10 p-2 rounded text-center border border-red-500/20">Offer Declined</div>`;
                        } else {
                            if (status === 'pending') statusHtml = `<div class="mt-2 grid grid-cols-2 gap-2"><button onclick="window.declineOffer('${activeConversationId}', '${doc.id}')" class="bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 text-red-100 text-xs font-bold py-2 rounded transition-colors">Decline</button><button onclick="window.acceptOffer('${activeConversationId}', '${doc.id}')" class="bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 text-green-100 text-xs font-bold py-2 rounded transition-colors">Accept</button></div>`;
                            else if (status === 'accepted') statusHtml = `<div class="mt-2 text-xs font-bold text-green-300 bg-green-500/10 p-2 rounded text-center border border-green-500/20">You accepted this offer</div>`;
                            else if (status === 'declined') statusHtml = `<div class="mt-2 text-xs font-bold text-red-300 bg-black/20 p-2 rounded text-center">You declined this offer</div>`;
                        }

                        bubble.innerHTML = `
                            <div class="flex flex-col gap-3 min-w-[200px] md:min-w-[240px]">
                                <div class="flex items-center gap-2 font-bold border-b border-white/20 pb-2 mb-1"><i data-lucide="tag" class="w-4 h-4"></i> Product Offer</div>
                                ${m.productImage ? `<img src="${m.productImage}" class="w-full aspect-square rounded-lg bg-black/10 object-cover border border-white/10">` : ''}
                                <div class="space-y-1"><p class="font-bold text-base md:text-lg leading-tight truncate">${m.productTitle || 'Product'}</p><p class="text-2xl md:text-3xl font-extrabold tracking-tight">$${m.offerAmount.toFixed(2)}</p></div>
                                <button onclick="window.viewProduct('${m.productId}', '${productOwnerId}')" class="mt-2 w-full bg-white/20 hover:bg-white/30 text-sm font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-2">View Product <i data-lucide="arrow-right" class="w-3 h-3"></i></button>
                                ${statusHtml}
                            </div>
                        `;
                    } else {
                        // Text Message
                        bubble.textContent = m.text;
                    }
                    
                    msgsDiv.appendChild(bubble);
                });
                
                if(window.lucide) window.lucide.createIcons();
                // Scroll to bottom
                setTimeout(() => { msgsDiv.scrollTop = msgsDiv.scrollHeight; }, 50);

            }, (error) => {
                console.error("Messages Error:", error);
                msgsDiv.innerHTML = `<div class="text-center text-xs text-red-500 py-10">Unable to load messages.<br>${error.message}</div>`;
            });

            // Check Input State (Blocking Check)
            const input = document.getElementById('chat-input');
            const sendBtn = document.querySelector('#chat-interface button[type="submit"]');
            
            if(blockedUsers.has(otherUserId)) {
                input.disabled = true; input.placeholder = "You blocked this user.";
                input.classList.add('cursor-not-allowed', 'opacity-50'); sendBtn.disabled = true; sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            try {
                const theirBlockRef = doc(db, 'users', otherUserId, 'blocked', user.uid);
                const snap = await getDoc(theirBlockRef);
                if(snap.exists()) {
                    input.disabled = true; input.placeholder = "Message sending unavailable.";
                    input.classList.add('cursor-not-allowed', 'opacity-50'); sendBtn.disabled = true; sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    const notice = document.createElement('div');
                    notice.className = "text-center text-xs text-red-500 py-2 bg-red-50 dark:bg-red-900/20 rounded-lg mx-auto w-fit px-4 my-2";
                    notice.innerText = "This user has you blocked.";
                    msgsDiv.appendChild(notice);
                } else {
                    input.disabled = false; input.placeholder = "Type a message...";
                    input.classList.remove('cursor-not-allowed', 'opacity-50'); sendBtn.disabled = false; sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch(e) {
                // Default to enabled on error (optimistic)
                input.disabled = false; input.placeholder = "Type a message...";
                input.classList.remove('cursor-not-allowed', 'opacity-50'); sendBtn.disabled = false;
            }
        };

        window.handleMobileChatBack = () => {
            const sidebar = document.getElementById('conversations-sidebar');
            const chatWrapper = document.getElementById('chat-wrapper');
            
            // Hide Chat
            if(chatWrapper) {
                chatWrapper.classList.add('hidden');
                chatWrapper.classList.remove('flex');
                chatWrapper.style.display = 'none'; // Force hide
            }
            
            // Show List
            if(sidebar) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
                sidebar.style.display = 'flex'; // Force show
            }
            
            activeConversationId = null;
        };
        
        window.handleSendMessage = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text || !activeConversationId) return;
            input.value = '';
            const user = auth.currentUser;
            try {
                await addDoc(collection(db, 'conversations', activeConversationId, 'messages'), {
                    text: text, type: 'text', senderId: user.uid, timestamp: serverTimestamp()
                });
                await updateDoc(doc(db, 'conversations', activeConversationId), {
                    lastMessage: text, lastUpdated: serverTimestamp()
                });
            } catch(e) { console.error("Send failed", e); }
        };
        
        window.startDirectMessageFromProfile = async () => {
             const user = auth.currentUser;
             const targetId = currentViewedProfileId;
             if(!user || !targetId) return;
             const convoId = [user.uid, targetId].sort().join('_');
             const convoRef = doc(db, 'conversations', convoId);
             const convoSnap = await getDoc(convoRef);
             if(!convoSnap.exists()) {
                const targetName = document.getElementById('profile-name').textContent.replace('@', '');
                const targetImg = document.getElementById('profile-image').src;
                await setDoc(convoRef, {
                    participants: [user.uid, targetId],
                    lastMessage: '',
                    lastUpdated: serverTimestamp(),
                    userData: {
                        [user.uid]: { username: user.displayName, avatarUrl: user.photoURL },
                        [targetId]: { username: targetName, avatarUrl: targetImg }
                    }
                });
             }
             window.navigateTo('inbox');
             window.switchInboxTab('messages');
             const d = (await getDoc(convoRef)).data();
             const targetName = document.getElementById('profile-name').textContent.replace('@', '');
             const targetImg = document.getElementById('profile-image').src;
             window.loadConversation(convoId, targetId, targetName, targetImg);
        };

        const originalOpenShareModal = window.openShareModal;
        window.openShareModal = (event, videoId, videoPath, videoUrl, authorId, title, desc, tags) => {
            currentShareProfile = null; // Clear profile state
            originalOpenShareModal(event, videoId, videoPath, videoUrl, authorId, title, desc, tags);
        };

        window.openShareModal = async (event, videoId, videoPath, videoUrl, authorId, title = '', desc = '', tags = '', username = '') => {
            if(event) event.stopPropagation();
            if (!auth.currentUser) { window.toggleAuthModal(true); return; }
            document.querySelectorAll('video').forEach(v => v.pause());
            
            currentShareVideo = { id: videoId, path: videoPath, url: videoUrl, authorId: authorId };
            const modal = document.getElementById('share-modal');
            const list = document.getElementById('share-following-list');
            const actionsRow = document.getElementById('share-actions-row');

            // Construct the shareable link
            // Fallback if username isn't passed (e.g. legacy calls) -> try to find in DOM or default
            let shareUsername = username;
            if (!shareUsername) {
                // Try to get from auth if it's mine, otherwise generic
                shareUsername = (auth.currentUser.uid === authorId) ? auth.currentUser.displayName : 'user';
            }
            const shareLink = `${window.location.origin}/${shareUsername}/video/${videoId}`;
            
            // Check ownership
            const isOwner = auth.currentUser.uid === authorId;
            let actionsHtml = '';

            const copyButtonHtml = `
                <button onclick="navigator.clipboard.writeText('${shareLink}'); window.showToast('Link copied!', 'success'); window.closeShareModal();" class="flex flex-col items-center gap-2 min-w-[70px] group w-full">
                    <div class="w-12 h-12 rounded-full bg-blue-500/10 group-hover:bg-blue-500/20 flex items-center justify-center transition-colors border border-blue-500/30 group-hover:border-blue-500">
                        <i data-lucide="link" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <span class="text-xs text-app-text font-bold">Copy Link</span>
                </button>
            `;
            
            if (isOwner) {
                // Escape strings for onclick (even though we aren't passing them to edit anymore, nice to keep safe)
                const safeTitle = title.replace(/'/g, "\\'");
                const safeDesc = desc.replace(/'/g, "\\'");
                const safeTags = tags.replace(/'/g, "\\'");
                
                actionsHtml = `
                    ${copyButtonHtml}
                    <button onclick="window.navigateTo('video/${videoId}/edit'); window.closeShareModal();" class="flex flex-col items-center gap-2 min-w-[70px] group w-full">
                        <div class="w-12 h-12 rounded-full bg-brand-teal/10 group-hover:bg-brand-teal/20 flex items-center justify-center transition-colors border border-brand-teal/30 group-hover:border-brand-teal">
                            <i data-lucide="edit-2" class="w-6 h-6 text-brand-teal"></i>
                        </div>
                        <span class="text-xs text-app-text font-bold">Edit</span>
                    </button>
                    <button onclick="window.handleDeleteVideo(event, '${videoPath}'); window.closeShareModal();" class="flex flex-col items-center gap-2 min-w-[70px] group w-full">
                        <div class="w-12 h-12 rounded-full bg-red-500/10 group-hover:bg-red-500/20 flex items-center justify-center transition-colors border border-red-500/30 group-hover:border-red-500">
                            <i data-lucide="trash-2" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                        </div>
                        <span class="text-xs text-app-text font-bold">Delete</span>
                    </button>
                `;
            } else {
                actionsHtml = `
                    <button onclick="window.handleRepost()" class="flex flex-col items-center gap-2 min-w-[70px] group w-full">
                        <div class="w-12 h-12 rounded-full bg-yellow-500/10 group-hover:bg-yellow-500/20 flex items-center justify-center transition-colors border border-yellow-500/30 group-hover:border-yellow-500">
                            <i data-lucide="repeat" class="w-6 h-6 text-yellow-600 group-hover:text-yellow-700 dark:text-yellow-400 dark:group-hover:text-yellow-300"></i>
                        </div>
                        <span class="text-xs text-app-text font-bold">Repost</span>
                    </button>
                    ${copyButtonHtml}
                    <button onclick="window.handleNotInterested()" class="flex flex-col items-center gap-2 min-w-[70px] group w-full">
                        <div class="w-12 h-12 rounded-full bg-gray-500/10 group-hover:bg-gray-500/20 flex items-center justify-center transition-colors border border-gray-500/30 group-hover:border-gray-500">
                            <i data-lucide="thumbs-down" class="w-6 h-6 text-gray-600 group-hover:text-gray-700 dark:text-gray-400 dark:group-hover:text-gray-300"></i>
                        </div>
                        <span class="text-xs text-app-text font-bold">Hide</span>
                    </button>
                    <button onclick="window.openReportModal('video', '${videoId}', '${authorId}'); window.closeShareModal();" class="flex flex-col items-center gap-2 min-w-[70px] group w-full">
                        <div class="w-12 h-12 rounded-full bg-red-500/10 group-hover:bg-red-500/20 flex items-center justify-center transition-colors border border-red-500/30 group-hover:border-red-500">
                            <i data-lucide="flag" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                        </div>
                        <span class="text-xs text-app-text font-bold">Report</span>
                    </button>
                `;
            }
            actionsRow.innerHTML = actionsHtml;
            
            modal.classList.remove('hidden');
            list.innerHTML = '<div class="text-center text-sm text-app-textMuted py-8"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading friends...</div>';
            if(window.lucide) window.lucide.createIcons();

            try {
                const q = query(collection(db, 'users', auth.currentUser.uid, 'following'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    list.innerHTML = `<div class="text-center text-sm text-app-textMuted py-8"><p>You aren't following anyone yet.</p><button onclick="window.navigateTo('explore'); window.closeShareModal();" class="mt-2 text-brand-orange hover:underline font-bold">Find people to follow</button></div>`;
                } else {
                    list.innerHTML = '';
                    const followingIds = snapshot.docs.map(d => d.id);
                    const promises = followingIds.slice(0, 10).map(uid => getDoc(doc(db, 'users', uid)));
                    const userDocs = await Promise.all(promises);
                    userDocs.forEach(userDoc => {
                        if(userDoc.exists()) {
                            const u = userDoc.data();
                            const profile = u.profile || {};
                            const uName = profile.username || 'User';
                            const uAv = profile.photoUrl || 'https://via.placeholder.com/100';
                            const div = document.createElement('div');
                            div.className = 'flex items-center gap-3 p-3 hover:bg-app-hover rounded-xl cursor-pointer transition-colors group';
                            div.onclick = () => window.handleShareToUser(userDoc.id, uName, uAv);
                            div.innerHTML = `
                                <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden shrink-0"><img src="${uAv}" class="w-full h-full object-cover"></div>
                                <div class="flex-1"><h4 class="font-bold text-sm text-app-text">${uName}</h4><p class="text-xs text-app-textMuted">Send via Direct Message</p></div>
                                <div class="w-8 h-8 rounded-full bg-brand-teal/10 flex items-center justify-center group-hover:bg-brand-teal text-brand-teal group-hover:text-white transition-all"><i data-lucide="send" class="w-4 h-4"></i></div>
                            `;
                            list.appendChild(div);
                        }
                    });
                    if(window.lucide) window.lucide.createIcons();
                }
            } catch(e) { console.error(e); list.innerHTML = 'Error loading list'; }
        };

        window.closeShareModal = () => { document.getElementById('share-modal').classList.add('hidden'); currentShareVideo = null; };
        
        window.handleShareToUser = async (targetId, targetName, targetAvatar) => {
            if (!auth.currentUser) return;
            const user = auth.currentUser;
            const convoId = [user.uid, targetId].sort().join('_');
            const isVideoShare = !!currentShareVideo;
            const isProfileShare = !!currentShareProfile;

            if (!isVideoShare && !isProfileShare) return;

            try {
                const convoRef = doc(db, 'conversations', convoId);
                const convoRefSnap = await getDoc(convoRef);
                let lastMsgText = isVideoShare ? 'Shared a video' : 'Shared a profile';
                
                if(!convoRefSnap.exists()) {
                    await setDoc(convoRef, {
                        participants: [user.uid, targetId], lastMessage: lastMsgText, lastUpdated: serverTimestamp(),
                        userData: { [user.uid]: { username: user.displayName, avatarUrl: user.photoURL }, [targetId]: { username: targetName, avatarUrl: targetAvatar } }
                    });
                } else { 
                    await updateDoc(convoRef, { lastMessage: lastMsgText, lastUpdated: serverTimestamp() }); 
                }

                const msgData = { senderId: user.uid, timestamp: serverTimestamp() };

                if (isVideoShare) {
                    msgData.type = 'video';
                    msgData.videoId = currentShareVideo.id;
                    msgData.videoUrl = currentShareVideo.url;
                    await window.incrementShareCount(currentShareVideo.id, currentShareVideo.path);
                    
                    if(currentShareVideo.path && currentShareVideo.path !== 'null') {
                        await setDoc(doc(db, currentShareVideo.path, 'shares', user.uid), { timestamp: serverTimestamp() });
                    }
                } else if (isProfileShare) {
                    msgData.type = 'profile';
                    msgData.profileId = currentShareProfile.id;
                    msgData.profileUsername = currentShareProfile.username;
                    msgData.profileAvatar = currentShareProfile.avatar;
                }

                await addDoc(collection(db, 'conversations', convoId, 'messages'), msgData);
                
                window.closeShareModal(); 
                window.showToast(`Sent to ${targetName}`, 'success');
                
                currentShareVideo = null;
                currentShareProfile = null;

            } catch (e) { 
                console.error("Share failed", e); 
                window.showToast("Failed to share", "error"); 
            }
        };

        window.handleRepost = async () => {
            if (!currentShareVideo || !auth.currentUser) return;
            const user = auth.currentUser;
            
            // Try to deduce type from DOM since `currentShareVideo` might lack it
            let mediaType = 'video';
            let mediaThumb = currentShareVideo.url; // Default to videoUrl passed in share

            // Try to find the element in background to check if slideshow
            const wrapper = document.querySelector(`.video-item-wrapper[data-id="${currentShareVideo.id}"]`);
            if (wrapper) {
                const slideImg = wrapper.querySelector(`img[id^="slide-${currentShareVideo.id}-"]`);
                if (slideImg) {
                    mediaType = 'slideshow';
                    mediaThumb = slideImg.src;
                }
            }

            try {
                const batch = writeBatch(db);
                
                // 1. User's repost list (Save Metadata)
                const repostRef = doc(db, 'users', user.uid, 'reposts', currentShareVideo.id);
                batch.set(repostRef, {
                    videoId: currentShareVideo.id, 
                    type: mediaType,
                    videoUrl: currentShareVideo.url, // Keep original URL reference
                    thumbnailUrl: mediaThumb,        // Save thumbnail for grid
                    path: currentShareVideo.path, 
                    originalAuthorId: currentShareVideo.authorId, 
                    timestamp: serverTimestamp()
                });

                // 2. Notification & Counters (Simplified)
                if (currentShareVideo.authorId && currentShareVideo.authorId !== user.uid) {
                    const notifRef = doc(collection(db, 'users', currentShareVideo.authorId, 'notifications'));
                    batch.set(notifRef, {
                        type: 'repost', fromUserId: user.uid, fromUsername: user.displayName, fromUserAvatar: user.photoURL, 
                        postId: currentShareVideo.id, postThumbnail: mediaThumb, read: false, timestamp: serverTimestamp() 
                    });
                }
                
                if(currentShareVideo.path && currentShareVideo.path !== 'null') {
                    const vidRef = doc(db, currentShareVideo.path);
                    batch.update(vidRef, { shares: increment(1) }); 
                }

                // Update DOM Count
                const el = document.querySelector(`.share-count-${currentShareVideo.id}`);
                if(el) { let val = parseInt(el.innerText.replace('k','000')); el.innerText = formatNumber(val + 1); }

                await batch.commit();
                window.closeShareModal(); 
                window.showToast("Reposted to your profile!", "success");
            } catch (e) { 
                console.error("Repost failed", e); 
                window.showToast("Failed to repost video", "error"); 
            }
        };

        window.handleNotInterested = () => {
             if (!currentShareVideo) return;
             // In a real app, save to user preferences/db. For now, hide from DOM.
             const el = document.querySelector(`.video-item-wrapper[data-id="${currentShareVideo.id}"]`);
             if (el) {
                 // Try to scroll to next before removing
                 const next = el.nextElementSibling;
                 if(next) next.scrollIntoView({behavior: 'smooth'});
                 setTimeout(() => el.remove(), 500);
             }
             window.closeShareModal();
             window.showToast("Video hidden. We'll show fewer videos like this.", "success");
        };

        // --- EXPLORE & FEED ---
        window.setupExploreListener = () => {
            if (unsubscribeExplore) return; 
            const grid = document.getElementById('explore-grid');
            const q = query(collectionGroup(db, 'videos'));
            unsubscribeExplore = onSnapshot(q, (snapshot) => {
                const dbPosts = snapshot.docs.map(d => ({ id: d.id, ...d.data(), path: d.ref.path }));
                allExploreVideos = [...dbPosts, ...FEED_DATA.map(p => ({...p, path: 'null'}))];
                const seen = new Set();     
                let uniqueVideos = [];
                
                // Merge and dedup
                const combined = [...dbPosts, ...FEED_DATA.map(p => ({...p, path: 'null'}))];
                combined.forEach(v => {
                    if(!seen.has(v.id)) { seen.add(v.id); uniqueVideos.push(v); }
                });

                // --- VISIBILITY FILTERING ---
                const myUid = auth.currentUser ? auth.currentUser.uid : null;
                allExploreVideos = uniqueVideos.filter(video => {
                    // Safety check for user object
                    const creatorId = video.user ? video.user.id : (video.creatorId || null);
                    
                    if (myUid && creatorId === myUid) return true;
                    if (video.visibility === 'private') return false;
                    if (video.visibility === 'followers') {
                        if (creatorId && window.myFollowing && window.myFollowing.has(creatorId)) return true;
                        return false;
                    }
                    return true;
                });

                window.renderExploreGrid(allExploreVideos);
            }, (error) => { console.error("Explore Error:", error); grid.innerHTML = `<div class="col-span-full text-center text-red-500">Error loading explore feed.</div>`; });
        };

        window.renderExploreGrid = (videos) => {
            const grid = document.getElementById('explore-grid');
            grid.innerHTML = '';
            
            if (videos.length === 0) {
                grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-app-textMuted opacity-60"><i data-lucide="search-x" class="w-16 h-16 mb-4"></i><p class="text-lg font-bold">No videos found</p><p class="text-sm">Try searching for something else.</p></div>`;
            } else {
                videos.forEach(video => {
                    const div = document.createElement('div');
                    div.className = 'aspect-[9/16] bg-black rounded-xl overflow-hidden relative cursor-pointer group border border-app-border shadow-sm hover:shadow-lg transition-all';
                    div.onclick = () => window.goToFeedVideo(video.id, video.user?.username);
                    
                    const title = video.title || video.description || 'Untitled';
                    const user = video.user?.username || 'User';
                    const views = video.views || 0;
                    
                    // Slideshow Detection
                    const isSlideshow = video.type === 'slideshow' || (video.images && video.images.length > 0);
                    let mediaHtml = '';
                    let iconHtml = '';

                    if (isSlideshow) {
                        // Slideshow Render
                        const coverImage = (video.images && video.images.length > 0) ? video.images[0] : (video.thumbnailUrl || '');
                        mediaHtml = `<img src="${coverImage}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 group-hover:scale-105 transition-all duration-500">`;
                        iconHtml = `<div class="absolute top-2 right-2 bg-black/60 p-1.5 rounded-full backdrop-blur-md z-20 border border-white/10"><i data-lucide="images" class="w-3 h-3 text-white"></i></div>`;
                    } else {
                        // Video Render
                        mediaHtml = `<video src="${video.videoUrl}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 group-hover:scale-105 transition-all duration-500" muted loop playsinline onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>`;
                        // Optional: Play icon or nothing
                        // iconHtml = `<div class="absolute top-2 right-2 ..."><i data-lucide="play" ...></i></div>`;
                    }

                    div.innerHTML = `
                        ${mediaHtml}
                        ${iconHtml}
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-60 group-hover:opacity-80 transition-opacity pointer-events-none"></div>
                        <div class="absolute bottom-0 left-0 w-full p-3 text-white pointer-events-none">
                            <p class="font-bold text-sm truncate drop-shadow-md">${title}</p>
                            <div class="flex items-center justify-between mt-1 opacity-90">
                                <span class="text-xs truncate flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> ${user}</span>
                                <span class="text-[10px] bg-white/20 px-1.5 py-0.5 rounded backdrop-blur-sm"><i data-lucide="play" class="w-2 h-2 inline fill-current"></i> ${formatNumber(views)}</span>
                            </div>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            }
            if(window.lucide) window.lucide.createIcons();
        };

        window.handleExploreSearch = () => {
            const query = document.getElementById('explore-search').value.toLowerCase().trim();
            if (!query) { window.renderExploreGrid(allExploreVideos); return; }
            const filtered = allExploreVideos.filter(video => {
                const titleMatch = (video.title || '').toLowerCase().includes(query);
                const descMatch = (video.description || '').toLowerCase().includes(query);
                const tagsMatch = video.tags ? video.tags.some(t => t.toLowerCase().includes(query)) : false;
                return titleMatch || descMatch || tagsMatch;
            });
            window.renderExploreGrid(filtered);
        };

        // --- PROFILE LOGIC ---
        window.viewUserProfile = async (userId, fallbackUsername, fallbackAvatar, skipNav = false) => {
            window.closeComments();

            // Cleanup previous listeners
            if (window.profileStatusUnsub) { window.profileStatusUnsub(); window.profileStatusUnsub = null; }
            if (window.profileWarningUnsub) { window.profileWarningUnsub(); window.profileWarningUnsub = null; }

            currentViewedProfileId = userId;
            const currentUser = auth.currentUser;
            const isMe = currentUser && currentUser.uid === userId;
            const isBlocked = blockedUsers.has(userId);

            // UI Elements
            const nameEl = document.getElementById('profile-name');
            const bioEl = document.getElementById('profile-bio');
            const imgEl = document.getElementById('profile-image');
            const salesEl = document.getElementById('profile-sales-display');
            const statFollowing = document.getElementById('profile-stat-following');
            const statFollowers = document.getElementById('profile-stat-followers');
            const statLikes = document.getElementById('profile-stat-likes');
            const actionsContainer = document.getElementById('profile-actions');
            const cameraBtn = document.getElementById('profile-camera-btn');
            const tabsContainer = document.querySelector('#profile-container .border-b');

            // Status element container (Insert if missing)
            let statusEl = document.getElementById('profile-status-display');
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'profile-status-display';
                statusEl.className = "flex items-center gap-2 mb-2 animate-fade-in";
                if (nameEl?.parentNode) nameEl.parentNode.insertBefore(statusEl, nameEl.nextSibling);
            }
            statusEl.innerHTML = '';

            const finalAvatar = window.getAvatar(fallbackAvatar, fallbackUsername);

            // Reset UI
            nameEl.textContent = fallbackUsername ? `@${fallbackUsername}` : '@Loading...';
            imgEl.src = finalAvatar;
            bioEl.textContent = 'Loading...';
            bioEl.classList.remove('text-red-500', 'font-medium'); // Reset styles

            statFollowing.textContent = '-';
            statFollowers.textContent = '-';
            statLikes.textContent = '-';

            if (salesEl) salesEl.classList.add('hidden');
            if (cameraBtn) cameraBtn.classList.toggle('hidden', !isMe);

            window.renderInternalView('profile');

            const safeName = (fallbackUsername || 'User').replace(/'/g, "\\'");
            const safeAvatar = finalAvatar.replace(/'/g, "\\'");

            if (!skipNav && fallbackUsername) {
                history.pushState(null, null, `/user/${fallbackUsername}`);
            }

            // --- BLOCKED USER CHECK ---
            if (!isMe && isBlocked) {
                actionsContainer.innerHTML = `
                    <button disabled class="px-6 py-2.5 rounded-lg border-2 border-app-border text-app-textMuted font-bold cursor-not-allowed opacity-50 flex items-center gap-2"><i data-lucide="message-square" class="w-4 h-4"></i> Message</button>
                    <div class="relative ml-auto">
                        <button onclick="window.toggleProfileMenu()" class="p-2.5 rounded-lg border border-app-border text-app-text hover:bg-app-hover transition-colors"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
                        <div id="profile-more-menu" class="hidden absolute top-full right-0 mt-2 w-48 bg-app-card border border-app-border rounded-xl shadow-xl z-20 overflow-hidden animate-fade-in">
                            <button onclick="window.handleBlockUser('${userId}')" class="w-full text-left px-4 py-3 text-sm font-bold text-red-500 hover:bg-app-hover flex items-center gap-2"><i data-lucide="ban" class="w-4 h-4"></i> <span id="block-btn-text">Unblock User</span></button>
                            <button onclick="window.handleReportUser('${userId}')" class="w-full text-left px-4 py-3 text-sm font-bold text-app-text hover:bg-app-hover flex items-center gap-2"><i data-lucide="flag" class="w-4 h-4"></i> Report User</button>
                        </div>
                    </div>
                `;
                if (tabsContainer) tabsContainer.classList.add('hidden');
                document.getElementById('profile-content-videos')?.classList.add('hidden');
                document.getElementById('profile-content-reposts')?.classList.add('hidden');
                document.getElementById('profile-content-likes')?.classList.add('hidden');
                document.getElementById('profile-content-products')?.classList.add('hidden');
                
                nameEl.textContent = `@${fallbackUsername || 'User'}`;
                bioEl.textContent = '';
                if (window.lucide) window.lucide.createIcons();
                return; 
            }

            // --- MAIN LISTENER ---
            window.profileStatusUnsub = onSnapshot(doc(db, "users", userId), snap => {
                if (!snap.exists()) return;
                const data = snap.data();
                const profile = data.profile || {};
                const stats = data.stats || {};
                const status = data.status || {};

                const bannedUntilDate = data.bannedUntil ? (data.bannedUntil.toDate ? data.bannedUntil.toDate() : new Date(data.bannedUntil)) : null;
                const isPermBanned = data.isBanned === true && !bannedUntilDate;
                const isTempBannedActive = bannedUntilDate && bannedUntilDate > new Date();
                
                const isBanned = isPermBanned || isTempBannedActive;

                if (!isMe && isBanned) {
                    // 1. Label
                    nameEl.innerHTML = `@${profile.username || fallbackUsername || 'User'} <span class="inline-flex items-center justify-center px-4 py-0.5 ml-2 text-[16px] font-bold uppercase tracking-wider text-white bg-red-600 rounded-full align-middle shadow-md">BANNED</span>`;
                    imgEl.src = window.getAvatar(profile.photoUrl, profile.username);
                    
                    // 2. Bio Replacement
                    bioEl.textContent = 'This account has been suspended due to a violation of our Community Guidelines.';
                    bioEl.classList.add('text-red-500', 'font-medium');

                    // 3. Clear Stats
                    statFollowing.textContent = '-';
                    statFollowers.textContent = '-';
                    statLikes.textContent = '-';

                    // 4. Hide Content Tabs
                    if (tabsContainer) tabsContainer.classList.add('hidden');
                    document.getElementById('profile-content-products').classList.add('hidden');
                    document.getElementById('profile-content-videos').classList.add('hidden');
                    document.getElementById('profile-content-reposts').classList.add('hidden');
                    document.getElementById('profile-content-likes').classList.add('hidden');
                    document.getElementById('profile-content-reviews')?.classList.add('hidden');

                    // 5. Disable Actions
                    actionsContainer.innerHTML = `
                        <button disabled class="w-full px-6 py-3 rounded-lg bg-gray-100 dark:bg-zinc-800 text-gray-400 dark:text-gray-500 font-bold cursor-not-allowed flex items-center justify-center gap-2 border border-gray-200 dark:border-zinc-700 shadow-inner">
                            <i data-lucide="ban" class="w-4 h-4"></i> Account Suspended
                        </button>
                    `;
                    
                    if (window.lucide) window.lucide.createIcons();
                    return; // Stop rendering normal profile
                }

                // --- NORMAL RENDERING (Not Banned or Is Me) ---

                nameEl.textContent = `@${profile.username || fallbackUsername || 'User'}`;
                imgEl.src = window.getAvatar(profile.photoUrl, profile.username);
                bioEl.textContent = profile.bio || 'No bio yet.';
                statFollowing.textContent = formatNumber(stats.following || 0);
                statFollowers.textContent = formatNumber(stats.followers || 0);
                
                // Status Bar
                const lastSeen = window.formatLastSeen(status.last_changed);
                const online = lastSeen === 'Online';
                let statusHtml = `<div class="flex items-center gap-1.5 px-2 py-0.5 rounded-full ${online ? 'bg-green-500/10' : 'bg-app-hover'}"><span class="h-2 w-2 rounded-full ${online ? 'bg-green-500' : 'bg-gray-400'}"></span><span class="text-[10px] font-bold">${lastSeen}</span></div>`;

                // My Own Strike/Ban Status (Persistent Warning)
                if (isMe) {
                    const mod = data.moderation || {};
                    const restrictedUntil = mod.restrictedUntil;
                    
                    // Clear any existing Warning (Dismissible) to avoid clutter
                    const existingWarn = document.getElementById('profile-active-warning');
                    
                    if (data.isBanned) { // Me View of Ban
                        if(existingWarn) existingWarn.remove();
                        statusHtml += `
                            <div id="profile-active-warning" data-type="ban" class="flex items-center gap-1 px-3 py-0.5 rounded-full border text-[10px] font-bold uppercase tracking-wide ml-2 bg-red-100 text-red-700 border-red-200">
                                <i data-lucide="ban" class="w-3 h-3 fill-current"></i>
                                <span>Account Suspended</span>
                            </div>`;
                    }
                    else if (restrictedUntil) {
                        const endDate = restrictedUntil.toDate ? restrictedUntil.toDate() : new Date(restrictedUntil);
                        if (endDate > new Date()) {
                            if(existingWarn) existingWarn.remove();
                            statusHtml += `
                                <div id="profile-active-warning" data-type="strike" class="flex items-center gap-1 px-3 py-0.5 rounded-full border text-[10px] font-bold uppercase tracking-wide ml-2 bg-orange-100 text-orange-700 border-orange-200">
                                    <i data-lucide="zap" class="w-3 h-3 fill-current"></i>
                                    <span>Strike Active</span>
                                </div>`;
                        }
                    }
                    else if (existingWarn && existingWarn.dataset.type === 'warn') {
                        statusHtml += existingWarn.outerHTML; 
                    }
                }

                statusEl.innerHTML = statusHtml;
                
                // Restore Tabs if they were hidden
                if (tabsContainer) tabsContainer.classList.remove('hidden');

                if (isMe) {
                    actionsContainer.innerHTML = `
                        <button onclick="window.openEditProfile()" class="px-6 py-2.5 rounded-lg bg-brand-teal text-white font-bold shadow-lg shadow-brand-teal/20 hover:bg-brand-teal/90">Edit Bio</button>
                        <button onclick="window.openProfileShareModal('${userId}', '${safeName}', '${safeAvatar}')" class="px-4 py-2.5 rounded-lg border border-app-border"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                    `;
                    
                    // Warning Listener (Only for Me)
                    const qWarn = query(collection(db, 'users', userId, 'system_notifications'), where('read', '==', false), where('type', 'in', ['warn', 'warning']), orderBy('timestamp', 'desc'));
                    window.profileWarningUnsub = onSnapshot(qWarn, (snap) => {
                        const activeStrike = document.querySelector('#profile-active-warning[data-type="strike"]');
                        const activeBan = document.querySelector('#profile-active-warning[data-type="ban"]');
                        if (activeStrike || activeBan) return;

                        const dismissed = JSON.parse(localStorage.getItem('jace_dismissed_profile_warnings') || '[]');
                        const activeWarn = snap.docs.find(d => !dismissed.includes(d.id));
                        const existingWarn = document.getElementById('profile-active-warning');
                        if(existingWarn) existingWarn.remove();

                        if (activeWarn && statusEl) {
                            const warnEl = document.createElement('div');
                            warnEl.id = 'profile-active-warning';
                            warnEl.dataset.type = 'warn';
                            warnEl.className = `flex items-center gap-1 px-3 py-0.5 rounded-full border text-[10px] font-bold uppercase tracking-wide ml-2 animate-fade-in bg-yellow-100 text-yellow-700 border-yellow-200`;
                            warnEl.innerHTML = `<i data-lucide="triangle-alert" class="w-3 h-3 fill-current"></i><span>Warning</span><button onclick="window.handleDismissProfileWarning('${activeWarn.id}')" class="ml-1 hover:bg-black/10 rounded-full p-0.5 transition-colors" title="Hide"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                            statusEl.appendChild(warnEl);
                            if(window.lucide) window.lucide.createIcons();
                        }
                    });

                } else {
                    // Actions for Others
                    actionsContainer.innerHTML = `
                        <button id="follow-btn" onclick="window.handleFollowToggle()" class="px-6 py-2.5 rounded-lg bg-brand-orange text-white font-bold shadow-lg shadow-brand-orange/20">Follow</button>
                        <button onclick="window.startDirectMessageFromProfile()" class="px-6 py-2.5 rounded-lg border-2 border-app-border font-bold flex items-center gap-2"><i data-lucide="message-square" class="w-4 h-4"></i> Message</button>
                        <button onclick="window.openProfileShareModal('${userId}', '${safeName}', '${safeAvatar}')" class="p-2.5 rounded-lg border border-app-border"><i data-lucide="share-2" class="w-5 h-5"></i></button>
                        <div class="relative">
                            <button onclick="window.toggleProfileMenu()" class="p-2.5 rounded-lg border border-app-border text-app-text hover:bg-app-hover transition-colors"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
                            <div id="profile-more-menu" class="hidden absolute top-full right-0 mt-2 w-48 bg-app-card border border-app-border rounded-xl shadow-xl z-20 overflow-hidden animate-fade-in">
                                <button onclick="window.handleBlockUser('${userId}')" class="w-full text-left px-4 py-3 text-sm font-bold text-red-500 hover:bg-app-hover flex items-center gap-2"><i data-lucide="ban" class="w-4 h-4"></i> Block User</button>
                                <button onclick="window.handleReportUser('${userId}')" class="w-full text-left px-4 py-3 text-sm font-bold text-app-text hover:bg-app-hover flex items-center gap-2"><i data-lucide="flag" class="w-4 h-4"></i> Report User</button>
                            </div>
                        </div>
                    `;
                }

                if(window.lucide) window.lucide.createIcons();
            });

            // Setup Sales Count (If seller)
            if (salesEl) {
                try {
                    const salesQ = query(collection(db, 'orders'), where('sellerId', '==', userId));
                    getAggregateFromServer(salesQ, { count: count() }).then(snap => {
                        salesEl.classList.remove('hidden');
                        salesEl.innerHTML = `<span class="flex items-center gap-1.5 text-sm font-bold bg-app-hover/50 px-2 py-1 rounded-lg"><i data-lucide="shopping-bag" class="w-4 h-4 text-brand-orange"></i> ${formatNumber(snap.data().count || 0)} Sales</span>`;
                    }).catch(() => {});
                } catch {}
            }

            // Setup Follow State (If viewer)
            if (currentUser && !isMe) {
                const followSnap = await getDoc(doc(db, 'users', currentUser.uid, 'following', userId));
                if (followSnap.exists()) {
                    const btn = document.getElementById('follow-btn');
                    if (btn) {
                        btn.textContent = 'Following';
                        btn.classList.remove('bg-brand-orange', 'text-white');
                        btn.classList.add('bg-app-card', 'border', 'border-app-border', 'text-app-text');
                    }
                }
            }

            window.setupProfileListener(userId);
            if(window.loadProfileRating) window.loadProfileRating(userId);
            window.switchTab('products');
        };

        window.openProfileShareModal = async (userId, username, avatar) => {
            if (!auth.currentUser) { window.toggleAuthModal(true); return; }
            
            currentShareVideo = null;
            currentShareProfile = { id: userId, username: username, avatar: avatar };
            
            const modal = document.getElementById('share-modal');
            const actionsRow = document.getElementById('share-actions-row');
            const list = document.getElementById('share-following-list');
            
            const profileLink = `${window.location.origin}/user/${username}`;

            // Add Copy Link Button
            actionsRow.innerHTML = `
                <div class="flex gap-4 w-full justify-center">
                    <button onclick="navigator.clipboard.writeText('${profileLink}'); window.showToast('Profile link copied!', 'success'); window.closeShareModal();" class="flex flex-col items-center gap-2 min-w-[70px] group">
                        <div class="w-12 h-12 rounded-full bg-blue-500/10 group-hover:bg-blue-500/20 flex items-center justify-center transition-colors border border-blue-500/30 group-hover:border-blue-500">
                            <i data-lucide="link" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <span class="text-xs text-app-text font-bold">Copy Link</span>
                    </button>
                </div>
                <div class="text-xs text-app-textMuted font-medium w-full text-center mt-2">Share this profile</div>
            `;
            
            modal.classList.remove('hidden');
            list.innerHTML = '<div class="text-center text-sm text-app-textMuted py-8"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading friends...</div>';
            if(window.lucide) window.lucide.createIcons();

            // Use Same Fetch Logic as Video Share...
            try {
                const q = query(collection(db, 'users', auth.currentUser.uid, 'following'));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    list.innerHTML = `<div class="text-center text-sm text-app-textMuted py-8"><p>You aren't following anyone yet.</p><button onclick="window.navigateTo('explore'); window.closeShareModal();" class="mt-2 text-brand-orange hover:underline font-bold">Find people to follow</button></div>`;
                } else {
                    list.innerHTML = '';
                    const followingIds = snapshot.docs.map(d => d.id);
                    const promises = followingIds.slice(0, 10).map(uid => getDoc(doc(db, 'users', uid)));
                    const userDocs = await Promise.all(promises);
                    userDocs.forEach(userDoc => {
                        if(userDoc.exists()) {
                            const u = userDoc.data();
                            const profile = u.profile || {};
                            const uName = profile.username || 'User';
                            const uAv = profile.photoUrl || 'https://via.placeholder.com/100';
                            const div = document.createElement('div');
                            div.className = 'flex items-center gap-3 p-3 hover:bg-app-hover rounded-xl cursor-pointer transition-colors group';
                            div.onclick = () => window.handleShareToUser(userDoc.id, uName, uAv);
                            div.innerHTML = `
                                <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden shrink-0"><img src="${uAv}" class="w-full h-full object-cover"></div>
                                <div class="flex-1"><h4 class="font-bold text-sm text-app-text">${uName}</h4><p class="text-xs text-app-textMuted">Send via Direct Message</p></div>
                                <div class="w-8 h-8 rounded-full bg-brand-teal/10 flex items-center justify-center group-hover:bg-brand-teal text-brand-teal group-hover:text-white transition-all"><i data-lucide="send" class="w-4 h-4"></i></div>
                            `;
                            list.appendChild(div);
                        }
                    });
                    if(window.lucide) window.lucide.createIcons();
                }
            } catch (e) { console.error("Share fetch error", e); list.innerHTML = '<div class="text-center text-sm text-red-500 py-8">Failed to load friends.</div>'; }
        };
        
        window.handleProfileUserSearch = (queryStr) => {
            clearTimeout(userSearchTimeout);
            const resultsContainer = document.getElementById('profile-user-results');
            const inputStr = queryStr.trim().toLowerCase();

            if (!inputStr) {
                resultsContainer.classList.add('hidden');
                resultsContainer.innerHTML = '';
                return;
            }

            userSearchTimeout = setTimeout(async () => {
                resultsContainer.classList.remove('hidden');
                resultsContainer.innerHTML = '<div class="p-4 text-center text-xs text-app-textMuted"><i data-lucide="loader-2" class="w-4 h-4 animate-spin mx-auto mb-1"></i>Searching...</div>';
                if(window.lucide) window.lucide.createIcons();

                try {
                    // Note: This query assumes you have created an index in Firestore for 'profile.username'.
                    // If strictly client-side filtering is needed for a small userbase, query(collection(db, 'users')) and filter in JS.
                    // Here we will try to filter client-side for simplicity in this demo environment since we can't create indexes for you.
                    
                    const q = query(collection(db, 'users')); // Fetch all (limited optimization for demo)
                    const snapshot = await getDocs(q);
                    
                    const users = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if (d.profile && d.profile.username) {
                            if (d.profile.username.toLowerCase().includes(inputStr)) {
                                users.push({ id: doc.id, ...d.profile });
                            }
                        }
                    });

                    resultsContainer.innerHTML = '';
                    
                    if (users.length === 0) {
                        resultsContainer.innerHTML = '<div class="p-3 text-center text-xs text-app-textMuted">No users found.</div>';
                        return;
                    }

                    users.forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-3 p-3 hover:bg-app-hover cursor-pointer border-b border-app-border/50 last:border-0 transition-colors';
                        div.onclick = () => {
                            window.viewUserProfile(u.id, u.username, u.photoUrl);
                            resultsContainer.classList.add('hidden');
                            document.getElementById('profile-user-search').value = '';
                        };
                        
                        const isBlocked = blockedUsers.has(u.id);
                        
                        div.innerHTML = `
                            <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden shrink-0">
                                <img src="${u.photoUrl || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-bold text-app-text truncate">@${u.username}</p>
                                ${isBlocked ? '<p class="text-[10px] text-red-500 font-bold">Blocked</p>' : ''}
                            </div>
                        `;
                        resultsContainer.appendChild(div);
                    });

                } catch (e) {
                    console.error("User search failed", e);
                    resultsContainer.innerHTML = '<div class="p-3 text-center text-xs text-red-500">Search failed.</div>';
                }
            }, 500); // Debounce 500ms
        };

        window.getAvatar = (url, username) => {
            if (url && url !== 'null' && url !== 'undefined' && url.length > 5) return url;
            
            // Otherwise, generate a colorful avatar based on username
            const safeName = (username || 'User').replace(/[^a-zA-Z0-9 ]/g, '').trim() || 'User';
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(safeName)}&background=random&color=fff&bold=true&size=128`;
        };

        window.viewMyProfile = () => {
            const user = auth.currentUser;
            if (user) { window.viewUserProfile(user.uid, user.displayName, user.photoURL); } 
            else { window.toggleAuthModal(true); }
        };

        window.openEditProfile = () => {
            if (!auth.currentUser) return;
            const currentBio = document.getElementById('profile-bio').textContent;
            document.getElementById('edit-bio-input').value = currentBio === 'No bio yet.' ? '' : currentBio;
            document.getElementById('edit-profile-modal').classList.remove('hidden');
        };

        window.closeEditProfileModal = () => { document.getElementById('edit-profile-modal').classList.add('hidden'); };

        window.saveProfileChanges = async (e) => {
            e.preventDefault();
            const newBio = document.getElementById('edit-bio-input').value.trim();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerText = 'Saving...';
            try {
                const user = auth.currentUser;
                await setDoc(doc(db, "users", user.uid), { profile: { bio: newBio } }, { merge: true });
                document.getElementById('profile-bio').textContent = newBio || 'No bio yet.';
                window.showToast("Bio updated successfully", "success");
                window.closeEditProfileModal();
            } catch(e) { console.error(e); window.showToast("Failed to update profile", "error"); } 
            finally { btn.disabled = false; btn.innerText = originalText; }
        };

        window.handleFollowToggle = async (e) => {
            const currentUser = auth.currentUser;
            if (!currentUser) { window.toggleAuthModal(true); return; }
            const targetId = currentViewedProfileId;
            if (!targetId || targetId === currentUser.uid) return;
            const followBtn = document.getElementById('follow-btn');
            const isFollowing = followBtn.textContent === 'Following';
            const statFollowers = document.getElementById('profile-stat-followers');
            
            if (isFollowing) {
                 followBtn.textContent = 'Follow';
                 followBtn.classList.remove('bg-app-card', 'border', 'border-app-border', 'text-app-text');
                 followBtn.classList.add('bg-brand-orange', 'text-white');
                 let val = parseInt(statFollowers.textContent.replace('k', '000'));
                 if(val > 0) statFollowers.textContent = formatNumber(val - 1);
            } else {
                 followBtn.textContent = 'Following';
                 followBtn.classList.remove('bg-brand-orange', 'text-white');
                 followBtn.classList.add('bg-app-card', 'border', 'border-app-border', 'text-app-text');
                 let val = parseInt(statFollowers.textContent.replace('k', '000'));
                 statFollowers.textContent = formatNumber(val + 1);
            }
            try {
                const batch = writeBatch(db);
                const meRef = doc(db, 'users', currentUser.uid);
                const themRef = doc(db, 'users', targetId);
                const followingRef = doc(db, 'users', currentUser.uid, 'following', targetId);
                const followerRef = doc(db, 'users', targetId, 'followers', currentUser.uid);

                if (isFollowing) {
                    batch.delete(followingRef); batch.delete(followerRef);
                    batch.update(meRef, { 'stats.following': increment(-1) });
                    batch.update(themRef, { 'stats.followers': increment(-1) });
                } else {
                    batch.set(followingRef, { timestamp: serverTimestamp() });
                    batch.set(followerRef, { timestamp: serverTimestamp() });
                    batch.set(meRef, { stats: { following: increment(1) } }, { merge: true });
                    batch.set(themRef, { stats: { followers: increment(1) } }, { merge: true });
                    const notifRef = collection(db, 'users', targetId, 'notifications');
                    batch.set(doc(notifRef), { type: 'follow', fromUserId: currentUser.uid, fromUsername: currentUser.displayName, fromUserAvatar: currentUser.photoURL, read: false, timestamp: serverTimestamp() });
                }
                await batch.commit();
            } catch (e) { console.error("Follow action failed", e); window.showToast("Action failed", "error"); }
        };

        window.openUserReviews = (userId) => {
            if(!userId) return;
            const modal = document.getElementById('user-reviews-modal');
            const list = document.getElementById('user-reviews-modal-list');
            
            modal.classList.remove('hidden');
            list.innerHTML = '<div class="text-center py-10 text-app-textMuted"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading reviews...</div>';
            if(window.lucide) window.lucide.createIcons();

            const q = query(collection(db, 'users', userId, 'reviews_received'), orderBy('timestamp', 'desc'));
            
            getDocs(q).then((snapshot) => {
                if (snapshot.empty) {
                    list.innerHTML = `
                        <div class="text-center py-10 text-app-textMuted">
                            <div class="w-16 h-16 rounded-full bg-app-card flex items-center justify-center mb-2 mx-auto">
                                <i data-lucide="star-off" class="w-8 h-8 opacity-50"></i>
                            </div>
                            <p class="font-bold">No reviews yet</p>
                            <p class="text-sm">Be the first to buy and review!</p>
                        </div>
                    `;
                } else {
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const r = doc.data();
                        let stars = '';
                        for(let i=1; i<=5; i++) stars += `<i data-lucide="star" class="w-3 h-3 ${i <= (r.rating||0) ? 'fill-brand-orange text-brand-orange' : 'text-gray-300 dark:text-gray-600'}"></i>`;

                        const card = document.createElement('div');
                        card.className = "bg-app-card border border-app-border rounded-xl p-4 animate-fade-in";
                        card.innerHTML = `
                            <div class="flex gap-3">
                                <div class="w-10 h-10 bg-gray-100 rounded-lg shrink-0 overflow-hidden border border-app-border">
                                    <img src="${r.productImage || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-app-text text-sm truncate">${r.productTitle || 'Product'}</h4>
                                    <div class="flex items-center gap-2 my-0.5">
                                        <div class="flex">${stars}</div>
                                        <span class="text-[10px] text-app-textMuted">${r.timestamp ? new Date(r.timestamp.toDate()).toLocaleDateString() : ''}</span>
                                    </div>
                                    <p class="text-sm text-app-text italic">"${r.comment}"</p>
                                    <div class="flex items-center gap-1.5 mt-2 pt-2 border-t border-app-border/50">
                                        <div class="w-4 h-4 rounded-full bg-gray-200 overflow-hidden"><img src="${r.reviewerAvatar}" class="w-full h-full object-cover"></div>
                                        <span class="text-xs font-bold text-app-textMuted">${r.reviewerName}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        list.appendChild(card);
                    });
                }
                if(window.lucide) window.lucide.createIcons();
            });
        };

        window.loadProfileRating = async (userId) => {
            const badge = document.getElementById('profile-rating-badge');
            if(!badge) return;
            
            // Make clickable immediately
            badge.onclick = () => window.openUserReviews(userId);

            // Reset to loading
            badge.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin text-app-textMuted"></i>`;
            if(window.lucide) window.lucide.createIcons();

            try {
                const q = query(collection(db, 'users', userId, 'reviews_received'));
                // Use aggregation to get stats efficiently
                const snapshot = await getAggregateFromServer(q, {
                    count: count(),
                    totalRating: sum('rating')
                });
                
                const data = snapshot.data();
                const countVal = data.count || 0;
                const total = data.totalRating || 0;
                const avg = countVal > 0 ? (total / countVal).toFixed(1) : '0.0';
                
                let starsHtml = '<div class="flex text-brand-orange">';
                const numStars = Math.round(Number(avg));
                for(let i=1; i<=5; i++) {
                    starsHtml += `<i data-lucide="star" class="w-4 h-4 ${i <= numStars ? 'fill-current' : 'text-gray-300 dark:text-gray-600'}"></i>`;
                }
                starsHtml += '</div>';

                badge.innerHTML = `
                    ${starsHtml}
                    <span class="text-xs font-bold text-app-text ml-1">${avg}</span>
                    <span class="text-xs text-app-textMuted">(${countVal})</span>
                `;
                if(window.lucide) window.lucide.createIcons();

            } catch(e) {
                console.warn("Rating fetch failed", e);
                badge.innerHTML = `<span class="text-xs text-app-textMuted">No ratings</span>`;
            }
        };

        window.toggleThreadReplies = (parentId) => {
            const container = document.getElementById(`replies-${parentId}`);
            const btn = document.getElementById(`toggle-${parentId}`);
            if(container && btn) {
                if(container.classList.contains('hidden')) {
                    container.classList.remove('hidden');
                    btn.innerHTML = `<div class="w-8 h-[1px] bg-app-textMuted/40"></div><span class="text-xs font-bold text-app-textMuted">Hide replies</span><i data-lucide="chevron-up" class="w-3 h-3 text-app-textMuted"></i>`;
                } else {
                    container.classList.add('hidden');
                     const count = btn.dataset.count;
                     btn.innerHTML = `<div class="w-8 h-[1px] bg-app-textMuted/40 group-hover:bg-brand-orange transition-colors"></div><span class="text-xs font-bold text-app-textMuted group-hover:text-app-text transition-colors">View ${count} replies</span><i data-lucide="chevron-down" class="w-3 h-3 text-app-textMuted group-hover:text-app-text transition-colors"></i>`;
                }
                if(window.lucide) window.lucide.createIcons();
            }
        }

        window.setupCommentGestures = () => {
            const panel = document.getElementById('comments-panel');
            // Find the drag handle (first child div)
            const handle = panel ? panel.querySelector('div.w-12') : null;
            
            if (!panel || !handle) return;

            let startY = 0;
            let currentPanelHeightVh = 60; // Start at default height
            let isDragging = false;

            // Helper to snap to state
            const setPanelState = (expanded) => {
                if (window.innerWidth >= 768) return; // Disable on desktop

                if (expanded) {
                    panel.style.height = '100%';
                    panel.style.top = '0'; // Ensure it hits top
                    panel.classList.remove('rounded-t-2xl');
                    currentPanelHeightVh = 100;
                } else {
                    panel.style.height = '60vh';
                    panel.style.top = 'auto'; // Reset top
                    panel.classList.add('rounded-t-2xl');
                    currentPanelHeightVh = 60;
                }
            };

            const onTouchStart = (e) => {
                if (window.innerWidth >= 768) return; // Ignore on desktop
                startY = e.touches[0].clientY;
                isDragging = true;
                panel.style.transition = 'none'; // Disable smooth transition while dragging
            };

            const onTouchMove = (e) => {
                if (!isDragging) return;
                const currentY = e.touches[0].clientY;
                const deltaY = currentY - startY; // Negative = moving up
                
                const screenH = window.innerHeight;
                
                // Current actual height in pixels before drag
                const startHeightPx = currentPanelHeightVh === 60 ? (screenH * 0.6) : screenH;
                
                // New height
                let newHeightPx = startHeightPx - deltaY;
                
                // Clamp limits (Min 30% screen, Max 100%)
                if (newHeightPx > screenH) newHeightPx = screenH;
                if (newHeightPx < (screenH * 0.3)) newHeightPx = (screenH * 0.3);

                panel.style.height = `${newHeightPx}px`;
                
                // If expanding near top, remove rounded corners visually
                if (newHeightPx > (screenH * 0.9)) {
                    panel.classList.remove('rounded-t-2xl');
                } else {
                    panel.classList.add('rounded-t-2xl');
                }
            };

            const onTouchEnd = (e) => {
                if (!isDragging) return;
                isDragging = false;
                panel.style.transition = 'height 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                
                // Determine snap position based on current height
                const finalHeightPx = parseFloat(panel.style.height);
                const screenH = window.innerHeight;
                const ratio = finalHeightPx / screenH;

                if (currentPanelHeightVh === 60) {
                    // If we were at 60%, expand if dragged up > 75%
                    // Close if dragged down < 40%
                    if (ratio > 0.75) {
                        setPanelState(true);
                    } else if (ratio < 0.45) {
                        window.closeComments();
                        // Reset internal state after close animation finishes
                        setTimeout(() => setPanelState(false), 300);
                    } else {
                        setPanelState(false); // Snap back to 60
                    }
                } else {
                    // If we were at 100%, collapse if dragged down < 85%
                    if (ratio < 0.85) {
                        setPanelState(false);
                    } else {
                        setPanelState(true); // Snap back to 100
                    }
                }
            };
            
            const onClick = (e) => {
                if(isDragging || window.innerWidth >= 768) return; 
                // Toggle
                panel.style.transition = 'height 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                if (currentPanelHeightVh === 60) setPanelState(true);
                else setPanelState(false);
            };

            // Attach listeners
            handle.removeEventListener('touchstart', onTouchStart); 
            handle.addEventListener('touchstart', onTouchStart, {passive: true});
            handle.addEventListener('touchmove', onTouchMove, {passive: true});
            handle.addEventListener('touchend', onTouchEnd);
            handle.addEventListener('click', onClick);
        };

        window.openComments = async (videoId, videoPath, uploaderId) => {
            // 1. Reset Panel State
            const panel = document.getElementById('comments-panel');
            if (panel) {
                if (window.innerWidth < 768) {
                    panel.style.height = '60vh'; panel.style.top = 'auto'; panel.classList.add('rounded-t-2xl');
                } else {
                    panel.style.height = ''; panel.style.top = ''; panel.classList.remove('rounded-t-2xl');
                }
                panel.style.transition = ''; 
            }

            if(window.setupCommentGestures) window.setupCommentGestures();

            // 2. UI Setup
            currentCommentVideoId = videoId;
            currentCommentVideoPath = videoPath;
            window.cancelReply(); 

            const overlay = document.getElementById('comment-overlay');
            const mainContent = document.getElementById('main-content');
            const list = document.getElementById('comments-list');
            const inputArea = document.getElementById('comment-input-area');
            const inputField = document.getElementById('comment-text');

            panel.classList.remove('translate-y-full');
            panel.classList.remove('md:translate-x-full');
            overlay.classList.remove('hidden');

            if (window.innerWidth >= 768) mainContent.classList.add('feed-shifted');

            list.innerHTML = '<div class="text-center text-app-textMuted py-10"><i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading...</div>';
            if(window.lucide) window.lucide.createIcons();
            
            if (!currentCommentVideoId) return;

            // Clean up old listener
            if (unsubscribeComments) { unsubscribeComments(); unsubscribeComments = null; }

            // --- 3. FETCH CONFIG & CHECK MODE ---
            // We fetch the video document snapshot to get `commentMode`
            let commentMode = 'allow';
            try {
                // We use getDoc on the path passed (which is usually the user subcollection path for profile/feed context)
                // NOTE: If videoPath is null (preview mode), we skip this.
                if (currentCommentVideoPath && currentCommentVideoPath !== 'null') {
                    const vSnap = await getDoc(doc(db, currentCommentVideoPath));
                    if(vSnap.exists()) {
                        commentMode = vSnap.data().commentMode || 'allow';
                    }
                }
            } catch(e) { console.warn("Failed to fetch video config", e); }

            // --- 4. HANDLE MODES ---
            
            // Handle 'Disable' (Off) - Hide everything
            if (commentMode === 'off') {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-app-textMuted opacity-60">
                        <i data-lucide="message-square-off" class="w-12 h-12 mb-2 text-red-400"></i>
                        <p class="font-bold text-app-text">Comments Disabled</p>
                        <p class="text-xs">The creator has turned off comments.</p>
                    </div>`;
                if(inputArea) inputArea.classList.add('hidden');
                if(window.lucide) window.lucide.createIcons();
                return; // Stop here
            }

            // Handle 'Restrict' - Show list, Disable Input
            if (commentMode === 'restrict') {
                if(inputArea) inputArea.classList.add('hidden');
                // Add a warning banner at top of list
                list.innerHTML = `<div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-500 text-xs font-bold text-center border-b border-yellow-200 dark:border-yellow-800 mb-2">Comments are restricted for this post.</div>`;
            } else {
                // 'Allow' - Show input
                if(inputArea) inputArea.classList.remove('hidden');
                if(inputField) inputField.disabled = false;
            }

            // --- 5. LOAD COMMENTS ---
            if (!currentCommentVideoPath || currentCommentVideoPath === 'null') {
                    list.innerHTML += `<div class="p-4 text-center text-xs text-app-textMuted">Preview Mode: Comments not live.</div>`;
                    return;
            }

            const q = query(collection(db, currentCommentVideoPath, 'comments'), orderBy('timestamp', 'asc'));
            
            unsubscribeComments = onSnapshot(q, (snapshot) => {
                // If restricted, preserve the warning banner we added
                if (commentMode === 'restrict') {
                    const warning = list.querySelector('.bg-yellow-50');
                    list.innerHTML = '';
                    if(warning) list.appendChild(warning);
                } else {
                    list.innerHTML = '';
                }

                if (snapshot.empty) { 
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = "flex flex-col items-center justify-center h-64 text-app-textMuted opacity-60";
                    emptyMsg.innerHTML = `<i data-lucide="message-square-dashed" class="w-12 h-12 mb-2"></i><p>No comments yet.</p>`;
                    list.appendChild(emptyMsg);
                } else {
                    const allComments = [];
                    snapshot.forEach(doc => allComments.push({ id: doc.id, ...doc.data() }));
                    
                    const parents = allComments.filter(c => !c.parentId);
                    const replies = allComments.filter(c => c.parentId);

                    // --- Render Helper (Same as before) ---
                    const renderCommentItem = (data, isReply = false) => {
                        const commentEl = document.createElement('div');
                        commentEl.className = `relative group flex gap-3 animate-fade-in ${isReply ? '' : ''}`;
                        
                        let timeAgo = "Just now";
                        if (data.timestamp) { 
                            const time = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                            const seconds = (new Date().getTime() - time.getTime()) / 1000; 
                            if(seconds > 86400) timeAgo = Math.floor(seconds/86400) + 'd'; 
                            else if(seconds > 3600) timeAgo = Math.floor(seconds/3600) + 'h'; 
                            else if(seconds > 60) timeAgo = Math.floor(seconds/60) + 'm'; 
                        }

                        const user = auth.currentUser;
                        const liked = user && data.likedBy && data.likedBy.includes(user.uid);
                        const isOwner = user && user.uid === data.userId;
                        const isCreator = uploaderId && data.userId === uploaderId;
                        const avatarSize = isReply ? 'w-7 h-7' : 'w-10 h-10';
                        const safeUsername = (data.username || 'User').replace(/'/g, "\\'");
                        const safeAvatar = (data.avatarUrl || 'https://via.placeholder.com/100').replace(/'/g, "\\'");
                        const formattedText = window.formatMentions ? window.formatMentions(data.text) : data.text;

                        // Reply button visibility based on mode
                        const replyBtn = (commentMode === 'restrict') ? '' : `
                            <button onclick="window.initReply('${isReply ? data.parentId : data.id}', '${safeUsername}')" class="text-xs font-bold text-app-textMuted hover:text-app-text transition-colors">Reply</button>
                        `;

                        commentEl.innerHTML = `
                            <div class="flex gap-3 group w-full">
                                <div onclick="window.viewUserProfile('${data.userId}', '${safeUsername}', '${safeAvatar}')" class="${avatarSize} rounded-full bg-gray-200 shrink-0 overflow-hidden ring-2 ring-transparent group-hover:ring-app-border transition-all cursor-pointer"><img src="${data.avatarUrl || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover"></div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-0.5">
                                        <span onclick="window.viewUserProfile('${data.userId}', '${safeUsername}', '${safeAvatar}')" class="text-xs font-bold text-app-text hover:underline cursor-pointer">${data.username || 'User'}</span>
                                        ${isCreator ? `<span class="px-1.5 py-0.5 bg-brand-orange text-white text-[10px] font-bold rounded-full flex items-center gap-0.5"><i data-lucide="crown" class="w-3 h-3"></i> Creator</span>` : ''}
                                        <span class="text-[10px] text-app-textMuted opacity-60">${timeAgo}</span>
                                    </div>
                                    <p class="text-[15px] text-app-text leading-relaxed break-words font-medium opacity-90">${formattedText}</p>
                                    <div class="flex items-center gap-4 mt-2 opacity-80 hover:opacity-100 transition-opacity">
                                        ${replyBtn}
                                        <button onclick="window.toggleCommentLike('${data.id}')" class="flex items-center gap-1 text-xs font-bold text-app-textMuted hover:text-brand-orange transition-colors"><i data-lucide="heart" class="w-3.5 h-3.5 ${liked ? 'fill-brand-orange text-brand-orange' : ''}"></i><span>${data.likes || 0}</span></button>
                                        <button onclick="window.openReportModal('comment', '${data.id}', '${data.userId}', '${currentCommentVideoPath}/comments/${data.id}')" class="text-xs font-bold text-app-textMuted hover:text-red-500 transition-colors flex items-center gap-1"><i data-lucide="flag" class="w-3 h-3"></i></button>
                                        ${isOwner ? `<button onclick="window.deleteComment('${data.id}')" class="text-xs font-bold text-red-500 hover:text-red-600 transition-colors" title="Delete comment"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        return commentEl;
                    };

                    parents.forEach(parent => {
                        const threadDiv = document.createElement('div'); 
                        threadDiv.className = "mb-6 relative";
                        threadDiv.appendChild(renderCommentItem(parent, false));
                        
                        const childReplies = replies.filter(r => r.parentId === parent.id);
                        if (childReplies.length > 0) {
                            const toggleBtn = document.createElement('button');
                            toggleBtn.className = "ml-[3.25rem] mt-2 flex items-center gap-2 group cursor-pointer";
                            toggleBtn.id = `toggle-${parent.id}`; 
                            toggleBtn.dataset.count = childReplies.length; 
                            toggleBtn.onclick = () => window.toggleThreadReplies(parent.id);
                            toggleBtn.innerHTML = `<div class="w-8 h-[1px] bg-app-textMuted/40 group-hover:bg-brand-orange transition-colors"></div><span class="text-xs font-bold text-app-textMuted group-hover:text-app-text transition-colors">View ${childReplies.length} replies</span><i data-lucide="chevron-down" class="w-3 h-3 text-app-textMuted group-hover:text-app-text transition-colors"></i>`;
                            threadDiv.appendChild(toggleBtn);
                            
                            const repliesContainer = document.createElement('div'); 
                            repliesContainer.id = `replies-${parent.id}`; 
                            repliesContainer.className = "ml-5 pl-0 mt-3 space-y-0 relative hidden"; 
                            
                            childReplies.forEach((reply, index) => {
                                const isLast = index === childReplies.length - 1;
                                const wrapper = document.createElement('div'); 
                                wrapper.className = "relative pl-8 pb-3"; 
                                const connector = document.createElement('div'); 
                                connector.className = "absolute left-0 top-0 w-6 h-[18px] border-l-2 border-b-2 border-app-border rounded-bl-xl pointer-events-none";
                                if (!isLast) { const spine = document.createElement('div'); spine.className = "absolute left-0 top-0 w-0 h-full border-l-2 border-app-border pointer-events-none"; wrapper.appendChild(spine); }
                                wrapper.appendChild(connector); 
                                wrapper.appendChild(renderCommentItem(reply, true)); 
                                repliesContainer.appendChild(wrapper);
                            });
                            threadDiv.appendChild(repliesContainer);
                        }
                        list.appendChild(threadDiv);
                    });
                }
                if(window.lucide) window.lucide.createIcons();
            }, (error) => { console.error("Comments Error:", error); });
        };

        window.closeComments = () => {
            window.cancelReply();
            if (unsubscribeComments) { unsubscribeComments(); unsubscribeComments = null; }
            
            const panel = document.getElementById('comments-panel');
            
            // UPDATED: Only reset height if we are on mobile
            if (window.innerWidth < 768) {
                panel.style.height = '60vh'; 
                panel.style.top = 'auto';
                panel.classList.add('rounded-t-2xl');
            } else {
                // Desktop clean up
                panel.style.height = '';
                panel.style.top = '';
                panel.classList.remove('rounded-t-2xl');
            }

            // Add back the hide classes
            panel.classList.add('translate-y-full'); 
            panel.classList.add('md:translate-x-full'); 
            
            document.getElementById('comment-overlay').classList.add('hidden');
            document.getElementById('main-content').classList.remove('feed-shifted');
            currentCommentVideoId = null; 
            currentCommentVideoPath = null;
        };
        
        window.deleteReview = (productId, sellerId, reviewId) => {
            window.openConfirmModal('Delete Review', 'Are you sure you want to delete your review? This action cannot be undone.', async () => {
                try {
                    const user = auth.currentUser;
                    if(!user) return;
                    
                    // Delete the review from the product's subcollection
                    await deleteDoc(doc(db, 'users', sellerId, 'products', productId, 'reviews', reviewId));

                    // Note: In a production app, you would also need to find and delete the copy in 'reviews_received'.
                    // Since we used addDoc separately, the IDs differ. A robust solution would store the aggregation ID on the main review.
                    // For now, this removes it from the product page.
                    
                    window.showToast('Review deleted successfully', 'success');
                    
                    // Re-render form if user wants to write a new one
                    renderReviewsSection(productId, sellerId);
                    
                } catch(e) {
                    console.error("Delete review failed", e);
                    window.showToast("Failed to delete review", "error");
                }
            });
        };

        window.deleteReviewReply = (productId, sellerId, reviewId) => {
            window.openConfirmModal('Delete Reply', 'Remove your response to this review?', async () => {
                try {
                    const ref = doc(db, 'users', sellerId, 'products', productId, 'reviews', reviewId);
                    
                    // Use deleteField() to remove specific fields
                    await updateDoc(ref, {
                        reply: deleteField(),
                        replyTimestamp: deleteField()
                    });
                    
                    window.showToast("Reply removed", "success");
                } catch (e) {
                    console.error("Delete reply failed", e);
                    window.showToast("Failed to delete reply", "error");
                }
            });
        };

        window.deleteComment = async (commentId) => {
            if (!currentCommentVideoPath || currentCommentVideoPath === 'null') {
                window.showToast("Cannot delete demo comments.", "error");
                return;
            }
            window.openConfirmModal('Delete Comment', 'Are you sure you want to delete this comment?', async () => {
                try {
                    await deleteDoc(doc(db, currentCommentVideoPath, 'comments', commentId));
                    if (currentCommentVideoPath && currentCommentVideoPath !== 'null') {
                        const videoDocRef = doc(db, currentCommentVideoPath);
                        await updateDoc(videoDocRef, { comments: increment(-1) });
                    }
                } catch(e) { console.error(e); window.showToast("Failed to delete comment", "error"); }
            });
        };

        window.initReply = (commentId, username) => {
            replyingTo = { id: commentId, username: username };
            const indicator = document.getElementById('reply-indicator');
            const nameSpan = document.getElementById('reply-username');
            const input = document.getElementById('comment-text');
            nameSpan.innerText = `@${username}`;
            indicator.classList.remove('hidden'); indicator.classList.add('flex');
            input.focus(); input.placeholder = `Reply to @${username}...`;
        };

        window.cancelReply = () => {
            replyingTo = null;
            const indicator = document.getElementById('reply-indicator');
            const input = document.getElementById('comment-text');
            if (indicator) { indicator.classList.add('hidden'); indicator.classList.remove('flex'); }
            if (input) input.placeholder = "Add a comment...";
        };

        window.toggleCommentLike = async (commentId) => {
            const user = auth.currentUser;
            if (!user) { window.toggleAuthModal(true); return; }
            if (!currentCommentVideoPath || currentCommentVideoPath === 'null') {
                window.showToast("Liked!", "success"); // Fake like
                return;
            }
            const commentRef = doc(db, currentCommentVideoPath, 'comments', commentId);
            try {
                const docSnap = await getDoc(commentRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const likedBy = data.likedBy || [];
                    const isLiked = likedBy.includes(user.uid);
                    if (isLiked) { await updateDoc(commentRef, { likes: increment(-1), likedBy: arrayRemove(user.uid) }); } 
                    else { await updateDoc(commentRef, { likes: increment(1), likedBy: arrayUnion(user.uid) }); }
                }
            } catch (e) { console.error("Failed to toggle comment like", e); }
        };

                let mentionSearchTimeout = null;

        window.handleCommentInput = (textarea) => {
            const cursorPosition = textarea.selectionStart;
            const text = textarea.value;
            const textBeforeCursor = text.substring(0, cursorPosition);
            
            // Regex to find the word being typed at the cursor (starts with @)
            const match = textBeforeCursor.match(/@(\w*)$/);
            const suggestionsBox = document.getElementById('mention-suggestions');

            if (match) {
                const queryStr = match[1].toLowerCase();
                
                clearTimeout(mentionSearchTimeout);
                mentionSearchTimeout = setTimeout(async () => {
                    try {
                        // Fetch users from Firestore (Optimized for demo: fetches a batch and filters client-side)
                        // In a production app with thousands of users, use a dedicated search service (e.g., Algolia)
                        const q = query(collection(db, 'users'), limit(50)); 
                        const snapshot = await getDocs(q);
                        
                        const matches = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const uName = data.profile?.username || '';
                            // Simple substring match
                            if (uName && uName.toLowerCase().includes(queryStr)) {
                                matches.push({ 
                                    username: uName, 
                                    avatar: data.profile?.photoUrl || 'https://via.placeholder.com/100' 
                                });
                            }
                        });

                        if (matches.length > 0) {
                            suggestionsBox.innerHTML = '';
                            // Show top 5 matches
                            matches.slice(0, 5).forEach(user => {
                                const div = document.createElement('div');
                                div.className = "flex items-center gap-2 p-3 hover:bg-app-hover cursor-pointer border-b border-app-border/50 last:border-0 transition-colors";
                                // onmousedown prevents the button from stealing focus from the textarea immediately
                                div.onmousedown = (e) => e.preventDefault(); 
                                div.onclick = () => window.selectMention(user.username);
                                div.innerHTML = `
                                    <div class="w-6 h-6 rounded-full bg-gray-200 overflow-hidden shrink-0 border border-app-border">
                                        <img src="${user.avatar}" class="w-full h-full object-cover">
                                    </div>
                                    <span class="text-sm font-bold text-app-text">@${user.username}</span>
                                `;
                                suggestionsBox.appendChild(div);
                            });
                            suggestionsBox.classList.remove('hidden');
                        } else {
                            suggestionsBox.classList.add('hidden');
                        }
                    } catch (e) {
                        console.error("Mention search error", e);
                    }
                }, 300); // 300ms debounce
            } else {
                if(suggestionsBox) suggestionsBox.classList.add('hidden');
            }
        };

        window.selectMention = (username) => {
            const textarea = document.getElementById('comment-text');
            const cursorPosition = textarea.selectionStart;
            const textBeforeCursor = textarea.value.substring(0, cursorPosition);
            const textAfterCursor = textarea.value.substring(cursorPosition);
            
            // Find the @ symbol being typed
            const match = textBeforeCursor.match(/@(\w*)$/);
            if (match) {
                const prefix = textBeforeCursor.substring(0, match.index);
                // Insert username + space
                const newText = prefix + '@' + username + ' ';
                textarea.value = newText + textAfterCursor;
                
                textarea.focus();
                // Move cursor to end of inserted mention
                const newPos = newText.length; 
                textarea.setSelectionRange(newPos, newPos);
            }
            
            document.getElementById('mention-suggestions').classList.add('hidden');
        };

        // 1. Format text to make @mentions clickable
        window.formatMentions = (text) => {
            if (!text) return '';
            // Escape HTML to prevent XSS before processing
            const safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // Regex to find @username (assuming alphanumeric + underscore)
            return safeText.replace(/@(\w+)/g, (match, username) => {
                return `<span onclick="event.stopPropagation(); window.lookupAndNavigateToProfile('${username}')" class="text-blue-500 font-bold cursor-pointer hover:underline">${match}</span>`;
            });
        };

        // 2. Lookup user by username and navigate
        window.lookupAndNavigateToProfile = async (username) => {
            try {
                const q = query(collection(db, 'users'), where('profile.username', '==', username), limit(1));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const data = doc.data();
                    window.viewUserProfile(doc.id, data.profile.username, data.profile.photoUrl);
                } else {
                    window.showToast(`User @${username} not found`, 'error');
                }
            } catch (e) {
                console.error("Profile lookup failed", e);
                window.showToast("Could not load profile", "error");
            }
        };

        // Close suggestions if clicking outside
        document.addEventListener('click', (e) => {
            const box = document.getElementById('mention-suggestions');
            const input = document.getElementById('comment-text');
            if (box && !box.classList.contains('hidden') && e.target !== input && !box.contains(e.target)) {
                box.classList.add('hidden');
            }
        });

        window.handleSendComment = async () => {
            const user = auth.currentUser;
            if (!user) { window.toggleAuthModal(true); return; }
            if (await window.checkAccountRestriction()) return;
            if (!currentCommentVideoId) { window.showToast("Cannot comment on preview items.", "error"); return; }
            const input = document.getElementById('comment-text');
            const text = input.value.trim();
            if (!text) return;
            if (text.length > 500) { alert("Comment too long (max 500 chars)"); return; }
            
            // Clear input immediately for better UX
            input.value = '';
            // Hide mention suggestions if open
            document.getElementById('mention-suggestions').classList.add('hidden');

            // Handle Mock/Preview (Client-side only)
            if (!currentCommentVideoPath || currentCommentVideoPath === 'null') {
                 const list = document.getElementById('comments-list');
                 const tempDiv = document.createElement('div');
                 tempDiv.className = "mb-6 relative animate-fade-in";
                 const safeUsername = (user.displayName || 'User').replace(/'/g, "\\'");
                 const safeAvatar = (user.photoURL || 'https://via.placeholder.com/100').replace(/'/g, "\\'");
                 // Use formatMentions here too!
                 tempDiv.innerHTML = `
                        <div class="relative group flex gap-3 animate-fade-in">
                            <div class="w-10 h-10 rounded-full bg-gray-200 shrink-0 overflow-hidden ring-2 ring-transparent group-hover:ring-app-border transition-all cursor-pointer"><img src="${user.photoURL || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover"></div>
                            <div class="flex-1 min-w-0"><div class="flex items-baseline gap-2 mb-0.5"><span class="text-xs font-bold text-app-text hover:underline cursor-pointer">${user.displayName || 'User'}</span><span class="text-[10px] text-app-textMuted opacity-60">Just now</span></div><p class="text-[15px] text-app-text leading-relaxed break-words font-medium opacity-90">${window.formatMentions(text)}</p>
                                <div class="flex items-center gap-4 mt-2 opacity-80 hover:opacity-100 transition-opacity">
                                    <button class="text-xs font-bold text-app-textMuted hover:text-app-text transition-colors">Reply</button>
                                    <button class="flex items-center gap-1 text-xs font-bold text-app-textMuted hover:text-brand-orange transition-colors"><i data-lucide="heart" class="w-3.5 h-3.5"></i><span>0</span></button>
                                </div>
                            </div>
                        </div>
                 `;
                 if(list.querySelector('i[data-lucide="message-square-dashed"]')) { list.innerHTML = ''; }
                 list.insertBefore(tempDiv, list.firstChild);
                 const countEl = document.querySelector(`.comment-count-${currentCommentVideoId}`);
                 if(countEl) { let current = parseInt(countEl.innerText.replace('k', '000')); countEl.innerText = formatNumber(current + 1); }
                 return;
            }

            try {
                const commentData = { userId: user.uid, username: user.displayName, avatarUrl: user.photoURL, text: text, timestamp: serverTimestamp(), likes: 0, likedBy: [] };
                if (replyingTo) { commentData.parentId = replyingTo.id; window.cancelReply(); }
                
                // 1. Add Comment
                await addDoc(collection(db, currentCommentVideoPath, 'comments'), commentData);
                
                // 2. Update Video Comment Count
                if (currentCommentVideoPath && currentCommentVideoPath !== 'null') {
                    const videoDocRef = doc(db, currentCommentVideoPath);
                    await setDoc(videoDocRef, { comments: increment(1) }, { merge: true });
                    
                    // 3. Notify Video Owner (if not self)
                    try {
                        const vidSnap = await getDoc(videoDocRef);
                        if(vidSnap.exists()) {
                            const vData = vidSnap.data();
                            const ownerId = vData.user.id; 
                            if(ownerId && ownerId !== user.uid) {
                                addDoc(collection(db, 'users', ownerId, 'notifications'), {
                                    type: 'comment', fromUserId: user.uid, fromUsername: user.displayName, fromUserAvatar: user.photoURL, previewText: text.substring(0, 50), postId: currentCommentVideoId, postThumbnail: vData.videoUrl || '', read: false, timestamp: serverTimestamp()
                                });
                            }
                        }
                    } catch(e) { console.warn("Owner notif failed", e); }
                }

                // 4. MENTION NOTIFICATIONS (New Logic)
                const mentionMatches = text.match(/@(\w+)/g);
                if (mentionMatches) {
                    const mentionedUsernames = [...new Set(mentionMatches.map(m => m.substring(1)))]; // Unique usernames, remove @
                    
                    // Process mentions in parallel
                    mentionedUsernames.forEach(async (mentionedUsername) => {
                        // Don't notify self
                        if (mentionedUsername === user.displayName) return;

                        try {
                            const q = query(collection(db, 'users'), where('profile.username', '==', mentionedUsername), limit(1));
                            const snapshot = await getDocs(q);
                            if (!snapshot.empty) {
                                const targetUserId = snapshot.docs[0].id;
                                
                                // Send notification
                                await addDoc(collection(db, 'users', targetUserId, 'notifications'), {
                                    type: 'comment', 
                                    fromUserId: user.uid,
                                    fromUsername: user.displayName,
                                    fromUserAvatar: user.photoURL,
                                    previewText: `Mentioned you: ${text.substring(0, 50)}`,
                                    postId: currentCommentVideoId,
                                    read: false,
                                    timestamp: serverTimestamp()
                                });
                            }
                        } catch (err) {
                            console.warn(`Failed to notify @${mentionedUsername}`, err);
                        }
                    });
                }

                const countEl = document.querySelector(`.comment-count-${currentCommentVideoId}`);
                if(countEl) { let current = parseInt(countEl.innerText.replace('k', '000')); countEl.innerText = formatNumber(current + 1); }
            } catch (e) {
                console.error("Error sending comment:", e);
                
                // 3. Catch Permission Error explicitly
                if (e.code === 'permission-denied') {
                    window.showToast("Access Denied: Your account is currently restricted.", "error");
                } else {
                    window.showToast("Failed to post comment: " + e.message, "error");
                }
                input.value = text; // Restore text so user doesn't lose it
            }
        };

        window.toggleLike = async (btn, videoId) => {
            const user = auth.currentUser;
            if (!user) { window.toggleAuthModal(true); return; }

            const videoWrapper = btn.closest('.video-item-wrapper');
            const videoPath = videoWrapper ? videoWrapper.dataset.path : null;
            
            if (!videoPath || videoPath === 'null') { 
                window.showToast("Cannot like preview items.", "error"); 
                return; 
            }

            if (btn.dataset.processing === 'true') return;
            btn.dataset.processing = 'true';

            const icon = btn.querySelector('svg') || btn.querySelector('i');
            const iconContainer = btn.querySelector('.icon-container') || btn.firstElementChild; 
            const countSpan = btn.querySelector('span');

            // Initialize visual state if needed
            if (btn.dataset.liked === undefined) {
                const visualState = icon.classList.contains('heart-liked'); 
                btn.dataset.liked = visualState ? 'true' : 'false';
            }
            if (btn.dataset.count === undefined) {
                btn.dataset.count = parseCount(countSpan.innerText);
            }

            let isLiked = btn.dataset.liked === 'true';
            let currentCount = parseInt(btn.dataset.count) || 0;
            let newLikedState = !isLiked;
            let newCount = isLiked ? Math.max(0, currentCount - 1) : currentCount + 1;

            // Optimistic UI
            btn.dataset.liked = newLikedState.toString();
            btn.dataset.count = newCount.toString();
            countSpan.innerText = formatNumber(newCount);
            
            if (newLikedState) {
                icon.classList.add('heart-liked', 'text-red-500', 'fill-red-500', 'animate-like');
                icon.classList.remove('text-white', 'md:text-app-text', 'text-gray-400');
                if (iconContainer) iconContainer.classList.add('heart-container-liked');
            } else {
                icon.classList.remove('heart-liked', 'text-red-500', 'fill-red-500', 'animate-like');
                icon.classList.add('text-white', 'md:text-app-text'); 
                if (iconContainer) iconContainer.classList.remove('heart-container-liked');
            }

            // Identify Content Type for Saving
            let mediaType = 'video';
            let mediaUrl = '';
            
            // Try to find slideshow image
            const slideImg = videoWrapper.querySelector(`img[id^="slide-${videoId}-"]`);
            // Try to find video element
            const vidElement = videoWrapper.querySelector('video');

            if (slideImg) {
                mediaType = 'slideshow';
                mediaUrl = slideImg.src; // First image
            } else if (vidElement) {
                mediaType = 'video';
                mediaUrl = vidElement.src;
            }

            try {
                const videoRef = doc(db, videoPath);
                const likeRef = doc(db, videoPath, "likes", user.uid);
                const userLikedVideoRef = doc(db, 'users', user.uid, 'likedVideos', videoId);
                
                const batch = writeBatch(db);

                if (newLikedState) {
                    batch.set(likeRef, { timestamp: serverTimestamp() });
                    batch.update(videoRef, { likes: increment(1) }); 
                    
                    // SAVE METADATA TO USER LIKES
                    batch.set(userLikedVideoRef, { 
                        type: mediaType,
                        videoUrl: mediaType === 'video' ? mediaUrl : null, 
                        thumbnailUrl: mediaUrl, // Used for both preview images
                        path: videoPath, 
                        timestamp: serverTimestamp() 
                    });

                    // Notification & Analytics (Simplified)
                    const parts = videoPath.split('/');
                    if (parts.length === 4 && parts[0] === 'users' && parts[1] !== user.uid) {
                        batch.set(doc(collection(db, 'users', parts[1], 'notifications')), { 
                            type: 'like', fromUserId: user.uid, fromUsername: user.displayName, fromUserAvatar: user.photoURL, 
                            postId: videoId, postThumbnail: mediaUrl, read: false, timestamp: serverTimestamp() 
                        });
                    }
                } else {
                    batch.delete(likeRef);
                    batch.update(videoRef, { likes: increment(-1) });
                    batch.delete(userLikedVideoRef);
                }

                await batch.commit();

            } catch (e) {
                console.error("Like toggle failed", e); 
                window.showToast("Connection failed. Like not saved.", "error");
                // Revert UI logic here if needed...
            } finally {
                btn.dataset.processing = 'false';
            }
        };

        async function checkLikeStatus(videoPath, btn) {
            const user = auth.currentUser;
            if (!user || !videoPath || videoPath === 'null') return;
            
            try {
                const docSnap = await getDoc(doc(db, videoPath, "likes", user.uid));
                
                if (docSnap.exists()) {
                    const icon = btn.querySelector('svg') || btn.querySelector('i');
                    const iconContainer = btn.querySelector('.icon-container') || btn.firstElementChild; 
                    
                    if (icon) {
                        icon.classList.add('heart-liked');
                        icon.classList.remove('text-white', 'md:text-app-text');
                    }
                    if (iconContainer) {
                        iconContainer.classList.add('heart-container-liked');
                    }
                }
            } catch (e) { 
                // Silent fail is fine here
            }
        }

        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            if(!container) return;

            // FORCE VISIBILITY: Reset container class to be a fixed transparent wrapper
            // This removes the 'hidden' class and the default teal background from the container itself
            container.className = "fixed bottom-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none";
            
            // Create the actual toast bubble
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-brand-teal' : 'bg-red-500';
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';
            
            toast.className = `flex items-center gap-3 px-6 py-4 rounded-xl text-white shadow-2xl ${bgColor} animate-toast-in pointer-events-auto min-w-[300px] border border-white/10 backdrop-blur-md`;
            toast.innerHTML = `<i data-lucide="${icon}" class="w-6 h-6 shrink-0"></i><span class="font-bold text-sm tracking-wide">${message}</span>`;
            
            container.appendChild(toast);
            if(window.lucide) window.lucide.createIcons();
            
            // Auto-remove animation
            setTimeout(() => { 
                toast.style.opacity = '0'; 
                toast.style.transform = 'translateY(20px)'; 
                setTimeout(() => toast.remove(), 300); 
            }, 4000);
        };

        window.toggleFAQ = (id) => {
            const ans = document.getElementById(`faq-ans-${id}`);
            const icon = document.getElementById(`faq-icon-${id}`);
            if (!ans || !icon) return;
            
            if (ans.classList.contains('hidden')) {
                ans.classList.remove('hidden');
                ans.classList.add('block');
                icon.style.transform = 'rotate(180deg)';
            } else {
                ans.classList.add('hidden');
                ans.classList.remove('block');
                icon.style.transform = 'rotate(0deg)';
            }
        };

        window.handleSupportSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            
            // 1. Get Auth Data
            const user = window.auth.currentUser;
            const userId = user ? user.uid : 'Guest';
            const username = user ? (user.displayName || 'Guest') : 'Guest';
            const authEmail = user ? user.email : 'N/A';

            // 2. Get Form Values
            const nameInput = form.querySelector('input[type="text"]').value;
            const emailInput = form.querySelector('input[type="email"]').value;
            const topicInput = form.querySelector('select').value;
            const messageInput = form.querySelector('textarea').value;

            // Validation
            if (!emailInput || !emailInput.includes('@')) {
                window.showToast("Please enter a valid email address.", "error");
                return;
            }

            // 3. Prepare UI (Loading State)
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Sending...`;
            
            try {
                // 4. Save to Firestore (For Admin Panel)
                await addDoc(collection(db, 'support_tickets'), {
                    userId: userId,
                    username: username,
                    authEmail: authEmail,
                    contactName: nameInput,
                    contactEmail: emailInput,
                    topic: topicInput,
                    message: messageInput,
                    status: 'open',
                    timestamp: serverTimestamp()
                });

                // 5. Send Email via EmailJS (Notifications)
                // We construct the body same as before
                const fullMessageBody = `
        User Message:
        ${messageInput}

        --------------------------------------------------
        USER DETAILS
        Name: ${nameInput}
        Input Email: ${emailInput}
        User ID: ${userId}
        Username: ${username}
        Topic: ${topicInput}
        --------------------------------------------------`;

                const templateParams = {
                    message: fullMessageBody,
                    reply_to: emailInput,
                    topic: topicInput
                };

                // Fire and forget email to avoid blocking UI if email service is slow
                emailjs.send('service_3jqdlyb', 'template_l6kzkzk', templateParams).catch(err => console.warn("EmailJS warning:", err));

                window.showToast("Support request sent successfully!", "success");
                form.reset();

            } catch (err) {
                console.error('Support Submit Error:', err);
                window.showToast("Failed to submit request. Please try again.", "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
                if(window.lucide) window.lucide.createIcons();
            }
        };

        // --- Create Product Logic ---
        window.handleProductImageSelect = (event) => {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            
            if (productImages.length + files.length > 8) {
                alert("You can upload a maximum of 8 images.");
                return;
            }

            productImages = [...productImages, ...files];
            window.renderProductImagePreviews();
        };

        window.removeProductImage = (index) => {
            productImages.splice(index, 1);
            window.renderProductImagePreviews();
        };

        window.renderProductImagePreviews = () => {
            const container = document.getElementById('product-images-preview');
            container.innerHTML = '';
            
            productImages.forEach((file, index) => {
                const url = URL.createObjectURL(file);
                const div = document.createElement('div');
                div.className = 'relative aspect-square rounded-lg overflow-hidden border border-app-border group';
                div.innerHTML = `
                    <img src="${url}" class="w-full h-full object-cover">
                    <button type="button" onclick="window.removeProductImage(${index})" class="absolute top-1 right-1 bg-black/60 hover:bg-red-500 text-white p-1 rounded-full transition-colors opacity-0 group-hover:opacity-100">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                    ${index === 0 ? '<span class="absolute bottom-0 left-0 right-0 bg-brand-teal text-white text-[10px] font-bold text-center py-0.5">Cover</span>' : ''}
                `;
                container.appendChild(div);
            });
            
            if (window.lucide) window.lucide.createIcons();
        };

        window.toggleShippingCostInput = () => {
             const radios = document.getElementsByName('shipping_cost_type');
             let selected = 'free';
             for(let r of radios) { if(r.checked) selected = r.value; }
             const container = document.getElementById('shipping-cost-container');
             if(selected === 'paid') {
                 container.classList.remove('hidden');
             } else {
                 container.classList.add('hidden');
                 document.getElementById('prod-shipping-cost').value = '';
             }
             window.updatePayout();
        };

        window.updatePayout = () => {
            const priceInput = document.getElementById('prod-price');
            const shippingInput = document.getElementById('prod-shipping-cost');
            
            // Elements
            const displayPrice = document.getElementById('calc-price');
            const displayShipping = document.getElementById('calc-shipping');
            const feeEl = document.getElementById('calc-fee');
            const payoutEl = document.getElementById('calc-payout');
            const totalEl = document.getElementById('calc-total');
            
            const price = parseFloat(priceInput.value) || 0;
            
            // Shipping Logic
            let shippingCost = 0;
            const shippingTypeRadios = document.getElementsByName('shipping_cost_type');
            let shippingType = 'free';
            for(let r of shippingTypeRadios) { if(r.checked) shippingType = r.value; }
            if (shippingType === 'paid') {
                 shippingCost = parseFloat(shippingInput.value) || 0;
            }

            const fee = price * 0.10;
            const payout = (price * 0.90) + shippingCost;
            const total = price + shippingCost;
            
            if(displayPrice) displayPrice.textContent = `$${price.toFixed(2)}`;
            if(displayShipping) displayShipping.textContent = `$${shippingCost.toFixed(2)}`;
            feeEl.textContent = `-$${fee.toFixed(2)}`;
            payoutEl.textContent = `$${payout.toFixed(2)}`;
            if(totalEl) totalEl.textContent = `$${total.toFixed(2)}`;
        };

        window.handleCreateProductSubmit = async (event) => {
            event.preventDefault();
            if (await window.checkAccountRestriction()) return;
            const user = auth.currentUser;
            if (!user) { window.toggleAuthModal(true); return; }

            if (productImages.length === 0) {
                alert("Please add at least one image.");
                return;
            }

            const title = document.getElementById('prod-title').value.trim();
            const desc = document.getElementById('prod-desc').value.trim();

            const categories = Array.from(window.selectedCategories.create);
            if (categories.length === 0) { alert("Please add at least one category."); return; }
            const category = categories[0]; // Primary

            const brand = document.getElementById('prod-brand').value.trim();
            const tagsInput = document.getElementById('prod-tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
            const condition = document.getElementById('prod-condition').value;
            const shipping = document.getElementById('prod-shipping').value;
            const location = document.getElementById('prod-location').value.trim();
            const stock = parseInt(document.getElementById('prod-stock').value) || 1;
            const price = parseFloat(document.getElementById('prod-price').value);

            // Shipping Cost Logic
            let shippingCost = 0;
            const shippingTypeRadios = document.getElementsByName('shipping_cost_type');
            let shippingType = 'free';
            for(let r of shippingTypeRadios) { if(r.checked) shippingType = r.value; }
            if (shippingType === 'paid') {
                 shippingCost = parseFloat(document.getElementById('prod-shipping-cost').value);
                 if (isNaN(shippingCost) || shippingCost < 0) {
                     alert("Please enter a valid shipping cost.");
                     return;
                 }
            }

            if (!title || isNaN(price) || price <= 0) {
                alert("Please fill in all required fields.");
                return;
            }

            const btn = document.getElementById('create-product-submit-btn');
            const statusDiv = document.getElementById('create-product-status');
            const originalBtnContent = btn.innerText;
            
            btn.disabled = true;
            btn.innerText = "Creating Product...";
            statusDiv.classList.add('hidden');

            try {
                // 1. Create a document reference first to get ID
                const prodRef = doc(collection(db, 'users', user.uid, 'products'));
                const productId = prodRef.id;

                // 2. Upload images
                const imageUrls = [];
                for (let i = 0; i < productImages.length; i++) {
                    const file = productImages[i];
                    const storagePath = `user_data/${user.uid}/products/${productId}/${file.name}`;
                    const storageRef = ref(storage, storagePath);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    imageUrls.push(url);
                }

                // 3. Save Metadata
                const productData = {
                    title,
                    description: desc,
                    category,
                    brand,
                    condition,
                    shippingMethod: shipping,
                    shippingCost: shippingCost,
                    location,
                    stock: stock,
                    tags: tags,
                    categories: categories,
                    price,
                    platformFee: price * 0.10,
                    sellerPayout: (price * 0.90) + shippingCost,
                    images: imageUrls,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                await setDoc(prodRef, productData);

                window.showToast("Product listed successfully!", "success");
                window.selectedCategories.create.clear();
                window.renderCategoryChips('create');
                
                // Reset form
                document.getElementById('create-product-form').reset();
                productImages = [];
                window.renderProductImagePreviews();
                window.updatePayout();
                window.toggleShippingCostInput(); // Reset visibility
                
                // Redirect to Profile -> Products tab
                await window.viewMyProfile();
                window.switchTab('products');

            } catch (error) {
                console.error("Create Product Error:", error);
                statusDiv.classList.remove('hidden');
                statusDiv.textContent = "Error: " + error.message;
                
                if (error.code === 'permission-denied') {
                    window.showToast("Listing Blocked: Account Restricted.", "error");
                } else {
                    window.showToast("Failed to list product.", "error");
                }
            } finally {
                btn.disabled = false;
                btn.innerText = originalBtnContent;
            }
        };
        
        window.handleDeleteProduct = async (event, productId) => {
            event.stopPropagation();
            window.openConfirmModal('Delete Product', 'Are you sure you want to delete this product? This action cannot be undone.', async () => {
                 const user = auth.currentUser;
                 if(!user) return;
                 try {
                    await deleteDoc(doc(db, 'users', user.uid, 'products', productId));
                    window.showToast("Product removed", "success");
                } catch(e) { console.error("Delete product failed", e); window.showToast("Failed to remove product", "error"); }
            });
        };

        window.toggleUploadType = (type) => {
            const input = document.getElementById('video-input');
            const dropzoneText = document.querySelector('#upload-container .border-dashed p.text-sm');
            const dropzoneSub = document.querySelector('#upload-container .border-dashed p.text-xs');
            const previewVideo = document.getElementById('upload-preview');
            const previewPlaceholder = document.getElementById('preview-placeholder');
            
            // Reset
            selectedVideoFile = null;
            selectedSlideFiles = [];
            previewVideo.classList.add('hidden');
            previewVideo.src = '';
            previewPlaceholder.classList.remove('hidden');
            document.getElementById('file-name-display').textContent = type === 'video' ? 'Click to select video' : 'Click to select images';
            document.getElementById('upload-submit-btn').disabled = true;
            
            // Clear existing slideshow preview if any
            const existingSlides = document.getElementById('upload-slideshow-preview');
            if(existingSlides) existingSlides.remove();

            if (type === 'video') {
                input.accept = "video/*";
                input.removeAttribute('multiple');
                dropzoneText.textContent = "Click to select video";
                // UPDATED TEXT WITH LIMITS
                dropzoneSub.textContent = "MP4, WebM (Max 10MB, 30s)";
            } else {
                input.accept = "image/*";
                input.setAttribute('multiple', 'true');
                dropzoneText.textContent = "Click to select images";
                dropzoneSub.textContent = "JPG, PNG, WEBP (Max 10)";
            }
        };

        window.handleFileSelect = (event) => {
            const typeRadio = document.querySelector('input[name="content_type"]:checked');
            const type = typeRadio ? typeRadio.value : 'video';
            
            if (type === 'video') {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('video/')) { 
                    window.showToast('Please select a valid video file.', 'error'); 
                    return; 
                }
                
                // 1. CHECK FILE SIZE (10MB = 10 * 1024 * 1024 bytes)
                const maxSize = 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    window.showToast("File is too large. Maximum size is 10MB.", "error");
                    event.target.value = ''; // Reset input
                    return;
                }

                // 2. CHECK DURATION (Max 30s)
                // We must load metadata to check duration
                const tempVideo = document.createElement('video');
                tempVideo.preload = 'metadata';
                
                tempVideo.onloadedmetadata = function() {
                    window.URL.revokeObjectURL(tempVideo.src);
                    
                    // Allow slight buffer (e.g., 30.9s)
                    if (tempVideo.duration > 31) { 
                        window.showToast(`Video is too long (${Math.round(tempVideo.duration)}s). Maximum duration is 30 seconds.`, "error");
                        event.target.value = ''; // Reset input
                        return;
                    }

                    // --- VALIDATION PASSED ---
                    selectedVideoFile = file;
                    document.getElementById('file-name-display').textContent = file.name;
                    document.getElementById('upload-submit-btn').disabled = false;
                    
                    const url = URL.createObjectURL(file);
                    const previewVideo = document.getElementById('upload-preview');
                    const previewPlaceholder = document.getElementById('preview-placeholder');
                    
                    // Clear slideshow if exists
                    const existingSlides = document.getElementById('upload-slideshow-preview');
                    if(existingSlides) existingSlides.remove();

                    previewVideo.src = url; 
                    previewVideo.classList.remove('hidden'); 
                    previewPlaceholder.classList.add('hidden');
                    previewVideo.play().catch(e => console.log('Preview autoplay blocked'));
                };

                tempVideo.onerror = function() {
                    window.showToast("Could not load video metadata. The file might be corrupted.", "error");
                    event.target.value = '';
                };

                tempVideo.src = URL.createObjectURL(file);
            
            } else {
                // Slideshow Logic (Standard)
                const files = Array.from(event.target.files);
                if (files.length === 0) return;
                
                const validImages = files.filter(f => f.type.startsWith('image/'));
                if (validImages.length === 0) { 
                    window.showToast('Please select image files.', 'error'); 
                    return; 
                }
                if (validImages.length > 10) { 
                    window.showToast('Max 10 images allowed.', 'error'); 
                    return; 
                }

                selectedSlideFiles = validImages;
                window.uploadSlideIndex = 0; // Reset to first slide
                
                document.getElementById('file-name-display').textContent = `${validImages.length} images selected`;
                document.getElementById('upload-submit-btn').disabled = false;

                // Prepare Containers
                const previewContainer = document.getElementById('upload-preview-container');
                document.getElementById('preview-placeholder').classList.add('hidden');
                document.getElementById('upload-preview').classList.add('hidden');
                document.getElementById('upload-preview').src = '';

                // Create/Reset Slideshow Container
                let slideContainer = document.getElementById('upload-slideshow-preview');
                if (!slideContainer) {
                    slideContainer = document.createElement('div');
                    slideContainer.id = 'upload-slideshow-preview';
                    slideContainer.className = "absolute inset-0 w-full h-full bg-black z-30 flex items-center justify-center overflow-hidden rounded-[1.8rem]"; 
                    previewContainer.appendChild(slideContainer);
                }
                
                // Trigger Render
                window.renderUploadPreview();
            }
        };

        window.updatePreviewAspect = (ratio) => {
            const container = document.getElementById('upload-preview-container');
            if (!container) return;

            // Reset classes
            container.classList.remove('w-[320px]', 'aspect-[9/16]', 'w-full', 'max-w-[500px]', 'aspect-video');

            if (ratio === 'landscape') {
                // Landscape Styling (Wider)
                container.classList.add('w-full', 'max-w-[500px]', 'aspect-video');
            } else {
                // Portrait Styling (Taller)
                container.classList.add('w-[320px]', 'aspect-[9/16]');
            }
        };

        window.renderUploadPreview = () => {
            const container = document.getElementById('upload-slideshow-preview');
            if (!container) return;
            
            if (!selectedSlideFiles || selectedSlideFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            const file = selectedSlideFiles[window.uploadSlideIndex];
            const url = URL.createObjectURL(file);
            
            // Render Image + Arrows + Counter
            container.innerHTML = `
                <div class="relative w-full h-full bg-black flex items-center justify-center">
                    <img src="${url}" class="w-full h-full object-contain">
                    
                    <!-- Navigation Overlay (Bottom of Preview) -->
                    <div class="absolute bottom-4 left-0 w-full px-4 flex justify-between items-center z-20 pointer-events-auto">
                        
                        <!-- Left Arrow -->
                        <button type="button" onclick="event.preventDefault(); window.changeUploadSlide(-1)" class="w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 transition-colors backdrop-blur-md border border-white/10">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        
                        <!-- Counter Badge -->
                        <span class="text-[10px] font-bold text-white bg-black/50 px-2 py-1 rounded-full backdrop-blur-md border border-white/10">
                            ${window.uploadSlideIndex + 1} / ${selectedSlideFiles.length}
                        </span>
                        
                        <!-- Right Arrow -->
                        <button type="button" onclick="event.preventDefault(); window.changeUploadSlide(1)" class="w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 transition-colors backdrop-blur-md border border-white/10">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Re-initialize icons for the new buttons
            if(window.lucide) window.lucide.createIcons();
        };

        window.changeUploadSlide = (dir) => {
            if (!selectedSlideFiles || selectedSlideFiles.length === 0) return;
            
            // Update index
            window.uploadSlideIndex += dir;
            
            // Loop navigation (Infinite scroll effect)
            if (window.uploadSlideIndex >= selectedSlideFiles.length) window.uploadSlideIndex = 0;
            if (window.uploadSlideIndex < 0) window.uploadSlideIndex = selectedSlideFiles.length - 1;
            
            // Re-render the view
            window.renderUploadPreview();
        };

        window.handleUploadSubmit = async (event) => {
            event.preventDefault();
            if (await window.checkAccountRestriction()) return;
            const user = auth.currentUser;
            const aspectRatio = document.querySelector('input[name="video_aspect"]:checked').value || 'portrait';
            const typeRadio = document.querySelector('input[name="content_type"]:checked');
            const contentType = typeRadio ? typeRadio.value : 'video';
            
            // 1. Validation
            if (!user) { alert("You must be logged in to upload."); return; }
            
            if (contentType === 'video' && !selectedVideoFile) { alert("Please select a video file."); return; }
            if (contentType === 'slideshow' && selectedSlideFiles.length === 0) { alert("Please select images."); return; }
            
            const productSelect = document.getElementById('upload-product-select');
            if (!productSelect.value) {
                alert("Product Required: You must attach a product to post content.");
                productSelect.focus();
                productSelect.classList.add('ring-2', 'ring-red-500');
                return;
            }

            // 2. Gather Data
            const productId = productSelect.value;
            const title = document.getElementById('meta-title').value;
            const desc = document.getElementById('meta-desc').value;
            const tagsStr = document.getElementById('meta-tags').value;
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
            const visibilityEl = document.querySelector('input[name="upload_visibility"]:checked');
            const visibility = visibilityEl ? visibilityEl.value : 'public';
            const commentEl = document.querySelector('input[name="upload_comments"]:checked');
            const commentMode = commentEl ? commentEl.value : 'allow';

            // Find selected product
            let productData = null;
            if (productId && window.userProducts) {
                const p = window.userProducts.find(up => up.id === productId);
                if (p) {
                    productData = {
                        id: p.id,
                        title: p.title,
                        price: parseFloat(p.price),
                        currency: '$', 
                        imageUrl: (p.images && p.images.length > 0) ? p.images[0] : null
                    };
                }
            }

            // 3. UI Loading
            const btn = document.getElementById('upload-submit-btn');
            const statusDiv = document.getElementById('upload-status');
            const originalBtnContent = btn.innerHTML; 
            btn.disabled = true; 
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i><span>Uploading...</span>`;
            if(window.lucide) window.lucide.createIcons();
            
            statusDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
            statusDiv.classList.add('bg-blue-50', 'text-brand-teal');
            statusDiv.textContent = "Uploading content...";

            try {
                // 4. Upload Files
                let mediaData = {};
                
                if (contentType === 'video') {
                    const sanitizedName = selectedVideoFile.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                    const storagePath = `user_data/${user.uid}/videos/${Date.now()}_${sanitizedName}`;
                    const storageRef = ref(storage, storagePath);
                    const snapshot = await uploadBytes(storageRef, selectedVideoFile);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    
                    mediaData = {
                        type: 'video',
                        videoUrl: downloadURL,
                        filePath: storagePath
                    };
                } else {
                    // Slideshow
                    const imageUrls = [];
                    const baseTime = Date.now();
                    
                    statusDiv.textContent = `Uploading images (0/${selectedSlideFiles.length})...`;
                    
                    for (let i = 0; i < selectedSlideFiles.length; i++) {
                        const file = selectedSlideFiles[i];
                        const sanitizedName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                        const storagePath = `user_data/${user.uid}/slideshows/${baseTime}_${i}_${sanitizedName}`;
                        const storageRef = ref(storage, storagePath);
                        await uploadBytes(storageRef, file);
                        const url = await getDownloadURL(storageRef);
                        imageUrls.push(url);
                        statusDiv.textContent = `Uploading images (${i+1}/${selectedSlideFiles.length})...`;
                    }
                    
                    mediaData = {
                        type: 'slideshow',
                        images: imageUrls,
                        videoUrl: null, // Fallback
                        filePath: `user_data/${user.uid}/slideshows/${baseTime}` // Folder-ish reference
                    };
                }

                statusDiv.textContent = "Finalizing...";

                const newRef = doc(collection(db, 'videos'));
                const newVideoId = newRef.id;
                const finalAvatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=random`;

                const docData = {
                    ...mediaData,
                    title: title,
                    description: desc || title,
                    tags: tags,
                    productId: productId,
                    product: productData,
                    aspectRatio: aspectRatio,
                    visibility: visibility,
                    commentMode: commentMode,
                    user: { 
                        id: user.uid, 
                        username: user.displayName || 'User', 
                        avatarUrl: finalAvatarUrl 
                    },
                    likes: 0, comments: 0, shares: 0, views: 0,
                    thumbnailUrl: (mediaData.type === 'slideshow' ? mediaData.images[0] : ''),
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                // Root
                await setDoc(newRef, docData);
                
                // User Subcollection
                await setDoc(doc(db, 'users', user.uid, 'videos', newVideoId), docData);

                // Success
                statusDiv.classList.remove('bg-blue-50', 'text-brand-teal');
                statusDiv.classList.add('bg-green-100', 'text-green-700'); 
                statusDiv.textContent = "Published successfully!";
                window.showToast("Published successfully!", "success");
                
                // Reset
                document.getElementById('upload-form').reset();
                selectedVideoFile = null;
                selectedSlideFiles = [];
                window.uploadSlideIndex = 0;
                document.getElementById('upload-preview').classList.add('hidden');
                document.getElementById('preview-placeholder').classList.remove('hidden');
                const existingSlides = document.getElementById('upload-slideshow-preview');
                if(existingSlides) existingSlides.remove();
                document.getElementById('file-name-display').textContent = 'Click to select...';
                
                // Reset Radio UI State
                const videoRadio = document.querySelector('input[name="content_type"][value="video"]');
                if(videoRadio) {
                    videoRadio.checked = true;
                    window.toggleUploadType('video'); // trigger reset logic
                }
                
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                    window.viewMyProfile();
                }, 1500);

            } catch (error) {
                console.error("Upload Error:", error);
                statusDiv.classList.remove('bg-blue-50', 'text-brand-teal'); 
                statusDiv.classList.add('bg-red-100', 'text-red-700'); 
                statusDiv.textContent = "Upload failed: " + error.message; 
            } finally {
                btn.innerHTML = originalBtnContent; 
                btn.disabled = false; 
                if(window.lucide) window.lucide.createIcons(); 
            }
        };

        window.setTheme = (theme) => {
            const html = document.documentElement;
            const lightCard = document.getElementById('theme-card-light');
            const darkCard = document.getElementById('theme-card-dark');
            if (theme === 'dark') {
                html.classList.add('dark'); localStorage.setItem('theme', 'dark');
                darkCard.classList.add('border-brand-orange', 'bg-app-hover'); darkCard.classList.remove('border-gray-200'); darkCard.querySelector('.check-icon').classList.remove('opacity-0');
                lightCard.classList.remove('border-brand-teal', 'bg-app-hover'); lightCard.classList.add('border-gray-200'); lightCard.querySelector('.check-icon').classList.add('opacity-0');
            } else {
                html.classList.remove('dark'); localStorage.setItem('theme', 'light');
                lightCard.classList.add('border-brand-teal', 'bg-app-hover'); lightCard.classList.remove('border-gray-200'); lightCard.querySelector('.check-icon').classList.remove('opacity-0');
                darkCard.classList.remove('border-brand-orange', 'bg-app-hover'); darkCard.classList.add('border-gray-200'); darkCard.querySelector('.check-icon').classList.add('opacity-0');
            }
        };
        const savedTheme = localStorage.getItem('theme') || 'light'; window.setTheme(savedTheme);

        window.switchTab = (tabName) => {
            const tabs = ['videos', 'reposts', 'likes', 'products'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const content = document.getElementById(`profile-content-${t}`);
                if (t === tabName) {
                    btn.classList.remove('tab-inactive'); btn.classList.add('tab-active'); content.classList.remove('hidden');
                    if(t === 'videos' || t === 'reposts' || t === 'products') content.classList.add('grid');
                } else {
                    btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); content.classList.add('hidden'); content.classList.remove('grid');
                }
            });
            if (unsubscribeLikes && tabName !== 'likes') { unsubscribeLikes(); unsubscribeLikes = null; }
            if (unsubscribeReposts && tabName !== 'reposts') { unsubscribeReposts(); unsubscribeReposts = null; }
            if (unsubscribeProducts && tabName !== 'products') { unsubscribeProducts(); unsubscribeProducts = null; }

            if (tabName === 'likes') {
                const user = auth.currentUser;
                if (user && user.uid === currentViewedProfileId) {
                    const likesContainer = document.getElementById('profile-content-likes');
                    // Reset to clean slate for filters
                    likesContainer.innerHTML = '';
                    likesContainer.classList.remove('hidden'); 
                    window.setupLikesListener(user.uid);
                } else {
                     const likesContainer = document.getElementById('profile-content-likes');
                     likesContainer.classList.remove('grid', 'grid-cols-3', 'md:grid-cols-4', 'lg:grid-cols-5', 'gap-4');
                     likesContainer.innerHTML = `<div class="flex flex-col items-center gap-2 py-20"><div class="w-16 h-16 rounded-full bg-app-card flex items-center justify-center mb-2"><i data-lucide="lock" class="w-8 h-8 text-app-textMuted/50"></i></div><p class="font-bold text-app-textMuted">Liked items are private</p><p class="text-sm">Only you can see what you've liked.</p></div>`;
                     if(window.lucide) window.lucide.createIcons();
                }
            } else if (tabName === 'reposts') { 
                window.setupRepostsListener(currentViewedProfileId); 
            } else if (tabName === 'products') {
                window.setupProductsListener(currentViewedProfileId);
            }
        };

        window.setupProductsListener = (userId) => {
            if(unsubscribeProducts) unsubscribeProducts();
            const container = document.getElementById('profile-content-products');
            container.innerHTML = '<div class="col-span-full text-center py-10 text-app-textMuted">Loading products...</div>';
            
            const q = query(collection(db, 'users', userId, 'products'), orderBy('createdAt', 'desc'));
            const isMe = auth.currentUser && auth.currentUser.uid === userId;
            
            unsubscribeProducts = onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                if(snapshot.empty) {
                    container.classList.remove('grid', 'grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4', 'gap-6');
                    container.innerHTML = `<div class="col-span-full flex flex-col items-center gap-2 py-20"><div class="w-16 h-16 rounded-full bg-app-card flex items-center justify-center mb-2"><i data-lucide="shopping-bag" class="w-8 h-8 text-app-textMuted/50"></i></div><p class="font-bold text-app-textMuted">No products listed</p></div>`;
                    return;
                }
                
                container.classList.add('grid', 'grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4', 'gap-6', 'w-full');
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'flex flex-col bg-app-card border border-app-border rounded-xl overflow-hidden cursor-pointer hover:shadow-lg transition-all group relative';
                    div.onclick = () => window.viewProduct(doc.id, userId);
                    
                    const imageUrl = (data.images && data.images.length > 0) ? data.images[0] : 'https://via.placeholder.com/300';
                    const isSoldOut = (data.stock || 0) <= 0;

                    div.innerHTML = `
                        <div class="aspect-square relative bg-gray-100 overflow-hidden">
                            <img src="${imageUrl}" class="w-full h-full object-cover ${isSoldOut ? 'grayscale opacity-60' : 'group-hover:scale-105'} transition-transform duration-500">
                            
                            ${data.condition === 'New' && !isSoldOut ? '<span class="absolute top-2 left-2 bg-brand-teal text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">NEW</span>' : ''}
                            
                            ${isSoldOut ? '<div class="absolute inset-0 flex items-center justify-center bg-black/40"><span class="bg-black/80 text-white text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider border border-white/20 backdrop-blur-sm">Sold Out</span></div>' : ''}

                            ${isMe ? `<button onclick="event.stopPropagation(); window.navigateTo('product/${doc.id}/edit')" class="absolute top-2 right-2 bg-white/90 hover:bg-brand-teal hover:text-white text-gray-700 p-1.5 rounded-full shadow-sm transition-all opacity-0 group-hover:opacity-100 z-10"><i data-lucide="edit-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                        <div class="p-3 flex flex-col gap-1">
                            <h4 class="font-bold text-app-text truncate text-sm ${isSoldOut ? 'text-app-textMuted line-through' : ''}">${data.title}</h4>
                            <p class="text-xs text-app-textMuted truncate">${data.brand || 'No brand'}</p>
                            <div class="mt-2 flex items-center justify-between">
                                <span class="font-bold text-app-text">$${data.price.toFixed(2)}</span>
                                ${!isSoldOut ? '<div class="bg-app-hover p-1 rounded-full"><i data-lucide="arrow-right" class="w-4 h-4 text-app-text"></i></div>' : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                if(window.lucide) window.lucide.createIcons();
            });
        };

        window.setupRepostsListener = (userId) => {
            if(window.unsubscribeReposts) window.unsubscribeReposts();
            const container = document.getElementById('profile-content-reposts');
            container.innerHTML = '<div class="col-span-full text-center py-10 text-app-textMuted">Loading reposts...</div>';
            
            const q = query(collection(db, 'users', userId, 'reposts'), orderBy('timestamp', 'desc'));
            
            window.unsubscribeReposts = onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                if(snapshot.empty) {
                     container.classList.remove('grid', 'grid-cols-3', 'md:grid-cols-4', 'lg:grid-cols-5', 'gap-4');
                     container.innerHTML = `<div class="flex flex-col items-center gap-2 py-20 w-full col-span-full text-app-textMuted"><div class="w-16 h-16 rounded-full bg-app-card flex items-center justify-center mb-2"><i data-lucide="repeat" class="w-8 h-8 text-app-textMuted/50"></i></div><p class="font-bold">No reposts yet</p></div>`;
                     return;
                }
                container.classList.add('grid', 'grid-cols-3', 'md:grid-cols-4', 'lg:grid-cols-5', 'gap-4', 'w-full');
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'aspect-[3/4] bg-black rounded-xl overflow-hidden relative cursor-pointer group border border-app-border';
                    div.onclick = () => window.goToFeedVideo(data.videoId);
                    
                    const isSlideshow = data.type === 'slideshow';
                    let mediaHtml = '';
                    let typeIcon = '';

                    if (isSlideshow) {
                        mediaHtml = `<img src="${data.thumbnailUrl || ''}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">`;
                        typeIcon = `<div class="absolute top-2 right-2 bg-black/60 p-1.5 rounded-full backdrop-blur-md z-20 border border-white/10"><i data-lucide="images" class="w-3 h-3 text-white"></i></div>`;
                    } else {
                        // Fallback to videoUrl if thumbnail missing for legacy data
                        mediaHtml = `<video src="${data.videoUrl}" class="w-full h-full object-cover opacity-90 group-hover:scale-105 transition-transform duration-500" muted loop playsinline onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>`;
                    }

                    div.innerHTML = `
                         ${mediaHtml}
                         ${typeIcon}
                         <div class="absolute bottom-2 right-2 bg-black/50 p-1.5 rounded-full backdrop-blur-sm z-10"><i data-lucide="repeat" class="w-3 h-3 text-white"></i></div>
                         <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-colors"></div>
                    `;
                    container.appendChild(div);
                });
                if(window.lucide) window.lucide.createIcons();
            });
        };

        window.setLikesFilter = (filter) => {
             currentLikesFilter = filter;
             const btnVideos = document.getElementById('likes-filter-videos');
             const btnProducts = document.getElementById('likes-filter-products');
             
             if(filter === 'videos') {
                 btnVideos.classList.remove('bg-app-card', 'border', 'border-app-border', 'text-app-textMuted');
                 btnVideos.classList.add('bg-app-text', 'text-app-bg');
                 btnProducts.classList.add('bg-app-card', 'border', 'border-app-border', 'text-app-textMuted');
                 btnProducts.classList.remove('bg-app-text', 'text-app-bg');
             } else {
                 btnProducts.classList.remove('bg-app-card', 'border', 'border-app-border', 'text-app-textMuted');
                 btnProducts.classList.add('bg-app-text', 'text-app-bg');
                 btnVideos.classList.add('bg-app-card', 'border', 'border-app-border', 'text-app-textMuted');
                 btnVideos.classList.remove('bg-app-text', 'text-app-bg');
             }
             
             // Trigger fetch
             const user = auth.currentUser;
             if(user) window.setupLikesListener(user.uid);
        };

        window.setupLikesListener = (userId) => {
            if(window.unsubscribeLikes) window.unsubscribeLikes();
            const container = document.getElementById('profile-content-likes');
            
            // Build UI structure
            container.innerHTML = `
                <div class="col-span-full flex justify-center gap-4 mb-6">
                    <button onclick="window.setLikesFilter('videos')" id="likes-filter-videos" class="px-4 py-1.5 rounded-full font-bold text-sm transition-colors ${currentLikesFilter === 'videos' ? 'bg-app-text text-app-bg' : 'bg-app-card border border-app-border text-app-textMuted'}">Media</button>
                    <button onclick="window.setLikesFilter('products')" id="likes-filter-products" class="px-4 py-1.5 rounded-full font-bold text-sm transition-colors ${currentLikesFilter === 'products' ? 'bg-app-text text-app-bg' : 'bg-app-card border border-app-border text-app-textMuted'}">Products</button>
                </div>
                <div id="likes-grid" class="col-span-full grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 w-full">
                    <div class="col-span-full text-center py-10 text-app-textMuted">Loading...</div>
                </div>
            `;
            
            const grid = document.getElementById('likes-grid');

            if(currentLikesFilter === 'videos') {
                 const q = query(collection(db, 'users', userId, 'likedVideos'), orderBy('timestamp', 'desc'));
                 window.unsubscribeLikes = onSnapshot(q, (snapshot) => {
                    grid.innerHTML = '';
                    if (snapshot.empty) {
                        grid.innerHTML = `<div class="w-full text-center py-10 text-app-textMuted col-span-full">No liked media yet.</div>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = 'aspect-[3/4] bg-black rounded-xl overflow-hidden relative cursor-pointer group border border-app-border';
                        div.onclick = () => window.goToFeedVideo(doc.id); 
                        
                        const isSlideshow = data.type === 'slideshow';
                        let mediaHtml = '';
                        let typeIcon = '';

                        if (isSlideshow) {
                            // Use stored thumbnail (first image)
                            mediaHtml = `<img src="${data.thumbnailUrl || ''}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">`;
                            typeIcon = `<div class="absolute top-2 right-2 bg-black/60 p-1.5 rounded-full backdrop-blur-md z-20 border border-white/10"><i data-lucide="images" class="w-3 h-3 text-white"></i></div>`;
                        } else {
                            mediaHtml = `<video src="${data.videoUrl}" class="w-full h-full object-cover opacity-80 hover:opacity-100 transition-opacity" muted loop playsinline onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>`;
                        }

                        div.innerHTML = `
                            ${mediaHtml}
                            ${typeIcon}
                            <div class="absolute bottom-2 left-2 text-white text-xs font-bold drop-shadow-md z-20"><i data-lucide="heart" class="w-3 h-3 fill-white inline"></i> Liked</div>
                        `;
                        grid.appendChild(div);
                    });
                    if(window.lucide) window.lucide.createIcons();
                 });
            } else {
                 // Products Filter (Unchanged logic, just ensure correct function hook)
                 const q = query(collection(db, 'users', userId, 'likedProducts'), orderBy('timestamp', 'desc'));
                 window.unsubscribeLikes = onSnapshot(q, (snapshot) => {
                    grid.innerHTML = '';
                    if (snapshot.empty) {
                        grid.innerHTML = `<div class="w-full text-center py-10 text-app-textMuted col-span-full">No liked products yet.</div>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = 'aspect-square bg-app-card rounded-xl overflow-hidden relative cursor-pointer group border border-app-border flex flex-col';
                        div.onclick = () => window.viewProduct(data.productId, data.sellerId);
                        
                        const img = data.image || 'https://via.placeholder.com/300';
                        
                        div.innerHTML = `
                            <div class="flex-1 overflow-hidden relative">
                                <img src="${img}" class="w-full h-full object-cover hover:scale-105 transition-transform">
                                <div class="absolute top-2 right-2 bg-white/90 p-1 rounded-full shadow-sm"><i data-lucide="heart" class="w-3 h-3 text-red-500 fill-red-500"></i></div>
                            </div>
                            <div class="p-2 bg-app-card">
                                <p class="text-xs font-bold truncate text-app-text">${data.title}</p>
                                <p class="text-[10px] text-app-textMuted font-bold">$${data.price}</p>
                            </div>
                        `;
                        grid.appendChild(div);
                    });
                    if(window.lucide) window.lucide.createIcons();
                 });
            }
        };

        window.triggerAvatarUpload = () => { document.getElementById('avatar-upload').click(); };
        window.handleAvatarUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { alert("File is too large. Please choose an image under 2MB."); return; }
            const user = auth.currentUser;
            if (!user) return;
            try {
                window.showToast("Uploading avatar...", "success");
                const storageRef = ref(storage, `user_data/${user.uid}/profile_picture.jpg`);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                await updateProfile(user, { photoURL: downloadURL });
                document.getElementById('profile-image').src = downloadURL;
                const userDisplay = document.getElementById('user-display');
                const sidebarImg = userDisplay.querySelector('img');
                if (sidebarImg) sidebarImg.src = downloadURL;
                await setDoc(doc(db, "users", user.uid), { profile: { photoUrl: downloadURL } }, { merge: true });
                window.showToast("Avatar updated!", "success");
            } catch (error) { console.error("Avatar upload failed:", error); window.showToast("Failed to upload avatar.", "error"); }
        };

        window.handleGoogleLogin = async () => {
            const authError = document.getElementById('auth-error');
            authError.classList.add('hidden');
            try { await signInWithPopup(auth, googleProvider); } catch (error) { console.error("Google Auth Error:", error); authError.textContent = error.message; authError.classList.remove('hidden'); }
        };

        window.checkUsernameTaken = async (username) => {
            // Note: This requires an index on 'profile.username' in Firestore for optimal performance
            const q = query(collection(db, 'users'), where('profile.username', '==', username));
            const snap = await getDocs(q);
            return !snap.empty;
        };

        window.handleChangeUsernameSubmit = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if(!user) return;
            
            const newName = document.getElementById('new-username-input').value.trim();
            const msg = document.getElementById('username-check-msg');
            const btn = e.target.querySelector('button');
            
            if (newName === user.displayName) {
                window.showToast("That's already your username.", "info");
                return;
            }
            
            const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
            if (!usernameRegex.test(newName)) {
                window.showToast("Invalid format. Letters, numbers, _ only.", "error");
                return;
            }

            btn.disabled = true; btn.innerText = "Checking availability...";
            msg.classList.add('hidden');
            
            try {
                const taken = await window.checkUsernameTaken(newName);
                if (taken) {
                    msg.textContent = "Username is already taken";
                    msg.className = "text-xs mt-2 font-bold text-red-500 block animate-pulse";
                    btn.disabled = false; btn.innerText = "Update Username";
                    return;
                }
                
                btn.innerText = "Updating...";
                
                // Update Auth Profile
                await updateProfile(user, { displayName: newName });
                
                // Update Firestore Profile
                await setDoc(doc(db, 'users', user.uid), { 
                    profile: { username: newName } 
                }, { merge: true });
                
                // Update Local UI
                document.getElementById('settings-username').textContent = newName;
                const sidebarName = document.querySelector('#user-display span.text-sm');
                if(sidebarName) sidebarName.textContent = newName;
                
                document.getElementById('change-username-modal').classList.add('hidden');
                window.showToast("Username updated!", "success");
                
            } catch(e) {
                console.error(e);
                window.showToast("Update failed", "error");
            } finally {
                btn.disabled = false; btn.innerText = "Update Username";
            }
        };

        window.handleChangePasswordSubmit = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if(!user) return;
            
            const p1 = document.getElementById('new-password-input').value;
            const p2 = document.getElementById('confirm-password-input').value;
            
            if(p1 !== p2) {
                window.showToast("Passwords do not match", "error");
                return;
            }
            
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerText = "Updating...";
            
            try {
                await updatePassword(user, p1);
                document.getElementById('change-password-modal').classList.add('hidden');
                window.showToast("Password updated successfully", "success");
            } catch(e) {
                console.error(e);
                if(e.code === 'auth/requires-recent-login') {
                    window.showToast("Security: Please log out and back in to change password.", "error");
                } else if (e.code === 'auth/weak-password') {
                    window.showToast("Password should be at least 6 characters.", "error");
                } else {
                    window.showToast("Failed: " + e.message, "error");
                }
            } finally {
                btn.disabled = false; btn.innerText = originalText;
            }
        };

        window.handleChangeEmailSubmit = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if(!user) return;

            const newEmail = document.getElementById('new-email-input').value.trim();
            if(newEmail === user.email) {
                window.showToast("That is your current email.", "info");
                return;
            }

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.disabled = true; btn.innerText = "Updating...";

            try {
                await updateEmail(user, newEmail);
                
                // Update Firestore
                await setDoc(doc(db, 'users', user.uid), { 
                    profile: { email: newEmail } 
                }, { merge: true });

                document.getElementById('settings-email').textContent = newEmail;
                document.getElementById('change-email-modal').classList.add('hidden');
                window.showToast("Email updated successfully!", "success");
            } catch(e) {
                console.error(e);
                if(e.code === 'auth/requires-recent-login') {
                    window.showToast("Security: Please log out and back in to change email.", "error");
                } else if (e.code === 'auth/email-already-in-use') {
                    window.showToast("Email is already in use.", "error");
                } else if (e.code === 'auth/invalid-email') {
                    window.showToast("Invalid email format.", "error");
                } else {
                    window.showToast("Failed: " + e.message, "error");
                }
            } finally {
                btn.disabled = false; btn.innerText = originalText;
            }
        };

        window.handleAuthAction = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            const submitBtn = document.getElementById('modal-submit');
            authError.classList.add('hidden'); authError.textContent = '';
            const originalBtnText = submitBtn.innerText;
            submitBtn.disabled = true; submitBtn.innerText = 'Processing...';
            try {
                if (currentAuthMode === 'complete_profile') {
                    const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
                    if (!usernameRegex.test(username)) throw new Error("Username must be 3-20 characters (letters, numbers, underscores).");
                    if (auth.currentUser) { await updateProfile(auth.currentUser, { displayName: username }); window.location.reload(); }
                    return;
                }
                if (currentAuthMode === 'login') { await signInWithEmailAndPassword(auth, email, password); } 
                    else if (currentAuthMode === 'signup') {
                        const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
                        if (!usernameRegex.test(username)) throw new Error("Username must be 3-20 characters (letters, numbers, underscores).");
                        
                        // UNIQUE CHECK
                        const taken = await window.checkUsernameTaken(username);
                        if(taken) throw new Error("Username is already taken. Please choose another.");

                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(userCredential.user, { displayName: username });
                        await setDoc(doc(db, 'users', userCredential.user.uid), { profile: { username: username, email: email }, stats: { followers: 0, following: 0 }, createdAt: serverTimestamp() });
                    }
            } catch (error) {
                let msg = error.message;
                if (error.code === 'auth/user-not-found') { if (currentAuthMode === 'login') { window.toggleAuthMode('signup'); msg = "Account not found. Please create one."; } } 
                else if (error.code === 'auth/email-already-in-use') { if (currentAuthMode === 'signup') { window.toggleAuthMode('login'); msg = "Account exists. Please log in."; } }
                authError.textContent = msg; authError.classList.remove('hidden');
            } finally { submitBtn.disabled = false; submitBtn.innerText = originalBtnText; }
        };

        window.handleLogout = async () => { try { await signOut(auth); window.navigateTo('feed'); } catch (error) { console.error("Logout failed", error); } };

        window.toggleAuthModal = (show) => {
            if (show) {
                authModal.classList.remove('hidden');
                if (currentAuthMode === 'complete_profile') return;
                window.toggleAuthMode('login');
                document.getElementById('email').value = ''; document.getElementById('password').value = ''; document.getElementById('username').value = '';
                authError.classList.add('hidden'); modalClose.classList.remove('hidden');
            } else { authModal.classList.add('hidden'); }
        };

        window.toggleAuthMode = (mode) => {
            currentAuthMode = mode;
            const title = document.getElementById('modal-title');
            const subtitle = document.getElementById('modal-subtitle');
            const submitBtn = document.getElementById('modal-submit');
            const toggleText = document.getElementById('modal-toggle-text');
            const usernameInput = document.getElementById('username');
            usernameContainer.classList.add('hidden'); emailFields.classList.remove('hidden'); googleBtnContainer.classList.remove('hidden'); toggleContainer.classList.remove('hidden'); usernameInput.required = false;
            if (mode === 'signup') {
                title.innerText = 'Create Account'; subtitle.innerText = 'Join the community'; submitBtn.innerText = 'Sign Up';
                toggleText.innerHTML = 'Already have an account? <a href="#" onclick="toggleAuthMode(\'login\')" class="text-brand-orange font-bold hover:underline">Login</a>';
                usernameContainer.classList.remove('hidden'); usernameInput.required = true;
            } else if (mode === 'login') {
                title.innerText = 'Welcome Back'; subtitle.innerText = 'Securely access your account'; submitBtn.innerText = 'Login';
                toggleText.innerHTML = 'New here? <a href="#" onclick="toggleAuthMode(\'signup\')" class="text-brand-orange font-bold hover:underline">Create Account</a>';
            } else if (mode === 'complete_profile') {
                title.innerText = 'One Last Step'; subtitle.innerText = 'Choose a username to continue'; submitBtn.innerText = 'Complete Profile';
                usernameContainer.classList.remove('hidden'); emailFields.classList.add('hidden'); googleBtnContainer.classList.add('hidden'); toggleContainer.classList.add('hidden'); usernameInput.required = true;
            }
            const form = document.getElementById('auth-form'); form.onsubmit = window.handleAuthAction;
        };

        authModal.addEventListener('click', (e) => { if (e.target === authModal && currentAuthMode !== 'complete_profile') window.toggleAuthModal(false); });

        const observerOptions = { root: document.getElementById('feed-container'), threshold: 0.6 };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target.querySelector('video');
                if(!video) return;
                
                const videoId = entry.target.dataset.id;
                const videoPath = entry.target.dataset.path;
                
                // IDs for containers
                const desktopId = `engagement-desktop-${videoId}`;
                const mobileId = `engagement-mobile-${videoId}`;
                const tags = entry.target.dataset.tags ? entry.target.dataset.tags.split(',') : [];

                if (entry.isIntersecting) {
                    video.play().catch(e => console.log('Autoplay prevented'));
                    onVideoStart({ id: videoId, tags: tags });
                    
                    // Start Engagement Animations
                    window.startEngagementBubbles(desktopId, videoPath);
                    window.startEngagementBubbles(mobileId, videoPath);

                    // Track View
                    if (!viewedVideos.has(videoId)) {
                        viewedVideos.add(videoId);
                        window.incrementViewCount(videoId, videoPath);
                    }
                } 
                else { 
                    if (entry.target.onVideoHidden) entry.target.onVideoHidden();
                    onVideoEnd();
                    video.pause(); 
                    video.currentTime = 0;
                    
                    // Stop Engagement Animations
                    window.stopEngagementBubbles(desktopId);
                    window.stopEngagementBubbles(mobileId);
                }
            });
        }, observerOptions);

        
        window.createVideoPost = (post) => {
            if (!post || !post.user) return document.createElement('div');
            
            const formatTime = (seconds) => {
                if (!seconds || isNaN(seconds)) return "00:00";
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
            };

            const isSlideshow = post.type === 'slideshow' && post.images && post.images.length > 0;
            const username = post.user.username || 'User';
            const avatarUrl = window.getAvatar(post.user.avatarUrl, username);
            const description = post.description || '';
            const path = post.path || 'null';
            
            const safeUsername = username.replace(/'/g, "\\'");
            const safeAvatar = avatarUrl.replace(/'/g, "\\'");
            const safeTitle = (post.title || '').replace(/'/g, "\\'");
            const safeDesc = description.replace(/'/g, "\\'").replace(/\n/g, ' '); 
            const safeTags = (post.tags || []).join(', ').replace(/'/g, "\\'");

            // --- 1. FOLLOW CHECK ---
            // Check if we are already following this user
            const isMe = window.auth.currentUser && window.auth.currentUser.uid === post.user.id;
            const isFollowing = window.myFollowing && window.myFollowing.has(post.user.id);
            const showFollowBtn = !isMe && !isFollowing;

            // Aspect Ratio & Layout Logic
            const isLandscape = post.aspectRatio === 'landscape';
            const useCenteredLayout = isLandscape || isSlideshow;

            const desktopContainerClass = isLandscape 
                ? 'md:h-[85%] md:w-auto md:aspect-video md:bg-black md:rounded-[2rem] md:max-w-[calc(100vw-350px)]' 
                : 'md:w-[450px] md:h-full md:bg-black md:rounded-[2rem]';
                
            const mobileContainerClass = useCenteredLayout
                ? 'relative w-full h-full bg-black flex flex-col justify-center pb-40 md:block md:pb-0'
                : 'relative w-full h-full bg-black';
                
            const videoClass = isLandscape 
                ? 'w-full h-auto max-h-full object-contain md:w-full md:h-full md:object-cover' 
                : 'w-full h-full object-cover';

            // Product Styling
            const productCardClass = 'w-full md:w-[400px]';
            const productCardBg = isLandscape ? 'bg-white/95 dark:bg-zinc-900/95 backdrop-blur-md' : 'bg-app-card';
            const overlayPadding = isLandscape ? 'pb-24 px-4 md:pb-7 md:px-8 pt-3' : 'pb-24 px-4 md:pb-7 md:px-6 pt-20';
            const textMargin = 'mb-2';
            const productMargin = isLandscape ? 'mt-1' : 'mt-2';
            const productPadding = 'p-3 md:p-3';
            const productImageSize = 'w-10 h-10 md:w-12 md:h-12';

            const postWrapper = document.createElement('div');
            postWrapper.className = 'w-full h-full snap-start flex justify-center items-center p-0 md:p-4 video-item-wrapper relative bg-black md:bg-transparent';
            postWrapper.dataset.id = post.id;
            postWrapper.dataset.path = path;
            postWrapper.dataset.tags = (post.tags || []).join(',');
            
            const currentUser = auth.currentUser;
            const isOwner = currentUser && currentUser.uid === post.user.id && path !== 'null'; 
            const ownerId = post.user.id || '';
            const prodImg = (post.product && (post.product.imageUrl || post.product.image)) ? (post.product.imageUrl || post.product.image) : null;
            const tagsList = (post.tags || []).map(t => t.startsWith('#') ? t : `#${t}`).join(' ');
            
            let visibilityBadge = '';
            if (post.visibility === 'followers') {
                visibilityBadge = `<span class="bg-blue-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 w-fit mb-1 shadow-sm"><i data-lucide="users" class="w-3 h-3"></i> Followers Only</span>`;
            } else if (post.visibility === 'private') {
                visibilityBadge = `<span class="bg-gray-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 w-fit mb-1 shadow-sm"><i data-lucide="lock" class="w-3 h-3"></i> Private</span>`;
            }

            // Description logic
            const isLongDesc = description.length > 60; 
            let descriptionHtml = '';
            if (isLongDesc) {
                descriptionHtml = `
                    <div class="${textMargin} relative transition-all duration-300 pointer-events-auto">
                        <div id="desc-short-${post.id}" class="flex items-end gap-1">
                            <p class="text-white/90 text-sm drop-shadow-md font-medium line-clamp-1 break-words">${description}</p>
                            <button onclick="document.getElementById('desc-short-${post.id}').classList.add('hidden'); document.getElementById('desc-full-${post.id}').classList.remove('hidden');" class="text-white font-bold text-xs hover:underline bg-black/20 px-1.5 rounded backdrop-blur-sm shadow-sm cursor-pointer whitespace-nowrap">more</button>
                        </div>
                        <div id="desc-full-${post.id}" class="hidden">
                            <p class="text-white/90 text-sm drop-shadow-md font-medium break-words whitespace-pre-wrap max-h-40 overflow-y-auto no-scrollbar animate-fade-in block">${description}</p>
                            <button onclick="document.getElementById('desc-full-${post.id}').classList.add('hidden'); document.getElementById('desc-short-${post.id}').classList.remove('hidden');" class="text-white font-bold text-xs hover:underline mt-1 bg-black/20 px-1.5 rounded backdrop-blur-sm shadow-sm cursor-pointer">less</button>
                        </div>
                    </div>`;
            } else {
                descriptionHtml = `<p class="text-white/90 text-sm drop-shadow-md ${textMargin} font-medium break-words pointer-events-auto">${description}</p>`;
            }
            const tagsHtml = tagsList ? `<div class="font-bold text-white text-sm drop-shadow-md leading-tight mt-1 ${textMargin} pointer-events-auto opacity-90">${tagsList}</div>` : '';

            // --- MEDIA CONTENT GENERATION ---
            let mediaContent = '';
            let slideshowSidebarButtons = ''; 
            
            if (isSlideshow) {
                const images = post.images;
                
                const slidesHtml = `
                    <div id="slide-track-${post.id}" class="flex h-full w-full transition-transform duration-300 ease-out will-change-transform cursor-grab active:cursor-grabbing">
                        ${images.map((src, idx) => `
                            <div class="w-full h-full shrink-0 flex items-center justify-center bg-black">
                                <img src="${src}" class="w-full h-auto max-h-full object-contain pointer-events-none select-none" draggable="false">
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Pagination Dots
                const dotsHtml = images.length > 1 ? `
                    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-1.5 z-20 pointer-events-none" id="dots-${post.id}">
                        ${images.map((_, idx) => `<div class="w-1.5 h-1.5 rounded-full ${idx === 0 ? 'bg-white w-3' : 'bg-white/40'} transition-all shadow-sm" data-index="${idx}"></div>`).join('')}
                    </div>
                ` : '';

                if (images.length > 1) {
                    slideshowSidebarButtons = `
                        <button onclick="event.stopPropagation(); window.prevSlide('${post.id}', ${images.length})" class="hidden md:flex flex-col items-center gap-1 group">
                            <div class="p-2 bg-black/40 backdrop-blur-sm md:bg-app-card rounded-full hover:bg-black/60 md:hover:bg-app-hover transition-all border border-transparent md:border-app-border group-hover:scale-110">
                                <i data-lucide="chevron-left" class="w-6 h-6 text-white md:text-app-text fill-current md:fill-none"></i>
                            </div>
                        </button>
                        <button onclick="event.stopPropagation(); window.nextSlide('${post.id}', ${images.length})" class="hidden md:flex flex-col items-center gap-1 group">
                            <div class="p-2 bg-black/40 backdrop-blur-sm md:bg-app-card rounded-full hover:bg-black/60 md:hover:bg-app-hover transition-all border border-transparent md:border-app-border group-hover:scale-110">
                                <i data-lucide="chevron-right" class="w-6 h-6 text-white md:text-app-text fill-current md:fill-none"></i>
                            </div>
                        </button>
                    `;
                }

                mediaContent = `
                    <div class="relative w-full h-full bg-black md:bg-gray-900 overflow-hidden" id="slideshow-container-${post.id}">
                        ${slidesHtml}
                        ${dotsHtml}
                        <div class="absolute top-4 right-4 bg-black/40 px-2 py-1 rounded-full text-white text-xs font-bold backdrop-blur-md z-20 border border-white/10 pointer-events-none">
                            <span id="slide-counter-${post.id}">1</span>/${images.length}
                        </div>
                    </div>
                `;
            } else {
                mediaContent = `
                    <video data-src="${post.videoUrl}" class="${videoClass} cursor-pointer" loop playsinline poster="${post.thumbnailUrl || ''}" preload="none"></video>
                    <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/90 pointer-events-none"></div>
                    <div class="play-pause-icon absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
                        <i data-lucide="play" class="w-16 h-16 text-white/80 fill-white drop-shadow-xl"></i>
                    </div>
                    <div class="absolute top-16 left-4 md:top-6 md:left-6 z-30 flex items-center gap-1 group/audio transition-all">
                        <button class="audio-toggle-btn bg-black/20 backdrop-blur-md p-2.5 rounded-full text-white hover:bg-black/40 transition-all shadow-sm z-40 flex items-center justify-center border border-white/10">
                            <i data-lucide="volume-2" class="w-5 h-5"></i>
                        </button>
                        <div class="volume-slider-container hidden bg-black/40 backdrop-blur-md rounded-full pl-3 pr-3 py-1.5 h-10 items-center animate-fade-in border border-white/10 ml-1">
                            <input type="range" min="0" max="1" step="0.1" value="1" class="w-20 h-full accent-brand-orange cursor-pointer video-volume-slider" onclick="event.stopPropagation()">
                        </div>
                    </div>
                    <div class="video-progress-container absolute bottom-16 md:bottom-0 left-0 w-full h-5 cursor-pointer z-[70] group/progress flex items-end pb-0 select-none">
                        <div class="video-time-tooltip absolute bottom-8 left-0 -translate-x-1/2 bg-black/80 text-white text-[10px] font-bold px-2 py-1 rounded opacity-0 group-hover/progress:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-[80] shadow-sm border border-white/10 backdrop-blur-md">00:00 / 00:00</div>
                        <div class="w-full h-full flex items-end pb-[2px]">
                            <div class="w-full h-1 bg-white/30 relative group-hover/progress:h-1.5 transition-all duration-200 backdrop-blur-sm rounded-r-lg">
                            <div class="video-progress-bar h-full bg-brand-orange w-0 relative rounded-r-lg">
                                <div class="absolute -right-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-xl scale-0 group-hover/progress:scale-100 transition-transform duration-200 border border-gray-100 cursor-grab active:cursor-grabbing"></div>
                            </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            const innerLayout = document.createElement('div');
            innerLayout.className = `relative w-full h-full md:flex md:flex-row md:items-center md:gap-6 md:w-auto md:h-[96%]`;
            
            innerLayout.innerHTML = `
                <div id="engagement-desktop-${post.id}" class="hidden md:block absolute left-[-100px] bottom-32 w-20 h-80 pointer-events-none z-50"></div>
                
                <!-- MAIN CONTENT CONTAINER -->
                <div class="${mobileContainerClass} ${desktopContainerClass} overflow-hidden shadow-none md:shadow-2xl md:border-4 md:border-app-card md:ring-1 md:ring-app-border group relative">
                    <div id="engagement-mobile-${post.id}" class="md:hidden absolute left-2 top-1/2 -translate-y-1/2 w-20 h-64 pointer-events-none z-50"></div>
                    
                    ${mediaContent}

                    ${isOwner ? `<button onclick="event.stopPropagation(); window.navigateTo('video/${post.id}/edit')" class="absolute top-16 right-4 md:top-6 md:right-6 z-30 bg-black/20 backdrop-blur-md p-2.5 rounded-full text-white hover:bg-brand-teal transition-all shadow-sm opacity-100 md:opacity-0 md:group-hover:opacity-100"><i data-lucide="edit-2" class="w-4 h-4"></i></button>` : ''}

                    <div class="absolute bottom-0 left-0 w-full h-full z-40 flex flex-col justify-end items-start ${overlayPadding} pointer-events-none">
                        <div class="pointer-events-auto pr-14 md:pr-0 w-full ${textMargin} flex-shrink-1 overflow-hidden" style="max-height: 50%;">
                            ${visibilityBadge}
                            <h3 onclick="event.stopPropagation(); window.viewUserProfile('${post.user.id}', '${safeUsername}', '${safeAvatar}')" class="font-bold text-white text-xl drop-shadow-md cursor-pointer hover:underline mb-1">@${username}</h3>
                            ${descriptionHtml}
                            ${tagsHtml}
                        </div>
                        ${post.product ? `
                            <div class="pointer-events-auto ${productCardClass} ${productCardBg} rounded-xl ${productPadding} shadow-xl transform transition-all hover:scale-[1.01] ${productMargin} border border-app-border flex-shrink-0 z-50 relative">
                                <div class="flex items-center justify-between gap-3">
                                    <div class="flex items-center gap-3 overflow-hidden flex-1">
                                        ${prodImg ? `<div class="${productImageSize} bg-gray-100 dark:bg-zinc-800 rounded-lg overflow-hidden shrink-0 border border-app-border"><img src="${prodImg}" class="w-full h-full object-cover"></div>` : ''}
                                        <div class="flex flex-col overflow-hidden justify-center">
                                            <div class="flex items-center gap-1 text-brand-orange text-[10px] font-bold uppercase tracking-wider mb-0.5"><i data-lucide="shopping-bag" class="w-3 h-3"></i><span>Shop</span></div>
                                            <span class="${isLandscape ? 'text-gray-900 dark:text-white' : 'text-app-text'} font-extrabold text-sm truncate leading-tight">${post.product.title}</span>
                                            <span class="text-xs ${isLandscape ? 'text-gray-600 dark:text-gray-400' : 'text-app-textMuted'} font-medium">${post.product.price ? formatCurrency(post.product.price) : 'View details'}</span>
                                        </div>
                                    </div>
                                    <button onclick="window.viewProduct('${post.product.id}', '${ownerId}')" class="bg-brand-orange hover:bg-brand-orangeDark text-white text-xs md:text-sm font-bold px-4 py-2 rounded-lg transition-colors shadow-lg shadow-brand-orange/20 shrink-0 whitespace-nowrap">Buy</button>
                                </div>
                            </div>` : ''}
                    </div>
                </div>

                <!-- SIDEBAR ACTION BUTTONS -->
                <div class="absolute bottom-52 right-2 flex flex-col gap-4 items-center z-30 md:static md:flex md:flex-col md:gap-5 md:justify-center md:h-full md:pb-10">
                    
                    <!-- 2. PFP with Smart Follow Button -->
                    <div class="relative group mb-3 md:mb-4">
                        <!-- Avatar (Click -> Profile) -->
                        <div class="w-12 h-12 md:w-16 md:h-16 rounded-full border-2 border-white md:border-brand-orange p-0.5 overflow-hidden transition-transform hover:scale-105 shadow-md bg-black/50 md:bg-app-card cursor-pointer" onclick="event.stopPropagation(); window.viewUserProfile('${post.user.id}', '${safeUsername}', '${safeAvatar}')">
                            <img src="${avatarUrl}" class="w-full h-full rounded-full object-cover">
                        </div>
                        
                        <!-- Plus Badge (Click -> Follow) -->
                        ${showFollowBtn ? `
                        <div onclick="window.handleFollowFromFeed(this, '${post.user.id}')" class="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-brand-orange text-white w-5 h-5 md:w-6 md:h-6 rounded-full flex items-center justify-center border-2 border-white shadow-sm cursor-pointer hover:scale-110 transition-transform z-20">
                            <i data-lucide="plus" class="w-3 h-3 md:w-4 md:h-4"></i>
                        </div>
                        ` : ''}
                    </div>
                    
                    <button class="flex flex-col items-center gap-1 group like-btn" onclick="window.toggleLike(this, '${post.id}')">
                        <div class="p-2 bg-black/40 backdrop-blur-sm md:bg-app-card rounded-full hover:bg-black/60 md:hover:bg-app-hover transition-all border border-transparent md:border-app-border icon-container group-hover:scale-110"><i data-lucide="heart" class="w-6 h-6 text-white md:text-app-text group-hover:text-brand-orange transition-colors fill-current md:fill-none"></i></div>
                        <span class="text-xs font-bold text-white md:text-app-textMuted drop-shadow-md md:drop-shadow-none">${formatNumber(post.likes || 0)}</span>
                    </button>
                    
                    <button class="flex flex-col items-center gap-1 group" onclick="window.openComments('${post.id}', '${path}', '${post.user.id}')">
                        <div class="p-2 bg-black/40 backdrop-blur-sm md:bg-app-card rounded-full hover:bg-black/60 md:hover:bg-app-hover transition-all border border-transparent md:border-app-border group-hover:scale-110"><i data-lucide="message-circle" class="w-6 h-6 text-white md:text-app-text fill-current md:fill-none"></i></div>
                        <span class="text-xs font-bold text-white md:text-app-textMuted drop-shadow-md md:drop-shadow-none comment-count-${post.id}">${formatNumber(post.comments)}</span>
                    </button>
                    
                    <button class="flex flex-col items-center gap-1 group" onclick="window.openShareModal(event, '${post.id}', '${path}', '${post.videoUrl}', '${post.user.id}', '${safeTitle}', '${safeDesc}', '${safeTags}', '${safeUsername}')">
                        <div class="p-2 bg-black/40 backdrop-blur-sm md:bg-app-card rounded-full hover:bg-black/60 md:hover:bg-app-hover transition-all border border-transparent md:border-app-border group-hover:scale-110"><i data-lucide="share-2" class="w-6 h-6 text-white md:text-app-text fill-current md:fill-none"></i></div>
                        <span class="text-xs font-bold text-white md:text-app-textMuted drop-shadow-md md:drop-shadow-none share-count-${post.id}">${formatNumber(post.shares)}</span>
                    </button>

                    <!-- INJECTED SLIDESHOW ARROWS (Hidden on Mobile) -->
                    ${slideshowSidebarButtons}
                </div>
            `;
            postWrapper.appendChild(innerLayout);

            // --- SLIDESHOW SPECIFIC: MOBILE SWIPE (Kept from previous steps) ---
            if (isSlideshow && post.images.length > 1) {
                const sliderContainer = innerLayout.querySelector(`#slideshow-container-${post.id}`);
                const track = innerLayout.querySelector(`#slide-track-${post.id}`);
                let startX = 0; let startY = 0; let isDragging = false; let isHorizontal = false;

                sliderContainer.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX; startY = e.touches[0].clientY; isDragging = true; isHorizontal = false;
                    if (track) { track.style.transition = 'none'; void track.offsetWidth; }
                }, { passive: false });

                sliderContainer.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    const x = e.touches[0].clientX; const y = e.touches[0].clientY;
                    const deltaX = x - startX; const deltaY = y - startY;
                    if (!isHorizontal) {
                        if (Math.abs(deltaY) > Math.abs(deltaX)) { isDragging = false; return; }
                        if (Math.abs(deltaX) > 10) { isHorizontal = true; }
                    }
                    if (isHorizontal) {
                        if (e.cancelable) e.preventDefault(); e.stopPropagation();
                        const currentIndex = window.activeSlides[post.id] || 0;
                        const width = sliderContainer.clientWidth;
                        const percentDelta = (deltaX / width) * 100;
                        const baseTranslate = -(currentIndex * 100);
                        let newTranslate = baseTranslate + percentDelta;
                        const totalSlides = post.images.length;
                        if ((currentIndex === 0 && deltaX > 0) || (currentIndex === totalSlides - 1 && deltaX < 0)) {
                            newTranslate = baseTranslate + (percentDelta * 0.3);
                        }
                        if (track) track.style.transform = `translateX(${newTranslate}%)`;
                    }
                }, { passive: false });

                sliderContainer.addEventListener('touchend', (e) => {
                    if (!isDragging || !isHorizontal) { isDragging = false; return; }
                    isDragging = false;
                    const touchEndX = e.changedTouches[0].clientX;
                    const deltaX = touchEndX - startX;
                    const currentIndex = window.activeSlides[post.id] || 0;
                    const totalSlides = post.images.length;
                    if (track) track.style.transition = 'transform 0.3s cubic-bezier(0.25, 1, 0.5, 1)';
                    let nextIndex = currentIndex;
                    if (Math.abs(deltaX) > 50) {
                        if (deltaX > 0) nextIndex = Math.max(0, currentIndex - 1);
                        else nextIndex = Math.min(totalSlides - 1, currentIndex + 1);
                    }
                    window.activeSlides[post.id] = nextIndex;
                    window.updateSlideUI(post.id, nextIndex, totalSlides);
                });
            }

            // Video Listeners
            if (!isSlideshow) {
                const video = innerLayout.querySelector('video');
                const overlay = innerLayout.querySelector('.play-pause-icon');
                const audioBtn = innerLayout.querySelector('.audio-toggle-btn');
                const sliderContainer = innerLayout.querySelector('.volume-slider-container');
                const volumeSlider = innerLayout.querySelector('.video-volume-slider');
                const icon = audioBtn.querySelector('i');
                const progressContainer = innerLayout.querySelector('.video-progress-container');
                const progressBar = innerLayout.querySelector('.video-progress-bar');
                const tooltip = innerLayout.querySelector('.video-time-tooltip');

                video.volume = 1; video.muted = false;

                if (progressContainer) {
                    let isDragging = false; let wasPaused = false;
                    const updateProgress = (clientX) => {
                        const rect = progressContainer.getBoundingClientRect();
                        const pos = (clientX - rect.left) / rect.width;
                        const clampedPos = Math.max(0, Math.min(1, pos));
                        const duration = video.duration || 0;
                        const currentTime = clampedPos * duration;
                        progressBar.style.width = `${clampedPos * 100}%`;
                        tooltip.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                        tooltip.style.left = `${clampedPos * 100}%`;
                        return currentTime;
                    };
                    const onDrag = (e) => { if (isDragging) { e.preventDefault(); video.currentTime = updateProgress(e.clientX); }};
                    const stopDrag = (e) => { if (isDragging) { isDragging = false; if (!wasPaused) video.play(); tooltip.classList.remove('opacity-100'); tooltip.classList.add('group-hover/progress:opacity-100'); document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); }};
                    progressContainer.addEventListener('mousedown', (e) => { e.stopPropagation(); isDragging = true; wasPaused = video.paused; video.pause(); video.currentTime = updateProgress(e.clientX); tooltip.classList.remove('group-hover/progress:opacity-100'); tooltip.classList.add('opacity-100'); document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', stopDrag); });
                    progressContainer.addEventListener('mousemove', (e) => { if (!isDragging) { const rect = progressContainer.getBoundingClientRect(); const pos = (e.clientX - rect.left) / rect.width; const clampedPos = Math.max(0, Math.min(1, pos)); const duration = video.duration || 0; tooltip.textContent = `${formatTime(clampedPos * duration)} / ${formatTime(duration)}`; tooltip.style.left = `${clampedPos * 100}%`; }});
                    video.addEventListener('timeupdate', () => { if (!isDragging && video.duration) { const pct = (video.currentTime / video.duration) * 100; progressBar.style.width = `${pct}%`; }});
                }

                if (audioBtn) {
                    audioBtn.addEventListener('click', (e) => { e.stopPropagation(); sliderContainer.classList.toggle('hidden'); sliderContainer.classList.toggle('flex'); });
                }
                if (volumeSlider) {
                    volumeSlider.addEventListener('input', (e) => { e.stopPropagation(); const val = parseFloat(e.target.value); video.volume = val; video.muted = (val === 0); if(val === 0) { icon.setAttribute('data-lucide', 'volume-x'); audioBtn.classList.add('bg-black/20'); audioBtn.classList.remove('bg-white/20'); } else { icon.setAttribute('data-lucide', 'volume-2'); audioBtn.classList.add('bg-white/20'); audioBtn.classList.remove('bg-black/20'); } if(window.lucide) window.lucide.createIcons(); });
                    volumeSlider.addEventListener('click', (e) => e.stopPropagation());
                }
                video.addEventListener('click', (e) => { e.stopPropagation(); if(video.paused) { document.querySelectorAll('video').forEach(v => { if(v!==video) v.pause(); }); video.play().catch(()=>{}); } else { video.pause(); } });
                video.addEventListener('play', () => { overlay.classList.remove('opacity-100'); overlay.classList.add('opacity-0'); });
                video.addEventListener('pause', () => { overlay.classList.remove('opacity-0'); overlay.classList.add('opacity-100'); if(window.lucide) window.lucide.createIcons(); });
            }

            const likeBtn = innerLayout.querySelector('.like-btn');
            if (typeof checkLikeStatus === 'function') checkLikeStatus(path, likeBtn);
            return postWrapper;
        };
        
        window.handleFollowFromFeed = async (btn, targetId) => {
            if (event) event.stopPropagation();
            if (!window.auth.currentUser) { window.toggleAuthModal(true); return; }
            
            // 1. Immediate UI Feedback (Optimistic)
            btn.classList.remove('bg-brand-orange', 'text-white');
            btn.classList.add('bg-green-500', 'text-white', 'scale-110');
            btn.innerHTML = `<i data-lucide="check" class="w-3 h-3 md:w-4 md:h-4"></i>`;
            if(window.lucide) window.lucide.createIcons();

            // 2. Perform Logic
            try {
                // Dynamically import Firestore helpers if needed, 
                // assuming this runs in the context where db, doc, writeBatch, etc. are available.
                // If not available on window, ensure this function is placed inside the module script.
                
                const currentUser = window.auth.currentUser;
                const batch = writeBatch(db); // Assumes 'db' and 'writeBatch' are in scope
                
                const meRef = doc(db, 'users', currentUser.uid);
                const themRef = doc(db, 'users', targetId);
                const followingRef = doc(db, 'users', currentUser.uid, 'following', targetId);
                const followerRef = doc(db, 'users', targetId, 'followers', currentUser.uid);

                batch.set(followingRef, { timestamp: serverTimestamp() });
                batch.set(followerRef, { timestamp: serverTimestamp() });
                batch.set(meRef, { stats: { following: increment(1) } }, { merge: true });
                batch.set(themRef, { stats: { followers: increment(1) } }, { merge: true });
                
                // Add to local set so it updates other views immediately
                if(window.myFollowing) window.myFollowing.add(targetId);

                // Notification
                const notifRef = doc(collection(db, 'users', targetId, 'notifications'));
                batch.set(notifRef, { 
                    type: 'follow', 
                    fromUserId: currentUser.uid, 
                    fromUsername: currentUser.displayName, 
                    fromUserAvatar: currentUser.photoURL, 
                    read: false, 
                    timestamp: serverTimestamp() 
                });

                await batch.commit();

                // 3. Animation Completion (Hide button)
                setTimeout(() => {
                    btn.style.transition = 'all 0.3s ease';
                    btn.classList.add('opacity-0', 'scale-0');
                    setTimeout(() => btn.remove(), 300);
                }, 1000);

            } catch (e) {
                console.error("Follow from feed failed", e);
                window.showToast("Action failed", "error");
                // Revert UI
                btn.classList.add('bg-brand-orange');
                btn.classList.remove('bg-green-500', 'scale-110');
                btn.innerHTML = `<i data-lucide="plus" class="w-3 h-3 md:w-4 md:h-4"></i>`;
                if(window.lucide) window.lucide.createIcons();
            }
        };

        window.activeSlides = {}; 
        window.updateSlideUI = (postId, index, total) => {
            // 1. Slide the Track
            const track = document.getElementById(`slide-track-${postId}`);
            if (track) {
                // Move track left by index * 100%
                track.style.transform = `translateX(-${index * 100}%)`;
            }

            // 2. Update Pagination Dots
            const dotsContainer = document.getElementById(`dots-${postId}`);
            if (dotsContainer) {
                Array.from(dotsContainer.children).forEach((dot, idx) => {
                    if (idx === index) {
                        dot.classList.remove('bg-white/40');
                        dot.classList.add('bg-white', 'w-3'); // Optional: make active dot slightly wider
                    } else {
                        dot.classList.add('bg-white/40');
                        dot.classList.remove('bg-white', 'w-3');
                    }
                });
            }

            // 3. Update Counter
            const counter = document.getElementById(`slide-counter-${postId}`);
            if(counter) counter.innerText = (index + 1);
        };

        window.nextSlide = (postId, total) => {
            if(!window.activeSlides[postId]) window.activeSlides[postId] = 0;
            const current = window.activeSlides[postId];
            const next = (current + 1) % total;
            window.activeSlides[postId] = next;
            window.updateSlideUI(postId, next, total);
        };

        window.prevSlide = (postId, total) => {
            if(!window.activeSlides[postId]) window.activeSlides[postId] = 0;
            const current = window.activeSlides[postId];
            const prev = (current - 1 + total) % total;
            window.activeSlides[postId] = prev;
            window.updateSlideUI(postId, prev, total);
        };

        window.loadEditVideoPage = async (videoId) => {
            const container = document.getElementById('edit-video-page-container');
            const form = document.getElementById('edit-video-page-form');
            
            // Reset UI
            form.reset();
            document.getElementById('edit-page-video-preview').src = '';
            
            const user = auth.currentUser;
            if (!user) { window.navigateTo('feed'); return; }

            try {
                // Fetch from User's collection (as they are the owner)
                const docRef = doc(db, 'users', user.uid, 'videos', videoId);
                const snap = await getDoc(docRef);

                if (!snap.exists()) {
                    window.showToast("Video not found", "error");
                    window.history.back();
                    return;
                }

                const data = snap.data();
                
                // Populate Fields
                document.getElementById('edit-page-video-id').value = videoId;
                document.getElementById('edit-page-video-path').value = `users/${user.uid}/videos/${videoId}`;
                document.getElementById('edit-page-title').value = data.title || '';
                document.getElementById('edit-page-desc').value = data.description || '';
                document.getElementById('edit-page-tags').value = (data.tags || []).join(', ');
                
                // NEW: Populate Storage Path for Deletion
                document.getElementById('edit-page-storage-path').value = data.filePath || '';
                
                // Preview
                const vidPreview = document.getElementById('edit-page-video-preview');
                vidPreview.src = data.videoUrl;
                vidPreview.load();

                // Aspect Ratio Preview Adjustment
                const previewContainer = document.getElementById('edit-page-preview-container');
                if (data.aspectRatio === 'landscape') {
                    previewContainer.classList.remove('w-[320px]', 'aspect-[9/16]');
                    previewContainer.classList.add('w-full', 'aspect-video');
                } else {
                    previewContainer.classList.add('w-[320px]', 'aspect-[9/16]');
                    previewContainer.classList.remove('w-full', 'aspect-video');
                }

                // Visibility Radio
                const visibility = data.visibility || 'public';
                const vRadio = document.querySelector(`input[name="edit_visibility"][value="${visibility}"]`);
                if (vRadio) vRadio.checked = true;

                // NEW: Comment Settings Radio
                const commentMode = data.commentMode || 'allow';
                const cRadio = document.querySelector(`input[name="edit_comments"][value="${commentMode}"]`);
                if (cRadio) cRadio.checked = true;

            } catch (e) {
                console.error("Load edit failed", e);
                window.showToast("Error loading video", "error");
            }
        };

        window.handleSaveEditVideo = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-video-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Saving...`;

            try {
                const videoId = document.getElementById('edit-page-video-id').value;
                const userPath = document.getElementById('edit-page-video-path').value;
                
                const title = document.getElementById('edit-page-title').value.trim();
                const desc = document.getElementById('edit-page-desc').value.trim();
                const tagsStr = document.getElementById('edit-page-tags').value.trim();
                const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
                
                // Handle Visibility
                const visibilityEl = document.querySelector('input[name="edit_visibility"]:checked');
                const visibility = visibilityEl ? visibilityEl.value : 'public';

                // NEW: Handle Comment Mode
                const commentEl = document.querySelector('input[name="edit_comments"]:checked');
                const commentMode = commentEl ? commentEl.value : 'allow';

                const updates = {
                    title: title,
                    description: desc,
                    tags: tags,
                    visibility: visibility,
                    commentMode: commentMode,
                    updatedAt: serverTimestamp()
                };

                const batch = writeBatch(db);

                // 1. Update User Subcollection Copy
                const userRef = doc(db, userPath);
                batch.set(userRef, updates, { merge: true });

                // 2. Update Root Collection Copy (The Feed Source)
                const rootRef = doc(db, 'videos', videoId);
                batch.set(rootRef, updates, { merge: true });

                await batch.commit();

                window.showToast("Video updated successfully", "success");
                
                // Update Feed UI if present in DOM
                if (window.setupFeedListener) window.setupFeedListener(); 

                // Navigate back
                window.history.back();

            } catch (e) {
                console.error("Save edit failed", e);
                if (e.code === 'not-found') {
                    window.showToast("Error: Document not found.", "error");
                } else {
                    window.showToast("Failed to save changes. " + e.message, "error");
                }
            } finally {
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
                if(window.lucide) window.lucide.createIcons();
            }
        };

        window.handleDeleteVideoFromEditPage = () => {
            const videoId = document.getElementById('edit-page-video-id').value;
            const userPath = document.getElementById('edit-page-video-path').value;
            const storagePath = document.getElementById('edit-page-storage-path').value;

            window.openConfirmModal(
                'Delete Video', 
                'Are you sure you want to delete this video? This action cannot be undone.', 
                async () => {
                    const btn = document.querySelector('button[onclick="window.handleDeleteVideoFromEditPage()"]');
                    if(btn) { btn.innerHTML = 'Deleting...'; btn.disabled = true; }

                    try {
                        // 1. Delete User Doc
                        await deleteDoc(doc(db, userPath));
                        
                        // 2. Delete Root Doc
                        await deleteDoc(doc(db, 'videos', videoId));

                        // 3. Delete Storage File
                        if (storagePath) { 
                            const fileRef = ref(storage, storagePath); 
                            await deleteObject(fileRef).catch(e => console.warn("Storage delete failed", e)); 
                        }

                        window.showToast("Video deleted.", "success");
                        
                        // Redirect to profile
                        window.viewMyProfile();

                    } catch(e) { 
                        console.error("Delete failed", e); 
                        window.showToast("Could not delete video. " + e.message, "error"); 
                        if(btn) { btn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i> Delete'; btn.disabled = false; window.lucide.createIcons(); }
                    }
                }
            );
        };

        window.toggleEditPageShippingInput = () => {
                const radios = document.getElementsByName('edit_page_shipping_cost_type');
                let selected = 'free';
                for(let r of radios) { if(r.checked) selected = r.value; }
                const container = document.getElementById('edit-page-shipping-cost-container');
                const input = document.getElementById('edit-page-prod-shipping-cost');
                
                if(selected === 'paid') {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                    if(input) input.value = '';
                }
                window.updateEditPagePayout();
        };

        window.updateEditPagePayout = () => {
                const priceInput = document.getElementById('edit-page-prod-price');
                const shippingInput = document.getElementById('edit-page-prod-shipping-cost');
                
                // Elements
                const displayPrice = document.getElementById('edit-page-calc-price');
                const displayShipping = document.getElementById('edit-page-calc-shipping');
                const feeEl = document.getElementById('edit-page-calc-fee');
                const payoutEl = document.getElementById('edit-page-calc-payout');
                const totalEl = document.getElementById('edit-page-calc-total');
                
                const price = parseFloat(priceInput.value) || 0;
                
                // Shipping Logic
                let shippingCost = 0;
                const shippingTypeRadios = document.getElementsByName('edit_page_shipping_cost_type');
                let shippingType = 'free';
                for(let r of shippingTypeRadios) { if(r.checked) shippingType = r.value; }
                if (shippingType === 'paid') {
                    shippingCost = parseFloat(shippingInput.value) || 0;
                }

                const fee = price * 0.10;
                const payout = (price * 0.90) + shippingCost;
                const total = price + shippingCost;
                
                if(displayPrice) displayPrice.textContent = `$${price.toFixed(2)}`;
                if(displayShipping) displayShipping.textContent = `$${shippingCost.toFixed(2)}`;
                feeEl.textContent = `-$${fee.toFixed(2)}`;
                payoutEl.textContent = `$${payout.toFixed(2)}`;
                if(totalEl) totalEl.textContent = `$${total.toFixed(2)}`;
        };

        window.loadEditProductPage = async (productId) => {
            const user = auth.currentUser;
            if (!user) { window.navigateTo('feed'); return; }

            const form = document.getElementById('edit-product-page-form');
            form.reset();
            
            if (!window.selectedCategories['edit-page']) window.selectedCategories['edit-page'] = new Set();
            window.selectedCategories['edit-page'].clear();
            window.renderCategoryChips('edit-page');

            try {
                const docRef = doc(db, 'users', user.uid, 'products', productId);
                const snap = await getDoc(docRef);

                if (!snap.exists()) {
                    window.showToast("Product not found", "error");
                    window.history.back();
                    return;
                }

                const data = snap.data();
                
                document.getElementById('edit-page-prod-id').value = productId;
                document.getElementById('edit-page-prod-title').value = data.title || '';
                document.getElementById('edit-page-prod-desc').value = data.description || '';
                document.getElementById('edit-page-prod-brand').value = data.brand || '';
                document.getElementById('edit-page-prod-condition').value = data.condition || 'New';
                document.getElementById('edit-page-prod-stock').value = data.stock || 1;
                document.getElementById('edit-page-prod-price').value = data.price || 0;
                document.getElementById('edit-page-prod-tags').value = (data.tags || []).join(', ');
                document.getElementById('edit-page-prod-shipping').value = data.shippingMethod || 'Standard';

                // Handle Categories
                if (data.categories && Array.isArray(data.categories)) {
                    data.categories.forEach(c => window.selectedCategories['edit-page'].add(c));
                } else if (data.category) {
                    window.selectedCategories['edit-page'].add(data.category);
                }
                window.renderCategoryChips('edit-page');

                // Handle Shipping Cost Logic
                const shippingCost = data.shippingCost || 0;
                const radios = document.getElementsByName('edit_page_shipping_cost_type');
                const costInput = document.getElementById('edit-page-prod-shipping-cost');
                const costContainer = document.getElementById('edit-page-shipping-cost-container');

                if (shippingCost > 0) {
                        // Paid
                        radios.forEach(r => { if(r.value === 'paid') r.checked = true; });
                        costContainer.classList.remove('hidden');
                        costInput.value = shippingCost;
                } else {
                        // Free
                        radios.forEach(r => { if(r.value === 'free') r.checked = true; });
                        costContainer.classList.add('hidden');
                        costInput.value = '';
                }

                // Trigger Calculation to update UI text
                window.updateEditPagePayout();

            } catch (e) {
                console.error("Load product edit failed", e);
                window.showToast("Error loading product", "error");
            }
        };

        window.handleSaveEditProductPage = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-product-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Saving...`;

            try {
                const user = auth.currentUser;
                const pid = document.getElementById('edit-page-prod-id').value;
                
                const title = document.getElementById('edit-page-prod-title').value.trim();
                const desc = document.getElementById('edit-page-prod-desc').value.trim();
                const brand = document.getElementById('edit-page-prod-brand').value.trim();
                const condition = document.getElementById('edit-page-prod-condition').value;
                const stock = parseInt(document.getElementById('edit-page-prod-stock').value) || 0;
                const price = parseFloat(document.getElementById('edit-page-prod-price').value) || 0;
                const tagsStr = document.getElementById('edit-page-prod-tags').value.trim();
                const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
                const shippingMethod = document.getElementById('edit-page-prod-shipping').value;

                const categories = Array.from(window.selectedCategories['edit-page']);
                const primaryCategory = categories.length > 0 ? categories[0] : 'Other';

                // Calculate Shipping Cost based on Radio
                let shippingCost = 0;
                const shippingTypeRadios = document.getElementsByName('edit_page_shipping_cost_type');
                let shippingType = 'free';
                for(let r of shippingTypeRadios) { if(r.checked) shippingType = r.value; }
                
                if (shippingType === 'paid') {
                        const rawCost = parseFloat(document.getElementById('edit-page-prod-shipping-cost').value);
                        if (isNaN(rawCost) || rawCost < 0) { throw new Error("Invalid shipping cost"); }
                        shippingCost = rawCost;
                }

                if (!title || price <= 0) { throw new Error("Title and valid Price are required."); }

                // Calculate Metadata
                const platformFee = price * 0.10;
                const sellerPayout = (price * 0.90) + shippingCost;

                await updateDoc(doc(db, 'users', user.uid, 'products', pid), {
                    title: title,
                    description: desc,
                    brand: brand,
                    condition: condition,
                    stock: stock,
                    price: price,
                    shippingMethod: shippingMethod,
                    shippingCost: shippingCost,
                    tags: tags,
                    categories: categories,
                    category: primaryCategory,
                    platformFee: platformFee,
                    sellerPayout: sellerPayout,
                    updatedAt: serverTimestamp()
                });

                window.showToast("Product updated successfully", "success");
                
                // Navigate back to product view
                window.viewProduct(pid, user.uid);

            } catch (e) {
                console.error("Save product failed", e);
                window.showToast("Failed to save: " + e.message, "error");
            } finally {
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
                if(window.lucide) window.lucide.createIcons();
            }
        };

        window.handleDeleteProductFromEditPage = () => {
            const pid = document.getElementById('edit-page-prod-id').value;
            const user = auth.currentUser;
            
            window.openConfirmModal(
                'Delete Product', 
                'Are you sure? This cannot be undone.', 
                async () => {
                    try {
                        await deleteDoc(doc(db, 'users', user.uid, 'products', pid));
                        window.showToast("Product deleted.", "success");
                        window.viewMyProfile();
                    } catch(e) { 
                        console.error("Delete failed", e); 
                        window.showToast("Delete failed", "error"); 
                    }
                }
            );
        };

        window.setupFeedListener = async () => {
            if (window.unsubscribeFeed) window.unsubscribeFeed();
            
            const container = document.getElementById('feed-container');
            container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-app-textMuted gap-4"><i data-lucide="loader-2" class="w-8 h-8 animate-spin"></i><p>Curating your feed...</p></div>';
            if(window.lucide) window.lucide.createIcons();

            try {
                let rawVideos = [];
                const seenIds = new Set();

                // 1. Algorithm
                try {
                    console.log("[Feed] 1. Trying Algorithm...");
                    const result = await getForYouFeedFn();
                    const rankedItems = result.data; 
                    if (rankedItems && rankedItems.length > 0) {
                        const videoPromises = rankedItems.map(item => getDoc(doc(db, 'videos', item.id)));
                        const videoSnaps = await Promise.all(videoPromises);
                        videoSnaps.forEach(snap => {
                            if (snap.exists() && !seenIds.has(snap.id)) {
                                rawVideos.push({ id: snap.id, ...snap.data(), path: snap.ref.path });
                                seenIds.add(snap.id);
                            }
                        });
                    }
                } catch (algoError) { console.warn("[Feed] Algo skipped:", algoError.message); }

                // 2. Fallback Root
                if (rawVideos.length < 5) {
                    try {
                        const q = query(collection(db, "videos"), orderBy("createdAt", "desc"), limit(10));
                        const snapshot = await getDocs(q);
                        snapshot.forEach(docSnap => {
                            if (!seenIds.has(docSnap.id)) {
                                rawVideos.push({ id: docSnap.id, ...docSnap.data(), path: docSnap.ref.path });
                                seenIds.add(docSnap.id);
                            }
                        });
                    } catch(e) {}
                }

                // 3. Fallback Global
                if (rawVideos.length < 5) {
                    try {
                        const q = query(collectionGroup(db, "videos"), limit(20)); 
                        const snapshot = await getDocs(q);
                        snapshot.forEach(docSnap => {
                            if (!seenIds.has(docSnap.id)) {
                                const data = docSnap.data();
                                if (data.videoUrl) {
                                    rawVideos.push({ id: docSnap.id, ...data, path: docSnap.ref.path });
                                    seenIds.add(docSnap.id);
                                }
                            }
                        });
                    } catch(e) {}
                }

                // 4. Ranking
                if (rawVideos.length > 0) {
                    rawVideos.sort((a, b) => {
                        const scoreA = (a.likes || 0) + ((a.views || 0) * 0.1);
                        const scoreB = (b.likes || 0) + ((b.views || 0) * 0.1);
                        return scoreB - scoreA;
                    });
                } else {
                    console.log("[Feed] Database empty. Using Demo Data.");
                    rawVideos = window.FEED_DATA || [];
                }

                if (rawVideos.length === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-app-textMuted text-center p-6"><div class="w-16 h-16 bg-app-card rounded-full flex items-center justify-center mb-4"><i data-lucide="video-off" class="w-8 h-8 opacity-50"></i></div><h3 class="font-bold text-lg text-app-text">No videos yet</h3><p class="text-sm mb-6 max-w-xs">Be the first to upload a video!</p><button onclick="window.navigateTo('upload')" class="bg-brand-orange text-white px-6 py-3 rounded-xl font-bold hover:scale-105 transition-transform">Create Content</button></div>`;
                    if(window.lucide) window.lucide.createIcons();
                    return;
                }

                // 5. HYDRATION (Users & Products)
                const uniqueUserIds = [...new Set(rawVideos.map(v => v.creatorId || (v.user ? v.user.id : null)).filter(id => id))];
                const userMap = {};
                
                // Fetch Users
                await Promise.all(uniqueUserIds.map(async (uid) => {
                    try {
                        const uSnap = await getDoc(doc(db, 'users', uid));
                        if (uSnap.exists()) {
                            const uData = uSnap.data();
                            const uName = uData.profile?.username || 'User';
                            userMap[uid] = { 
                                id: uid, 
                                username: uName, 
                                avatarUrl: window.getAvatar(uData.profile?.photoUrl, uName)
                            };
                        }
                    } catch (e) {}
                }));

                // FIX: Fetch Missing Products on-the-fly
                // This fixes the issue where landscape videos uploaded previously might have missed the product snapshot
                const missingProductVideos = rawVideos.filter(v => !v.product && v.productId && (v.creatorId || (v.user && v.user.id)));
                const productMap = {};

                if (missingProductVideos.length > 0) {
                    console.log(`[Feed] Hydrating ${missingProductVideos.length} missing products from IDs...`);
                    await Promise.all(missingProductVideos.map(async (v) => {
                        const uid = v.creatorId || (v.user ? v.user.id : null);
                        const pid = v.productId;
                        if(!uid || !pid) return;
                        
                        try {
                            const pSnap = await getDoc(doc(db, 'users', uid, 'products', pid));
                            if (pSnap.exists()) {
                                const p = pSnap.data();
                                productMap[pid] = {
                                    id: pSnap.id,
                                    title: p.title,
                                    price: p.price,
                                    imageUrl: (p.images && p.images[0]) ? p.images[0] : null,
                                    image: (p.images && p.images[0]) ? p.images[0] : null
                                };
                            }
                        } catch(e) { console.warn("Product hydration failed", e); }
                    }));
                }

                const finalVideos = rawVideos.map(v => {
                    // User Hydration
                    let userObj = v.user;
                    if (!userObj && v.creatorId) userObj = userMap[v.creatorId];
                    if (!userObj) {
                        userObj = { id: 'unknown', username: 'Jace User', avatarUrl: window.getAvatar(null, 'Jace User') };
                    }
                    
                    // Product Hydration Check
                    let prodObj = v.product;
                    if (!prodObj && v.productId && productMap[v.productId]) {
                        prodObj = productMap[v.productId];
                    }

                    return { ...v, user: userObj, product: prodObj };
                });

                // 6. Render
                const myUid = auth.currentUser ? auth.currentUser.uid : null;
                
                const filteredVideos = finalVideos.filter(video => {
                    // 1. Owner always sees their own videos
                    if (myUid && video.user && video.user.id === myUid) return true;
                    
                    // 2. Private: Only owner sees (already handled above)
                    if (video.visibility === 'private') return false;
                    
                    // 3. Followers: Only followers see
                    if (video.visibility === 'followers') {
                        // Check if I am following the creator
                        // window.myFollowing is a Set populated in onAuthStateChanged
                        if (window.myFollowing && window.myFollowing.has(video.user.id)) {
                            return true;
                        }
                        return false;
                    }
                    
                    // 4. Public (Default)
                    return true;
                });

                // 6. Render
                container.innerHTML = '';
                if (filteredVideos.length === 0) {
                     container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-app-textMuted text-center p-6"><i data-lucide="filter" class="w-12 h-12 opacity-50 mb-2"></i><p>No videos available for you right now.</p></div>';
                }
                
                filteredVideos.forEach(post => {
                    const postEl = window.createVideoPost(post);
                    container.appendChild(postEl);
                    if(window.attachInteractionLogger) window.attachInteractionLogger(postEl, post.id);
                });

                // 7. ATTACH SMART OBSERVERS
                window.initSmartObservers();

                if(window.lucide) window.lucide.createIcons();

            } catch (error) {
                console.error("[Feed] Critical Failure:", error);
                container.innerHTML = '<div class="text-center text-red-500 py-20">Failed to load feed. Check console.</div>';
            }
        };

        window.initSmartObservers = () => {
            // Cleanup old observers if they exist in global scope
            if (window.feedPlaybackObserver) window.feedPlaybackObserver.disconnect();
            if (window.feedBufferObserver) window.feedBufferObserver.disconnect();

            const feedContainer = document.getElementById('feed-container');

            // A. PLAYBACK OBSERVER (Handles Play/Pause strictness)
            // Threshold 0.7 means video must be 70% visible to play
            window.feedPlaybackObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target.querySelector('video');
                    if (!video) return;
                    
                    const videoId = entry.target.dataset.id;
                    const videoPath = entry.target.dataset.path;
                    const desktopId = `engagement-desktop-${videoId}`;
                    const mobileId = `engagement-mobile-${videoId}`;

                    if (entry.isIntersecting) {
                        // STOP ALL OTHER VIDEOS IMMEDIATELY
                        // This prevents background audio overlap
                        document.querySelectorAll('video').forEach(v => {
                            if (v !== video && !v.paused) {
                                v.pause();
                                v.currentTime = 0; // Reset others to start
                            }
                        });

                        // Ensure src is set (in case buffer observer missed it due to fast scroll)
                        if (!video.src && video.dataset.src) {
                            video.src = video.dataset.src;
                            video.load();
                        }

                        // Play
                        const playPromise = video.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => console.log('Auto-play blocked:', error));
                        }

                        // Analytics & Engagement Animations
                        if (typeof onVideoStart === 'function') onVideoStart({ id: videoId, tags: (entry.target.dataset.tags || '').split(',') });
                        if (typeof window.startEngagementBubbles === 'function') {
                            window.startEngagementBubbles(desktopId, videoPath);
                            window.startEngagementBubbles(mobileId, videoPath);
                        }
                        if (typeof window.incrementViewCount === 'function' && !viewedVideos.has(videoId)) {
                            viewedVideos.add(videoId);
                            window.incrementViewCount(videoId, videoPath);
                        }

                    } else {
                        // Pause Immediately
                        video.pause();
                        
                        // Analytics Cleanup
                        if (entry.target.onVideoHidden) entry.target.onVideoHidden();
                        if (typeof onVideoEnd === 'function') onVideoEnd();
                        if (typeof window.stopEngagementBubbles === 'function') {
                            window.stopEngagementBubbles(desktopId);
                            window.stopEngagementBubbles(mobileId);
                        }
                    }
                });
            }, { 
                root: feedContainer, 
                threshold: 0.7 // Strict visibility
            });

            // B. BUFFER OBSERVER (Handles Memory Management)
            // rootMargin '200px' detects videos just outside viewport
            window.feedBufferObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target.querySelector('video');
                    if (!video) return;

                    if (entry.isIntersecting) {
                        // LOAD: Entering buffer zone
                        if (!video.src && video.dataset.src) {
                            // console.log('Preloading:', video.dataset.src);
                            video.src = video.dataset.src;
                            video.load(); // Prepare buffer
                        }
                    } else {
                        // UNLOAD: Leaving buffer zone (Far away)
                        // This prevents "overload or lag" by freeing memory
                        if (video.src) {
                            // console.log('Unloading:', video.dataset.src);
                            video.pause();
                            video.removeAttribute('src'); 
                            video.load(); // Triggers browser to release media resources
                        }
                    }
                });
            }, { 
                root: feedContainer, 
                rootMargin: '200px 0px 200px 0px' 
            });

            // Attach to all video wrappers
            document.querySelectorAll('.video-item-wrapper').forEach(item => {
                window.feedPlaybackObserver.observe(item);
                window.feedBufferObserver.observe(item);
            });
        };

        window.attachInteractionLogger = (wrapper, videoId) => {
            const video = wrapper.querySelector('video');
            if (!video) return;

            let startTime = 0;
            let loggedView = false;

            video.addEventListener('play', () => {
                startTime = Date.now();
            });

            video.addEventListener('timeupdate', () => {
                const duration = video.duration || 1;
                const percent = video.currentTime / duration;

                // VIEW: Log if watched > 70% (Only once per session)
                if (percent > 0.7 && !loggedView) {
                    loggedView = true;
                    logInteractionFn({
                        videoId: videoId,
                        watchPercent: percent,
                        liked: false,
                        completed: false
                    }).catch(e => console.error("Log view failed", e));
                    
                    console.log(`[Algorithm] View logged for ${videoId}`);
                }
            });

            // SKIP DETECTION HOOK
            // This is called when the video leaves the viewport
            wrapper.onVideoHidden = () => {
                if (startTime === 0) return; // Was not playing
                
                const watchTime = (Date.now() - startTime) / 1000; // Seconds
                const duration = video.duration || 1;
                const percent = video.currentTime / duration;

                // SKIP: Less than 2 seconds watch time
                if (watchTime < 2) {
                    console.log(`[Algorithm] Skip logged for ${videoId} (${watchTime.toFixed(1)}s)`);
                    logInteractionFn({
                        videoId: videoId,
                        watchPercent: percent,
                        liked: false,
                        completed: false
                    });
                }
                
                startTime = 0; // Reset
            };
        };

        window.setupProfileListener = (userId) => {
             if (window.unsubscribeProfile) { window.unsubscribeProfile(); }
             const container = document.getElementById('profile-content-videos');
             const q = query(collection(db, "users", userId, "videos"));
             
             window.unsubscribeProfile = onSnapshot(q, (snapshot) => {
                const userUploads = snapshot.docs.map(d => ({ id: d.id, ...d.data(), path: d.ref.path }));
                // Fallback demo data logic removed for brevity, assume real data for new features
                
                // Sorting & Filtering
                const viewerId = auth.currentUser ? auth.currentUser.uid : null;
                const isMe = (viewerId === userId);

                let allUploads = userUploads.filter(video => {
                    if (isMe) return true;
                    if (video.visibility === 'private') return false;
                    if (video.visibility === 'followers') {
                        if (window.myFollowing && window.myFollowing.has(userId)) return true;
                        return false;
                    }
                    return true;
                });
                
                allUploads.sort((a, b) => {
                    const getTime = (p) => { if (p.createdAt && typeof p.createdAt.toDate === 'function') return p.createdAt.toDate().getTime(); if (p.timestamp && typeof p.timestamp.toDate === 'function') return p.timestamp.toDate().getTime(); return 0; };
                    return getTime(b) - getTime(a);
                });

                container.innerHTML = '';
                
                if (allUploads.length === 0) {
                     // Empty placeholders
                     for (let i = 0; i < 5; i++) {
                        const div = document.createElement('div');
                        div.className = 'aspect-[3/4] bg-app-card rounded-xl hover:opacity-80 transition-opacity cursor-pointer flex items-center justify-center border border-app-border';
                        if (i === 0) div.innerHTML = `<span class="text-xs text-app-textMuted text-center px-2">${isMe ? 'Upload to see it here!' : 'No videos shared yet.'}</span>`;
                        container.appendChild(div);
                     }
                } else {
                     allUploads.forEach(post => {
                         const div = document.createElement('div');
                         div.className = 'aspect-[3/4] bg-black rounded-xl overflow-hidden relative cursor-pointer group border border-app-border';
                         div.onclick = () => window.goToFeedVideo(post.id);
                         
                         const isSlideshow = post.type === 'slideshow' || (post.images && post.images.length > 0);
                         let mediaHtml = '';
                         let typeIcon = '';

                         if (isSlideshow) {
                             const thumb = (post.images && post.images[0]) ? post.images[0] : (post.thumbnailUrl || '');
                             mediaHtml = `<img src="${thumb}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">`;
                             typeIcon = `<div class="absolute top-2 right-2 bg-black/60 p-1.5 rounded-full backdrop-blur-md z-20 border border-white/10"><i data-lucide="images" class="w-3 h-3 text-white"></i></div>`;
                         } else {
                             mediaHtml = `<video src="${post.videoUrl}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" muted loop playsinline onmouseover="this.play()" onmouseout="this.pause();this.currentTime=0;"></video>`;
                             // typeIcon = `<div class="absolute top-2 right-2 bg-black/60 p-1.5 rounded-full backdrop-blur-md z-20"><i data-lucide="video" class="w-3 h-3 text-white"></i></div>`;
                         }

                         div.innerHTML = `
                             ${mediaHtml}
                             ${typeIcon}
                             <div class="absolute bottom-2 left-2 text-white text-xs font-bold flex items-center gap-1 shadow-black drop-shadow-md z-10"><i data-lucide="play" class="w-3 h-3 fill-white"></i> ${formatNumber(post.views || 0)}</div>
                             <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-colors"></div>
                             ${post.path !== 'null' && isMe ? `<button onclick="event.stopPropagation(); window.navigateTo('video/${post.id}/edit')" class="absolute top-2 left-2 bg-black/50 hover:bg-brand-teal text-white p-1.5 rounded-full backdrop-blur-sm transition-colors z-20 opacity-0 group-hover:opacity-100" title="Edit Content"><i data-lucide="edit-2" class="w-4 h-4"></i></button>` : ''}
                         `;
                         container.appendChild(div);
                     });
                     
                     // Fillers
                     const remaining = Math.max(0, 5 - allUploads.length);
                     for(let i=0; i < remaining; i++) { const div = document.createElement('div'); div.className = 'aspect-[3/4] bg-app-card rounded-xl border border-app-border opacity-50'; container.appendChild(div); }
                }
                if(window.lucide) window.lucide.createIcons();
             }, (error) => { console.error("Profile Listener Error:", error); });
        };

        window.toggleProfileMenu = () => {
            const menu = document.getElementById('profile-more-menu');
            if(menu) menu.classList.toggle('hidden');
        };

        window.updatePresence = async (state) => {
            const user = auth.currentUser;
            if(!user) return;
            try {
                // Use setDoc with merge to avoid overwriting profile data
                const userRef = doc(db, 'users', user.uid);
                await setDoc(userRef, {
                    status: {
                        state: state,
                        last_changed: serverTimestamp()
                    }
                }, { merge: true });
            } catch(e) { 
                console.warn("Presence update silent fail", e); 
            }
        };

        window.setupPresenceSystem = () => {
            if (presenceInterval) clearInterval(presenceInterval);
            
            // Immediate update
            window.updatePresence('online');

            // Heartbeat every 2 minutes
            presenceInterval = setInterval(() => {
                if(document.visibilityState === 'visible' && auth.currentUser) {
                    window.updatePresence('online');
                }
            }, 120000);

            // Update on tab focus
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && auth.currentUser) {
                    window.updatePresence('online');
                }
            });
        };

        window.teardownPresenceSystem = () => {
            if (presenceInterval) clearInterval(presenceInterval);
            if (profileStatusUnsub) profileStatusUnsub();
            if (chatStatusUnsub) chatStatusUnsub();
            presenceInterval = null;
            profileStatusUnsub = null;
            chatStatusUnsub = null;
        };

        window.formatLastSeen = (timestamp) => {
            if (!timestamp) return 'Online'; // Assume online if timestamp is pending (local write)
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffSeconds = Math.floor((now - date) / 1000);
            
            if (diffSeconds < 300) return 'Online'; // < 5 mins
            
            if (diffSeconds < 3600) return `Last seen ${Math.floor(diffSeconds / 60)}m ago`;
            if (diffSeconds < 86400) return `Last seen ${Math.floor(diffSeconds / 3600)}h ago`;
            if (diffSeconds < 604800) return `Last seen ${Math.floor(diffSeconds / 86400)}d ago`;
            return `Last seen ${date.toLocaleDateString()}`;
        };

        window.handleBlockUser = async (targetId) => {
            const user = auth.currentUser;
            if(!user) return;
            
            const isBlocked = blockedUsers.has(targetId);
            const blockRef = doc(db, 'users', user.uid, 'blocked', targetId);
            
            // UI Feedback immediately
            const btnText = document.getElementById('block-btn-text');
            if(btnText) btnText.innerText = "Processing...";

            try {
                if(isBlocked) {
                    // Unblock
                    await deleteDoc(blockRef);
                    blockedUsers.delete(targetId);
                    window.showToast("User unblocked", "success");
                } else {
                    // Block
                    await setDoc(blockRef, { timestamp: serverTimestamp() });
                    blockedUsers.add(targetId);
                    window.showToast("User blocked. Content hidden.", "success");
                }
                
                window.toggleProfileMenu();
                
                if (unsubscribeFeed) { unsubscribeFeed(); unsubscribeFeed = null; }
                window.setupFeedListener(); 
                
                window.renderStoreGrid(allStoreProducts); // Will filter based on blockedUsers Set
                window.renderExploreGrid(allExploreVideos); // Will filter based on blockedUsers Set
                
                if (currentViewedProfileId === targetId) {
                    const name = document.getElementById('profile-name').textContent.replace('@','');
                    const img = document.getElementById('profile-image').src;
                    window.viewUserProfile(targetId, name, img);
                }
                
            } catch(e) {
                console.error("Block action failed", e);
                window.showToast("Action failed", "error");
            }
        };

        // --- REPORTING LOGIC ---
        window.openReportModal = (type, id, userId, specificPath = null) => {
            if(!window.auth.currentUser) { window.toggleAuthModal(true); return; }
            
            document.getElementById('report-target-type').value = type;
            document.getElementById('report-target-id').value = id;
            document.getElementById('report-user-id').value = userId || '';
            
            // Store the specific path in a data attribute on the form or a hidden field
            // (We'll use a new global variable for simplicity in this hotfix)
            window.currentReportPath = specificPath;
            
            // Reset Form
            document.getElementById('report-reason').value = '';
            document.getElementById('report-details').value = '';
            
            document.getElementById('report-modal').classList.remove('hidden');
        };

        window.handleReportSubmit = async (e) => {
            e.preventDefault();
            
            // 1. UI Loading State
            const btn = e.target.querySelector('button[type="submit"]');
            const originalContent = btn.innerHTML;
            btn.disabled = true; 
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Sending...`;
            if(window.lucide) window.lucide.createIcons();

            // 2. Gather Data
            const type = document.getElementById('report-target-type').value;
            const id = document.getElementById('report-target-id').value;
            const reportedUserId = document.getElementById('report-user-id').value;
            const reason = document.getElementById('report-reason').value;
            const details = document.getElementById('report-details').value;
            const user = window.auth.currentUser;

            if(!user) {
                window.showToast("You must be logged in.", "error");
                btn.disabled = false; btn.innerHTML = originalContent;
                return;
            }

            // --- CRITICAL PATH RESOLUTION ---
            // We prioritize the explicitly passed path, then fallback to construction
            let resolvedTargetPath = window.currentReportPath || null;

            if (!resolvedTargetPath) {
                if (type === 'video' && reportedUserId && id) {
                    resolvedTargetPath = `users/${reportedUserId}/videos/${id}`;
                } 
                else if (type === 'product' && reportedUserId && id) {
                    resolvedTargetPath = `users/${reportedUserId}/products/${id}`;
                } 
                else if (type === 'comment' && id) {
                    // Try to use the global video path if we are currently viewing it
                    if (window.currentCommentVideoPath) {
                        resolvedTargetPath = `${window.currentCommentVideoPath}/comments/${id}`;
                    }
                }
            }

            // Safety check: If path is still null or invalid (missing User ID), warn the user but submit anyway
            // (Admins can still see the report, but auto-delete button might be disabled)
            if (type !== 'user' && (!resolvedTargetPath || resolvedTargetPath.includes('//'))) {
                console.warn("Report path could not be resolved fully:", resolvedTargetPath);
            }

            try {
                let reportedUsername = "Unknown";
                let reportedUserEmail = "N/A";
                let contextData = "Context unavailable";

                // 3. Fetch User Info
                if(reportedUserId) {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', reportedUserId));
                        if(userDoc.exists()) {
                            reportedUsername = userDoc.data().profile?.username || "Unknown";
                            reportedUserEmail = userDoc.data().profile?.email || "Hidden/N/A";
                        }
                    } catch(err) {}
                }

                // 4. Fetch Context Snapshot
                if (resolvedTargetPath) {
                    try {
                        const snap = await getDoc(doc(db, resolvedTargetPath));
                        if(snap.exists()) {
                            const d = snap.data();
                            if(type === 'comment') contextData = `Comment: "${d.text}"`;
                            else if(type === 'video') contextData = `Video: ${d.title}\nDesc: ${d.description || ''}`;
                            else if(type === 'product') contextData = `Product: ${d.title} ($${d.price})`;
                        }
                    } catch(err) { console.warn("Context fetch failed", err); }
                }

                // 5. Construct Email Body
                const emailBody = `
                    NEW REPORT RECEIVED

                    -- REPORTER INFO --
                    User ID: ${user.uid}
                    Username: ${user.displayName || 'N/A'}
                    Email: ${user.email}

                    -- REPORTED USER INFO --
                    User ID: ${reportedUserId}
                    Username: ${reportedUsername}
                    Email: ${reportedUserEmail}

                    -- REPORT DETAILS --
                    Target Type: ${type.toUpperCase()}
                    Target ID: ${id}
                    Target Path: ${resolvedTargetPath || 'N/A'}
                    Reason: ${reason}
                    User Comments: ${details || 'None'}

                    -- CONTENT CONTEXT --
                    ${contextData}
                `;

                // 6. Send Email via EmailJS
                const emailParams = {
                    message: emailBody,
                    reporter_id: user.uid,
                    reporter_name: user.displayName,
                    reporter_email: user.email,
                    reported_id: reportedUserId,
                    reported_name: reportedUsername,
                    reported_email: reportedUserEmail,
                    report_reason: reason,
                    report_details: details,
                    content_context: contextData,
                    reply_to: user.email
                };

                emailjs.send('service_3jqdlyb', 'template_l6kzkzk', emailParams)
                    .catch(err => console.warn("EmailJS Error:", err));

                // 7. Save to Firestore
                await addDoc(collection(db, 'reports'), {
                    reporterId: user.uid,
                    reporterUsername: user.displayName,
                    reporterEmail: user.email,
                    targetType: type,
                    targetId: id,
                    targetPath: resolvedTargetPath, // <--- CRITICAL for Deletion
                    reportedUserId: reportedUserId,
                    reportedUsername: reportedUsername, 
                    reason: reason,
                    details: details,
                    contextSnapshot: contextData,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });

                window.showToast("Report sent successfully.", "success");
                document.getElementById('report-modal').classList.add('hidden');

            } catch(err) {
                console.error("Report Error:", err);
                window.showToast("Failed to submit.", "error");
            } finally {
                btn.disabled = false; btn.innerHTML = originalContent;
            }
        };

        window.handleReportUser = (targetId) => {
            window.toggleProfileMenu();
            // Open the new modal instead of just showing a toast
            window.openReportModal('user', targetId, targetId);
        };

        window.goToFeedVideo = (id, username) => {
            // If we have a username, use it to build the URL
            if (username && username !== 'User' && username !== 'undefined') {
                const url = `/${username}/video/${id}`;
                history.pushState(null, null, url);
            }
            
            // Switch view
            window.renderInternalView('feed');
            
            // Scroll Logic
            setTimeout(() => {
                const el = document.querySelector(`.video-item-wrapper[data-id="${id}"]`);
                if (el) { 
                    el.scrollIntoView({ behavior: 'smooth' }); 
                    const video = el.querySelector('video'); 
                    if (video) video.play().catch(e => console.log(e)); 
                } else {
                    // If video isn't in current feed (e.g. came from explore), 
                    // the router logic handles deep load if refreshing, 
                    // but for SPA transition we might need to fetch it if not present.
                    // For simplicity in this update, we rely on feed being populated 
                    // or just the URL update for sharing.
                }
            }, 100);
        };
        
        window.handleDeleteVideo = async (event, videoPath, storagePath) => {
            event.stopPropagation();
            window.openConfirmModal('Delete Video', 'Are you sure you want to delete this video? This action cannot be undone.', async () => {
                 try {
                    await deleteDoc(doc(db, videoPath));
                    if (storagePath) { const fileRef = ref(storage, storagePath); await deleteObject(fileRef).catch(e => console.warn("Storage delete failed", e)); }
                    window.showToast("Video deleted.", "success");
                } catch(e) { console.error("Delete failed", e); window.showToast("Could not delete video.", "error"); }
            });
        };

        // --- INBOX LOGIC ---
        window.switchInboxTab = (tab) => {
            currentInboxTab = tab;

            // References
            const notifTab = document.getElementById('tab-inbox-notifications');
            const msgTab = document.getElementById('tab-inbox-messages');
            const soldTab = document.getElementById('tab-inbox-sold');
            const ordersTab = document.getElementById('tab-inbox-orders');
            const systemTab = document.getElementById('tab-inbox-system'); // NEW

            const mNotifTab = document.getElementById('mobile-tab-inbox-notifications');
            const mMsgTab = document.getElementById('mobile-tab-inbox-messages');
            const mSoldTab = document.getElementById('mobile-tab-inbox-sold');
            const mOrdersTab = document.getElementById('mobile-tab-inbox-orders');
            const mSystemTab = document.getElementById('mobile-tab-inbox-system'); // NEW

            const notifView = document.getElementById('inbox-view-notifications');
            const msgView = document.getElementById('inbox-view-messages');
            const soldView = document.getElementById('inbox-view-sold');
            const ordersView = document.getElementById('inbox-view-orders');
            const systemView = document.getElementById('inbox-view-system'); // NEW

            // Styles Helper
            const resetTab = (el) => { if(el) { el.classList.remove('inbox-tab-active', 'font-bold', 'text-app-text'); el.classList.add('text-app-textMuted', 'hover:bg-app-hover'); }};
            const activeTab = (el) => { if(el) { el.classList.add('inbox-tab-active', 'font-bold', 'text-app-text'); el.classList.remove('text-app-textMuted', 'hover:bg-app-hover'); }};
            
            const resetMTab = (el) => { if(el) { el.classList.remove('border-brand-teal', 'text-app-text'); el.classList.add('border-transparent', 'text-app-textMuted'); }};
            const activeMTab = (el) => { if(el) { el.classList.add('border-brand-teal', 'text-app-text'); el.classList.remove('border-transparent', 'text-app-textMuted'); }};

            // Reset All
            [notifTab, msgTab, soldTab, ordersTab, systemTab].forEach(resetTab);
            [mNotifTab, mMsgTab, mSoldTab, mOrdersTab, mSystemTab].forEach(resetMTab);

            if(notifView) notifView.classList.add('hidden');
            if(msgView) { msgView.classList.add('hidden'); msgView.classList.remove('flex'); msgView.style.display = 'none'; }
            if(soldView) { soldView.classList.add('hidden'); soldView.classList.remove('flex'); }
            if(ordersView) { ordersView.classList.add('hidden'); ordersView.classList.remove('flex'); }
            if(systemView) { systemView.classList.add('hidden'); }

            // Activate Tab
            if (tab === 'notifications') {
                activeTab(notifTab); activeMTab(mNotifTab);
                if(notifView) notifView.classList.remove('hidden');
            } 
            else if (tab === 'messages') {
                activeTab(msgTab); activeMTab(mMsgTab);
                if(msgView) {
                    msgView.classList.remove('hidden');
                    msgView.classList.add('flex');
                    msgView.style.display = 'flex';
                    
                    // Sidebar visibility fix logic (same as before)
                    const sidebar = document.getElementById('conversations-sidebar');
                    const chatWrapper = document.getElementById('chat-wrapper');
                    const isDesktop = window.innerWidth >= 768;
                    if (sidebar) { sidebar.classList.remove('hidden'); sidebar.classList.add('flex'); sidebar.style.display = 'flex'; }
                    if (chatWrapper && isDesktop) { chatWrapper.classList.remove('hidden'); chatWrapper.classList.add('flex'); chatWrapper.style.display = 'flex'; }
                    else if (chatWrapper && !activeConversationId) { chatWrapper.classList.add('hidden'); chatWrapper.classList.remove('flex'); chatWrapper.style.display = 'none'; }
                    else if (chatWrapper && activeConversationId) { chatWrapper.classList.remove('hidden'); chatWrapper.classList.add('flex'); chatWrapper.style.display = 'flex'; if(sidebar) sidebar.classList.add('hidden'); }

                    if (window.setupConversationsListener) window.setupConversationsListener();
                }
            } 
            else if (tab === 'sold') {
                activeTab(soldTab); activeMTab(mSoldTab);
                if(soldView) { soldView.classList.remove('hidden'); soldView.classList.add('flex'); }
                if(window.setupSoldOrdersListener) window.setupSoldOrdersListener();
            } 
            else if (tab === 'orders') {
                activeTab(ordersTab); activeMTab(mOrdersTab);
                if(ordersView) { ordersView.classList.remove('hidden'); ordersView.classList.add('flex'); }
                if(window.setupBuyerOrdersListener) window.setupBuyerOrdersListener();
            }
            else if (tab === 'system') {
                activeTab(systemTab); activeMTab(mSystemTab);
                if(systemView) { systemView.classList.remove('hidden'); }
                if(window.setupSystemNotificationsListener) window.setupSystemNotificationsListener();
            }
        };


        // --- SOLD SUB-TABS LOGIC ---
        window.switchSoldTab = (subTab) => {
            currentSoldFilter = subTab;
            ['to-ship', 'in-transit', 'canceled'].forEach(t => {
                const btn = document.getElementById(`sold-tab-${t}`);
                if(!btn) return;
                if (t === subTab) {
                    btn.className = "text-sm font-bold text-app-text border-b-2 border-brand-orange pb-1";
                } else {
                    btn.className = "text-sm font-bold text-app-textMuted border-b-2 border-transparent hover:text-app-text pb-1 transition-all";
                }
            });
            window.setupSoldOrdersListener();
        };

        window.setupSoldOrdersListener = () => {
            const user = auth.currentUser;
            if(!user) return;
            if(unsubscribeSoldOrders) unsubscribeSoldOrders();

            const list = document.getElementById('sold-orders-list');
            list.innerHTML = '<div class="text-center text-app-textMuted py-10"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading orders...</div>';
            if(window.lucide) window.lucide.createIcons();

            const q = query(collection(db, 'orders'), where('sellerId', '==', user.uid));
            
            unsubscribeSoldOrders = onSnapshot(q, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => orders.push({id: doc.id, ...doc.data()}));
                orders.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                let statusFilter = 'paid';
                if(currentSoldFilter === 'in-transit') statusFilter = 'shipped';
                if(currentSoldFilter === 'canceled') statusFilter = 'canceled';
                
                const filtered = orders.filter(o => o.status === statusFilter);

                list.innerHTML = '';
                if (filtered.length === 0) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-app-textMuted opacity-60"><i data-lucide="package-search" class="w-12 h-12 mb-2"></i><p>No orders in "${currentSoldFilter}".</p></div>`;
                } else {
                    filtered.forEach(order => {
                        const div = document.createElement('div');
                        div.className = "bg-app-card border border-app-border rounded-xl p-4 flex gap-4 items-center animate-fade-in";
                        
                        const img = order.items && order.items[0] && order.items[0].image ? order.items[0].image : 'https://via.placeholder.com/150';
                        const title = order.items && order.items[0] ? order.items[0].title : 'Unknown Item';
                        const count = order.items ? order.items.length : 0;
                        const total = order.totalAmount || 0;
                        const buyerName = order.buyerName || 'Buyer';

                        div.innerHTML = `
                            <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden shrink-0 border border-app-border">
                                <img src="${img}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-app-text truncate text-sm">${title} ${count > 1 ? `(+${count-1} more)` : ''}</h4>
                                <p class="text-xs text-app-textMuted">Buyer: ${buyerName}</p>
                                <p class="font-bold text-brand-teal mt-1">$${total.toFixed(2)}</p>
                            </div>
                            <div class="flex flex-col gap-2 items-end">
                                <button onclick="window.openOrderDetails('${order.id}')" class="px-4 py-2 bg-app-bg border border-app-border text-app-text text-xs font-bold rounded-lg hover:bg-app-hover transition-colors">View Order</button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }
                if(window.lucide) window.lucide.createIcons();
            });
        };

        window.setupBuyerOrdersListener = () => {
            const user = auth.currentUser;
            if(!user) return;
            if(unsubscribeBuyerOrders) unsubscribeBuyerOrders();

            const list = document.getElementById('buyer-orders-list');
            list.innerHTML = '<div class="text-center text-app-textMuted py-10"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading your orders...</div>';
            if(window.lucide) window.lucide.createIcons();

            const q = query(collection(db, 'orders'), where('buyerId', '==', user.uid));
            
            unsubscribeBuyerOrders = onSnapshot(q, (snapshot) => {
                const orders = [];
                snapshot.forEach(doc => orders.push({id: doc.id, ...doc.data()}));
                
                // Sort by newest
                orders.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                list.innerHTML = '';
                if (orders.length === 0) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center py-20 text-app-textMuted opacity-60"><i data-lucide="shopping-bag" class="w-16 h-16 mb-4"></i><p class="text-lg font-bold">No orders yet</p><p class="text-sm">Items you buy will appear here.</p></div>`;
                } else {
                    orders.forEach(order => {
                        const div = document.createElement('div');
                        div.className = "bg-app-card border border-app-border rounded-xl p-4 flex gap-4 items-center animate-fade-in";
                        
                        const img = order.items && order.items[0] && order.items[0].image ? order.items[0].image : 'https://via.placeholder.com/150';
                        const title = order.items && order.items[0] ? order.items[0].title : 'Unknown Item';
                        const count = order.items ? order.items.length : 0;
                        const total = order.totalAmount || 0;
                        
                        // Status styling
                        let statusColor = 'text-gray-500';
                        let statusIcon = 'clock';
                        let statusText = order.status || 'Pending';
                        
                        if(statusText === 'paid') { statusColor = 'text-brand-teal'; statusIcon = 'check-circle'; statusText = 'Paid'; }
                        if(statusText === 'shipped') { statusColor = 'text-brand-orange'; statusIcon = 'truck'; statusText = 'Shipped'; }
                        if(statusText === 'delivered') { statusColor = 'text-green-500'; statusIcon = 'package-check'; statusText = 'Delivered'; }
                        if(statusText === 'canceled') { statusColor = 'text-red-500'; statusIcon = 'x-circle'; statusText = 'Canceled'; }

                        // ADDED: Cancel Button Logic (Only if status is 'paid')
                        let cancelButton = '';
                        if (order.status === 'paid') {
                             cancelButton = `<button onclick="window.cancelOrder('${order.id}')" class="px-4 py-2 mt-2 bg-red-50 text-red-500 border border-red-100 text-xs font-bold rounded-lg hover:bg-red-100 transition-colors">Cancel</button>`;
                        }

                        div.innerHTML = `
                            <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden shrink-0 border border-app-border">
                                <img src="${img}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex flex-wrap justify-between items-start gap-2">
                                    <h4 class="font-bold text-app-text truncate text-sm">${title} ${count > 1 ? `(+${count-1} more)` : ''}</h4>
                                    <span class="text-[10px] font-bold uppercase tracking-wider ${statusColor} flex items-center gap-1 bg-app-bg px-2 py-0.5 rounded border border-app-border">
                                        <i data-lucide="${statusIcon}" class="w-3 h-3"></i> ${statusText}
                                    </span>
                                </div>
                                <p class="text-xs text-app-textMuted mt-1">Order #${order.id.substr(0,8)}</p>
                                <p class="font-bold text-app-text mt-0.5">$${total.toFixed(2)}</p>
                            </div>
                            <div class="flex flex-col items-end">
                                <button onclick="window.openOrderDetails('${order.id}')" class="px-4 py-2 bg-app-bg border border-app-border text-app-text text-xs font-bold rounded-lg hover:bg-app-hover transition-colors">Details</button>
                                ${cancelButton}
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }
                if(window.lucide) window.lucide.createIcons();
            });
        };
        
        window.openOrderDetails = async (orderId) => {
            const modal = document.getElementById('order-details-modal');
            const content = document.getElementById('order-details-content');
            const footer = document.getElementById('order-details-footer');
            const user = auth.currentUser; // Get current user for permission check
            
            content.innerHTML = '<div class="text-center py-10"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto"></i></div>';
            footer.innerHTML = '';
            modal.classList.remove('hidden');
            if(window.lucide) window.lucide.createIcons();

            try {
                const orderSnap = await getDoc(doc(db, 'orders', orderId));
                if(!orderSnap.exists()) return;
                const order = orderSnap.data();
                const isSeller = user && user.uid === order.sellerId; // Check ownership

                // Render Info Section
                let itemsHtml = (order.items || []).map(item => `
                    <div class="flex items-center gap-3 p-3 bg-app-bg rounded-xl border border-app-border">
                        <img src="${item.image}" class="w-12 h-12 object-cover rounded-lg">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-bold text-app-text truncate">${item.title}</p>
                            <p class="text-xs text-app-textMuted">Qty: ${item.quantity || 1} â¢ $${item.price.toFixed(2)} ea</p>
                        </div>
                    </div>
                `).join('');

                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-brand-teal/5 p-4 rounded-xl border border-brand-teal/10">
                            <p class="text-[10px] font-bold text-brand-teal uppercase tracking-widest mb-1">Buyer Information</p>
                            <p class="font-bold text-app-text">${order.buyerName}</p>
                            <p class="text-xs text-app-textMuted">${order.buyerEmail || ''}</p>
                            <div class="mt-3 pt-3 border-t border-brand-teal/10">
                                <p class="text-[10px] font-bold text-app-textMuted uppercase tracking-widest mb-1">Shipping To</p>
                                <p class="text-xs text-app-text leading-relaxed">${order.shippingAddress || 'No address provided'}</p>
                            </div>
                        </div>
                        
                        <div>
                            <p class="text-[10px] font-bold text-app-textMuted uppercase tracking-widest mb-3">Items Purchased</p>
                            <div class="space-y-2">${itemsHtml}</div>
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-app-border">
                            <span class="text-sm font-bold text-app-textMuted">Order Total</span>
                            <span class="text-xl font-black text-brand-teal">$${(order.totalAmount || 0).toFixed(2)}</span>
                        </div>
                    </div>
                `;

                // Action Buttons based on status and role
                let actions = '';

                if (isSeller) {
                    // SELLER VIEW: Can Print Label & Ship
                    actions += `<button onclick="window.openShippingLabel('${orderId}')" class="flex-1 bg-app-bg border border-app-border text-app-text font-bold py-3 rounded-xl hover:bg-app-hover transition-all flex items-center justify-center gap-2 text-sm"><i data-lucide="printer" class="w-4 h-4"></i> Shipping Label</button>`;
                    
                    if (order.status === 'paid') {
                        actions += `<button onclick="window.markAsShipped('${orderId}')" class="flex-1 bg-brand-teal text-white font-bold py-3 rounded-xl hover:bg-brand-teal/90 shadow-lg shadow-brand-teal/20 transition-all text-sm">Confirm Shipment</button>`;
                    } else if (order.status === 'shipped') {
                        actions += `<div class="flex-1 text-center py-3 text-green-500 font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="truck" class="w-4 h-4"></i> In Transit</div>`;
                    }
                } else {
                    // BUYER VIEW: Only see status
                     if (order.status === 'paid') {
                        actions += `<div class="w-full text-center py-3 text-app-textMuted font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="package" class="w-4 h-4"></i> Order Processing</div>`;
                    } else if (order.status === 'shipped') {
                        actions += `<div class="w-full text-center py-3 text-green-500 font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="truck" class="w-4 h-4"></i> Shipped - On the way</div>`;
                    } else if (order.status === 'delivered') {
                        actions += `<div class="w-full text-center py-3 text-brand-teal font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Delivered</div>`;
                    } else {
                        actions += `<div class="w-full text-center py-3 text-app-textMuted font-bold text-sm">${order.status}</div>`;
                    }
                }

                footer.innerHTML = actions;
                if(window.lucide) window.lucide.createIcons();

            } catch(e) {
                console.error(e);
                content.innerHTML = '<p class="text-center text-red-500">Error loading details.</p>';
            }
        };

        window.cancelOrder = (orderId) => {
            window.openConfirmModal('Cancel Order', 'Are you sure you want to cancel this order? This action cannot be undone and stock will be returned to the seller.', async () => {
                try {
                    const orderRef = doc(db, 'orders', orderId);
                    const orderSnap = await getDoc(orderRef);
                    
                    if (!orderSnap.exists()) {
                        window.showToast("Order not found", "error");
                        return;
                    }
                    
                    const orderData = orderSnap.data();
                    
                    if (orderData.status !== 'paid') {
                        window.showToast("Cannot cancel order at this stage.", "error");
                        return;
                    }
                    
                    const batch = writeBatch(db);

                    // 1. Update Order Status
                    batch.update(orderRef, { status: 'canceled' });

                    // 2. Replenish Stock
                    if(orderData.items && Array.isArray(orderData.items)) {
                        orderData.items.forEach(item => {
                            if(item.sellerId && item.productId) {
                                const prodRef = doc(db, 'users', item.sellerId, 'products', item.productId);
                                const qty = item.quantity || 1;
                                batch.update(prodRef, { stock: increment(qty) });
                            }
                        });
                    }
                    
                    // 3. Notify Seller
                    if (orderData.sellerId) {
                        const buyerName = orderData.buyerName || 'Buyer';
                        const notifRef = doc(collection(db, 'users', orderData.sellerId, 'notifications'));
                        batch.set(notifRef, {
                            type: 'purchase', 
                            fromUserId: auth.currentUser.uid,
                            fromUsername: buyerName,
                            fromUserAvatar: auth.currentUser.photoURL,
                            previewText: `Order #${orderId.substring(0,6)} canceled by buyer. Stock replenished.`,
                            read: false,
                            timestamp: serverTimestamp(),
                            orderId: orderId
                        });
                    }

                    await batch.commit();
                    window.showToast("Order canceled & refunded", "success");

                } catch (e) {
                    console.error("Cancel failed", e);
                    window.showToast("Failed to cancel order", "error");
                }
            });
        };

        window.acceptOffer = async (convoId, msgId) => {
            try {
                const msgRef = doc(db, 'conversations', convoId, 'messages', msgId);
                await updateDoc(msgRef, { status: 'accepted' });
                window.showToast("Offer accepted", "success");
            } catch(e) {
                console.error(e);
                window.showToast("Failed to accept", "error");
            }
        };

        window.declineOffer = async (convoId, msgId) => {
            try {
                const msgRef = doc(db, 'conversations', convoId, 'messages', msgId);
                await updateDoc(msgRef, { status: 'declined' });
                window.showToast("Offer declined", "success");
            } catch(e) {
                console.error(e);
                window.showToast("Failed to decline", "error");
            }
        };

        window.addOfferToCart = async (productId, sellerId, title, offerPrice, image) => {
            const user = auth.currentUser;
            if(!user) return;
            
            try {
                // Use a special doc ID to distinguish offer-based cart items or just overwrite standard
                // Here we simply overwrite, meaning if they add via offer, it sets the price.
                const cartRef = doc(db, 'users', user.uid, 'cart', productId);
                
                await setDoc(cartRef, {
                    productId: productId,
                    sellerId: sellerId,
                    title: title,
                    price: parseFloat(offerPrice), // USE OFFER PRICE
                    image: image || '',
                    quantity: 1, 
                    stock: 1, // Assume 1 for simplicity unless we fetch live stock
                    addedAt: serverTimestamp(),
                    isOffer: true // Flag to indicate special pricing
                });
                
                window.showToast("Added to cart at offer price!", "success");
                window.navigateTo('cart');
            } catch(e) {
                console.error("Add offer to cart failed", e);
                window.showToast("Failed to add to cart", "error");
            }
        };

        window.markAsShipped = async (orderId) => {
            const btn = document.querySelector('#order-details-footer button.bg-brand-teal');
            if(btn) { btn.disabled = true; btn.innerText = "Processing Payout..."; }

            try {
                const user = auth.currentUser;
                if (!user) throw new Error("Not logged in");

                const orderRef = doc(db, 'orders', orderId);
                const orderSnap = await getDoc(orderRef);
                
                if (!orderSnap.exists()) throw new Error("Order not found");
                const orderData = orderSnap.data();

                if (orderData.status !== 'paid') {
                    window.showToast("Order is already processed or canceled", "info");
                    return;
                }

                // Calculate Payout Logic (Moved from Payment Success)
                const grossAmount = orderData.totalAmount || 0;
                const platformFee = grossAmount * 0.10;
                const netPayout = grossAmount - platformFee;
                // 1 minute delay for testing (would be 5 days in production)
                const releaseTime = new Date(Date.now() + 60000); 

                const batch = writeBatch(db);

                // 1. Update Order Status
                batch.update(orderRef, { status: 'shipped' });

                // 2. Add to Transaction History (Seller)
                const transRef = doc(collection(db, 'users', user.uid, 'transactions'));
                batch.set(transRef, {
                    type: 'sale',
                    amount: netPayout,
                    grossAmount: grossAmount,
                    fee: platformFee,
                    status: 'pending', // Starts as pending
                    description: `Sale shipped (Order #${orderId.substring(0,4)})`,
                    orderId: orderId,
                    buyerName: orderData.buyerName || 'Guest',
                    createdAt: serverTimestamp(),
                    releaseAt: releaseTime
                });

                // 3. Update Pending & Lifetime Balance (Seller)
                const sellerUserRef = doc(db, 'users', user.uid);
                batch.update(sellerUserRef, {
                    'wallet.pending': increment(netPayout),
                    'wallet.lifetime': increment(netPayout)
                });

                // 4. Notify Buyer
                const buyerNotifRef = doc(collection(db, 'users', orderData.buyerId, 'notifications'));
                batch.set(buyerNotifRef, {
                    type: 'purchase', // Using purchase icon for order updates
                    fromUserId: user.uid,
                    fromUsername: user.displayName || 'Seller',
                    fromUserAvatar: user.photoURL,
                    previewText: `Your order has been shipped!`,
                    read: false,
                    timestamp: serverTimestamp(),
                    orderId: orderId
                });

                await batch.commit();

                window.showToast("Order shipped & funds pending!", "success");
                document.getElementById('order-details-modal').classList.add('hidden');

            } catch(e) {
                console.error("Shipping update failed", e);
                window.showToast("Update failed: " + e.message, "error");
                if(btn) { btn.disabled = false; btn.innerText = "Confirm Shipment"; }
            }
        };

        // --- SHIPPING LABEL LOGIC ---
        window.openShippingLabel = async (orderId) => {
            const user = auth.currentUser;
            const modal = document.getElementById('shipping-label-modal');
            modal.classList.remove('hidden');
            
            try {
                const orderSnap = await getDoc(doc(db, 'orders', orderId));
                if(!orderSnap.exists()) return;
                const order = orderSnap.data();

                let sellerName = user.displayName;
                let sellerAddr = "Address not set in Settings";
                const sellerSnap = await getDoc(doc(db, 'users', user.uid));
                if(sellerSnap.exists() && sellerSnap.data().preferences && sellerSnap.data().preferences.address) {
                    const a = sellerSnap.data().preferences.address;
                    sellerAddr = `${a.street} ${a.apt||''}, ${a.city}, ${a.state} ${a.zip}`;
                }

                document.getElementById('label-seller-name').textContent = sellerName;
                document.getElementById('label-seller-address').textContent = sellerAddr;
                document.getElementById('label-buyer-name').textContent = order.buyerName || "Buyer";
                document.getElementById('label-buyer-address').textContent = order.shippingAddress || "No address provided";
                document.getElementById('label-tracking').textContent = `9405 ${Math.floor(Math.random() * 10000)} ${Math.floor(Math.random() * 10000)} 02`;

                // REMOVED: await updateDoc(doc(db, 'orders', orderId), { status: 'shipped' });
                // This is now handled by markAsShipped
            } catch(e) { console.error("Label Error", e); }
        };

        // --- CHECKOUT LOGIC UPDATES ---
        window.closeCheckoutModal = () => {
             document.getElementById('checkout-modal').classList.add('hidden');
             document.getElementById('paypal-button-container').innerHTML = ''; // Clear buttons
             checkoutItemsBuffer = [];
        };

        window.initiateCheckout = async (itemId) => {
            const user = auth.currentUser;
            if(!user) { window.toggleAuthModal(true); return; }
            
            try {
                const docSnap = await getDoc(doc(db, 'users', user.uid, 'cart', itemId));
                if(!docSnap.exists()) return;
                const item = { id: docSnap.id, ...docSnap.data() };
                checkoutItemsBuffer = [item];
                window.navigateTo('checkout'); // Navigate to page
            } catch(e) { console.error(e); }
        };

        window.initiateCheckoutAll = async () => {
            const user = auth.currentUser;
            if(!user) { window.toggleAuthModal(true); return; }
            
            try {
                const snapshot = await getDocs(collection(db, 'users', user.uid, 'cart'));
                if(snapshot.empty) { window.showToast("Cart is empty", "error"); return; }
                
                checkoutItemsBuffer = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                window.navigateTo('checkout'); // Navigate to page
            } catch(e) { console.error(e); }
        };

        window.openCheckoutModal = async () => {
            const user = auth.currentUser;
            const summaryDiv = document.getElementById('checkout-items-summary');
            const addressDiv = document.getElementById('checkout-address-preview');
            const subtotalEl = document.getElementById('checkout-subtotal');
            const totalEl = document.getElementById('checkout-total');
            const paypalContainer = document.getElementById('paypal-button-container');
            
            // 1. Render Items & Calculate Total
            summaryDiv.innerHTML = '';
            let subtotal = 0;
            checkoutItemsBuffer.forEach(item => {
                const itemTotal = item.price * (item.quantity || 1);
                subtotal += itemTotal;
                
                const div = document.createElement('div');
                div.className = "flex gap-3 items-center";
                div.innerHTML = `
                    <div class="w-12 h-12 bg-gray-100 rounded-lg overflow-hidden shrink-0"><img src="${item.image}" class="w-full h-full object-cover"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-app-text truncate">${item.title}</p>
                        <p class="text-xs text-app-textMuted">Qty: ${item.quantity || 1}</p>
                    </div>
                    <span class="font-bold text-app-text">$${itemTotal.toFixed(2)}</span>
                `;
                summaryDiv.appendChild(div);
            });
            
            checkoutTotalAmount = subtotal;
            subtotalEl.innerText = `$${subtotal.toFixed(2)}`;
            totalEl.innerText = `$${subtotal.toFixed(2)}`;

            // 2. Render Address
            let addressStr = "No address saved.";
            try {
                const docSnap = await getDoc(doc(db, 'users', user.uid));
                if(docSnap.exists() && docSnap.data().preferences && docSnap.data().preferences.address) {
                    const a = docSnap.data().preferences.address;
                    const c = docSnap.data().preferences.defaultLocation;
                    // Basic check if fields exist
                    if(a.street || c) {
                        addressStr = `${a.street || ''} ${a.apt||''}, ${a.city||''}, ${a.state||''} ${a.zip||''}, ${c||''}`;
                    }
                }
            } catch(e) {}
            addressDiv.innerText = addressStr;
            
            document.getElementById('checkout-modal').classList.remove('hidden');

            // 3. Render PayPal Buttons
            paypalContainer.innerHTML = ''; // CRITICAL: Clear previous buttons
            
            if(window.paypal) {
                window.paypal.Buttons({
                    createOrder: function(data, actions) {
                        return actions.order.create({
                            purchase_units: [{
                                amount: { value: checkoutTotalAmount.toFixed(2) }
                            }]
                        });
                    },
                    onApprove: function(data, actions) {
                        return actions.order.capture().then(function(details) {
                            window.handlePaymentSuccess(details);
                        });
                    },
                    onError: function(err) {
                        console.error('PayPal Error', err);
                        window.showToast("Payment initialization failed", "error");
                    }
                }).render('#paypal-button-container');
            } else {
                paypalContainer.innerHTML = '<div class="text-red-500 text-sm p-4 text-center">PayPal SDK not loaded. Refresh page.</div>';
            }
        };

        window.renderCheckoutPage = async () => {
            const user = auth.currentUser;
            const itemsDiv = document.getElementById('checkout-page-items');
            const addressDiv = document.getElementById('checkout-page-address');
            const subtotalEl = document.getElementById('checkout-page-subtotal');
            const totalEl = document.getElementById('checkout-page-total');
            const payBtnAmount = document.getElementById('card-pay-amount');
            
            // 1. Render Items
            itemsDiv.innerHTML = '';
            let subtotal = 0;
            checkoutItemsBuffer.forEach(item => {
                const itemTotal = item.price * (item.quantity || 1);
                subtotal += itemTotal;
                
                const div = document.createElement('div');
                div.className = "flex gap-3 items-center p-3 bg-app-bg rounded-xl border border-app-border";
                div.innerHTML = `
                    <div class="w-12 h-12 bg-gray-100 rounded-lg overflow-hidden shrink-0"><img src="${item.image}" class="w-full h-full object-cover"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-app-text truncate">${item.title}</p>
                        <p class="text-xs text-app-textMuted">Qty: ${item.quantity || 1}</p>
                    </div>
                    <span class="font-bold text-app-text">$${itemTotal.toFixed(2)}</span>
                `;
                itemsDiv.appendChild(div);
            });
            
            checkoutTotalAmount = subtotal;
            subtotalEl.innerText = `$${subtotal.toFixed(2)}`;
            totalEl.innerText = `$${subtotal.toFixed(2)}`;
            if(payBtnAmount) payBtnAmount.innerText = `$${subtotal.toFixed(2)}`;

            // 2. Render Address
            let addressStr = "No address saved. Please add one in Settings.";
            try {
                const docSnap = await getDoc(doc(db, 'users', user.uid));
                if(docSnap.exists() && docSnap.data().preferences && docSnap.data().preferences.address) {
                    const a = docSnap.data().preferences.address;
                    const c = docSnap.data().preferences.defaultLocation;
                    if(a.street || c) {
                        addressStr = `
                            <p class="font-bold text-app-text">${user.displayName}</p>
                            <p>${a.street || ''} ${a.apt||''}</p>
                            <p>${a.city||''}, ${a.state||''} ${a.zip||''}</p>
                            <p>${c||''}</p>
                        `;
                    }
                }
            } catch(e) {}
            addressDiv.innerHTML = addressStr;

            // 3. Reset Payment UI (Default to Card)
            document.querySelector('input[name="payment_method"][value="stripe"]').checked = true;
            window.togglePaymentMethod('stripe');
        };

        window.togglePaymentMethod = (method) => {
            const stripeForm = document.getElementById('payment-form-stripe');
            const paypalForm = document.getElementById('payment-form-paypal');
            const paypalContainer = document.getElementById('paypal-page-container');

            if (!stripeForm || !paypalForm || !paypalContainer) return;

            if (method === 'stripe') {
                stripeForm.classList.remove('hidden');
                paypalForm.classList.add('hidden');
                paypalContainer.innerHTML = ''; // Clear to prevent duplicates
            } else {
                stripeForm.classList.add('hidden');
                paypalForm.classList.remove('hidden');
                
                if (paypalContainer.innerHTML.trim() === "" && window.paypal) {
                    try {
                        window.paypal.Buttons({
                            createOrder: function(data, actions) {
                                return actions.order.create({
                                    purchase_units: [{
                                        amount: { value: (checkoutTotalAmount || 0).toFixed(2) }
                                    }]
                                });
                            },
                            onApprove: function(data, actions) {
                                return actions.order.capture().then(function(details) {
                                    if (window.handlePaymentSuccess) window.handlePaymentSuccess(details);
                                });
                            },
                            onError: function(err) {
                                console.error('PayPal SDK Error:', err);
                                window.showToast("PayPal failed to load.", "error");
                            }
                        }).render('#paypal-page-container');
                    } catch (e) {
                        console.error("PayPal Render Crash:", e);
                    }
                }
            }
        };

        window.processStripePayment = async () => {
            const btn = document.getElementById('btn-pay-stripe');
            const originalHtml = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Connecting to Stripe...`;
            if (window.lucide) window.lucide.createIcons();

            try {
                // 1. Safety Check
                if (!Array.isArray(checkoutItemsBuffer) || checkoutItemsBuffer.length === 0) {
                    throw new Error("Cart is empty");
                }

                // 2. Persist State: Save items to localStorage so we can retrieve them after redirect
                localStorage.setItem('jace_pending_checkout', JSON.stringify(checkoutItemsBuffer));

                // 3. Dynamic URLs: Tell Stripe where to send the user back
                // (Note: Your backend Cloud Function must be updated to accept `success_url` and `cancel_url` from req.body)
                const currentOrigin = window.location.origin;
                const successUrl = `${currentOrigin}/?payment_status=success&session_id={CHECKOUT_SESSION_ID}`;
                const cancelUrl = `${currentOrigin}/?payment_status=canceled`;

                const res = await fetch(
                    "https://us-central1-jace-login-test.cloudfunctions.net/createCheckout",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            items: checkoutItemsBuffer,
                            success_url: successUrl, // Backend needs to use this
                            cancel_url: cancelUrl    // Backend needs to use this
                        })
                    }
                );

                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`Server error ${res.status}: ${text}`);
                }

                const data = await res.json();

                if (!data.url) {
                    throw new Error("Stripe did not return a checkout URL");
                }

                // 4. Redirect
                window.location.href = data.url;

            } catch (error) {
                console.warn("Stripe connection failed:", error);
                
                // If connection fails, try fallback demo mode or show error
                window.showToast("Connecting to Stripe failed. Using Demo Mode.", "info");
                
                // FALLBACK DEMO LOGIC (Optional - keep existing demo logic here if backend fails)
                await new Promise(resolve => setTimeout(resolve, 1500));
                const user = window.auth?.currentUser;
                const mockDetails = {
                    id: "STRIPE_DEMO_" + Date.now(),
                    payer: { name: { given_name: user?.displayName || "Stripe Guest" } }
                };
                await window.handlePaymentSuccess(mockDetails);
                localStorage.removeItem('jace_pending_checkout'); // Clean up

            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                if (window.lucide) window.lucide.createIcons();
            }
        };

        const originalHandleSuccess = window.handlePaymentSuccess; 
        window.handlePaymentSuccess = async (details) => {
            const user = auth.currentUser;
            const payerName = (details.payer && details.payer.name) ? details.payer.name.given_name : 'Buyer';
            
            const batch = writeBatch(db);
            const ordersBySeller = {};
            
            // 1. Group items by Seller
            checkoutItemsBuffer.forEach(item => {
                if (!item.sellerId) return;
                if(!ordersBySeller[item.sellerId]) {
                    ordersBySeller[item.sellerId] = { items: [], total: 0 };
                }
                ordersBySeller[item.sellerId].items.push(item);
                const itemTotal = (item.price * (item.quantity || 1));
                ordersBySeller[item.sellerId].total += itemTotal;

                // Stock Decrement
                if(item.productId) {
                    const prodRef = doc(db, 'users', item.sellerId, 'products', item.productId);
                    const qty = item.quantity || 1;
                    batch.update(prodRef, { stock: increment(-qty) });
                }
            });

            const addressDiv = document.getElementById('checkout-address-preview');
            const addressStr = addressDiv ? addressDiv.innerText : "Address not available";

            // 2. Process Orders & Transactions
            for (const [sellerId, data] of Object.entries(ordersBySeller)) {
                // A. Create Order Record
                const orderRef = doc(collection(db, 'orders'));
                batch.set(orderRef, {
                    orderId: orderRef.id,
                    sellerId: sellerId,
                    buyerId: user.uid,
                    buyerName: user.displayName || 'Guest',
                    buyerEmail: user.email || '',
                    buyerAvatar: user.photoURL || null,
                    items: data.items,
                    totalAmount: data.total,
                    status: 'paid', // Stays 'paid' until seller ships
                    shippingAddress: addressStr,
                    paypalOrderId: details.id || 'MOCK_ID',
                    timestamp: serverTimestamp()
                });

                // B. Create Notification
                const notifRef = doc(collection(db, 'users', sellerId, 'notifications'));
                const firstItem = data.items[0];
                const count = data.items.length - 1;
                batch.set(notifRef, {
                    type: 'purchase',
                    fromUserId: user.uid,
                    fromUsername: user.displayName || 'Guest',
                    fromUserAvatar: user.photoURL || null,
                    previewText: count > 0 ? `Sold: ${firstItem.title} (+${count} more)` : `Sold: ${firstItem.title}`,
                    read: false,
                    timestamp: serverTimestamp(),
                    orderId: orderRef.id
                });

                // REMOVED WALLET LOGIC FROM HERE (Moved to markAsShipped)
            }

            // 3. Clear Cart
            checkoutItemsBuffer.forEach(item => {
                if(item.id) { 
                    const cartRef = doc(db, 'users', user.uid, 'cart', item.id);
                    batch.delete(cartRef);
                }
            });

            try {
                await batch.commit();
                window.closeCheckoutModal();
                window.navigateTo('inbox');
                window.switchInboxTab('orders');
                window.showToast("Order placed successfully!", "success");
                checkoutItemsBuffer = [];
            } catch(e) {
                console.error("Order processing failed", e);
                if (e.code === 'not-found') {
                     window.showToast("Seller account setup incomplete, but order recorded.", "info");
                } else {
                     window.showToast("Payment captured but system error occurred.", "error");
                }
            }
        };

        window.setReviewRating = (val) => {
            currentReviewRating = val;
            const container = document.getElementById('review-star-input');
            const label = document.getElementById('rating-label');
            if (!container) return;
            
            const labels = ["Poor", "Fair", "Good", "Very Good", "Excellent"];
            if (label) label.textContent = labels[val-1];

            const btns = container.querySelectorAll('button');
            btns.forEach((btn, idx) => {
                const icon = btn.querySelector('i');
                if (idx < val) {
                    icon?.classList.add('fill-brand-orange', 'text-brand-orange');
                    icon?.classList.remove('text-gray-300');
                } else {
                    icon?.classList.remove('fill-brand-orange', 'text-brand-orange');
                    icon?.classList.add('text-gray-300');
                }
            });
        };

        window.submitProductReview = async (productId, sellerId) => {
            const user = auth.currentUser;
            if (!user) { window.showToast("Please login", "error"); return; }
            
            const textInput = document.getElementById('review-text');
            const text = textInput.value.trim();
            if (!text) { window.showToast("Please write a comment", "error"); return; }

            const btn = document.getElementById('btn-submit-review');
            btn.disabled = true; btn.innerText = "Submitting...";

            try {
                // 1. Get Product Details for the Denormalized Profile View
                const prodRef = doc(db, 'users', sellerId, 'products', productId);
                const prodSnap = await getDoc(prodRef);
                const prodData = prodSnap.exists() ? prodSnap.data() : { title: 'Product', images: [] };

                const reviewData = {
                    rating: currentReviewRating,
                    comment: text,
                    userId: user.uid,
                    username: user.displayName || 'User',
                    avatarUrl: user.photoURL || 'https://via.placeholder.com/100',
                    timestamp: serverTimestamp()
                };

                // 2. Add to Product Reviews Subcollection
                await addDoc(collection(db, 'users', sellerId, 'products', productId, 'reviews'), reviewData);

                // 3. Add to User's "Reviews Received" (for Profile Page aggregation)
                await addDoc(collection(db, 'users', sellerId, 'reviews_received'), {
                    ...reviewData,
                    productId: productId,
                    productTitle: prodData.title,
                    productImage: (prodData.images && prodData.images[0]) ? prodData.images[0] : null,
                    reviewerName: user.displayName || 'User',
                    reviewerAvatar: user.photoURL
                });

                window.showToast("Review submitted!", "success");
                // Hide form logic could be added here, or just reset
                document.getElementById('product-review-form-container').innerHTML = `
                    <div class="bg-green-100 border border-green-200 text-green-700 p-4 rounded-xl text-center text-sm font-bold">
                        Thanks for your review!
                    </div>
                `;

            } catch (e) {
                console.error("Review Submit Error", e);
                window.showToast("Failed to submit review", "error");
                btn.disabled = false; btn.innerText = "Submit Review";
            }
        };

        window.toggleReviewReply = (reviewId) => {
            const form = document.getElementById(`review-reply-form-${reviewId}`);
            if (form) form.classList.toggle('hidden');
        };

        window.submitReviewReply = async (reviewId, productId, sellerId) => {
            const input = document.getElementById(`reply-input-${reviewId}`);
            const text = input.value.trim();
            if (!text) return;

            try {
                const ref = doc(db, 'users', sellerId, 'products', productId, 'reviews', reviewId);
                await updateDoc(ref, {
                    reply: text,
                    replyTimestamp: serverTimestamp()
                });
                window.showToast("Reply posted", "success");
            } catch (e) {
                window.showToast("Failed to reply", "error");
            }
        };

                // --- WALLET LOGIC ---

        window.loadWalletData = async () => {
            const user = auth.currentUser;
            if(!user) return;

            const balanceAvail = document.getElementById('wallet-balance-available');
            const balancePend = document.getElementById('wallet-balance-pending');
            const balanceLife = document.getElementById('wallet-balance-lifetime');

            // 1. Process potential funds first
            await window.processPendingFunds(user.uid);

            // 2. Fetch User Doc for Balances
            try {
                const userSnap = await getDoc(doc(db, 'users', user.uid));
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    const wallet = data.wallet || { available: 0, pending: 0, lifetime: 0 };
                    
                    balanceAvail.innerText = formatCurrency(wallet.available);
                    balancePend.innerText = formatCurrency(wallet.pending);
                    balanceLife.innerText = formatCurrency(wallet.lifetime);
                }
            } catch(e) { console.error("Wallet fetch error", e); }

            // 3. Fetch Transactions
            if(window.reloadWalletActivity) window.reloadWalletActivity(user.uid);
        };

        // Helper to just reload the list
        window.reloadWalletActivity = async (userId) => {
            const activityList = document.getElementById('wallet-recent-activity');
            if(!activityList) return;
            
            try {
                const q = query(
                    collection(db, 'users', userId, 'transactions'),
                    orderBy('createdAt', 'desc'),
                    limit(10)
                );
                
                const snapshot = await getDocs(q);
                activityList.innerHTML = '';
                
                if (snapshot.empty) {
                    activityList.innerHTML = `<div class="text-center text-xs text-app-textMuted py-4">No recent activity</div>`;
                } else {
                    snapshot.forEach(doc => {
                        const t = doc.data();
                        const isCredit = t.type === 'sale' || t.type === 'adjustment';
                        const color = isCredit ? 'text-green-600' : 'text-app-text';
                        const sign = isCredit ? '+' : '-';
                        const icon = t.type === 'sale' ? 'shopping-bag' : 'arrow-up-right';
                        const bg = t.type === 'sale' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600';
                        
                        const statusBadge = t.status === 'pending' 
                            ? `<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded font-bold ml-2">Pending</span>` 
                            : '';

                        const div = document.createElement('div');
                        div.className = "flex items-center justify-between p-3 rounded-xl bg-app-bg border border-app-border";
                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full ${bg} flex items-center justify-center shrink-0">
                                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-app-text flex items-center">${t.description} ${statusBadge}</p>
                                    <p class="text-xs text-app-textMuted">${t.createdAt ? new Date(t.createdAt.toDate()).toLocaleString() : 'Date N/A'}</p>
                                </div>
                            </div>
                            <span class="${color} font-bold text-sm whitespace-nowrap">${sign}${formatCurrency(t.amount)}</span>
                        `;
                        activityList.appendChild(div);
                    });
                    if(window.lucide) window.lucide.createIcons();
                }
            } catch(e) { console.error("Transaction fetch error", e); }
        };

        window.processPendingFunds = async (inputUserId) => {
            const user = auth.currentUser;
            if(!user) return;

            // FIX: Use passed ID or default to current user's ID
            const userId = inputUserId || user.uid;

            // Visual feedback on the button
            const refreshBtn = document.querySelector('#settings-wallet-section button');
            let originalText = '';
            if(refreshBtn) {
                originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Checking...';
                refreshBtn.disabled = true;
                if(window.lucide) window.lucide.createIcons();
            }

            try {
                // 1. Query ALL pending transactions
                const q = query(
                    collection(db, 'users', userId, 'transactions'),
                    where('status', '==', 'pending')
                );

                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    if(refreshBtn) { refreshBtn.innerHTML = originalText; refreshBtn.disabled = false; }
                    return; 
                }

                const batch = writeBatch(db);
                let totalReleased = 0;
                let count = 0;
                const now = new Date();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Safe Date Conversion
                    let releaseDate;
                    if (data.releaseAt && typeof data.releaseAt.toDate === 'function') {
                        releaseDate = data.releaseAt.toDate(); 
                    } else if (data.releaseAt instanceof Date) {
                        releaseDate = data.releaseAt; 
                    } else if (typeof data.releaseAt === 'string') {
                        releaseDate = new Date(data.releaseAt);
                    } else {
                        return; 
                    }

                    // Check if ready to release
                    if (releaseDate <= now) {
                        const amount = parseFloat(data.amount) || 0;
                        totalReleased += amount;
                        
                        // Update Transaction Status
                        batch.update(doc.ref, { 
                            status: 'released', 
                            releasedAt: serverTimestamp() 
                        });
                        count++;
                    }
                });

                if (count > 0) {
                    // 2. Move Funds in Wallet
                    const userRef = doc(db, 'users', userId);
                    batch.update(userRef, {
                        'wallet.pending': increment(-totalReleased),
                        'wallet.available': increment(totalReleased)
                    });

                    await batch.commit();
                    window.showToast(`$${totalReleased.toFixed(2)} moved to Available!`, 'success');
                    
                    // 3. Force UI Refresh
                    const userSnap = await getDoc(userRef);
                    if(userSnap.exists()) {
                        const w = userSnap.data().wallet || {};
                        const availEl = document.getElementById('wallet-balance-available');
                        const pendEl = document.getElementById('wallet-balance-pending');
                        if(availEl) availEl.innerText = `$${(w.available || 0).toFixed(2)}`;
                        if(pendEl) pendEl.innerText = `$${(w.pending || 0).toFixed(2)}`;
                    }
                    
                    if(window.reloadWalletActivity) window.reloadWalletActivity(userId);

                } 

            } catch (e) {
                console.error("Pending funds processing error:", e);
                window.showToast("Error checking funds", "error");
            } finally {
                if(refreshBtn) {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                    if(window.lucide) window.lucide.createIcons();
                }
            }
        };

        // Analytics State
        let cachedAnalyticsData = { revenueByDate: {} }; 
        let currentChartType = 'bar';

        window.loadAnalyticsData = async () => {
            const user = auth.currentUser;
            if(!user) return;

            const revEl = document.getElementById('analytics-revenue');
            const ordEl = document.getElementById('analytics-orders');
            const viewEl = document.getElementById('analytics-views');
            const follEl = document.getElementById('analytics-followers');
            const chartEl = document.getElementById('analytics-chart-container');
            const prodListEl = document.getElementById('analytics-top-products');

            // 1. IMMEDIATE RENDER (Empty State)
            // Initialize last 30 days with 0 to show graph immediately
            let revenueByDate = {}; 
            for(let i=29; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                revenueByDate[key] = 0;
            }
            cachedAnalyticsData = { revenueByDate };
            // Render immediately so graph is visible even before data loads
            window.renderAnalyticsChart(currentChartType); 

            // Set specific loading states for text
            if(prodListEl) prodListEl.innerHTML = '<div class="text-center text-xs text-app-textMuted py-10">Loading data...</div>';
            if(window.lucide) window.lucide.createIcons();

            try {
                // --- 2. FETCH TRANSACTIONS (Revenue) ---
                const transQ = query(collection(db, 'users', user.uid, 'transactions'));
                const transSnap = await getDocs(transQ);
                
                let totalRevenue = 0;

                transSnap.forEach(doc => {
                    const t = doc.data();
                    if ((t.type === 'sale' || t.type === 'adjustment') && t.amount) {
                        const amount = parseFloat(t.amount);
                        if(isNaN(amount)) return;

                        totalRevenue += amount;
                        
                        let dateKey = null;
                        if(t.createdAt && typeof t.createdAt.toDate === 'function') {
                            dateKey = t.createdAt.toDate().toISOString().split('T')[0];
                        } else if (t.timestamp && typeof t.timestamp.toDate === 'function') {
                             dateKey = t.timestamp.toDate().toISOString().split('T')[0];
                        }

                        if(dateKey && revenueByDate[dateKey] !== undefined) {
                            revenueByDate[dateKey] += amount;
                        }
                    }
                });

                if(revEl) revEl.innerText = formatCurrency(totalRevenue);

                // Update Cache and Re-render with REAL data
                cachedAnalyticsData = { revenueByDate };
                window.renderAnalyticsChart(currentChartType);

                // --- 3. FETCH ORDERS (Count & Top Products) ---
                const ordersQ = query(collection(db, 'orders'), where('sellerId', '==', user.uid));
                const ordersSnap = await getDocs(ordersQ);
                
                let totalOrders = ordersSnap.size;
                if(ordEl) ordEl.innerText = totalOrders;

                const productCounts = {}; 
                ordersSnap.forEach(doc => {
                    const o = doc.data();
                    if(o.items && Array.isArray(o.items)) {
                        o.items.forEach(item => {
                            const pid = item.productId || item.id || 'unknown'; 
                            if(!productCounts[pid]) {
                                productCounts[pid] = { 
                                    title: item.title || 'Unknown Item', 
                                    image: item.image || '', 
                                    count: 0, 
                                    revenue: 0 
                                };
                            }
                            productCounts[pid].count += (parseInt(item.quantity) || 1);
                            productCounts[pid].revenue += (parseFloat(item.price) * (parseInt(item.quantity)||1));
                        });
                    }
                });

                const sortedProds = Object.values(productCounts).sort((a,b) => b.revenue - a.revenue).slice(0, 5);
                
                if(prodListEl) {
                    prodListEl.innerHTML = '';
                    if(sortedProds.length === 0) {
                        prodListEl.innerHTML = '<div class="text-center text-xs text-app-textMuted py-4">No sales yet.</div>';
                    } else {
                        sortedProds.forEach((p, idx) => {
                            const row = document.createElement('div');
                            row.className = "flex items-center gap-3 border-b border-app-border/50 pb-3 last:border-0 animate-fade-in";
                            row.innerHTML = `
                                <span class="text-xs font-bold text-app-textMuted w-4">#${idx+1}</span>
                                <div class="w-10 h-10 bg-gray-100 rounded-lg overflow-hidden shrink-0 border border-app-border">
                                    <img src="${p.image || 'https://via.placeholder.com/150'}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold text-app-text truncate">${p.title}</p>
                                    <p class="text-[10px] text-app-textMuted">${p.count} sold</p>
                                </div>
                                <span class="text-xs font-bold text-brand-teal">${formatCurrency(p.revenue)}</span>
                            `;
                            prodListEl.appendChild(row);
                        });
                    }
                }

                // --- 4. FETCH USER STATS ---
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if(userDoc.exists()) {
                    const stats = userDoc.data().stats || {};
                    if(follEl) follEl.innerText = formatNumber(stats.followers || 0);
                }

                try {
                    const vidSnap = await getAggregateFromServer(query(collection(db, 'users', user.uid, 'videos')), {
                        totalViews: sum('views')
                    });
                    if(viewEl) viewEl.innerText = formatNumber(vidSnap.data().totalViews || 0);
                } catch(err) { }

            } catch(e) {
                console.error("Analytics error", e);
            }
        };

        window.switchChartType = (type) => {
            currentChartType = type;
            // Update UI buttons
            const btnBar = document.getElementById('chart-btn-bar');
            const btnLine = document.getElementById('chart-btn-line');
            
            if(type === 'bar') {
                btnBar.className = "px-3 py-1 text-xs font-bold bg-app-text text-app-bg rounded shadow-sm transition-all";
                btnLine.className = "px-3 py-1 text-xs font-bold text-app-textMuted hover:text-app-text transition-all";
            } else {
                btnLine.className = "px-3 py-1 text-xs font-bold bg-app-text text-app-bg rounded shadow-sm transition-all";
                btnBar.className = "px-3 py-1 text-xs font-bold text-app-textMuted hover:text-app-text transition-all";
            }
            
            window.renderAnalyticsChart(type);
        };

        window.renderAnalyticsChart = (type) => {
            const chartEl = document.getElementById('analytics-chart-container');
            if(!chartEl) {
                console.error("Graph container #analytics-chart-container not found!");
                return;
            }
            
            const data = cachedAnalyticsData.revenueByDate;
            if(!data) {
                chartEl.innerHTML = '<div class="flex items-center justify-center h-full text-xs text-app-textMuted">No data available</div>';
                return;
            }

            const dates = Object.keys(data).sort();
            const values = Object.values(data);
            
            // Determine Scale
            let maxVal = Math.max(...values);
            if(maxVal === 0) maxVal = 100; 

            chartEl.innerHTML = '';

            if (type === 'bar') {
                // BAR CHART
                chartEl.className = "flex-1 w-full flex items-end justify-between px-2 gap-[1px] min-h-0 relative"; // Ensure flex layout

                dates.forEach((date, idx) => {
                    const val = data[date];
                    const heightPct = (val / maxVal) * 100;
                    
                    const barGroup = document.createElement('div');
                    barGroup.className = "flex-1 flex flex-col justify-end items-center group relative h-full hover:bg-app-hover/50 rounded-sm transition-colors cursor-crosshair";
                    
                    // Min height 4% for visibility if 0 but valid date
                    const displayHeight = val > 0 ? Math.max(heightPct, 4) : 4;
                    const colorClass = val > 0 ? "bg-brand-teal/80" : "bg-gray-200 dark:bg-zinc-800";

                    barGroup.innerHTML = `
                        <div class="w-full rounded-t-sm transition-all duration-500 relative ${colorClass}" style="height: ${displayHeight}%"></div>
                        <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20 pointer-events-none shadow-lg">
                            ${date.slice(5)}: ${formatCurrency(val)}
                        </div>
                    `;
                    chartEl.appendChild(barGroup);
                });
            } else {
                // LINE CHART
                chartEl.className = "flex-1 w-full relative min-h-0 block"; // Reset to block for SVG

                const width = 100;
                const height = 100;
                
                const points = values.map((val, idx) => {
                    const x = (idx / (values.length - 1)) * width;
                    const y = height - ((val / maxVal) * height);
                    return `${x},${y}`;
                }).join(' ');

                const fillPoints = `0,${height} ${points} ${width},${height}`;

                const svg = `
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full overflow-visible">
                        <defs>
                            <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="var(--app-text)" stop-opacity="0.2"/>
                                <stop offset="100%" stop-color="var(--app-text)" stop-opacity="0"/>
                            </linearGradient>
                        </defs>
                        <path d="M${fillPoints}" fill="url(#chartGradient)" stroke="none" />
                        <polyline points="${points}" fill="none" stroke="var(--app-text)" stroke-width=".5" stroke-linecap="round" stroke-linejoin="round" />
                        ${dates.map((date, idx) => {
                            const val = data[date];
                            const x = (idx / (values.length - 1)) * 100;
                            return `<rect x="${x - 2}" y="0" width="4" height="100" fill="transparent" class="group hover:fill-app-text/5 cursor-pointer"><title>${date}: ${formatCurrency(val)}</title></rect>`;
                        }).join('')}
                    </svg>
                `;
                chartEl.innerHTML = svg;
            }
        };

        window.checkUserRole = async (userId) => {
            try {
                onSnapshot(doc(db, 'config', 'roles'), (docSnap) => {
                    const btn = document.getElementById('nav-admin');
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const admins = data.admins || {};
                        const mods = data.mods || {};
                        
                        currentUserRole.admin = !!admins[userId];
                        currentUserRole.mod = !!mods[userId];

                        if (currentUserRole.admin || currentUserRole.mod) {
                            btn.classList.remove('hidden');
                            btn.classList.add('flex');
                        } else {
                            btn.classList.add('hidden');
                            btn.classList.remove('flex');
                        }
                    } else {
                        // If config/roles doesn't exist, hide button
                        btn.classList.add('hidden');
                        btn.classList.remove('flex');
                    }
                });
            } catch (e) {
                console.warn("Role check failed", e);
            }
        };

        window.switchAdminTab = (tab) => {
            // Known views
            const views = ['reports', 'roles', 'support', 'users'];
            
            // 1. Manage Views Visibility
            views.forEach(v => {
                const el = document.getElementById(`admin-view-${v}`);
                if (el) {
                    if (v === tab) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            });

            // 2. Manage Top Tabs Styles (Active state)
            // If tab is 'users', we effectively DESELECT all top tabs
            const topTabs = ['reports', 'support', 'roles'];
            topTabs.forEach(t => {
                const btn = document.getElementById(`admin-tab-${t}`);
                if (btn) {
                    if (t === tab) {
                        // Active style
                        btn.className = "px-6 py-2 rounded-lg text-sm font-bold bg-app-text text-app-bg shadow-sm transition-all";
                    } else {
                        // Inactive style
                        btn.className = "px-6 py-2 rounded-lg text-sm font-bold text-app-textMuted hover:text-app-text transition-all";
                    }
                }
            });

            // 3. Clear/Reset Bottom Filter Styles if NOT in users mode
            if (tab !== 'users') {
                ['bans', 'strikes', 'warns'].forEach(t => {
                    const btn = document.getElementById(`user-filter-${t}`);
                    if (btn) {
                        btn.classList.remove('bg-app-text', 'text-app-bg');
                        btn.classList.add('text-app-textMuted', 'hover:text-app-text');
                    }
                });
            }

            // 4. Load Data
            if (tab === 'reports') window.loadReports();
            else if (tab === 'roles') window.loadRolesList();
            else if (tab === 'support') window.loadSupportTickets();
            else if (tab === 'users') window.loadPunishedUsers();
        };

        window.currentPunishFilter = 'bans';
        window.filterPunishedUsers = (type) => {
            // 1. Switch main view to 'users' (This deselects top tabs)
            window.switchAdminTab('users');
            
            window.currentPunishFilter = type;
            const types = ['bans', 'strikes', 'warns'];
            
            // 2. Update Bottom Bar Styles
            types.forEach(t => {
                const btn = document.getElementById(`user-filter-${t}`);
                if(!btn) return;

                if(t === type) {
                    // Active: Dark background, light text
                    btn.classList.remove('text-app-textMuted', 'hover:text-app-text');
                    btn.classList.add('bg-app-text', 'text-app-bg');
                } else {
                    // Inactive: Transparent background, muted text
                    btn.classList.remove('bg-app-text', 'text-app-bg');
                    btn.classList.add('text-app-textMuted', 'hover:text-app-text');
                }
            });

            window.loadPunishedUsers();
        };

        window.loadPunishedUsers = async () => {
            const list = document.getElementById('admin-users-list');
            list.innerHTML = '<div class="text-center py-10 text-app-textMuted"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Fetching users...</div>';
            if(window.lucide) window.lucide.createIcons();

            try {
                let q;
                const usersRef = collection(db, 'users');

                if (window.currentPunishFilter === 'bans') {
                    q = query(usersRef, where('isBanned', '==', true));
                } else if (window.currentPunishFilter === 'strikes') {
                    q = query(usersRef, where('moderation.strikes', '>', 0));
                } else if (window.currentPunishFilter === 'warns') {
                    q = query(usersRef, where('moderation.warnings', '>', 0));
                } else {
                    q = query(usersRef, where('isBanned', '==', true)); // Default fallback
                }

                const snapshot = await getDocs(q);
                list.innerHTML = '';

                if (snapshot.empty) {
                    list.innerHTML = `<div class="text-center py-20 text-app-textMuted">No users found with active ${window.currentPunishFilter}.</div>`;
                    return;
                }

                snapshot.forEach(docSnap => {
                    const u = docSnap.data();
                    const profile = u.profile || {};
                    const mod = u.moderation || {};
                    
                    let statusBadge = '';
                    if (u.isBanned) statusBadge = `<span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold uppercase">Banned</span>`;
                    else if (mod.strikes > 0) statusBadge = `<span class="bg-orange-100 text-orange-600 px-2 py-1 rounded text-xs font-bold uppercase">${mod.strikes} Strikes</span>`;
                    else if (mod.warnings > 0) statusBadge = `<span class="bg-yellow-100 text-yellow-600 px-2 py-1 rounded text-xs font-bold uppercase">${mod.warnings} Warnings</span>`;

                    const div = document.createElement('div');
                    div.className = "bg-app-card border border-app-border rounded-xl p-4 flex items-center gap-4 hover:border-brand-teal/50 transition-colors group";
                    
                    div.innerHTML = `
                        <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden shrink-0">
                            <img src="${window.getAvatar(profile.photoUrl, profile.username)}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <h4 class="font-bold text-app-text text-sm">@${profile.username || 'Unknown'}</h4>
                                ${statusBadge}
                            </div>
                            <p class="text-xs text-app-textMuted font-mono">UID: ${docSnap.id}</p>
                            ${u.banReason ? `<p class="text-xs text-red-500 mt-1 italic">Reason: ${u.banReason}</p>` : ''}
                        </div>
                        <button onclick="window.openModerationPanel('${docSnap.id}', null, 'Admin List', 'Review Status', null, null, null)" class="px-4 py-2 bg-app-bg border border-app-border rounded-lg text-xs font-bold hover:bg-app-hover transition-colors">
                            Manage
                        </button>
                    `;
                    list.appendChild(div);
                });
                if(window.lucide) window.lucide.createIcons();

            } catch (e) {
                console.error("Load Punished Users Error:", e);
                list.innerHTML = `<div class="text-center text-red-500 py-10">Error loading data: ${e.message}</div>`;
            }
        };

        window.filterReports = (type) => {
            window.currentReportFilter = type;
            
            // Update Button Styles
            document.querySelectorAll('.report-filter-btn').forEach(btn => {
                if(btn.dataset.type === type) {
                    btn.classList.remove('bg-app-card', 'border', 'text-app-textMuted', 'hover:text-app-text');
                    btn.classList.add('bg-app-text', 'text-app-bg');
                } else {
                    btn.classList.add('bg-app-card', 'border', 'text-app-textMuted', 'hover:text-app-text');
                    btn.classList.remove('bg-app-text', 'text-app-bg');
                }
            });

            // Reload triggers the client-side filter
            window.loadReports();
        };

        window.loadReports = () => {
            if (window.unsubscribeReports) window.unsubscribeReports();
            const list = document.getElementById('admin-reports-list');
            list.innerHTML = '<div class="text-center py-10 text-app-textMuted"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading reports...</div>';
            
            const q = query(collection(db, 'reports'), orderBy('timestamp', 'desc'));
            
            window.unsubscribeReports = onSnapshot(q, (snapshot) => {
                list.innerHTML = '';
                let reports = [];
                snapshot.forEach(docSnap => { reports.push({ id: docSnap.id, ...docSnap.data() }); });

                if (window.currentReportFilter !== 'all') {
                    reports = reports.filter(r => r.targetType === window.currentReportFilter);
                }

                if (reports.length === 0) {
                    list.innerHTML = '<div class="text-center py-10 text-app-textMuted">No pending reports found.</div>';
                    return;
                }

                reports.forEach(r => {
                    let targetPath = r.targetPath || '';
                    // If path is missing, try to build it now for display/action logic
                    if ((!targetPath || targetPath.includes('undefined')) && r.reportedUserId && r.targetId && r.targetId !== 'undefined') {
                        if(r.targetType === 'video') targetPath = `users/${r.reportedUserId}/videos/${r.targetId}`; 
                        else if(r.targetType === 'product') targetPath = `users/${r.reportedUserId}/products/${r.targetId}`;
                    }

                    let contentUrl = '#';
                    let contentUrlDisplay = 'N/A';
                    let isBroken = (!r.targetId || r.targetId === 'undefined');

                    if (!isBroken) {
                        if(r.targetType === 'video') {
                            contentUrl = `${window.location.origin}/${r.reportedUsername}/video/${r.targetId}`;
                            contentUrlDisplay = `View Video`;
                        } 
                        else if(r.targetType === 'product') {
                            contentUrl = `${window.location.origin}/product/${r.targetId}?seller=${r.reportedUserId}`;
                            contentUrlDisplay = `View Product`;
                        }
                    }

                    const safeContext = (r.contextSnapshot || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
                    const safeReason = (r.reason || '').replace(/'/g, "\\'");
                    const safePath = targetPath || '';

                    const div = document.createElement('div');
                    div.className = "bg-app-card border border-app-border rounded-xl p-5 shadow-sm animate-fade-in mb-4";
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="inline-block bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded mb-2 uppercase tracking-wide">${r.targetType}</span>
                                ${isBroken ? '<span class="inline-block bg-gray-200 text-gray-700 text-xs font-bold px-2 py-1 rounded mb-2 ml-2">BROKEN ID</span>' : ''}
                                <p class="font-bold text-app-text">Reason: ${r.reason}</p>
                                <p class="text-sm text-app-textMuted">Details: ${r.details || 'None'}</p>
                            </div>
                            <div class="text-right text-xs text-app-textMuted">
                                <p>${r.timestamp?.toDate ? r.timestamp.toDate().toLocaleString() : 'Just now'}</p>
                                <p>Reporter: ${r.reporterUsername || 'Unknown'}</p>
                            </div>
                        </div>
                        
                        <div class="bg-app-bg p-3 rounded-lg border border-app-border text-sm font-mono text-app-text mb-4 whitespace-pre-wrap max-h-40 overflow-y-auto">
                            <div class="flex justify-between mb-2 border-b border-app-border pb-2">
                                <span class="font-bold text-xs text-app-textMuted uppercase">Context</span>
                                ${!isBroken ? `<a href="${contentUrl}" target="_blank" class="text-blue-500 hover:underline text-xs font-bold">${contentUrlDisplay}</a>` : '<span class="text-red-500 text-xs font-bold">Link Unavailable</span>'}
                            </div>
                            ${r.contextSnapshot || 'No context available'}
                        </div>

                        <div class="flex flex-wrap gap-3 pt-3 border-t border-app-border items-center">
                            <div class="flex items-center gap-2 mr-auto cursor-pointer hover:opacity-80" onclick="window.navigateTo('user/${r.reportedUsername}')">
                                <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden border border-app-border">
                                    <img src="https://ui-avatars.com/api/?name=${r.reportedUsername}&background=random" class="w-full h-full object-cover">
                                </div>
                                <div class="text-xs">
                                    <span class="block font-bold text-red-500">Reported</span>
                                    <span class="block text-app-text font-bold">@${r.reportedUsername}</span>
                                </div>
                            </div>

                            <button onclick="window.handleResolveReport('${r.id}')" class="px-4 py-2 bg-app-hover text-app-text font-bold rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-xs">Dismiss</button>
                            
                            ${!isBroken ? `
                            <button onclick="window.openModerationPanel('${r.reportedUserId}', '${r.id}', '${safeContext}', '${safeReason}', '${safePath}', '${r.targetType}', '${r.targetId}')" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-lg transition-colors text-xs flex items-center gap-1">
                                <i data-lucide="shield-alert" class="w-3 h-3"></i> Moderate
                            </button>` : 
                            `<button disabled class="px-4 py-2 bg-gray-300 text-gray-500 font-bold rounded-lg text-xs cursor-not-allowed">Cannot Moderate</button>`}

                            ${(targetPath && !targetPath.includes('undefined')) ? `<button onclick="window.handleAdminDeleteContent('${targetPath}', '${r.id}', '${r.targetType}')" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors text-xs">Delete Content</button>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                });
                if(window.lucide) window.lucide.createIcons();
            });
        };

        window.loadSupportTickets = () => {
            if (window.unsubscribeSupportTickets) window.unsubscribeSupportTickets();
            const list = document.getElementById('admin-support-list');
            list.innerHTML = '<div class="text-center py-10 text-app-textMuted"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading tickets...</div>';
            if(window.lucide) window.lucide.createIcons();

            // Use simple query to avoid index issues
            const q = query(collection(db, 'support_tickets'), orderBy('timestamp', 'desc'));

            window.unsubscribeSupportTickets = onSnapshot(q, (snapshot) => {
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center py-10 text-app-textMuted">No support tickets found.</div>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const t = { id: docSnap.id, ...docSnap.data() };
                    const div = document.createElement('div');
                    div.className = "bg-app-card border border-app-border rounded-xl p-5 shadow-sm animate-fade-in mb-4"; // Added mb-4
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <span class="inline-block bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded mb-1 uppercase tracking-wide">${t.topic}</span>
                                <h4 class="font-bold text-app-text">${t.contactName} <span class="text-app-textMuted font-normal text-xs">(${t.contactEmail})</span></h4>
                            </div>
                            <span class="text-xs text-app-textMuted">${t.timestamp?.toDate ? t.timestamp.toDate().toLocaleString() : 'Just now'}</span>
                        </div>
                        <div class="bg-app-bg p-3 rounded-lg border border-app-border text-sm text-app-text mb-4">
                            ${t.message}
                        </div>
                        <div class="flex gap-2 justify-end">
                            <a href="mailto:${t.contactEmail}?subject=Re: ${t.topic} (JACE Support)" class="px-4 py-2 bg-brand-teal text-white font-bold rounded-lg hover:bg-brand-teal/90 text-xs flex items-center gap-2">
                                <i data-lucide="mail" class="w-3 h-3"></i> Reply via Email
                            </a>
                            <button onclick="deleteDoc(doc(db, 'support_tickets', '${t.id}'))" class="px-4 py-2 border border-app-border rounded-lg hover:bg-app-hover text-xs font-bold text-red-500">Close Ticket</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
                if(window.lucide) window.lucide.createIcons();
            }, (error) => {
                console.error("Load Tickets Error:", error);
                list.innerHTML = `<div class="text-center text-red-500 py-10">Error loading tickets: ${error.message}</div>`;
            });
        };

        window.handleResolveReport = async (reportId) => {
            if(!confirm("Dismiss this report?")) return;
            try {
                await deleteDoc(doc(db, 'reports', reportId));
                window.showToast("Report dismissed.", "success");
            } catch(e) { console.error(e); window.showToast("Error dismissing report", "error"); }
        };

        window.handleAdminDeleteContent = (path, reportId, type) => {
            // This is for the direct "Delete Content" button on the Report Card
            window.openConfirmModal(
                `Delete ${type}?`, 
                `Confirm deleting: ${path}`,
                async () => {
                    try {
                        console.log(`[Admin Direct] Deleting: ${path}`);
                        
                        // 1. Nested Delete
                        const ref = doc(db, path);
                        const snap = await getDoc(ref);
                        if (!snap.exists()) {
                            console.warn("Doc not found at path. Already deleted?");
                            window.showToast("Document not found (check console)", "warning");
                        } else {
                            await deleteDoc(ref);
                            console.log("Nested doc deleted.");
                        }

                        // 2. Root Delete (If Video)
                        if (type === 'video') {
                            // Extract ID from path: users/{uid}/videos/{id}
                            const parts = path.split('/');
                            const videoId = parts[parts.length - 1]; // Last part is ID
                            if (videoId) {
                                await deleteDoc(doc(db, 'videos', videoId));
                                console.log(`Root video ${videoId} deleted.`);
                            }
                        }
                        
                        // 3. Resolve Report
                        if (reportId) {
                            await deleteDoc(doc(db, 'reports', reportId));
                        }
                        
                        window.showToast(`${type} deleted & report resolved.`, "success");
                        
                    } catch(e) {
                        console.error("Admin Delete Failed", e);
                        if (e.code === 'permission-denied') {
                            window.showToast("Permission Denied (Rules).", "error");
                        } else {
                            window.showToast(`Error: ${e.message}`, "error");
                        }
                    }
                },
                "Delete Now"
            );
        };

        let adminSearchTimeout = null;
        window.handleAdminUserSearch = (queryStr) => {
            clearTimeout(adminSearchTimeout);
            const container = document.getElementById('admin-user-search-results');
            const inputStr = queryStr.trim().toLowerCase();

            if (!inputStr) {
                container.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            adminSearchTimeout = setTimeout(async () => {
                container.classList.remove('hidden');
                container.innerHTML = '<div class="p-4 text-center text-xs text-app-textMuted"><i data-lucide="loader-2" class="w-4 h-4 animate-spin mx-auto mb-1"></i>Searching...</div>';
                if(window.lucide) window.lucide.createIcons();

                try {
                    // Optimized for demo: Fetch all users and filter client-side.
                    // In production, use Firestore indices or a search service.
                    const q = query(collection(db, 'users')); 
                    const snapshot = await getDocs(q);
                    
                    const matches = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const uname = d.profile?.username || '';
                        const uemail = d.profile?.email || '';
                        
                        if (uname.toLowerCase().includes(inputStr) || uemail.toLowerCase().includes(inputStr)) {
                            matches.push({ id: doc.id, ...d.profile });
                        }
                    });

                    container.innerHTML = '';
                    
                    if (matches.length === 0) {
                        container.innerHTML = '<div class="p-3 text-center text-xs text-app-textMuted">No users found.</div>';
                        return;
                    }

                    matches.forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-3 p-3 hover:bg-app-hover cursor-pointer border-b border-app-border/50 last:border-0 transition-colors';
                        
                        // Click opens Moderation Panel in "Manual" mode
                        div.onclick = () => {
                            window.openModerationPanel(u.id, null, 'Manual Admin Search', 'Manual Review', null, null, null);
                            container.classList.add('hidden');
                            // Clear input
                            document.querySelector('input[oninput="window.handleAdminUserSearch(this.value)"]').value = '';
                        };
                        
                        div.innerHTML = `
                            <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden shrink-0">
                                <img src="${u.photoUrl || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-bold text-app-text truncate">@${u.username}</p>
                                <p class="text-[10px] text-app-textMuted truncate">${u.email || 'No Email'}</p>
                            </div>
                            <div class="px-2 py-1 bg-brand-orange/10 text-brand-orange rounded text-[10px] font-bold">Moderate</div>
                        `;
                        container.appendChild(div);
                    });

                } catch (e) {
                    console.error("Admin search failed", e);
                    container.innerHTML = '<div class="p-3 text-center text-xs text-red-500">Search error.</div>';
                }
            }, 500);
        };

        window.currentModTarget = null; // { userId, reportId, context, violation }
        window.openModerationPanel = async (userId, reportId, context, violation, targetPath, targetType, targetId) => {
            window.currentModTarget = { userId, reportId, context, violation, targetPath, targetType, targetId };
            
            const panel = document.getElementById('moderation-panel');
            const nameEl = document.getElementById('mod-user-name');
            const idEl = document.getElementById('mod-user-id');
            const avatarEl = document.getElementById('mod-user-avatar');
            const contextEl = document.getElementById('mod-context-display');
            const violationEl = document.getElementById('mod-violation-reason');
            const statsEl = document.getElementById('mod-user-stats');

            // Reset/Clear previous injected buttons
            const existingUnbanBtn = document.getElementById('mod-force-unban-btn');
            if(existingUnbanBtn) existingUnbanBtn.remove();

            panel.classList.remove('translate-x-full');
            
            idEl.textContent = `UID: ${userId}`;
            contextEl.textContent = context || 'No context provided.';
            violationEl.textContent = violation || 'Policy Violation';
            
            nameEl.textContent = 'Loading...';
            avatarEl.src = 'https://via.placeholder.com/100';
            statsEl.innerHTML = 'Loading stats...';
            
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if(userDoc.exists()) {
                    const data = userDoc.data();
                    nameEl.textContent = `@${data.profile?.username || 'Unknown'}`;
                    avatarEl.src = data.profile?.photoUrl || 'https://via.placeholder.com/100';
                    const followers = data.stats?.followers || 0;
                    const created = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    
                    let statsHtml = `<span>Joined: ${created}</span> <span>â¢</span> <span>${followers} Followers</span>`;

                    // --- ACTIVE BAN INDICATOR & UNBAN BUTTON ---
                    const isBanned = data.isBanned === true;
                    const bannedUntil = data.bannedUntil ? data.bannedUntil.toDate() : null;
                    const isTempBanned = bannedUntil && bannedUntil > new Date();
                    
                    if (isBanned || isTempBanned) {
                        let banText = "Actively Banned (Permanent)";
                        if (isTempBanned) banText = `Suspended until ${bannedUntil.toLocaleDateString()}`;
                        
                        statsHtml += `
                            <div class="mt-2 w-full bg-red-100 text-red-700 px-3 py-2 rounded-lg text-xs font-bold border border-red-200 flex items-center justify-between gap-2 animate-pulse">
                                <span class="flex items-center gap-2"><i data-lucide="ban" class="w-4 h-4"></i> ${banText}</span>
                            </div>
                        `;

                        // Inject "Lift Ban" button into the Action Controls area
                        const controlsDiv = document.querySelector('#moderation-panel .bg-app-bg.border.border-app-border.rounded-xl.p-4.mb-4');
                        if (controlsDiv) {
                            const unbanBtn = document.createElement('button');
                            unbanBtn.id = 'mod-force-unban-btn';
                            unbanBtn.className = "mt-3 w-full flex items-center justify-center p-3 bg-green-600 text-white hover:bg-green-700 rounded-xl transition-all font-bold text-sm gap-2 shadow-lg shadow-green-600/20";
                            unbanBtn.innerHTML = `<i data-lucide="shield-check" class="w-5 h-5"></i> Lift Ban (Force Unban)`;
                            unbanBtn.onclick = () => window.handleLiftBan(userId);
                            controlsDiv.appendChild(unbanBtn);
                        }
                    }
                    statsEl.innerHTML = statsHtml;
                    if(window.lucide) window.lucide.createIcons();
                }
            } catch(e) {
                nameEl.textContent = 'User Not Found';
            }

            window.loadModerationLogs(userId);
        };

        window.closeModerationPanel = () => {
            document.getElementById('moderation-panel').classList.add('translate-x-full');
            window.currentModTarget = null;
        };

        window.loadModerationLogs = (userId) => {
            const logContainer = document.getElementById('mod-history-log');
            logContainer.innerHTML = '<div class="text-center text-xs text-app-textMuted py-2">Loading...</div>';
            
            const q = query(collection(db, 'users', userId, 'moderation_logs'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                logContainer.innerHTML = '';
                if(snapshot.empty) {
                    logContainer.innerHTML = '<div class="text-center text-xs text-app-textMuted py-4 bg-app-card rounded-lg border border-app-border">Clean Record</div>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const log = doc.data();
                    let color = 'text-gray-500';
                    if(log.type === 'warn' || log.type === 'warning') color = 'text-yellow-500';
                    if(log.type === 'strike') color = 'text-orange-500';
                    if(log.type === 'ban') color = 'text-red-500';
                    
                    const div = document.createElement('div');
                    div.className = "text-xs p-3 bg-app-card border border-app-border rounded-lg relative group";
                    div.innerHTML = `
                        <div class="flex justify-between mb-1">
                            <span class="font-bold uppercase ${color}">${log.type}</span>
                            <span class="text-app-textMuted">${log.timestamp?.toDate ? log.timestamp.toDate().toLocaleDateString() : 'N/A'}</span>
                        </div>
                        <p class="text-app-text mb-1">${log.reason || 'No reason logged'}</p>
                        <div class="flex justify-between items-center">
                            <p class="text-[10px] text-app-textMuted">Admin: ${log.adminId || 'System'}</p>
                            <button onclick="window.deleteModerationLog('${userId}', '${doc.id}', '${log.type}')" class="text-red-500 hover:text-red-700 hover:bg-red-50 rounded px-2 py-0.5 opacity-0 group-hover:opacity-100 transition-opacity font-bold">Remove</button>
                        </div>
                    `;
                    logContainer.appendChild(div);
                });
            });
        };

        window.handleModAction = async (action) => {
            if(!window.currentModTarget) return;
            
            const { userId, context, targetPath, targetType, targetId, reportId } = window.currentModTarget;
            const adminUser = auth.currentUser;
            const actionTitle = action.charAt(0).toUpperCase() + action.slice(1);
            
            // --- Gather Reason ---
            const violationType = document.getElementById('mod-violation-type') ? document.getElementById('mod-violation-type').value : 'General Violation';
            const customReason = document.getElementById('mod-violation-custom') ? document.getElementById('mod-violation-custom').value.trim() : '';
            
            let finalReason = violationType;
            if (customReason) finalReason += `: ${customReason}`;
            // ---------------------

            // Duration Logic
            const durationVal = document.getElementById('mod-ban-duration') ? document.getElementById('mod-ban-duration').value : '24h';
            let banExpiryDate = null;
            let banLabel = "Permanent";

            if (action === 'ban') {
                if (durationVal !== 'permanent') {
                    banExpiryDate = new Date();
                    if (durationVal === '24h') banExpiryDate.setTime(banExpiryDate.getTime() + (24 * 60 * 60 * 1000));
                    if (durationVal === '3d') banExpiryDate.setTime(banExpiryDate.getTime() + (3 * 24 * 60 * 60 * 1000));
                    if (durationVal === '7d') banExpiryDate.setTime(banExpiryDate.getTime() + (7 * 24 * 60 * 60 * 1000));
                    if (durationVal === '30d') banExpiryDate.setTime(banExpiryDate.getTime() + (30 * 24 * 60 * 60 * 1000));
                    banLabel = `until ${banExpiryDate.toLocaleDateString()}`;
                }
            }

            let finalPath = targetPath;
            if ((!finalPath || finalPath === 'null' || finalPath.includes('undefined')) && userId && targetType && targetId && targetId !== 'undefined') {
                if (targetType === 'video') finalPath = `users/${userId}/videos/${targetId}`;
                else if (targetType === 'product') finalPath = `users/${userId}/products/${targetId}`;
            }

            let warningMsg = `Issue ${action.toUpperCase()}?\nReason: ${finalReason}`;
            if (action === 'ban') warningMsg += `\nDuration: ${durationVal.toUpperCase()}`;
            
            const shouldDelete = (finalPath && (action === 'strike' || action === 'ban'));
            if (shouldDelete) warningMsg += `\n\nâ ï¸ Content will be DELETED.`;

            window.openConfirmModal(
                `Confirm ${actionTitle}`, 
                warningMsg,
                async () => {
                    const btn = document.getElementById('confirm-yes-btn');
                    if(btn) { btn.disabled = true; btn.innerText = "Processing..."; }

                    try {
                        if (shouldDelete) {
                            try {
                                await deleteDoc(doc(db, finalPath));
                                if (targetType === 'video' && targetId) { await deleteDoc(doc(db, 'videos', targetId)); }
                            } catch (e) { console.error("Content delete error", e); }
                        }

                        const batch = writeBatch(db);
                        const timestamp = serverTimestamp();

                        // Notify
                        const notifRef = doc(collection(db, 'users', userId, 'system_notifications'));
                        let title = "Account Update";
                        let notifBody = finalReason;
                        
                        if (action === 'warn') title = "â ï¸ Account Warning";
                        else if (action === 'strike') title = "â¡ Community Guidelines Strike";
                        else if (action === 'ban') {
                            title = "ð« Account Suspended";
                            notifBody = `Your account is suspended ${banLabel}. Reason: ${finalReason}`;
                        }

                        batch.set(notifRef, {
                            type: action,
                            title: title,
                            violation: notifBody,
                            contentSnapshot: context, 
                            read: false,
                            timestamp: timestamp
                        });

                        // Log
                        const logRef = doc(collection(db, 'users', userId, 'moderation_logs'));
                        batch.set(logRef, {
                            type: action,
                            reason: finalReason, 
                            duration: action === 'ban' ? durationVal : null,
                            adminId: adminUser.uid,
                            timestamp: timestamp
                        });

                        // User Document Update
                        const userRef = doc(db, 'users', userId);
                        
                        if (action === 'warn') {
                            batch.set(userRef, { moderation: { warnings: increment(1) } }, { merge: true });
                        }
                        else if (action === 'strike') {
                            const userSnap = await getDoc(userRef);
                            let restrictDate = new Date();
                            restrictDate.setTime(restrictDate.getTime() + (24 * 60 * 60 * 1000));
                            batch.set(userRef, { 
                                moderation: { strikes: increment(1), restrictedUntil: restrictDate } 
                            }, { merge: true });
                        }
                        else if (action === 'ban') {
                            const updateData = { 
                                isBanned: true, 
                                bannedAt: timestamp,
                                banReason: finalReason // <--- SAVING REASON HERE
                            };
                            if (banExpiryDate) updateData.bannedUntil = banExpiryDate;
                            else updateData.bannedUntil = null; 
                            batch.set(userRef, updateData, { merge: true });
                        }

                        if(reportId) batch.delete(doc(db, 'reports', reportId));

                        await batch.commit();
                        window.showToast(`${actionTitle} applied.`, "success");
                        
                        // Clear Custom Inputs
                        if(document.getElementById('mod-violation-custom')) document.getElementById('mod-violation-custom').value = '';
                        
                        window.closeModerationPanel();
                        
                    } catch(e) {
                        console.error("Mod Action Failed", e);
                        window.showToast("Action failed: " + e.message, "error");
                    } finally {
                        window.closeConfirmModal();
                    }
                },
                `Execute ${actionTitle}`
            );
        };

        window.deleteModerationLog = async (userId, logId, type) => {
            if(!confirm("Delete this moderation record? This will revert the action on the user's account.")) return;
            
            try {
                const batch = writeBatch(db);
                
                // 1. Delete Log Entry
                const logRef = doc(db, 'users', userId, 'moderation_logs', logId);
                batch.delete(logRef);

                // 2. Decrement Stats & Lift Restrictions
                const userRef = doc(db, 'users', userId);
                const safeType = (type || '').toLowerCase();

                if (safeType === 'warn' || safeType === 'warning') {
                    batch.set(userRef, { moderation: { warnings: increment(-1) } }, { merge: true });
                } 
                else if (safeType === 'strike') {
                    batch.update(userRef, { 
                        'moderation.strikes': increment(-1),
                        'moderation.restrictedUntil': deleteField() // CRITICAL: Removes the restriction date
                    });
                }
                else if (safeType === 'ban') {
                    // CRITICAL FIX: Explicitly delete ban timestamps and set isBanned to false
                    batch.update(userRef, { 
                        isBanned: false,
                        bannedUntil: deleteField(),
                        bannedAt: deleteField()
                    });
                }

                // 3. Notify User
                const notifRef = doc(collection(db, 'users', userId, 'system_notifications'));
                batch.set(notifRef, {
                    type: 'info', 
                    title: 'Account Status Update',
                    violation: `A ${safeType} has been removed from your record. Restrictions have been lifted.`,
                    read: false,
                    timestamp: serverTimestamp()
                });

                await batch.commit();
                window.showToast("Record removed & restrictions lifted.", "success");
                
            } catch(e) {
                console.error("Failed to delete log", e);
                window.showToast("Failed to remove record. " + e.message, "error");
            }
        };

        // Check if account is restricted and return true if blocked
        window.checkAccountRestriction = async () => {
            const user = auth.currentUser;
            if (!user) return false;
            
            try {
                // Check User Document
                const snap = await getDoc(doc(db, 'users', user.uid));
                if (snap.exists()) {
                    const data = snap.data();
                    const restrictedUntil = data.moderation?.restrictedUntil;
                    
                    if (restrictedUntil) {
                        const endDate = restrictedUntil.toDate ? restrictedUntil.toDate() : new Date(restrictedUntil);
                        const now = new Date();
                        
                        if (endDate > now) {
                            const dateStr = endDate.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
                            window.showToast(`Account restricted until ${dateStr}`, 'error');
                            return true; // BLOCKED
                        }
                    }
                }
            } catch (e) {
                console.error("Restriction check failed", e);
            }
            return false; // ALLOWED
        };

        window.handleLiftBan = async (userId) => {
            window.openConfirmModal(
                "Lift Ban?", 
                "This will immediately restore access to the user account.",
                async () => {
                    try {
                        const userRef = doc(db, 'users', userId);
                        await updateDoc(userRef, {
                            isBanned: false,
                            bannedUntil: deleteField(),
                            bannedAt: deleteField()
                        });
                        
                        window.showToast("Ban lifted successfully.", "success");
                        // Refresh panel
                        if (window.currentModTarget) {
                            const { userId, reportId, context, violation, targetPath, targetType, targetId } = window.currentModTarget;
                            window.openModerationPanel(userId, reportId, context, violation, targetPath, targetType, targetId);
                        }
                    } catch(e) {
                        console.error("Lift ban failed", e);
                        window.showToast("Error lifting ban: " + e.message, "error");
                    }
                },
                "Lift Ban"
            );
        };

        // Check restriction on login/refresh and show the detailed modal
        window.monitorAccountStatus = (user) => {
            window.resetBanUI();

            if (window.accountStatusUnsub) {
                window.accountStatusUnsub();
                window.accountStatusUnsub = null;
            }

            window.accountStatusUnsub = onSnapshot(doc(db, 'users', user.uid), async (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                const now = new Date();
                
                // --- 1. BAN LOGIC & AUTO-HEAL ---
                const bannedUntilDate = data.bannedUntil ? (data.bannedUntil.toDate ? data.bannedUntil.toDate() : new Date(data.bannedUntil)) : null;
                
                // Case A: Permanent Ban
                const isPermBanned = data.isBanned === true && !bannedUntilDate; 
                
                // Case B: Active Temporary Ban
                const isTempBannedActive = data.isBanned === true && bannedUntilDate && bannedUntilDate > now;

                // Case C: EXPIRED Temporary Ban (The Bug Fix)
                // If isBanned is true, but the date has passed, we must CLEAN the DB so Rules let us in.
                if (data.isBanned === true && bannedUntilDate && bannedUntilDate <= now) {
                    console.log("[Auto-Heal] Lifting expired ban...");
                    try {
                        await updateDoc(doc(db, 'users', user.uid), {
                            isBanned: false,
                            bannedUntil: deleteField(),
                            bannedAt: deleteField(),
                            banReason: deleteField()
                        });
                        // Do not return; let the UI refresh naturally on the next snapshot update
                        return; 
                    } catch(e) { console.error("Auto-heal ban failed", e); }
                }

                if (isPermBanned || isTempBannedActive) {
                    const modal = document.getElementById('ban-modal');
                    const reasonEl = document.getElementById('ban-reason-display');
                    const dateEl = document.getElementById('ban-date-display');
                    
                    modal.classList.remove('hidden');
                    
                    if (data.banReason) {
                        reasonEl.textContent = data.banReason;
                    } else {
                        reasonEl.textContent = "Violation of Terms of Service";
                    }
                    
                    if (isPermBanned) {
                        dateEl.innerText = "PERMANENT";
                        dateEl.classList.add('text-red-500');
                    } else {
                        dateEl.innerText = bannedUntilDate.toLocaleString();
                    }
                    
                    // LOCKDOWN UI
                    const sidebar = document.getElementById('app-sidebar');
                    if(sidebar) {
                        const nav = sidebar.querySelector('nav');
                        if(nav) nav.classList.add('hidden');
                        const upload = document.getElementById('upload-btn');
                        if(upload) upload.classList.add('hidden');
                        const create = document.getElementById('create-product-btn');
                        if(create) create.classList.add('hidden');
                    }
                    
                    const mobNav = document.getElementById('mobile-bottom-nav');
                    if(mobNav) mobNav.classList.add('hidden');

                    const feed = document.getElementById('feed-container');
                    if(feed) {
                        feed.innerHTML = '<div class="h-full flex items-center justify-center bg-black text-red-500 font-bold">ACCESS DENIED</div>';
                    }
                    
                    window.renderInternalView('profile'); 
                    return; 
                }

                // --- 2. STRIKE LOGIC & AUTO-HEAL ---
                const restrictedUntil = data.moderation?.restrictedUntil;
                if (restrictedUntil) {
                    const endDate = restrictedUntil.toDate ? restrictedUntil.toDate() : new Date(restrictedUntil);
                    
                    // If active
                    if (endDate > now) {
                        const dateStr = endDate.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
                        const dateDisplay = document.getElementById('restriction-date-display');
                        if(dateDisplay) dateDisplay.innerText = dateStr;
                        document.getElementById('restriction-modal').classList.remove('hidden');
                    } else {
                        // Expired Strike - Clean up DB
                        console.log("[Auto-Heal] Clearing expired restriction...");
                        try {
                            await updateDoc(doc(db, 'users', user.uid), {
                                'moderation.restrictedUntil': deleteField()
                            });
                        } catch(e) { console.error("Auto-heal strike failed", e); }
                        
                        document.getElementById('restriction-modal').classList.add('hidden');
                    }
                }
            });
        };

        window.loadRolesList = async () => {
            const div = document.getElementById('admin-staff-list');
            try {
                const snap = await getDoc(doc(db, 'config', 'roles'));
                if(snap.exists()) {
                    const data = snap.data();
                    const admins = Object.keys(data.admins || {}).map(uid => `<div class="flex justify-between items-center bg-brand-teal/10 p-2 rounded mb-1"><span class="font-mono text-xs">${uid}</span><span class="text-xs font-bold text-brand-teal">ADMIN</span></div>`).join('');
                    const mods = Object.keys(data.mods || {}).map(uid => `<div class="flex justify-between items-center bg-blue-100 dark:bg-blue-900/30 p-2 rounded mb-1"><span class="font-mono text-xs">${uid}</span><span class="text-xs font-bold text-blue-500">MOD</span></div>`).join('');
                    div.innerHTML = admins + mods;
                    if(!admins && !mods) div.innerHTML = "No staff configured.";
                } else {
                    div.innerHTML = "Roles document not found. Create 'config/roles' in Firestore.";
                }
            } catch(e) { div.innerHTML = "Error loading roles."; }
        };

        window.handleRoleUpdate = async (e) => {
            e.preventDefault();
            const uid = document.getElementById('admin-role-uid').value.trim();
            const isAdmin = document.getElementById('admin-role-is-admin').checked;
            const isMod = document.getElementById('admin-role-is-mod').checked;
            
            if(!uid) return;

            try {
                const ref = doc(db, 'config', 'roles');
                
                // Use dot notation to update specific keys in the map
                const updates = {};
                if(isAdmin) updates[`admins.${uid}`] = true; 
                else updates[`admins.${uid}`] = deleteField(); // Helper imported from firestore

                if(isMod) updates[`mods.${uid}`] = true;
                else updates[`mods.${uid}`] = deleteField();

                await updateDoc(ref, updates);
                
                window.showToast("Roles updated successfully", "success");
                window.loadRolesList();
                document.getElementById('admin-role-uid').value = '';
            } catch(e) {
                console.error(e);
                window.showToast("Failed to update roles. Ensure 'config/roles' doc exists.", "error");
            }
        };

        // --- MOBILE INTERFACE ---

        window.toggleMobileMenu = () => {
            const sidebar = document.getElementById('app-sidebar');
            const overlay = document.getElementById('mobile-menu-overlay');
            
            if (!sidebar || !overlay) return;

            if (sidebar.classList.contains('-translate-x-full')) {
                // Open Menu
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                // Close Menu
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        };

        // --- INITIALIZATION HOOKS ---
                
        // Hook viewProduct to inject Review UI
        hookFunction('viewProduct', null, async (productId, sellerId) => {
            await renderReviewsSection(productId, sellerId);
        });

        // Hook viewUserProfile to inject Reviews Tab
        hookFunction('viewUserProfile', null, async (userId, username, avatar) => {
            // await addReviewsTabToProfile(userId); // <--- COMMENT OUT OR REMOVE THIS
            await window.loadProfileRating(userId); // <--- ADD THIS
        });

        // Hook switchTab to handle the new 'reviews' case (since the original switchTab doesn't know about it)
        hookFunction('switchTab', (tabName) => {
            // We need to manually handle the UI toggling for our new tab 
            // because the original switchTab only loops through hardcoded IDs
            const reviewBtn = document.getElementById('tab-reviews');
            const reviewContent = document.getElementById('profile-content-reviews');
            
            if (reviewBtn && reviewContent) {
                if (tabName === 'reviews') {
                    reviewBtn.classList.remove('tab-inactive');
                    reviewBtn.classList.add('tab-active');
                    reviewContent.classList.remove('hidden');
                    
                    // Hide others (The original switchTab might have hidden them, but if we pass 'reviews' 
                    // to the original function, it might ignore it or just hide everything else. 
                    // We rely on the original function to hide its known tabs)
                } else {
                    reviewBtn.classList.remove('tab-active');
                    reviewBtn.classList.add('tab-inactive');
                    reviewContent.classList.add('hidden');
                }
            }
        }, null);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') { document.getElementById('feed-container').scrollBy({ top: window.innerHeight, behavior: 'smooth' }); } 
            else if (e.key === 'ArrowUp') { document.getElementById('feed-container').scrollBy({ top: -window.innerHeight, behavior: 'smooth' }); } 
            else if (e.key.toLowerCase() === 'm') { const videos = document.querySelectorAll('video'); const isMuted = videos[0].muted; videos.forEach(v => v.muted = !isMuted); }
        });

        document.addEventListener('click', (e) => {
            const searchWrap = document.querySelector('.relative.w-full.max-w-xs.group');
            const results = document.getElementById('profile-user-results');
            if (searchWrap && results && !searchWrap.contains(e.target)) {
                results.classList.add('hidden');
            }
        });

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>